<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>ZFS Administration Guide</title>
<style>
/*
 * Modern Light/Dark Mode Stylesheet for illumos Documentation
 * Pure CSS solution with automatic theme switching based on system preferences
 * Responsive design for all devices
 */

/* ==================== CSS CUSTOM PROPERTIES (VARIABLES) ==================== */

:root {
  /* Light mode colors (default) */
  --bg-color: #ffffff;
  --bg-secondary: #f8f9fa;
  --bg-tertiary: #e9ecef;
  --text-color: #212529;
  --text-secondary: #6c757d;
  --text-muted: #868e96;
  --border-color: #dee2e6;
  --border-secondary: #e9ecef;
  --link-color: #0d6efd;
  --link-hover: #0a58ca;
  --link-visited: #6f42c1;
  
  /* Code highlighting */
  --code-bg: #f8f9fa;
  --code-border: #e9ecef;
  --code-text: #0033b3;
  --code-block-bg: #fafbfc;
  --code-block-border: #d1d9e0;
  
  /* Admonition colors */
  --note-bg: #cff4fc;
  --note-border: #0dcaf0;
  --warning-bg: #fff3cd;
  --warning-border: #ffc107;
  --important-bg: #f8d7da;
  --important-border: #dc3545;
  --tip-bg: #d1e7dd;
  --tip-border: #198754;
  --caution-bg: #fff3cd;
  --caution-border: #fd7e14;
  
  /* Table colors */
  --table-bg: #ffffff;
  --table-stripe: #f8f9fa;
  --table-border: #dee2e6;
  --table-header-bg: #e9ecef;
  
  /* TOC colors */
  --toc-bg: #f8f9fa;
  --toc-border: #dee2e6;
  --toc-link: #495057;
  --toc-link-hover: #0d6efd;
  
  /* Shadow and focus */
  --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  --shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  --focus-ring: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  
  /* Typography */
  --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --font-family-mono: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --font-size-base: clamp(1rem, 0.9rem + 0.5vw, 1.125rem);
  --line-height-base: 1.6;
  
  /* Spacing */
  --content-max-width: 75rem;
  --toc-width: 16rem;
  --spacing-sm: 0.5rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
}

/* Dark mode colors */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-color: #1a1a1a;
    --bg-secondary: #2d2d2d;
    --bg-tertiary: #404040;
    --text-color: #e9ecef;
    --text-secondary: #adb5bd;
    --text-muted: #6c757d;
    --border-color: #495057;
    --border-secondary: #404040;
    --link-color: #6ea8fe;
    --link-hover: #9ec5fe;
    --link-visited: #b8a9ff;
    
    /* Code highlighting for dark mode */
    --code-bg: #2b2b2b;
    --code-border: #4a4a4a;
    --code-text: #569cd6;
    --code-block-bg: #1e1e1e;
    --code-block-border: #3e3e3e;
    
    /* Admonition colors for dark mode */
    --note-bg: #1f4a54;
    --note-border: #0dcaf0;
    --warning-bg: #4a3728;
    --warning-border: #ffc107;
    --important-bg: #4a2628;
    --important-border: #dc3545;
    --tip-bg: #1e3a28;
    --tip-border: #198754;
    --caution-bg: #4a3728;
    --caution-border: #fd7e14;
    
    /* Table colors for dark mode */
    --table-bg: #2d2d2d;
    --table-stripe: #404040;
    --table-border: #495057;
    --table-header-bg: #404040;
    
    /* TOC colors for dark mode */
    --toc-bg: #2d2d2d;
    --toc-border: #495057;
    --toc-link: #adb5bd;
    --toc-link-hover: #6ea8fe;
    
    /* Shadow for dark mode */
    --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.4);
    --focus-ring: 0 0 0 0.25rem rgba(110, 168, 254, 0.25);
  }
}

/* ==================== BASE STYLES ==================== */

* {
  box-sizing: border-box;
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
}

body {
  font-family: var(--font-family-base);
  font-size: var(--font-size-base);
  line-height: var(--line-height-base);
  color: var(--text-color);
  background-color: var(--bg-color);
  margin: 0;
  padding: 0;
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* ==================== LAYOUT ==================== */

.container {
  max-width: var(--content-max-width);
  margin: 0 auto;
  padding: var(--spacing-md);
}

/* Main content area */
#content {
  max-width: none;
  margin-right: var(--spacing-xl);
  padding-right: var(--spacing-lg);
}

/* Content when TOC is on left side */
body.toc2.toc-left #content {
  margin-right: var(--spacing-xl);
  padding-right: var(--spacing-xl);
}

/* ==================== TYPOGRAPHY ==================== */

h1, h2, h3, h4, h5, h6 {
  font-weight: 700;
  line-height: 1.2;
  margin-top: calc(var(--spacing-xl) * 1.5);
  margin-bottom: var(--spacing-lg);
  margin-right: var(--spacing-md);
  color: var(--text-color);
  letter-spacing: -0.02em;
  position: relative;
}

/* Make heading text clickable for easy linking */
h1[id]:hover, h2[id]:hover, h3[id]:hover, h4[id]:hover, h5[id]:hover, h6[id]:hover {
  cursor: pointer;
  text-decoration: underline;
  text-decoration-color: var(--link-color);
  text-decoration-thickness: 2px;
  text-underline-offset: 4px;
}

h1 {
  font-size: clamp(2rem, 2.2rem + 1vw, 2.8rem);
  font-weight: 800;
  border-bottom: 3px solid var(--border-color);
  padding-bottom: var(--spacing-md);
  margin-top: 0;
  margin-bottom: var(--spacing-xl);
}

h2 {
  font-size: clamp(1.6rem, 1.8rem + 0.5vw, 2.2rem);
  font-weight: 700;
  border-bottom: 2px solid var(--border-color);
  padding-bottom: var(--spacing-sm);
  margin-top: calc(var(--spacing-xl) * 2);
}

h3 {
  font-size: clamp(1.4rem, 1.5rem + 0.3vw, 1.8rem);
  font-weight: 650;
  border-left: 4px solid var(--border-color);
  padding-left: var(--spacing-md);
  margin-top: calc(var(--spacing-xl) * 1.5);
}

h4 {
  font-size: clamp(1.2rem, 1.3rem + 0.2vw, 1.5rem);
  font-weight: 650;
  color: var(--text-color);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px dotted var(--border-color);
  padding-bottom: 0.25rem;
}

h5 {
  font-size: clamp(1.1rem, 1.15rem + 0.1vw, 1.3rem);
  font-weight: 600;
  font-style: italic;
}

h6 {
  font-size: clamp(1rem, 1.05rem + 0.1vw, 1.2rem);
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

p {
  margin-bottom: var(--spacing-md);
  margin-right: var(--spacing-md);
}

/* ==================== LINKS ==================== */

a {
  color: var(--link-color);
  text-decoration: none;
  transition: color 0.2s ease;
}

a:hover {
  color: var(--link-hover);
  text-decoration: underline;
}

a:visited {
  color: var(--link-visited);
}

a:focus {
  outline: none;
  box-shadow: var(--focus-ring);
  border-radius: 0.25rem;
}

/* ==================== CODE BLOCKS ==================== */

code {
  font-family: var(--font-family-mono);
  font-size: 0.9em;
  color: var(--code-text);
  background-color: var(--code-bg);
  padding: 0.125rem 0.25rem;
  border-radius: 0.25rem;
  border: 1px solid var(--code-border);
}

pre {
  font-family: var(--font-family-mono);
  font-size: 0.875rem;
  line-height: 1.5;
  background-color: var(--code-block-bg);
  color: var(--text-color);
  border: 1px solid var(--code-block-border);
  border-radius: 0.5rem;
  padding: var(--spacing-md);
  margin: var(--spacing-md) var(--spacing-md) var(--spacing-md) 0;
  overflow-x: auto;
  box-shadow: var(--shadow);
}

pre code {
  background: none;
  border: none;
  padding: 0;
  color: inherit;
  font-size: inherit;
}

/* ==================== SYNTAX HIGHLIGHTING ==================== */

/* Base highlighting for light mode */
.hljs {
  background-color: var(--code-block-bg) !important;
  color: var(--text-color) !important;
}

/* Light mode syntax highlighting */
:root {
  --hl-keyword: #0033b3;          /* Keywords: blue */
  --hl-string: #067d17;           /* Strings: green */
  --hl-comment: #808080;          /* Comments: gray */
  --hl-number: #1750eb;           /* Numbers: blue */
  --hl-type: #800080;             /* Types: purple */
  --hl-function: #000080;         /* Functions: dark blue */
  --hl-variable: #660e7a;         /* Variables: dark purple */
  --hl-preprocessor: #808000;     /* Preprocessor: olive */
  --hl-operator: #000000;         /* Operators: black */
  --hl-literal: #0000ff;          /* Literals: blue */
}

/* Dark mode syntax highlighting */
@media (prefers-color-scheme: dark) {
  :root {
    --hl-keyword: #569cd6;        /* Keywords: light blue */
    --hl-string: #9cdcfe;         /* Strings: light cyan */
    --hl-comment: #6a9955;        /* Comments: green */
    --hl-number: #b5cea8;         /* Numbers: light green */
    --hl-type: #4ec9b0;           /* Types: teal */
    --hl-function: #dcdcaa;       /* Functions: yellow */
    --hl-variable: #9cdcfe;       /* Variables: light cyan */
    --hl-preprocessor: #c586c0;   /* Preprocessor: light purple */
    --hl-operator: #d4d4d4;       /* Operators: light gray */
    --hl-literal: #d69d85;        /* Literals: orange */
  }
}

/* Highlight.js C/C++ syntax highlighting */
.hljs-keyword,
.hljs-selector-tag,
.hljs-built_in {
  color: var(--hl-keyword) !important;
  font-weight: 600;
}

.hljs-string,
.hljs-attribute {
  color: var(--hl-string) !important;
}

.hljs-comment,
.hljs-quote {
  color: var(--hl-comment) !important;
  font-style: italic;
}

.hljs-number,
.hljs-literal {
  color: var(--hl-number) !important;
}

.hljs-type,
.hljs-class .hljs-title {
  color: var(--hl-type) !important;
  font-weight: 600;
}

.hljs-function .hljs-title,
.hljs-title.function_ {
  color: var(--hl-function) !important;
  font-weight: 600;
}

.hljs-variable,
.hljs-name {
  color: var(--hl-variable) !important;
}

.hljs-meta,
.hljs-preprocessor {
  color: var(--hl-preprocessor) !important;
  font-weight: 600;
}

.hljs-operator,
.hljs-punctuation {
  color: var(--hl-operator) !important;
}

/* DTrace-specific highlighting */
.hljs-dtrace-probe,
.hljs-dtrace-builtin {
  color: var(--hl-function) !important;
  font-weight: 600;
}

/* Additional C-specific tokens */
.hljs-params {
  color: var(--text-color) !important;
}

.hljs-title {
  color: var(--hl-function) !important;
  font-weight: 600;
}

/* Ensure good contrast for inline code */
code:not(.hljs) {
  color: var(--hl-keyword) !important;
  background-color: var(--code-bg) !important;
  font-weight: 500;
}

/* Fallback for code blocks without syntax highlighting */
pre:not(.hljs) {
  color: var(--text-color) !important;
  background-color: var(--code-block-bg) !important;
}

/* Improve readability for unstyled code blocks */
pre code:not(.hljs) {
  color: var(--text-color) !important;
  background: transparent !important;
  border: none !important;
  padding: 0 !important;
}

/* ==================== TABLES ==================== */

table {
  width: calc(100% - 2 * var(--spacing-md));
  border-collapse: collapse;
  margin: var(--spacing-md) var(--spacing-md);
  background-color: var(--table-bg);
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: var(--shadow);
  border: 1px solid var(--table-border);
}

th, td {
  padding: calc(var(--spacing-sm) * 0.75) var(--spacing-sm);
  text-align: left;
  border-bottom: 1px solid var(--table-border);
  border-right: 1px solid var(--table-border);
}

th:last-child,
td:last-child {
  border-right: none;
}

th {
  background-color: var(--table-header-bg);
  font-weight: 600;
  color: var(--text-color);
  border-bottom: 2px solid var(--table-border);
}

tbody tr:nth-child(even) {
  background-color: var(--table-stripe);
}

tbody tr:hover {
  background-color: var(--bg-tertiary);
}

/* Lists inside table cells - reduce spacing */
td ul, td ol, th ul, th ol {
  margin: var(--spacing-sm) 0;
  padding-left: var(--spacing-lg);
}

td li, th li {
  margin: calc(var(--spacing-sm) * 0.25) 0;
}

/* Paragraphs in table cells - reduce spacing */
td p, th p {
  margin-bottom: calc(var(--spacing-sm) * 0.5);
  margin-right: 0;
}

/* ==================== TABLE OF CONTENTS ==================== */

#toc {
  background-color: var(--toc-bg);
  border: 1px solid var(--toc-border);
  border-radius: 0.5rem;
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
  box-shadow: var(--shadow);
  position: relative;
}

#toc .title {
  font-weight: 600;
  font-size: 0.95rem;
  margin-bottom: calc(var(--spacing-sm) * 0.5);
  color: var(--text-color);
}

#toc ul {
  list-style: none;
  padding-left: 0;
  margin: 0;
}

#toc ul ul {
  padding-left: calc(var(--spacing-md) * 0.75);
  margin-top: calc(var(--spacing-sm) * 0.25);
}

#toc li {
  margin: calc(var(--spacing-sm) * 0.25) 0;
}

#toc a {
  color: var(--toc-link);
  text-decoration: none;
  display: block;
  padding: 0.125rem 0.375rem;
  border-radius: 0.25rem;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

#toc a:hover {
  color: var(--toc-link-hover);
  background-color: var(--bg-tertiary);
  text-decoration: none;
}

/* Active/Current section highlighting */
#toc a.active {
  color: var(--link-color);
  background-color: var(--link-color);
  background-color: color-mix(in srgb, var(--link-color) 15%, transparent);
  font-weight: 600;
  border-left: 3px solid var(--link-color);
  padding-left: calc(0.375rem - 3px);
}

@media (prefers-color-scheme: dark) {
  #toc a.active {
    background-color: color-mix(in srgb, var(--link-color) 20%, transparent);
  }
}

/* Target section highlighting */
:target {
  scroll-margin-top: var(--spacing-xl);
  animation: highlight-target 2s ease-out;
}

@keyframes highlight-target {
  0% {
    background-color: color-mix(in srgb, var(--link-color) 20%, transparent);
  }
  100% {
    background-color: transparent;
  }
}

/* Smooth scrolling enhancement */
html {
  scroll-behavior: smooth;
  scroll-padding-top: var(--spacing-xl);
}

/* Progressive enhancement for scroll-spy */
body.js-enabled #toc a {
  transition: all 0.2s ease;
}

body.js-enabled #toc a.active {
  transform: translateX(2px);
}

/* Parent section highlighting for nested TOC */
#toc a.active-parent {
  color: var(--toc-link-hover);
  font-weight: 500;
  background-color: color-mix(in srgb, var(--link-color) 8%, transparent);
}

/* Fallback for browsers without color-mix support */
@supports not (background-color: color-mix(in srgb, blue 15%, transparent)) {
  #toc a.active {
    background-color: var(--link-hover);
    background-color: rgba(13, 110, 253, 0.15);
  }
  
  @media (prefers-color-scheme: dark) {
    #toc a.active {
      background-color: rgba(110, 168, 254, 0.2);
    }
  }
  
  #toc a.active-parent {
    background-color: rgba(13, 110, 253, 0.08);
  }
  
  @media (prefers-color-scheme: dark) {
    #toc a.active-parent {
      background-color: rgba(110, 168, 254, 0.1);
    }
  }
}

/* Left TOC layout for larger screens */
@media (min-width: 1200px) {
  body.toc2.toc-left {
    padding-left: calc(var(--toc-width) + var(--spacing-lg));
  }
  
  #toc.toc2 {
    position: fixed;
    left: 0;
    top: 0;
    width: var(--toc-width);
    height: 100vh;
    overflow-y: auto;
    margin: 0;
    border-radius: 0;
    border-left: none;
    border-top: none;
    border-bottom: none;
    z-index: 1000;
  }
}

/* ==================== ADMONITIONS ==================== */

.admonitionblock {
  margin: var(--spacing-lg) var(--spacing-md);
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: var(--shadow);
}

.admonitionblock table {
  margin: 0;
  box-shadow: none;
  width: 100%;
  border: none;
  border-radius: 0;
}

.admonitionblock td.icon {
  display: none;
}

.admonitionblock td.content {
  padding: var(--spacing-md);
  border: none;
  border-bottom: none;
  border-right: none;
}

/* Note */
.admonitionblock.note {
  background-color: var(--note-bg);
  border-left: 4px solid var(--note-border);
}

/* Warning */
.admonitionblock.warning {
  background-color: var(--warning-bg);
  border-left: 4px solid var(--warning-border);
}

/* Important */
.admonitionblock.important {
  background-color: var(--important-bg);
  border-left: 4px solid var(--important-border);
}

/* Tip */
.admonitionblock.tip {
  background-color: var(--tip-bg);
  border-left: 4px solid var(--tip-border);
}

/* Caution */
.admonitionblock.caution {
  background-color: var(--caution-bg);
  border-left: 4px solid var(--caution-border);
}

/* ==================== LISTS ==================== */

ul, ol {
  padding-left: var(--spacing-xl);
  margin: var(--spacing-md) var(--spacing-md) var(--spacing-md) 0;
}

li {
  margin: var(--spacing-sm) 0;
}

dt {
  font-weight: 600;
  margin-top: var(--spacing-md);
  color: var(--text-color);
}

dd {
  margin-left: var(--spacing-xl);
  margin-bottom: var(--spacing-md);
}

/* ==================== BLOCKQUOTES ==================== */

blockquote {
  border-left: 4px solid var(--border-color);
  margin: var(--spacing-lg) var(--spacing-md) var(--spacing-lg) 0;
  padding: var(--spacing-md) var(--spacing-lg);
  background-color: var(--bg-secondary);
  font-style: italic;
  border-radius: 0 0.5rem 0.5rem 0;
}

/* ==================== IMAGES AND FIGURES ==================== */

img {
  max-width: 80%;
  width: auto;
  height: auto;
  border-radius: 0.5rem;
  box-shadow: var(--shadow);
  margin: var(--spacing-md) auto;
  display: block;
}

.imageblock {
  text-align: center;
  margin: var(--spacing-lg) 0;
}

.imageblock .title {
  font-style: italic;
  color: var(--text-secondary);
  margin-top: var(--spacing-sm);
}

/* ==================== RESPONSIVE DESIGN ==================== */

/* Mobile adjustments */
@media (max-width: 768px) {
  .container {
    padding: var(--spacing-sm);
  }
  
  #content {
    margin-right: var(--spacing-md);
    padding-right: var(--spacing-sm);
  }
  
  body.toc2.toc-left #content {
    margin-right: var(--spacing-md);
    padding-right: var(--spacing-sm);
  }
  
  h1 {
    font-size: 1.8rem;
    margin-right: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-sm);
  }
  
  h2 {
    font-size: 1.5rem;
    margin-right: var(--spacing-sm);
    margin-top: var(--spacing-xl);
    padding: var(--spacing-sm);
  }
  
  h3 {
    font-size: 1.3rem;
    margin-top: var(--spacing-lg);
    padding-left: var(--spacing-sm);
  }
  
  h4 {
    font-size: 1.1rem;
  }
  
  h1, h2, h3, h4, h5, h6 {
    margin-right: var(--spacing-sm);
  }
  
  p {
    margin-right: var(--spacing-sm);
  }
  
  pre {
    font-size: 0.8rem;
    padding: var(--spacing-sm);
    margin-right: var(--spacing-sm);
  }
  
  ul, ol {
    margin-right: var(--spacing-sm);
  }
  
  blockquote {
    margin-right: var(--spacing-sm);
  }
  
  table {
    font-size: 0.9rem;
    width: calc(100% - 2 * var(--spacing-sm));
    margin: var(--spacing-md) var(--spacing-sm);
  }
  
  th, td {
    padding: calc(var(--spacing-sm) * 0.5) calc(var(--spacing-sm) * 0.75);
  }
  
  #toc {
    margin-bottom: var(--spacing-md);
  }
  
  .admonitionblock {
    margin: var(--spacing-md) var(--spacing-sm);
  }
  
  .admonitionblock td.icon {
    display: none;
  }
  
  .admonitionblock td.content {
    padding: var(--spacing-sm);
    border: none;
  }
  
  .admonitionblock table {
    margin: 0;
    width: 100%;
  }
  
  /* Even more compact lists in table cells on mobile */
  td ul, td ol, th ul, th ol {
    margin: calc(var(--spacing-sm) * 0.5) 0;
    padding-left: var(--spacing-md);
  }
  
  td li, th li {
    margin: calc(var(--spacing-sm) * 0.125) 0;
  }
  
  td p, th p {
    margin-bottom: calc(var(--spacing-sm) * 0.25);
  }
}

/* Tablet adjustments */
@media (min-width: 769px) and (max-width: 1199px) {
  .container {
    padding: var(--spacing-md) var(--spacing-lg);
  }
}

/* ==================== PRINT STYLES ==================== */

@media print {
  :root {
    --bg-color: white;
    --text-color: black;
    --border-color: #ccc;
  }
  
  body {
    font-size: 12pt;
    line-height: 1.4;
  }
  
  #toc.toc2 {
    position: static;
    width: auto;
    height: auto;
    margin-bottom: var(--spacing-lg);
  }
  
  body.toc2.toc-left {
    padding-left: 0;
  }
  
  .admonitionblock {
    page-break-inside: avoid;
  }
  
  pre {
    page-break-inside: avoid;
  }
  
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
}

/* ==================== UTILITIES ==================== */

.text-center {
  text-align: center;
}

.text-right {
  text-align: right;
}

.mb-0 {
  margin-bottom: 0;
}

.mt-0 {
  margin-top: 0;
}

/* ==================== ACCESSIBILITY ==================== */

/* Focus indicators */
*:focus {
  outline: 2px solid var(--link-color);
  outline-offset: 2px;
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  :root {
    --border-color: #000000;
    --border-secondary: #000000;
    --text-secondary: var(--text-color);
  }
}

/* ==================== CUSTOM ENHANCEMENTS ==================== */

/* Note: This CSS includes scroll-spy functionality that works with CSS alone
 * For enhanced scroll-spy with JavaScript, include scroll-spy.js:
 * <script src="scroll-spy.js"></script>
 */

/* Better selection colors */
::selection {
  background-color: var(--link-color);
  color: white;
}

/* Loading state */
body {
  opacity: 0;
  animation: fadeIn 0.3s ease-in-out forwards;
}

@keyframes fadeIn {
  to {
    opacity: 1;
  }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>ZFS Administration Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preface">1. Preface</a>
<ul class="sectlevel3">
<li><a href="#zfs-delegated-administration">1.1. ZFS Delegated Administration</a></li>
<li><a href="#setting-up-separate-zfs-logging-devices">1.2. Setting Up Separate ZFS Logging Devices</a></li>
<li><a href="#creating-intermediate-zfs-datasets">1.3. Creating Intermediate ZFS Datasets</a></li>
<li><a href="#zfs-hotplugging-enhancements">1.4. ZFS Hotplugging Enhancements</a></li>
<li><a href="#recursively-renaming-zfs-snapshots-zfs-rename-r">1.5. Recursively Renaming ZFS Snapshots (<code>zfs rename</code> <code>r</code>)</a></li>
<li><a href="#gzip-compression-is-available-for-zfs">1.6. GZIP Compression is Available for ZFS</a></li>
<li><a href="#storing-multiple-copies-of-zfs-user-data">1.7. Storing Multiple Copies of ZFS User Data</a></li>
<li><a href="#improved-zpool-status-output">1.8. Improved <code>zpool status</code> Output</a></li>
<li><a href="#zfs-and-solaris-iscsi-improvements">1.9. ZFS and Solaris iSCSI Improvements</a></li>
<li><a href="#sharing-zfs-file-system-enhancements">1.10. Sharing ZFS File System Enhancements</a></li>
<li><a href="#zfs-command-history-zpool-history">1.11. ZFS Command History (<code>zpool history</code>)</a></li>
<li><a href="#zfs-property-improvements">1.12. ZFS Property Improvements</a></li>
<li><a href="#displaying-all-zfs-file-system-information">1.13. Displaying All ZFS File System Information</a></li>
<li><a href="#new-zfs-receive-f-option">1.14. New <code>zfs receive</code> <code>F</code> Option</a></li>
<li><a href="#recursive-zfs-snapshots">1.15. Recursive ZFS Snapshots</a></li>
<li><a href="#double-parity-raid-z-raidz2">1.16. Double Parity RAID-Z (<code>raidz2</code>)</a></li>
<li><a href="#hot-spares-for-zfs-storage-pool-devices">1.17. Hot Spares for ZFS Storage Pool Devices</a></li>
<li><a href="#replacing-a-zfs-file-system-with-a-zfs-clone-zfs-promote">1.18. Replacing a ZFS File System With a ZFS Clone (<code>zfs promote</code>)</a></li>
<li><a href="#upgrading-zfs-storage-pools-zpool-upgrade">1.19. Upgrading ZFS Storage Pools (<code>zpool upgrade</code>)</a></li>
<li><a href="#using-zfs-to-clone-non-global-zones-and-other-enhancements">1.20. Using ZFS to Clone Non-Global Zones and Other Enhancements</a></li>
<li><a href="#zfs-backup-and-restore-commands-are-renamed">1.21. ZFS Backup and Restore Commands are Renamed</a></li>
<li><a href="#recovering-destroyed-storage-pools">1.22. Recovering Destroyed Storage Pools</a></li>
<li><a href="#zfs-is-integrated-with-fault-manager">1.23. ZFS is Integrated With Fault Manager</a></li>
<li><a href="#new-zpool-clear-command">1.24. New <code>zpool clear</code> Command</a></li>
<li><a href="#compact-nfsv4-acl-format">1.25. Compact NFSv4 ACL Format</a></li>
<li><a href="#file-system-monitoring-tool-fsstat">1.26. File System Monitoring Tool (<code>fsstat</code>)</a></li>
<li><a href="#zfs-web-based-management">1.27. ZFS Web-Based Management</a></li>
<li><a href="#creating-a-zfs-storage-pool">1.28. Creating a ZFS Storage Pool</a></li>
<li><a href="#creating-a-zfs-file-system-hierarchy">1.29. Creating a ZFS File System Hierarchy</a></li>
</ul>
</li>
<li><a href="#zfs-and-traditional-file-system-differences">2. ZFS and Traditional File System Differences</a>
<ul class="sectlevel2">
<li><a href="#zfs-file-system-granularity">2.1. ZFS File System Granularity</a></li>
<li><a href="#zfs-space-accounting">2.2. ZFS Space Accounting</a>
<ul class="sectlevel3">
<li><a href="#out-of-space-behavior">2.2.1. Out of Space Behavior</a></li>
</ul>
</li>
<li><a href="#mounting-zfs-file-systems">2.3. Mounting ZFS File Systems</a></li>
<li><a href="#traditional-volume-management">2.4. Traditional Volume Management</a></li>
<li><a href="#the-nfsv4-acl-model">2.5. The NFSv4 ACL Model</a></li>
</ul>
</li>
<li><a href="#managing-zfs-storage-pools">3. Managing ZFS Storage Pools</a>
<ul class="sectlevel2">
<li><a href="#components-of-a-zfs-storage-pool">3.1. Components of a ZFS Storage Pool</a>
<ul class="sectlevel3">
<li><a href="#using-disks-in-a-zfs-storage-pool">3.1.1. Using Disks in a ZFS Storage Pool</a></li>
<li><a href="#using-files-in-a-zfs-storage-pool">3.1.2. Using Files in a ZFS Storage Pool</a></li>
<li><a href="#identifying-virtual-devices-in-a-storage-pool">3.1.3. Identifying Virtual Devices in a Storage Pool</a></li>
</ul>
</li>
<li><a href="#replication-features-of-a-zfs-storage-pool">3.2. Replication Features of a ZFS Storage Pool</a>
<ul class="sectlevel3">
<li><a href="#mirrored-storage-pool-configuration">3.2.1. Mirrored Storage Pool Configuration</a></li>
<li><a href="#raid-z-storage-pool-configuration">3.2.2. RAID-Z Storage Pool Configuration</a></li>
<li><a href="#self-healing-data-in-a-redundant-configuration">3.2.3. Self-Healing Data in a Redundant Configuration</a></li>
<li><a href="#dynamic-striping-in-a-storage-pool">3.2.4. Dynamic Striping in a Storage Pool</a></li>
</ul>
</li>
<li><a href="#creating-and-destroying-zfs-storage-pools">3.3. Creating and Destroying ZFS Storage Pools</a>
<ul class="sectlevel3">
<li><a href="#creating-a-zfs-storage-pool-1">3.3.1. Creating a ZFS Storage Pool</a></li>
<li><a href="#handling-zfs-storage-pool-creation-errors">3.3.2. Handling ZFS Storage Pool Creation Errors</a></li>
<li><a href="#destroying-zfs-storage-pools">3.3.3. Destroying ZFS Storage Pools</a></li>
<li><a href="#clearing-storage-pool-devices">3.3.4. Clearing Storage Pool Devices</a></li>
<li><a href="#replacing-devices-in-a-storage-pool">3.3.5. Replacing Devices in a Storage Pool</a></li>
<li><a href="#designating-hot-spares-in-your-storage-pool">3.3.6. Designating Hot Spares in Your Storage Pool</a></li>
</ul>
</li>
<li><a href="#managing-zfs-storage-pool-properties">3.4. Managing ZFS Storage Pool Properties</a></li>
<li><a href="#querying-zfs-storage-pool-status">3.5. Querying ZFS Storage Pool Status</a>
<ul class="sectlevel3">
<li><a href="#displaying-basic-zfs-storage-pool-information">3.5.1. Displaying Basic ZFS Storage Pool Information</a></li>
<li><a href="#viewing-zfs-storage-pool-io-statistics">3.5.2. Viewing ZFS Storage Pool I/O Statistics</a></li>
<li><a href="#determining-the-health-status-of-zfs-storage-pools">3.5.3. Determining the Health Status of ZFS Storage Pools</a></li>
</ul>
</li>
<li><a href="#migrating-zfs-storage-pools">3.6. Migrating ZFS Storage Pools</a>
<ul class="sectlevel3">
<li><a href="#preparing-for-zfs-storage-pool-migration">3.6.1. Preparing for ZFS Storage Pool Migration</a></li>
<li><a href="#exporting-a-zfs-storage-pool">3.6.2. Exporting a ZFS Storage Pool</a></li>
<li><a href="#determining-available-storage-pools-to-import">3.6.3. Determining Available Storage Pools to Import</a></li>
<li><a href="#finding-zfs-storage-pools-from-alternate-directories">3.6.4. Finding ZFS Storage Pools From Alternate Directories</a></li>
<li><a href="#importing-zfs-storage-pools">3.6.5. Importing ZFS Storage Pools</a></li>
<li><a href="#recovering-destroyed-zfs-storage-pools">3.6.6. Recovering Destroyed ZFS Storage Pools</a></li>
<li><a href="#upgrading-zfs-storage-pools">3.6.7. Upgrading ZFS Storage Pools</a></li>
</ul>
</li>
<li><a href="#creating-and-destroying-zfs-file-systems">3.7. Creating and Destroying ZFS File Systems</a>
<ul class="sectlevel3">
<li><a href="#creating-a-zfs-file-system">3.7.1. Creating a ZFS File System</a></li>
<li><a href="#destroying-a-zfs-file-system">3.7.2. Destroying a ZFS File System</a></li>
<li><a href="#renaming-a-zfs-file-system">3.7.3. Renaming a ZFS File System</a></li>
</ul>
</li>
<li><a href="#introducing-zfs-properties">3.8. Introducing ZFS Properties</a>
<ul class="sectlevel3">
<li><a href="#zfs-read-only-native-properties">3.8.1. ZFS Read-Only Native Properties</a></li>
<li><a href="#settable-zfs-native-properties">3.8.2. Settable ZFS Native Properties</a></li>
<li><a href="#zfs-user-properties-1">3.8.3. ZFS User Properties</a></li>
</ul>
</li>
<li><a href="#querying-zfs-file-system-information">3.9. Querying ZFS File System Information</a>
<ul class="sectlevel3">
<li><a href="#listing-basic-zfs-information">3.9.1. Listing Basic ZFS Information</a></li>
<li><a href="#creating-complex-zfs-queries">3.9.2. Creating Complex ZFS Queries</a></li>
</ul>
</li>
<li><a href="#managing-zfs-properties">3.10. Managing ZFS Properties</a>
<ul class="sectlevel3">
<li><a href="#setting-zfs-properties">3.10.1. Setting ZFS Properties</a></li>
<li><a href="#inheriting-zfs-properties">3.10.2. Inheriting ZFS Properties</a></li>
</ul>
</li>
<li><a href="#overview-of-zfs-clones">3.11. Overview of ZFS Clones</a>
<ul class="sectlevel3">
<li><a href="#creating-a-zfs-clone">3.11.1. Creating a ZFS Clone</a></li>
<li><a href="#destroying-a-zfs-clone">3.11.2. Destroying a ZFS Clone</a></li>
<li><a href="#replacing-a-zfs-file-system-with-a-zfs-clone">3.11.3. Replacing a ZFS File System With a ZFS Clone</a></li>
</ul>
</li>
<li><a href="#saving-and-restoring-zfs-data">3.12. Saving and Restoring ZFS Data</a>
<ul class="sectlevel3">
<li><a href="#saving-zfs-data-with-other-backup-products">3.12.1. Saving ZFS Data With Other Backup Products</a></li>
<li><a href="#saving-a-zfs-snapshot">3.12.2. Saving a ZFS Snapshot</a></li>
<li><a href="#restoring-a-zfs-snapshot">3.12.3. Restoring a ZFS Snapshot</a></li>
<li><a href="#sending-and-receiving-complex-zfs-snapshot-streams">3.12.4. Sending and Receiving Complex ZFS Snapshot Streams</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#using-acls-to-protect-zfs-files">4. Using ACLs to Protect ZFS Files</a>
<ul class="sectlevel2">
<li><a href="#the-nfsv4-acl-model-1">4.1. The NFSv4 ACL Model</a>
<ul class="sectlevel3">
<li><a href="#syntax-descriptions-for-setting-acls">4.1.1. Syntax Descriptions for Setting ACLs</a></li>
<li><a href="#acl-inheritance">4.1.2. ACL Inheritance</a></li>
<li><a href="#acl-property-modes">4.1.3. ACL Property Modes</a></li>
</ul>
</li>
<li><a href="#setting-acls-on-zfs-files">4.2. Setting ACLs on ZFS Files</a></li>
<li><a href="#setting-and-displaying-acls-on-zfs-files-in-verbose-format">4.3. Setting and Displaying ACLs on ZFS Files in Verbose Format</a>
<ul class="sectlevel3">
<li><a href="#setting-acl-inheritance-on-zfs-files-in-verbose-format">4.3.1. Setting ACL Inheritance on ZFS Files in Verbose Format</a></li>
</ul>
</li>
<li><a href="#setting-and-displaying-acls-on-zfs-files-in-compact-format">4.4. Setting and Displaying ACLs on ZFS Files in Compact Format</a></li>
</ul>
</li>
<li><a href="#zfs-delegated-administration-1">5. ZFS Delegated Administration</a>
<ul class="sectlevel2">
<li><a href="#overview-of-zfs-delegated-administration">5.1. Overview of ZFS Delegated Administration</a>
<ul class="sectlevel3">
<li><a href="#disabling-zfs-delegated-permissions">5.1.1. Disabling ZFS Delegated Permissions</a></li>
</ul>
</li>
<li><a href="#delegating-zfs-permissions">5.2. Delegating ZFS Permissions</a>
<ul class="sectlevel3">
<li><a href="#syntax-descriptions-for-delegating-permissions">5.2.1. Syntax Descriptions for Delegating Permissions</a></li>
<li><a href="#removing-zfs-delegated-permissions-zfs-unallow">5.2.2. Removing ZFS Delegated Permissions (<code>zfs unallow</code>)</a></li>
</ul>
</li>
<li><a href="#using-zfs-delegated-administration">5.3. Using ZFS Delegated Administration</a>
<ul class="sectlevel3">
<li><a href="#displaying-zfs-delegated-permissions-examples">5.3.1. Displaying ZFS Delegated Permissions (Examples)</a></li>
<li><a href="#delegating-zfs-permissions-examples">5.3.2. Delegating ZFS Permissions (Examples)</a></li>
<li><a href="#removing-zfs-permission-examples">5.3.3. Removing ZFS Permission (Examples)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#zfs-advanced-topics">6. ZFS Advanced Topics</a>
<ul class="sectlevel2">
<li><a href="#zfs-volumes">6.1. ZFS Volumes</a>
<ul class="sectlevel3">
<li><a href="#using-a-zfs-volume-as-a-swap-or-dump-device">6.1.1. Using a ZFS Volume as a Swap or Dump Device</a></li>
<li><a href="#using-a-zfs-volume-as-a-solaris-iscsi-target">6.1.2. Using a ZFS Volume as a Solaris iSCSI Target</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface"><a class="anchor" href="#_preface"></a>1. Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The ZFS Administration Guide provides information about setting up and
managing ZFS file systems.</p>
</div>
<div class="paragraph">
<p>This guide contains information for both SPARC based and x86 based
systems.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This illumos release supports systems that use the SPARC and x86
families of processor architectures: UltraSPARC, SPARC64, AMD64,
Pentium, and Xeon EM64T. The supported systems appear in the
<a href="https://illumos.org/hcl/">illumos Hardware Compatibility List</a>. This
document cites any implementation differences between the platform
types.</p>
</div>
<div class="paragraph">
<p>In this document these x86 terms mean the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>“x86” refers to the larger family of 64-bit and 32-bit x86 compatible
products.</p>
</li>
<li>
<p>“x64” points out specific 64-bit information about AMD64 or EM64T
systems.</p>
</li>
<li>
<p>“32-bit x86” points out specific 32-bit information about x86 based
systems.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For supported systems, see the illumos Hardware Compatibility List.</p>
</div>
<div id="who-should-use-this-book" class="paragraph">
<p>=== Who Should Use This Book</p>
</div>
<div class="paragraph">
<p>This guide is intended for anyone who is interested in setting up and
managing ZFS file systems. Experience using illumos or another UNIX
operating system is recommended.</p>
</div>
<div id="how-this-book-is-organized" class="paragraph">
<p>=== How This Book Is Organized</p>
</div>
<div class="paragraph">
<p>The following table describes the chapters in this book.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Chapter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#zfs-file-system-introduction">ZFS File System (Introduction)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides an overview
of ZFS and its features and benefits. It also covers some basic concepts
and terminology.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#getting-started-with-zfs">Getting Started With ZFS</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides step-by-step
instructions on setting up simple ZFS configurations with simple pools
and file systems. This chapter also provides the hardware and software
required to create ZFS file systems.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#zfs-and-traditional-file-system-differences">ZFS and Traditional File System Differences</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identifies
important features that make ZFS significantly different from
traditional file systems. Understanding these key differences will help
reduce confusion when using traditional tools to interact with ZFS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#managing-zfs-storage-pools">Managing ZFS Storage Pools</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides a detailed
description of how to create and administer storage pools.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#managing-zfs-file-systems">Managing ZFS File Systems</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides detailed information
about managing ZFS file systems. Included are such concepts as
hierarchical file system layout, property inheritance, and automatic
mount point management and share interactions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#working-with-zfs-snapshots-and-clones">Working With ZFS Snapshots and Clones</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describes how
to create and administer ZFS snapshots and clones.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#using-acls-to-protect-zfs-files">Using ACLs to Protect ZFS Files</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describes how to use
access control lists (ACLs) to protect your ZFS files by providing more
granular permissions then the standard UNIX permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#zfs-advanced-topics">ZFS Advanced Topics</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides information on using ZFS
volumes, using ZFS with zones, and alternate root pools.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#zfs-troubleshooting-and-data-recovery">ZFS Troubleshooting and Data Recovery</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describes how to
identify ZFS failure modes and how to recover from them. Steps for
preventing failures are covered as well.</p></td>
</tr>
</tbody>
</table>
<div id="related-books-and-papers" class="paragraph">
<p>=== Related Books</p>
</div>
<div class="paragraph">
<p>Related information about general Solaris system administration topics
can be found in the following books:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Solaris System Administration: Basic Administration</p>
</li>
<li>
<p>Solaris System Administration: Advanced Administration</p>
</li>
<li>
<p>Solaris System Administration: Devices and File Systems</p>
</li>
<li>
<p>Solaris System Administration: Security Services</p>
</li>
<li>
<p>Solaris Volume Manager Administration Guide</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>=== Documentation, Support, and Training</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.sun.com/documentation/">Documentation</a></p>
</li>
<li>
<p><a href="http://www.sun.com/support/">Support</a></p>
</li>
<li>
<p><a href="http://www.sun.com/training/">Training</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>=== Typographic Conventions</p>
</div>
<div class="paragraph">
<p>The following table describes the typographic conventions that are used
in this book.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Typographic Conventions</caption>
<colgroup>
<col style="width: 21%;">
<col style="width: 45%;">
<col style="width: 34%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Typeface</th>
<th class="tableblock halign-left valign-top">Meaning</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AaBbCc123</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The names of commands, files, and directories, and
onscreen computer output</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Edit your <code>.login</code> file.</p>
</div>
<div class="paragraph">
<p>Use <code>lsa</code> to list all files.</p>
</div>
<div class="paragraph">
<p><code>machine_name% you have mail.</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AaBbCc123</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">What you type, contrasted with onscreen computer output</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>machine_name%</code> <code>su</code></p>
</div>
<div class="paragraph">
<p><code>Password:</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;aabbcc123&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Placeholder: replace with a real name or value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The command to remove a file is <code>rm</code> &lt;filename&gt;.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>AaBbCc123</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Book titles, new terms, and terms to be emphasized</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Read Chapter 6 in the User&#8217;s Guide.</p>
</div>
<div class="paragraph">
<p>A <em>cache</em> is a copy that is stored locally.</p>
</div>
<div class="paragraph">
<p>Do <em>not</em> save the file.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Some emphasized items appear bold online.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div id="shell-prompts-in-command-examples" class="paragraph">
<p>=== Shell Prompts in Command Examples</p>
</div>
<div class="paragraph">
<p>The following table shows the default UNIX system prompt and superuser
prompt for the C shell, Bourne shell, and Korn shell.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Shell Prompts</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Shell</th>
<th class="tableblock halign-left valign-top">Prompt</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C shell</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>machine_name%</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C shell for superuser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>machine_name#</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bourne shell and Korn shell</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>$</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bourne shell and Korn shell for superuser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>#</code></p></td>
</tr>
</tbody>
</table>
<div id="zfs-file-system-introduction" class="paragraph">
<p>== ZFS File System (Introduction)</p>
</div>
<div class="paragraph">
<p>This chapter provides an overview of the ZFS file system and its
features and benefits. This chapter also covers some basic terminology
used throughout the rest of this book.</p>
</div>
<div class="paragraph">
<p>The following sections are provided in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#whats-new-in-zfs">What&#8217;s New in ZFS?</a></p>
</li>
<li>
<p><a href="#what-is-zfs">What Is ZFS?</a></p>
</li>
<li>
<p><a href="#zfs-terminology">ZFS Terminology</a></p>
</li>
<li>
<p><a href="#zfs-component-naming-requirements">ZFS Component Naming Requirements</a></p>
</li>
</ul>
</div>
<div id="whats-new-in-zfs" class="paragraph">
<p>=== What&#8217;s New in ZFS?</p>
</div>
<div class="paragraph">
<p>This section summarizes new features in the ZFS file system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#using-cache-devices-in-your-zfs-storage-pool">Using Cache Devices in Your ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#enhancements-to-the-zfs-send-command">Enhancements to the Command</a></p>
</li>
<li>
<p><a href="#zfs-quotas-and-reservations-for-file-system-data-only">ZFS Quotas and Reservations for File System Data Only</a></p>
</li>
<li>
<p><a href="#zfs-file-system-properties-for-the-solaris-cifs-service">ZFS File System Properties for the Solaris CIFS Service</a></p>
</li>
<li>
<p><a href="#zfs-storage-pool-properties">ZFS Storage Pool Properties</a></p>
</li>
<li>
<p><a href="#zfs-and-file-system-mirror-mounts">ZFS and File System Mirror Mounts</a></p>
</li>
<li>
<p><a href="#zfs-command-history-enhancements-zpool-history">ZFS Command History Enhancements ()</a></p>
</li>
<li>
<p><a href="#upgrading-zfs-file-systems-zfs-upgrade">Upgrading ZFS File Systems ()</a></p>
</li>
<li>
<p><a href="#zfs-delegated-administration">ZFS Delegated Administration</a></p>
</li>
<li>
<p><a href="#setting-up-separate-zfs-logging-devices">Setting Up Separate ZFS Logging Devices</a></p>
</li>
<li>
<p><a href="#creating-intermediate-zfs-datasets">Creating Intermediate ZFS Datasets</a></p>
</li>
<li>
<p><a href="#zfs-hotplugging-enhancements">ZFS Hotplugging Enhancements</a></p>
</li>
<li>
<p><a href="#recursively-renaming-zfs-snapshots-zfs-rename-r">Recursively Renaming ZFS Snapshots ( )</a></p>
</li>
<li>
<p><a href="#gzip-compression-is-available-for-zfs">GZIP Compression is Available for ZFS</a></p>
</li>
<li>
<p><a href="#storing-multiple-copies-of-zfs-user-data">Storing Multiple Copies of ZFS User Data</a></p>
</li>
<li>
<p><a href="#improved-zpool-status-output">Improved Output</a></p>
</li>
<li>
<p><a href="#zfs-and-solaris-iscsi-improvements">ZFS and Solaris iSCSI Improvements</a></p>
</li>
<li>
<p><a href="#sharing-zfs-file-system-enhancements">Sharing ZFS File System Enhancements</a></p>
</li>
<li>
<p><a href="#zfs-command-history-zpool-history">ZFS Command History ()</a></p>
</li>
<li>
<p><a href="#zfs-property-improvements">ZFS Property Improvements</a></p>
</li>
<li>
<p><a href="#displaying-all-zfs-file-system-information">Displaying All ZFS File System Information</a></p>
</li>
<li>
<p><a href="#new-zfs-receive-f-option">New Option</a></p>
</li>
<li>
<p><a href="#recursive-zfs-snapshots">Recursive ZFS Snapshots</a></p>
</li>
<li>
<p><a href="#double-parity-raid-z-raidz2">Double Parity RAID-Z ()</a></p>
</li>
<li>
<p><a href="#hot-spares-for-zfs-storage-pool-devices">Hot Spares for ZFS Storage Pool Devices</a></p>
</li>
<li>
<p><a href="#replacing-a-zfs-file-system-with-a-zfs-clone-zfs-promote">Replacing a ZFS File System With a ZFS Clone ()</a></p>
</li>
<li>
<p><a href="#upgrading-zfs-storage-pools-zpool-upgrade">Upgrading ZFS Storage Pools ()</a></p>
</li>
<li>
<p><a href="#using-zfs-to-clone-non-global-zones-and-other-enhancements">Using ZFS to Clone Non-Global Zones and Other
Enhancements</a></p>
</li>
<li>
<p><a href="#zfs-backup-and-restore-commands-are-renamed">ZFS Backup and Restore Commands are Renamed</a></p>
</li>
<li>
<p><a href="#recovering-destroyed-storage-pools">Recovering Destroyed Storage Pools</a></p>
</li>
<li>
<p><a href="#zfs-is-integrated-with-fault-manager">ZFS is Integrated With Fault Manager</a></p>
</li>
<li>
<p><a href="#new-zpool-clear-command">New Command</a></p>
</li>
<li>
<p><a href="#compact-nfsv4-acl-format">Compact NFSv4 ACL Format</a></p>
</li>
<li>
<p><a href="#file-system-monitoring-tool-fsstat">File System Monitoring Tool ()</a></p>
</li>
<li>
<p><a href="#zfs-web-based-management">ZFS Web-Based Management</a></p>
</li>
</ul>
</div>
<div id="using-cache-devices-in-your-zfs-storage-pool" class="paragraph">
<p>==== Using Cache Devices in Your ZFS Storage Pool</p>
</div>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 1/08:</strong> In this Solaris release, you
can create pool and specify <em>cache devices</em>, which are used to cache
storage pool data.</p>
</div>
<div class="paragraph">
<p>Cache devices provide an additional layer of caching between main memory
and disk. Using cache devices provide the greatest performance
improvement for random read-workloads of mostly static content.</p>
</div>
<div class="paragraph">
<p>One or more cache devices can specified when the pool is created. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create pool mirror c0t2d0 c0t4d0 cache c0t0d0
# zpool status pool
  pool: pool
 state: ONLINE
 scrub: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        pool        ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c0t2d0  ONLINE       0     0     0
            c0t4d0  ONLINE       0     0     0
        cache
          c0t0d0    ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>After cache devices are added, they gradually fill with content from
main memory. Depending on the size of your cache device, it could take
over an hour for them to fill. Capacity and reads can be monitored by
using the <code>zpool iostat</code> command as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool iostat -v pool 5</pre>
</div>
</div>
<div class="paragraph">
<p>Cache devices can be added or removed from the pool after the pool is
created.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#creating-a-zfs-storage-pool-with-cache-devices">Creating a ZFS Storage Pool with
Cache Devices</a> and <a href="#gfxrx">example_title</a>.</p>
</div>
<div id="enhancements-to-the-zfs-send-command" class="paragraph">
<p>==== Enhancements to the <code>zfs send</code> Command</p>
</div>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 1/08:</strong> This release includes the
following enhancements to the <code>zfs send</code> command.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Send all incremental streams from one snapshot to a cumulative
snapshot. For example:</p>
<div class="literalblock">
<div class="content">
<pre># zfs list
NAME                      USED  AVAIL  REFER  MOUNTPOINT
pool                      428K  16.5G    20K  /pool
pool/fs                    71K  16.5G    21K  /pool/fs
pool/fs@snapA              16K      -  18.5K  -
pool/fs@snapB              17K      -    20K  -
pool/fs@snapC              17K      -  20.5K  -
pool/fs@snapD                0      -    21K  -
# zfs send -I pool/fs@snapA pool/fs@snapD &gt; /snaps/fs@combo</pre>
</div>
</div>
<div class="paragraph">
<p>Send all incremental snapshots between <code>fs@snapA</code> to <code>fs@snapD</code> to
<code>fs@combo</code>.</p>
</div>
</li>
<li>
<p>Send an incremental stream from the origin snapshot to create a clone.
The original snapshot must already exist on the receiving side to accept
the incremental stream. For example:</p>
<div class="literalblock">
<div class="content">
<pre># zfs send -I pool/fs@snap1 pool/clone@snapA &gt; /snaps/fsclonesnap-I
.
.
# zfs receive -F pool/clone &lt; /snaps/fsclonesnap-I</pre>
</div>
</div>
</li>
<li>
<p>Send a replication stream of all descendent file systems, up to the
named snapshots. When received, all properties, snapshots, descendent
file systems, and clones are preserved. For example:</p>
<div class="literalblock">
<div class="content">
<pre>zfs send -R pool/fs@snap &gt; snaps/fs-R</pre>
</div>
</div>
<div class="paragraph">
<p>For an extended example, see <a href="#gfxpm">example_title</a>.</p>
</div>
</li>
<li>
<p>Send an incremental replication stream.</p>
<div class="literalblock">
<div class="content">
<pre>zfs send -R -[iI] @snapA pool/fs@snapD</pre>
</div>
</div>
<div class="paragraph">
<p>For an extended example, see <a href="#gfxpm">example_title</a>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information, see <a href="#sending-and-receiving-complex-zfs-snapshot-streams">Sending and Receiving Complex ZFS
Snapshot Streams</a>.</p>
</div>
<div id="zfs-quotas-and-reservations-for-file-system-data-only" class="paragraph">
<p>==== ZFS Quotas and Reservations for File System Data Only</p>
</div>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 1/08:</strong> In addition to the existing
ZFS quota and reservation features, this release includes dataset quotas
and reservations that do not include descendents, such as snapshots and
clones, in the space consumption accounting.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The refquota property limits the amount of space a dataset can
consume. This property enforces a hard limit on the amount of space that
can be used. This hard limit does not include space used by descendents,
such as snapshots and clones.</p>
</li>
<li>
<p>The <code>refreservation</code> property sets the minimum amount of space that is
guaranteed to a dataset, not including its descendents.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, you can set a 10 Gbyte refquota for <code>studentA</code> that sets a
10-Gbyte hard limit of <em>referenced</em> space. For additional flexibility,
you can set a 20-Gbyte quota that allows you to manage `studentA&#8217;s
snapshots.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set refquota=10g tank/studentA
# zfs set quota=20g tank/studentA</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see <a href="#zfs-quotas-and-reservations">ZFS Quotas and Reservations</a>.</p>
</div>
<div id="zfs-file-system-properties-for-the-solaris-cifs-service" class="paragraph">
<p>==== ZFS File System Properties for the Solaris CIFS Service</p>
</div>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 1/08:</strong> This release provides support
for the Solaris Common Internet File System (CIFS) service. This product
provides the ability to share files between Solaris and Windows or MacOS
systems.</p>
</div>
<div class="paragraph">
<p>To facilitate sharing files between these systems by using the Solaris
CIFS service, the following new ZFS properties are provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Case sensitivity support (<code>casesensitivity</code>)</p>
</li>
<li>
<p>Non-blocking mandatory locks (<code>nbmand</code>)</p>
</li>
<li>
<p>SMB share support (<code>sharesmb</code>)</p>
</li>
<li>
<p>Unicode normalization support (<code>normalization</code>)</p>
</li>
<li>
<p>UTF-8 character set support (<code>utf8only</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Currently, the <code>sharesmb</code> property is available to share ZFS files in
the Solaris CIFS environment. More ZFS CIFS-related properties will be
available in an upcoming release. For information about using the
<code>sharesmb</code> property, see <a href="#sharing-zfs-files-in-a-solaris-cifs-environment">Sharing ZFS Files in a Solaris CIFS
Environment</a>.</p>
</div>
<div class="paragraph">
<p>In addition to the ZFS properties added for supporting the Solaris CIFS
software product, the <code>vscan</code> property is available for scanning ZFS
files if you have a 3rd-party virus scanning engine.</p>
</div>
<div id="zfs-storage-pool-properties" class="paragraph">
<p>==== ZFS Storage Pool Properties</p>
</div>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 1/08:</strong> ZFS storage pool properties
were introduced in an earlier release. This release provides for
additional property information. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool get all users
NAME   PROPERTY     VALUE       SOURCE
users  size         16.8G       -
users  used         217M        -
users  available    16.5G       -
users  capacity     1%          -
users  altroot      -           default
users  health       ONLINE      -
users  guid         11063207170669925585  -
users  version      8           default
users  bootfs       -           default
users  delegation   on          default
users  autoreplace  off         default
users  temporary    on          local</pre>
</div>
</div>
<div class="paragraph">
<p>For a description of these properties, see <a href="#gfiex">ZFS Pool Property
Descriptions</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>cachefile</code> property – <strong>Solaris Express Developer Edition 1/08:</strong>
This release provides the <code>cachefile</code> property, which controls where
pool configuration information is cached. All pools in the cache are
automatically imported when the system boots. However, installation and
clustering environments might need to cache this information in a
different location so that pools are not automatically imported.</p>
<div class="paragraph">
<p>You can set this property to cache pool configuration in a different
location that can be imported later by using the <code>zpool import</code> <code>c</code>
command. For most ZFS configurations, this property would not be used.</p>
</div>
<div class="paragraph">
<p>The <code>cachefile</code> property is not persistent and is not stored on disk.
This property replaces the <code>temporary</code> property that was used to
indicate that pool information should not be cached in previous Solaris
releases.</p>
</div>
</li>
<li>
<p>The <code>failmode</code> property – <strong>Solaris Express Developer Edition 1/08:</strong>
This release provides the <code>failmode</code> property for determining the
behavior of a catastrophic pool failure due to a loss of device
connectivity or the failure of all devices in the pool. The <code>failmode</code>
property can be set to these values: <code>wait</code>, <code>continue</code>, or <code>panic</code>. The
default value is <code>wait</code>, which means you must reconnect the device or
replace a failed device and clear the error with the <code>zpool clear</code>
command.</p>
<div class="paragraph">
<p>The <code>failmode</code> property is set like other settable ZFS properties, which
can be set either before or after the pool is created. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool set failmode=continue tank
# zpool get failmode tank
NAME  PROPERTY  VALUE     SOURCE
tank  failmode  continue  local</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create -o failmode=continue</pre>
</div>
</div>
<div class="paragraph">
<p>For a description of all ZFS pool properties, see <a href="#gfiex">ZFS Pool
Property Descriptions</a>.</p>
</div>
</li>
</ul>
</div>
<div id="zfs-and-file-system-mirror-mounts" class="paragraph">
<p>==== ZFS and File System Mirror Mounts</p>
</div>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 1/08:</strong> In this Solaris release, NFSv4
mount enhancements are provided to make ZFS file systems more accessible
to NFS clients.</p>
</div>
<div class="paragraph">
<p>When file systems are created on the NFS server, the NFS client can
automatically discover these newly created file systems within their
existing mount of a parent file system.</p>
</div>
<div class="paragraph">
<p>For example, if the server <code>neo</code> already shares the <code>tank</code> file system
and client <code>zee</code> has it mounted, <code>/tank/baz</code> is automatically visible on
the client after it is created on the server.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>zee# mount neo:/tank /mnt
zee# ls /mnt
baa    bar

neo# zfs create tank/baz

zee% ls /mnt
baa    bar    baz
zee% ls /mnt/baz
file1    file2</pre>
</div>
</div>
<div id="zfs-command-history-enhancements-zpool-history" class="paragraph">
<p>==== ZFS Command History Enhancements (<code>zpool history</code>)</p>
</div>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 9/07:</strong> The <code>zpool history</code> command
has been enhanced to provide the following new features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ZFS file system event information</p>
</li>
<li>
<p>A <code>l</code> option for displaying a long format that includes the user name,
the hostname, and the zone in which the operation was performed</p>
</li>
<li>
<p>A <code>i</code> option for displaying internal event information that can be
used for diagnostic purposes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the <code>zpool history</code> command provides both <code>zpool</code> command
events and <code>zfs</code> command events.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool history users
History for 'users':
2007-04-26.12:44:02 zpool create users mirror c0t8d0 c0t9d0 c0t10d0
2007-04-26.12:44:38 zfs create users/markm
2007-04-26.12:44:47 zfs create users/marks
2007-04-26.12:44:57 zfs create users/neil
2007-04-26.12:47:15 zfs snapshot -r users/home@yesterday
2007-04-26.12:54:50 zfs snapshot -r users/home@today
2007-04-26.13:29:13 zfs create users/snapshots
2007-04-26.13:30:00 zfs create -o compression=gzip users/snapshots
2007-04-26.13:31:24 zfs create -o compression=gzip-9 users/oldfiles
2007-04-26.13:31:47 zfs set copies=2 users/home
2007-06-25.14:22:52 zpool offline users c0t10d0
2007-06-25.14:52:42 zpool online users c0t10d0
2007-06-25.14:53:06 zpool upgrade users</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>zpool history</code> <code>i</code> option provides internal event information. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool history -i

.
.
.
2007-08-08.15:10:02 [internal create txg:348657] dataset = 83
2007-08-08.15:10:03 zfs create tank/mark
2007-08-08.15:27:41 [internal permission update txg:348869] ul$76928 create dataset = 5
2007-08-08.15:27:41 [internal permission update txg:348869] ul$76928 destroy dataset = 5
2007-08-08.15:27:41 [internal permission update txg:348869] ul$76928 mount dataset = 5
2007-08-08.15:27:41 [internal permission update txg:348869] ud$76928 create dataset = 5
2007-08-08.15:27:41 [internal permission update txg:348869] ud$76928 destroy dataset = 5
2007-08-08.15:27:41 [internal permission update txg:348869] ud$76928 mount dataset = 5
2007-08-08.15:27:41 zfs allow marks create,destroy,mount tank
2007-08-08.15:27:59 [internal permission update txg:348873] ud$76928 snapshot dataset = 5
2007-08-08.15:27:59 zfs allow -d marks snapshot tank</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>zpool history</code> <code>l</code> option provides a long format. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool history -l tank
History for 'tank':
2007-07-19.10:55:13 zpool create tank mirror c0t1d0 c0t11d0 [user root on neo:global]
2007-07-19.10:55:19 zfs create tank/cindys [user root on neo:global]
2007-07-19.10:55:49 zfs allow cindys create,destroy,mount,snapshot tank/cindys [user root on neo:global]
2007-07-19.10:56:24 zfs create tank/cindys/data [user cindys on neo:global]</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about using the <code>zpool history</code> command, see
<a href="#identifying-problems-in-zfs">Identifying Problems in ZFS</a>.</p>
</div>
<div id="upgrading-zfs-file-systems-zfs-upgrade" class="paragraph">
<p>==== Upgrading ZFS File Systems (<code>zfs upgrade</code>)</p>
</div>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 9/07:</strong> The <code>zfs upgrade</code> command is
included in this release to provide future ZFS file system enhancements
to existing file systems. ZFS storage pools have a similar upgrade
feature to provide pool enhancements to existing storage pools.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs upgrade
This system is currently running ZFS filesystem version 2.

The following filesystems are out of date, and can be upgraded.  After being
upgraded, these filesystems (and any 'zfs send' streams generated from
subsequent snapshots) will no longer be accessible by older software versions.

VER  FILESYSTEM
---  ------------
 1   datab
 1   datab/users
 1   datab/users/area51</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>File systems that are upgraded and any streams created from those
upgraded file systems by the <code>zfs send</code> command are not accessible on
systems that are running older software releases.</p>
</div>
<div class="paragraph">
<p>However, no new ZFS file system upgrade features are provided in this
release.</p>
</div>
<div class="sect3">
<h4 id="zfs-delegated-administration"><a class="anchor" href="#zfs-delegated-administration"></a>1.1. ZFS Delegated Administration</h4>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 9/07:</strong> In this release, you can
delegate fine-grained permissions to perform ZFS administration tasks to
non-privileged users.</p>
</div>
<div class="paragraph">
<p>You can use the <code>zfs allow</code> and <code>zfs unallow</code> commands to grant and
remove permissions.</p>
</div>
<div class="paragraph">
<p>You can modify the ability to use delegated administration with the
pool&#8217;s <code>delegation</code> property. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool get delegation users
NAME  PROPERTY    VALUE       SOURCE
users  delegation  on          default
# zpool set delegation=off users
# zpool get delegation users
NAME  PROPERTY    VALUE       SOURCE
users  delegation  off         local</pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>delegation</code> property is enabled.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#zfs-delegated-administration">ZFS Delegated Administration</a> and
<code>zfs(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="setting-up-separate-zfs-logging-devices"><a class="anchor" href="#setting-up-separate-zfs-logging-devices"></a>1.2. Setting Up Separate ZFS Logging Devices</h4>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 9/07:</strong> The ZFS intent log (ZIL) is
provided to satisfy POSIX requirements for synchronous transactions. For
example, databases often require their transactions to be on stable
storage devices when returning from a system call. NFS and other
applications can also use fsync() to ensure data stability. By default,
the ZIL is allocated from blocks within the main storage pool. However,
better performance might be possible by using separate intent log
devices in your ZFS storage pool, such as with NVRAM or a dedicated
disk.</p>
</div>
<div class="paragraph">
<p>Log devices for the ZFS intent log are not related to database log
files.</p>
</div>
<div class="paragraph">
<p>You can set up a ZFS logging device when the storage pool is created or
after the pool is created. For examples of setting up log devices, see
<a href="#creating-a-zfs-storage-pool-with-log-devices">Creating a ZFS Storage Pool with Log Devices</a> and
<a href="#adding-devices-to-a-storage-pool">Adding Devices to a Storage Pool</a>.</p>
</div>
<div class="paragraph">
<p>You can attach a log device to an existing log device to create a
mirrored log device. This operation is identical to attaching a device
in a unmirrored storage pool.</p>
</div>
<div class="paragraph">
<p>Consider the following points when determining whether setting up a ZFS
log device is appropriate for your environment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Any performance improvement seen by implementing a separate log device
depends on the device type, the hardware configuration of the pool, and
the application workload. For preliminary performance information, see
this blog:</p>
<div class="paragraph">
<p><a href="http://blogs.oracle.com/perrin/entry/slog_blog_or_blogging_on" class="bare">http://blogs.oracle.com/perrin/entry/slog_blog_or_blogging_on</a></p>
</div>
</li>
<li>
<p>Log devices can be unreplicated or mirrored, but RAIDZ is not
supported for log devices.</p>
</li>
<li>
<p>If a separate log device is not mirrored and the device that contains
the log fails, storing log blocks reverts to the storage pool.</p>
</li>
<li>
<p>Log devices can be added, replaced, attached, detached, and imported
and exported as part of the larger storage pool. Currently, log devices
cannot be removed.</p>
</li>
<li>
<p>The minimum size of a log device is the same as the minimum size of
device in pool, which is 64 Mbytes. The amount of in-play data that
might be stored on a log device is relatively small. Log blocks are
freed when the log transaction (system call) is committed.</p>
</li>
<li>
<p>The maximum size of a log device should be approximately 1/2 the size
of physical memory because that is the maximum amount of potential
in-play data that can be stored. For example, if a system has 16 Gbytes
of physical memory, consider a maximum log device size of 8 Gbytes.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-intermediate-zfs-datasets"><a class="anchor" href="#creating-intermediate-zfs-datasets"></a>1.3. Creating Intermediate ZFS Datasets</h4>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 9/07:</strong> You can use the <code>p</code> option
with the <code>zfs create</code>, <code>zfs clone</code>, and <code>zfs rename</code> commands to quickly
create a non-existent intermediate dataset, if it doesn&#8217;t already exist.</p>
</div>
<div class="paragraph">
<p>For example, create ZFS datasets (<code>users/area51</code>) in the <code>datab</code> storage
pool.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list
NAME                        USED  AVAIL  REFER  MOUNTPOINT
datab                       106K  16.5G    18K  /datab
# zfs create -p -o compression=on datab/users/area51</pre>
</div>
</div>
<div class="paragraph">
<p>If the intermediate dataset exists during the create operation, the
operation completes successfully.</p>
</div>
<div class="paragraph">
<p>Properties specified apply to the target dataset, not to the
intermediate datasets. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get mountpoint,compression datab/users/area51
NAME                PROPERTY     VALUE                SOURCE
datab/users/area51  mountpoint   /datab/users/area51  default
datab/users/area51  compression  on                   local</pre>
</div>
</div>
<div class="paragraph">
<p>The intermediate dataset is created with the default mount point. Any
additional properties are disabled for the intermediate dataset. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get mountpoint,compression datab/users
NAME         PROPERTY     VALUE         SOURCE
datab/users  mountpoint   /datab/users  default
datab/users  compression  off           default</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see <code>zfs(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-hotplugging-enhancements"><a class="anchor" href="#zfs-hotplugging-enhancements"></a>1.4. ZFS Hotplugging Enhancements</h4>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 9/07:</strong> In this release, ZFS more
effectively responds to devices that are removed and provides a
mechanism to automatically identify devices that are inserted with the
following enhancements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can replace an existing device with an equivalent device without
having to use the <code>zpool replace</code> command.</p>
<div class="paragraph">
<p>The <code>autoreplace</code> property controls automatic device replacement. If set
to off, device replacement must be initiated by the administrator by
using the <code>zpool replace</code> command. If set to on, any new device, found
in the same physical location as a device that previously belonged to
the pool, is automatically formatted and replaced. The default behavior
is off.</p>
</div>
</li>
<li>
<p>The storage pool state <code>REMOVED</code> is provided when a device or hot
spare has been removed if the device was physically removed while the
system was running. A hot-spare device is substituted for the removed
device, if available.</p>
</li>
<li>
<p>If a device is removed and then inserted, the device is placed online.
If a hot-spare was activated when the device is re-inserted, the spare
is removed when the online operation completes.</p>
</li>
<li>
<p>Automatic detection when devices are removed or inserted is
hardware-dependent and might not be supported on all platforms. For
example, USB devices are automatically configured upon inserted.
However, you might have to use the <code>cfgadm</code> <code>c configure</code> command to
configure a SATA drive.</p>
</li>
<li>
<p>Hot spares are checked periodically to make sure they are online and
available.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information, see <code>zpool(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="recursively-renaming-zfs-snapshots-zfs-rename-r"><a class="anchor" href="#recursively-renaming-zfs-snapshots-zfs-rename-r"></a>1.5. Recursively Renaming ZFS Snapshots (<code>zfs rename</code> <code>r</code>)</h4>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 5/07:</strong> You can recursively rename all
descendent ZFS snapshots by using the <code>zfs rename</code> <code>r</code> command.</p>
</div>
<div class="paragraph">
<p>For example, snapshot a set of ZFS file systems.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs snapshot -r users/home@today
# zfs list
NAME                     USED  AVAIL  REFER  MOUNTPOINT
users                    216K  16.5G    20K  /users
users/home                76K  16.5G    22K  /users/home
users/home@today            0      -    22K  -
users/home/markm          18K  16.5G    18K  /users/home/markm
users/home/markm@today      0      -    18K  -
users/home/marks          18K  16.5G    18K  /users/home/marks
users/home/marks@today      0      -    18K  -
users/home/neil           18K  16.5G    18K  /users/home/neil
users/home/neil@today       0      -    18K  -</pre>
</div>
</div>
<div class="paragraph">
<p>Then, rename the snapshots the following day.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs rename -r users/home@today @yesterday
# zfs list
NAME                         USED  AVAIL  REFER  MOUNTPOINT
users                        216K  16.5G    20K  /users
users/home                    76K  16.5G    22K  /users/home
users/home@yesterday            0      -    22K  -
users/home/markm              18K  16.5G    18K  /users/home/markm
users/home/markm@yesterday      0      -    18K  -
users/home/marks              18K  16.5G    18K  /users/home/marks
users/home/marks@yesterday      0      -    18K  -
users/home/neil               18K  16.5G    18K  /users/home/neil
users/home/neil@yesterday       0      -    18K  -</pre>
</div>
</div>
<div class="paragraph">
<p>Snapshots are the only dataset that can be renamed recursively. For more
information about snapshots, see <a href="#overview-of-zfs-snapshots">Overview of ZFS Snapshots</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="gzip-compression-is-available-for-zfs"><a class="anchor" href="#gzip-compression-is-available-for-zfs"></a>1.6. GZIP Compression is Available for ZFS</h4>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 5/07:</strong> In this Solaris release, you
can set <code>gzip</code> compression on ZFS file systems in addition to <code>lzjb</code>
compression. You can specify compression as <code>gzip</code>, the default, or
<code>gzip-</code>&lt;N&gt;, where &lt;N&gt; equals 1 through 9. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create -o compression=gzip users/home/snapshots
# zfs get compression users/home/snapshots
NAME                  PROPERTY     VALUE            SOURCE
users/home/snapshots  compression  gzip             local
# zfs create -o compression=gzip-9 users/home/oldfiles
# zfs get compression users/home/oldfiles
NAME                  PROPERTY     VALUE           SOURCE
users/home/oldfiles   compression  gzip-9          local</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about setting ZFS properties, see
<a href="#setting-zfs-properties">Setting ZFS Properties</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="storing-multiple-copies-of-zfs-user-data"><a class="anchor" href="#storing-multiple-copies-of-zfs-user-data"></a>1.7. Storing Multiple Copies of ZFS User Data</h4>
<div class="paragraph">
<p><strong>Solaris Express Developer Edition 5/07:</strong> As a reliability feature, ZFS
file system metadata is automatically stored multiple times across
different disks, if possible. This feature is known as <em>ditto blocks</em>.</p>
</div>
<div class="paragraph">
<p>In this Solaris release, you can specify that multiple copies of user
data is also stored per file system by using the <code>zfs set copies</code>
command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set copies=2 users/home
# zfs get copies users/home
NAME        PROPERTY  VALUE       SOURCE
users/home  copies    2           local</pre>
</div>
</div>
<div class="paragraph">
<p>Available values are 1, 2, or 3. The default value is 1. These copies
are in addition to any pool-level redundancy, such as in a mirrored or
RAID-Z configuration.</p>
</div>
<div class="paragraph">
<p>The benefits of storing multiple copies of ZFS user data are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Improves data retention by allowing recovery from unrecoverable block
read faults, such as media faults (bit rot) for all ZFS configurations.</p>
</li>
<li>
<p>Provides data protection even in the case where only a single disk is
available.</p>
</li>
<li>
<p>Allows you to select data protection policies on a per-file system
basis, beyond the capabilities of the storage pool.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Depending on the allocation of the ditto blocks in the storage pool,
multiple copies might be placed on a single disk. A subsequent full disk
failure might cause all ditto blocks to be unavailable.</p>
</div>
<div class="paragraph">
<p>You might consider using ditto blocks when you accidentally create a
non-redundant pool and when you need to set data retention policies.</p>
</div>
<div class="paragraph">
<p>For a detailed description of how setting copies on a system with a
single-disk pool or a multiple-disk pool might impact overall data
protection, see
<a href="https://blogs.oracle.com/relling/entry/zfs_copies_and_data_protection">this
blog entry</a>. For more information about setting ZFS properties, see
<a href="#setting-zfs-properties">Setting ZFS Properties</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="improved-zpool-status-output"><a class="anchor" href="#improved-zpool-status-output"></a>1.8. Improved <code>zpool status</code> Output</h4>
<div class="paragraph">
<p><strong>Solaris Express 1/07:</strong> You can use the <code>zpool status</code> <code>v</code> command to
display a list of files with persistent errors. Previously, you had to
use the <code>find</code> <code>inum</code> command to identify the filenames from the list of
displayed inodes.</p>
</div>
<div class="paragraph">
<p>For more information about displaying a list of files with persistent
errors, see <a href="#repairing-a-corrupted-file-or-directory">Repairing a Corrupted File or Directory</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-and-solaris-iscsi-improvements"><a class="anchor" href="#zfs-and-solaris-iscsi-improvements"></a>1.9. ZFS and Solaris iSCSI Improvements</h4>
<div class="paragraph">
<p><strong>Solaris Express, Developer Edition 2/07:</strong> In this Solaris release, you
can create a ZFS volume as a Solaris iSCSI target device by setting the
<code>shareiscsi</code> property on the ZFS volume. This method is a convenient way
to quickly set up a Solaris iSCSI target. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create -V 2g tank/volumes/v2
# zfs set shareiscsi=on tank/volumes/v2
# iscsitadm list target
Target: tank/volumes/v2
    iSCSI Name: iqn.1986-03.com.sun:02:984fe301-c412-ccc1-cc80-cf9a72aa062a
    Connections: 0</pre>
</div>
</div>
<div class="paragraph">
<p>After the iSCSI target is created, set up the iSCSI initiator. For
information about setting up a Solaris iSCSI initiator, see Chapter 14,
Configuring Solaris iSCSI Targets and Initiators (Tasks), in System
Administration Guide: Devices and File Systems.</p>
</div>
<div class="paragraph">
<p>For more information about managing a ZFS volume as an iSCSI target, see
<a href="#using-a-zfs-volume-as-a-solaris-iscsi-target">Using a ZFS Volume as a Solaris iSCSI Target</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sharing-zfs-file-system-enhancements"><a class="anchor" href="#sharing-zfs-file-system-enhancements"></a>1.10. Sharing ZFS File System Enhancements</h4>
<div class="paragraph">
<p><strong>Solaris Express, Developer Edition 2/07:</strong> In this Solaris release, the
process of sharing file systems has been improved. Although modifying
system configuration files, such as <code>/etc/dfs/dfstab</code>, is unnecessary
for sharing ZFS file systems, you can use the <code>sharemgr</code> command to
manage ZFS share properties. The <code>sharemgr</code> command enables you to set
and manage share properties on share groups. ZFS shares are
automatically designated in the <code>zfs</code> share group.</p>
</div>
<div class="paragraph">
<p>As in previous releases, you can set the ZFS <code>sharenfs</code> property on a
ZFS file system to share a ZFS file system. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set sharenfs=on tank/home</pre>
</div>
</div>
<div class="paragraph">
<p>Or, you can use the new <code>sharemgr</code> <code>add-share</code> subcommand to share a ZFS
file system in the <code>zfs</code> share group. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sharemgr add-share -s tank/data zfs
# sharemgr show -vp zfs
zfs nfs=()
    zfs/tank/data
          /tank/data
          /tank/data/1
          /tank/data/2
          /tank/data/3</pre>
</div>
</div>
<div class="paragraph">
<p>Then, you can use the <code>sharemgr</code> command to manage ZFS shares. The
following example shows how to use <code>sharemgr</code> to set the <code>nosuid</code>
property on the shared ZFS file systems. You must preface ZFS share
paths with <code>/zfs</code> designation.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sharemgr set -P nfs -p nosuid=true zfs/tank/data
# sharemgr show -vp zfs
zfs nfs=()
    zfs/tank/data nfs=(nosuid="true")
          /tank/data
          /tank/data/1
          /tank/data/2
          /tank/data/3</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see <code>sharemgr(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-command-history-zpool-history"><a class="anchor" href="#zfs-command-history-zpool-history"></a>1.11. ZFS Command History (<code>zpool history</code>)</h4>
<div class="paragraph">
<p><strong>Solaris Express 12/06:</strong> In this Solaris release, ZFS automatically logs
successful <code>zfs</code> and <code>zpool</code> commands that modify pool state
information. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool history
History for 'newpool':
2007-04-25.11:37:31 zpool create newpool mirror c0t8d0 c0t10d0
2007-04-25.11:37:46 zpool replace newpool c0t10d0 c0t9d0
2007-04-25.11:38:04 zpool attach newpool c0t9d0 c0t11d0
2007-04-25.11:38:09 zfs create newpool/user1
2007-04-25.11:38:15 zfs destroy newpool/user1

History for 'tank':
2007-04-25.11:46:28 zpool create tank mirror c1t0d0 c2t0d0 mirror c3t0d0 c4t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>This features enables you or Sun support personnel to identify the
<em>exact</em> set of ZFS commands that was executed to troubleshoot an error
scenario.</p>
</div>
<div class="paragraph">
<p>You can identify a specific storage pool with the <code>zpool history</code>
command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool history newpool
History for 'newpool':
History for 'newpool':
2007-04-25.11:37:31 zpool create newpool mirror c0t8d0 c0t10d0
2007-04-25.11:37:46 zpool replace newpool c0t10d0 c0t9d0
2007-04-25.11:38:04 zpool attach newpool c0t9d0 c0t11d0
2007-04-25.11:38:09 zfs create newpool/user1
2007-04-25.11:38:15 zfs destroy newpool/user1</pre>
</div>
</div>
<div class="paragraph">
<p>The features of the history log are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The log cannot be disabled.</p>
</li>
<li>
<p>The log is saved persistently on disk, which means the log is saved
across system reboots.</p>
</li>
<li>
<p>The log is implemented as a ring buffer. The minimum size is 128
Kbytes. The maximum size is 32 Mbytes.</p>
</li>
<li>
<p>For smaller pools, the maximum size is capped at 1% of the pool size,
where &lt;size&gt; is determined at pool creation time.</p>
</li>
<li>
<p>Requires no administration, which means tuning the size of the log or
changing the location of the log is unnecessary.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Currently, the <code>zpool history</code> command does not record
&lt;user-ID&gt;, &lt;hostname&gt;, or &lt;zone-name&gt;.</p>
</div>
<div class="paragraph">
<p>For more information about troubleshooting ZFS problems, see
<a href="#identifying-problems-in-zfs">Identifying Problems in ZFS</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-property-improvements"><a class="anchor" href="#zfs-property-improvements"></a>1.12. ZFS Property Improvements</h4>
<div class="sect4">
<h5 id="zfs-xattr-property"><a class="anchor" href="#zfs-xattr-property"></a>ZFS <code>xattr</code> Property</h5>
<div class="paragraph">
<p><strong>Solaris Express 1/07:</strong> You can use the <code>xattr</code> property to disable or
enable extended attributes for a specific ZFS file system. The default
value is on. For a description of ZFS properties, see
<a href="#introducing-zfs-properties">Introducing ZFS Properties</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="zfs-canmount-property"><a class="anchor" href="#zfs-canmount-property"></a>ZFS <code>canmount</code> Property</h5>
<div class="paragraph">
<p><strong>Solaris Express 10/06:</strong> The new <code>canmount</code> property allows you to
specify whether a dataset can be mounted by using the <code>zfs mount</code>
command. For more information, see <a href="#the-canmount-property">The Property</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="zfs-user-properties"><a class="anchor" href="#zfs-user-properties"></a>ZFS User Properties</h5>
<div class="paragraph">
<p><strong>Solaris Express 10/06:</strong> In addition to the standard native properties
that can either export internal statistics or control ZFS file system
behavior, ZFS supports user properties. User properties have no effect
on ZFS behavior, but you can use them to annotate datasets with
information that is meaningful in your environment.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#zfs-user-properties">ZFS User Properties</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="setting-properties-when-creating-zfs-file-systems"><a class="anchor" href="#setting-properties-when-creating-zfs-file-systems"></a>Setting Properties When Creating ZFS File Systems</h5>
<div class="paragraph">
<p><strong>Solaris Express 10/06:</strong> In this Solaris release, you can set properties
when you create a file system, in addition to setting properties after
the file system is created.</p>
</div>
<div class="paragraph">
<p>The following examples illustrate equivalent syntax:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create tank/home
# zfs set mountpoint=/export/zfs tank/home
# zfs set sharenfs=on tank/home
# zfs set compression=on tank/home</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create -o mountpoint=/export/zfs -o sharenfs=on -o compression=on tank/home</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="displaying-all-zfs-file-system-information"><a class="anchor" href="#displaying-all-zfs-file-system-information"></a>1.13. Displaying All ZFS File System Information</h4>
<div class="paragraph">
<p><strong>Solaris Express 10/06:</strong> In this Solaris release, you can use various
forms of the <code>zfs get</code> command to display information about all datasets
if you do not specify a dataset. In previous releases, all dataset
information was not retreivable with the <code>zfs get</code> command.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get -s local all
tank/home               atime          off                    local
tank/home/bonwick       atime          off                    local
tank/home/marks         quota          50G                    local</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="new-zfs-receive-f-option"><a class="anchor" href="#new-zfs-receive-f-option"></a>1.14. New <code>zfs receive</code> <code>F</code> Option</h4>
<div class="paragraph">
<p><strong>Solaris Express 10/06:</strong> In this Solaris release, you can use the new
<code>F</code> option to the <code>zfs receive</code> command to force a rollback of the file
system to the most recent snapshot before doing the receive. Using this
option might be necessary when the file system is modified between the
time a rollback occurs and the receive is initiated.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#restoring-a-zfs-snapshot">Restoring a ZFS Snapshot</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="recursive-zfs-snapshots"><a class="anchor" href="#recursive-zfs-snapshots"></a>1.15. Recursive ZFS Snapshots</h4>
<div class="paragraph">
<p><strong>Solaris Express 8/06:</strong> When you use the <code>zfs snapshot</code> command to
create a file system snapshot, you can use the <code>r</code> option to recursively
create snapshots for all descendent file systems. In addition, using the
<code>r</code> option recursively destroys all descendent snapshots when a snapshot
is destroyed.</p>
</div>
<div class="paragraph">
<p>Recursive ZFS snapshots are created quickly as one atomic operation. The
snapshots are created together (all at once) or not created at all. The
benefit of atomic snapshots operations is that the snapshot data is
always taken at one consistent time, even across descendent file
systems.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#creating-and-destroying-zfs-snapshots">Creating and Destroying ZFS
Snapshots</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="double-parity-raid-z-raidz2"><a class="anchor" href="#double-parity-raid-z-raidz2"></a>1.16. Double Parity RAID-Z (<code>raidz2</code>)</h4>
<div class="paragraph">
<p><strong>Solaris Express 7/06:</strong> A redundant RAID-Z configuration can now have
either single- or double-parity, which means that one or two device
failures can be sustained respectively, without any data loss. You can
specify the <code>raidz2</code> keyword for a double-parity RAID-Z configuration.
Or, you can specify the <code>raidz</code> or <code>raidz1</code> keyword for a single-parity
RAID-Z configuration.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#creating-raid-z-storage-pools">Creating RAID-Z Storage Pools</a> or
<code>zpool(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="hot-spares-for-zfs-storage-pool-devices"><a class="anchor" href="#hot-spares-for-zfs-storage-pool-devices"></a>1.17. Hot Spares for ZFS Storage Pool Devices</h4>
<div class="paragraph">
<p><strong>Solaris Express 7/06:</strong> The ZFS hot spares feature enables you to
identify disks that could be used to replace a failed or faulted device
in one or more storage pools. Designating a device as a <em>hot spare</em>
means that if an active device in the pool fails, the hot spare
automatically replaces the failed device. Or, you can manually replace a
device in a storage pool with a hot spare.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#designating-hot-spares-in-your-storage-pool">Designating Hot Spares in Your
Storage Pool</a> and <code>zpool(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="replacing-a-zfs-file-system-with-a-zfs-clone-zfs-promote"><a class="anchor" href="#replacing-a-zfs-file-system-with-a-zfs-clone-zfs-promote"></a>1.18. Replacing a ZFS File System With a ZFS Clone (<code>zfs promote</code>)</h4>
<div class="paragraph">
<p><strong>Solaris Express 7/06:</strong> The <code>zfs promote</code> command enables you to replace
an existing ZFS file system with a clone of that file system. This
feature is helpful when you want to run tests on an alternative version
of a file system and then, make that alternative version of the file
system the active file system.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#replacing-a-zfs-file-system-with-a-zfs-clone">Replacing a ZFS File System With a
ZFS Clone</a> and <code>zfs(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="upgrading-zfs-storage-pools-zpool-upgrade"><a class="anchor" href="#upgrading-zfs-storage-pools-zpool-upgrade"></a>1.19. Upgrading ZFS Storage Pools (<code>zpool upgrade</code>)</h4>
<div class="paragraph">
<p><strong>Solaris Express 6/06:</strong> You can upgrade your storage pools to a newer
version to take advantage of the latest features by using the
<code>zpool upgrade</code> command. In addition, the <code>zpool status</code> command has
been modified to notify you when your pools are running older versions.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#upgrading-zfs-storage-pools">Upgrading ZFS Storage Pools</a> and
<code>zpool(8)</code>.</p>
</div>
<div class="paragraph">
<p>If you want to use the ZFS Administration console on a system with a
pool from a previous Solaris release, make sure you upgrade your pools
before using the ZFS Administration console. To see if your pools need
to be upgraded, use the <code>zpool status</code> command. For information about
the ZFS Administration console, see <a href="#zfs-web-based-management">ZFS Web-Based
Management</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-zfs-to-clone-non-global-zones-and-other-enhancements"><a class="anchor" href="#using-zfs-to-clone-non-global-zones-and-other-enhancements"></a>1.20. Using ZFS to Clone Non-Global Zones and Other Enhancements</h4>
<div class="paragraph">
<p><strong>Solaris Express 6/06:</strong> When the source <code>zonepath</code> and the target
<code>zonepath</code> both reside on ZFS and are in the same pool, <code>zoneadm clone</code>
now automatically uses the ZFS clone feature to clone a zone. This
enhancement means that <code>zoneadm clone</code> will take a ZFS snapshot of the
source <code>zonepath</code> and set up the target <code>zonepath</code>. The snapshot is
named <code>SUNWzoneX</code>, where <code>X</code> is a unique ID used to distinguish between
multiple snapshots. The destination zone&#8217;s <code>zonepath</code> is used to name
the ZFS clone. A software inventory is performed so that a snapshot used
at a future time can be validated by the system. Note that you can still
specify that the ZFS <code>zonepath</code> be copied instead of the ZFS clone, if
desired.</p>
</div>
<div class="paragraph">
<p>To clone a source zone multiple times, a new parameter added to
<code>zoneadm</code> allows you to specify that an existing snapshot should be
used. The system validates that the existing snapshot is usable on the
target. Additionally, the zone install process now has the capability to
detect when a ZFS file system can be created for a zone, and the
uninstall process can detect when a ZFS file system in a zone can be
destroyed. These steps are then performed automatically by the <code>zoneadm</code>
command.</p>
</div>
<div class="paragraph">
<p>Keep the following points in mind when using ZFS on a system with
containers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do not use the ZFS snapshot features to clone a zone</p>
</li>
<li>
<p>You can delegate or a add a ZFS file system to a non-global zone. For
more information, see <a href="#adding-zfs-file-systems-to-a-non-global-zone">Adding ZFS File Systems to a
Non-Global Zone</a> or <a href="#delegating-datasets-to-a-non-global-zone">Delegating Datasets to a Non-Global
Zone</a>.</p>
</li>
<li>
<p>Do not use a ZFS file system for a global zone root path or a
non-global zone root path in the Solaris 10 releases. You can use ZFS as
a zone root path in the Solaris Express releases, but keep in mind that
patching or upgrading these zones is not supported.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information, see System Administration Guide: Virtualization
Using the Solaris Operating System.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-backup-and-restore-commands-are-renamed"><a class="anchor" href="#zfs-backup-and-restore-commands-are-renamed"></a>1.21. ZFS Backup and Restore Commands are Renamed</h4>
<div class="paragraph">
<p><strong>Solaris Express 5/06:</strong> In this Solaris release, the <code>zfs backup</code> and
<code>zfs restore</code> commands are renamed to <code>zfs send</code> and <code>zfs receive</code> to
more accurately describe their function. The function of these commands
is to save and restore ZFS data stream representations.</p>
</div>
<div class="paragraph">
<p>For more information about these commands, see <a href="#saving-and-restoring-zfs-data">Saving and
Restoring ZFS Data</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="recovering-destroyed-storage-pools"><a class="anchor" href="#recovering-destroyed-storage-pools"></a>1.22. Recovering Destroyed Storage Pools</h4>
<div class="paragraph">
<p><strong>Solaris Express 5/06:</strong> This release includes the <code>zpool import</code> <code>D</code>
command, which enables you to recover pools that were previously
destroyed with the <code>zpool destroy</code> command.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#recovering-destroyed-zfs-storage-pools">Recovering Destroyed ZFS Storage
Pools</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-is-integrated-with-fault-manager"><a class="anchor" href="#zfs-is-integrated-with-fault-manager"></a>1.23. ZFS is Integrated With Fault Manager</h4>
<div class="paragraph">
<p><strong>Solaris Express 4/06:</strong> This release includes the integration of a ZFS
diagnostic engine that is capable of diagnosing and reporting pool
failures and device failures. Checksum, I/O, device, and pool errors
associated with pool or device failures are also reported.</p>
</div>
<div class="paragraph">
<p>The diagnostic engine does not include predictive analysis of checksum
and I/O errors, nor does it include proactive actions based on fault
analysis.</p>
</div>
<div class="paragraph">
<p>In the event of the ZFS failure, you might see a message similar to the
following from <code>fmd</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SUNW-MSG-ID: ZFS-8000-D3, TYPE: Fault, VER: 1, SEVERITY: Major
EVENT-TIME: Fri Mar 10 11:09:06 MST 2006
PLATFORM: SUNW,Ultra-60, CSN: -, HOSTNAME: neo
SOURCE: zfs-diagnosis, REV: 1.0
EVENT-ID: b55ee13b-cd74-4dff-8aff-ad575c372ef8
DESC: A ZFS device failed.  Refer to http://illumos.org/msg/ZFS-8000-D3 for more information.
AUTO-RESPONSE: No automated response will occur.
IMPACT: Fault tolerance of the pool may be compromised.
REC-ACTION: Run 'zpool status -x' and replace the bad device.</pre>
</div>
</div>
<div class="paragraph">
<p>By reviewing the recommended action, which will be to follow the more
specific directions in the <code>zpool status</code> command, you will be able to
quickly identify and resolve the failure.</p>
</div>
<div class="paragraph">
<p>For an example of recovering from a reported ZFS problem, see
<a href="#repairing-a-missing-device">Repairing a Missing Device</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="new-zpool-clear-command"><a class="anchor" href="#new-zpool-clear-command"></a>1.24. New <code>zpool clear</code> Command</h4>
<div class="paragraph">
<p><strong>Solaris Express 4/06:</strong> This release includes the <code>zpool clear</code> command
for clearing error counts associated with a device or the pool.
Previously, error counts were cleared when a device in a pool was
brought online with the <code>zpool online</code> command. For more information,
see <code>zpool(8)</code> and <a href="#clearing-storage-pool-devices">Clearing Storage Pool Devices</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="compact-nfsv4-acl-format"><a class="anchor" href="#compact-nfsv4-acl-format"></a>1.25. Compact NFSv4 ACL Format</h4>
<div class="paragraph">
<p><strong>Solaris Express 4/06:</strong> In this release, three NFSv4 ACL formats are
available: verbose, positional, and compact. The new compact and
positional ACL formats are available to set and display ACLs. You can
use the <code>chmod</code> command to set all 3 ACL formats. You can use the <code>ls</code>
<code>V</code> command to display compact and positional ACL formats and the <code>ls</code>
<code>v</code> command to display verbose ACL formats.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#setting-and-displaying-acls-on-zfs-files-in-compact-format">Setting and Displaying ACLs on ZFS
Files in Compact Format</a>, <code>chmod(1)</code>, and <code>ls(1)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="file-system-monitoring-tool-fsstat"><a class="anchor" href="#file-system-monitoring-tool-fsstat"></a>1.26. File System Monitoring Tool (<code>fsstat</code>)</h4>
<div class="paragraph">
<p><strong>Solaris Express 4/06:</strong> A new file system monitoring tool, <code>fsstat</code>, is
available to report file system operations. Activity can be reported by
mount point or by file system type. The following example shows general
ZFS file system activity.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ fsstat zfs
 new  name   name  attr  attr lookup rddir  read read  write write
 file remov  chng   get   set    ops   ops   ops bytes   ops bytes
7.82M 5.92M 2.76M 1.02G 3.32M  5.60G 87.0M  363M 1.86T 20.9M  251G zfs</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see <code>fsstat(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-web-based-management"><a class="anchor" href="#zfs-web-based-management"></a>1.27. ZFS Web-Based Management</h4>
<div class="paragraph">
<p><strong>Solaris Express 1/06:</strong> A web-based ZFS management tool is available to
perform many administrative actions. With this tool, you can perform the
following tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a new storage pool.</p>
</li>
<li>
<p>Add capacity to an existing pool.</p>
</li>
<li>
<p>Move (export) a storage pool to another system.</p>
</li>
<li>
<p>Import a previously exported storage pool to make it available on
another system.</p>
</li>
<li>
<p>View information about storage pools.</p>
</li>
<li>
<p>Create a file system.</p>
</li>
<li>
<p>Create a volume.</p>
</li>
<li>
<p>Take a snapshot of a file system or a volume.</p>
</li>
<li>
<p>Roll back a file system to a previous snapshot.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can access the ZFS Administration console through a secure web
browser at the following URL:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>https://system-name:6789/zfs</pre>
</div>
</div>
<div class="paragraph">
<p>If you type the appropriate URL and are unable to reach the ZFS
Administration console, the server might not be started. To start the
server, run the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># /usr/sbin/smcwebserver start</pre>
</div>
</div>
<div class="paragraph">
<p>If you want the server to run automatically when the system boots, run
the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># /usr/sbin/smcwebserver enable</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot use the Solaris Management Console (<code>smc</code>) to manage ZFS
storage pools or file systems.</p>
</div>
<div class="paragraph">
<p>You will not be able to manage ZFS file systems remotely with the ZFS
Administration console because of a change in a recent Solaris release,
which shutdown some network services automatically. Use the following
command to enable these services:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># netservices open</pre>
</div>
</div>
<div id="what-is-zfs" class="paragraph">
<p>=== What Is ZFS?</p>
</div>
<div class="paragraph">
<p>The ZFS file system is a revolutionary new file system that
fundamentally changes the way file systems are administered, with
features and benefits not found in any other file system available
today. ZFS has been designed to be robust, scalable, and simple to
administer.</p>
</div>
<div id="zfs-pooled-storage" class="paragraph">
<p>==== ZFS Pooled Storage</p>
</div>
<div class="paragraph">
<p>ZFS uses the concept of <em>storage pools</em> to manage physical storage.
Historically, file systems were constructed on top of a single physical
device. To address multiple devices and provide for data redundancy, the
concept of a <em>volume manager</em> was introduced to provide the image of a
single device so that file systems would not have to be modified to take
advantage of multiple devices. This design added another layer of
complexity and ultimately prevented certain file system advances,
because the file system had no control over the physical placement of
data on the virtualized volumes.</p>
</div>
<div class="paragraph">
<p>ZFS eliminates the volume management altogether. Instead of forcing you
to create virtualized volumes, ZFS aggregates devices into a storage
pool. The storage pool describes the physical characteristics of the
storage (device layout, data redundancy, and so on,) and acts as an
arbitrary data store from which file systems can be created. File
systems are no longer constrained to individual devices, allowing them
to share space with all file systems in the pool. You no longer need to
predetermine the size of a file system, as file systems grow
automatically within the space allocated to the storage pool. When new
storage is added, all file systems within the pool can immediately use
the additional space without additional work. In many ways, the storage
pool acts as a virtual memory system. When a memory DIMM is added to a
system, the operating system doesn&#8217;t force you to invoke some commands
to configure the memory and assign it to individual processes. All
processes on the system automatically use the additional memory.</p>
</div>
<div id="transactional-semantics" class="paragraph">
<p>==== Transactional Semantics</p>
</div>
<div class="paragraph">
<p>ZFS is a transactional file system, which means that the file system
state is always consistent on disk. Traditional file systems overwrite
data in place, which means that if the machine loses power, for example,
between the time a data block is allocated and when it is linked into a
directory, the file system will be left in an inconsistent state.
Historically, this problem was solved through the use of the <code>fsck</code>
command. This command was responsible for going through and verifying
file system state, making an attempt to repair any inconsistencies in
the process. This problem caused great pain to administrators and was
never guaranteed to fix all possible problems. More recently, file
systems have introduced the concept of <em>journaling</em>. The journaling
process records action in a separate journal, which can then be replayed
safely if a system crash occurs. This process introduces unnecessary
overhead, because the data needs to be written twice, and often results
in a new set of problems, such as when the journal can&#8217;t be replayed
properly.</p>
</div>
<div class="paragraph">
<p>With a transactional file system, data is managed using <em>copy on write</em>
semantics. Data is never overwritten, and any sequence of operations is
either entirely committed or entirely ignored. This mechanism means that
the file system can never be corrupted through accidental loss of power
or a system crash. So, no need for a <code>fsck</code> equivalent exists. While the
most recently written pieces of data might be lost, the file system
itself will always be consistent. In addition, synchronous data (written
using the <code>O_DSYNC</code> flag) is always guaranteed to be written before
returning, so it is never lost.</p>
</div>
<div id="checksums-and-self-healing-data" class="paragraph">
<p>==== Checksums and Self-Healing Data</p>
</div>
<div class="paragraph">
<p>With ZFS, all data and metadata is checksummed using a user-selectable
algorithm. Traditional file systems that do provide checksumming have
performed it on a per-block basis, out of necessity due to the volume
management layer and traditional file system design. The traditional
design means that certain failure modes, such as writing a complete
block to an incorrect location, can result in properly checksummed data
that is actually incorrect. ZFS checksums are stored in a way such that
these failure modes are detected and can be recovered from gracefully.
All checksumming and data recovery is done at the file system layer, and
is transparent to applications.</p>
</div>
<div class="paragraph">
<p>In addition, ZFS provides for self-healing data. ZFS supports storage
pools with varying levels of data redundancy, including mirroring and a
variation on RAID-5. When a bad data block is detected, ZFS fetches the
correct data from another redundant copy, and repairs the bad data,
replacing it with the good copy.</p>
</div>
<div id="unparalleled-scalability" class="paragraph">
<p>==== Unparalleled Scalability</p>
</div>
<div class="paragraph">
<p>ZFS has been designed from the ground up to be the most scalable file
system, ever. The file system itself is 128-bit, allowing for 256
quadrillion zettabytes of storage. All metadata is allocated
dynamically, so no need exists to pre-allocate inodes or otherwise limit
the scalability of the file system when it is first created. All the
algorithms have been written with scalability in mind. Directories can
have up to 2<sup>48</sup> (256 trillion) entries, and no limit exists on the
number of file systems or number of files that can be contained within a
file system.</p>
</div>
<div id="zfs-snapshots" class="paragraph">
<p>==== ZFS Snapshots</p>
</div>
<div class="paragraph">
<p>A <em>snapshot</em> is a read-only copy of a file system or volume. Snapshots
can be created quickly and easily. Initially, snapshots consume no
additional space within the pool.</p>
</div>
<div class="paragraph">
<p>As data within the active dataset changes, the snapshot consumes space
by continuing to reference the old data. As a result, the snapshot
prevents the data from being freed back to the pool.</p>
</div>
<div id="simplified-administration" class="paragraph">
<p>==== Simplified Administration</p>
</div>
<div class="paragraph">
<p>Most importantly, ZFS provides a greatly simplified administration
model. Through the use of hierarchical file system layout, property
inheritance, and automanagement of mount points and NFS share semantics,
ZFS makes it easy to create and manage file systems without needing
multiple commands or editing configuration files. You can easily set
quotas or reservations, turn compression on or off, or manage mount
points for numerous file systems with a single command. Devices can be
examined or repaired without having to understand a separate set of
volume manager commands. You can take an unlimited number of
instantaneous snapshots of file systems. You can backup and restore
individual file systems.</p>
</div>
<div class="paragraph">
<p>ZFS manages file systems through a hierarchy that allows for this
simplified management of properties such as quotas, reservations,
compression, and mount points. In this model, file systems become the
central point of control. File systems themselves are very cheap
(equivalent to a new directory), so you are encouraged to create a file
system for each user, project, workspace, and so on. This design allows
you to define fine-grained management points.</p>
</div>
<div id="zfs-terminology" class="paragraph">
<p>=== ZFS Terminology</p>
</div>
<div class="paragraph">
<p>This section describes the basic terminology used throughout this book:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">checksum</dt>
<dd>
<p>A 256-bit hash of the data in a file system block. The checksum
capability can range from the simple and fast fletcher2 (the default)
to cryptographically strong hashes such as SHA256.</p>
</dd>
<dt class="hdlist1">clone</dt>
<dd>
<p>A file system whose initial contents are identical to the contents of
a snapshot.
+
For information about clones, see <a href="#overview-of-zfs-clones">Overview of ZFS Clones</a>.</p>
</dd>
<dt class="hdlist1">dataset</dt>
<dd>
<p>A generic name for the following ZFS entities: clones, file systems,
snapshots, or volumes.
+
Each dataset is identified by a unique name in the ZFS namespace.
Datasets are identified using the following format:
+
&lt;pool&gt;/&lt;path&gt;[&lt;@snapshot&gt;]
+</p>
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;pool&gt;</dt>
<dd>
<p>Identifies the name of the storage pool that contains the dataset</p>
</dd>
<dt class="hdlist1">&lt;path&gt;</dt>
<dd>
<p>Is a slash-delimited path name for the dataset object</p>
</dd>
<dt class="hdlist1">&lt;snapshot&gt;</dt>
<dd>
<p>  Is an optional component that identifies a snapshot of a dataset
+
For more information about datasets, see <a href="#managing-zfs-file-systems">Managing ZFS File
Systems</a>.</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">file system</dt>
<dd>
<p>A dataset that contains a standard POSIX file system.
+
For more information about file systems, see <a href="#managing-zfs-file-systems">Managing ZFS
File Systems</a>.</p>
</dd>
<dt class="hdlist1">mirror</dt>
<dd>
<p>A virtual device that stores identical copies of data on two or more
disks. If any disk in a mirror fails, any other disk in that mirror
can provide the same data.</p>
</dd>
<dt class="hdlist1">pool</dt>
<dd>
<p>A logical group of devices describing the layout and physical
characteristics of the available storage. Space for datasets is
allocated from a pool.
+
For more information about storage pools, see <a href="#managing-zfs-storage-pools">Managing ZFS
Storage Pools</a>.</p>
</dd>
<dt class="hdlist1">RAID-Z</dt>
<dd>
<p>A virtual device that stores data and parity on multiple disks,
similar to RAID-5. For more information about RAID-Z, see
<a href="#raid-z-storage-pool-configuration">RAID-Z Storage Pool Configuration</a>.</p>
</dd>
<dt class="hdlist1">resilvering</dt>
<dd>
<p>The process of transferring data from one device to another device is
known as <em>resilvering</em>. For example, if a mirror component is replaced
or taken offline, the data from the up-to-date mirror component is
copied to the newly restored mirror component. This process is
referred to as <em>mirror resynchronization</em> in traditional volume
management products.
+
For more information about ZFS resilvering, see <a href="#viewing-resilvering-status">Viewing
Resilvering Status</a>.</p>
</dd>
<dt class="hdlist1">snapshot</dt>
<dd>
<p>A read-only image of a file system or volume at a given point in time.
+
For more information about snapshots, see <a href="#overview-of-zfs-snapshots">Overview of ZFS
Snapshots</a>.</p>
</dd>
<dt class="hdlist1">virtual device</dt>
<dd>
<p>A logical device in a pool, which can be a physical device, a file, or
a collection of devices.
+
For more information about virtual devices, see
<a href="#identifying-virtual-devices-in-a-storage-pool">Identifying Virtual Devices in a Storage Pool</a>.</p>
</dd>
<dt class="hdlist1">volume</dt>
<dd>
<p>A dataset used to emulate a physical device. For example, you can
create an ZFS volume as a swap device.
+
For more information about ZFS volumes, see <a href="#zfs-volumes">ZFS Volumes</a>.</p>
</dd>
</dl>
</div>
<div id="zfs-component-naming-requirements" class="paragraph">
<p>=== ZFS Component Naming Requirements</p>
</div>
<div class="paragraph">
<p>Each ZFS component must be named according to the following rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Empty components are not allowed.</p>
</li>
<li>
<p>Each component can only contain alphanumeric characters in addition to
the following four special characters:</p>
<div class="ulist">
<ul>
<li>
<p>Underscore (_)</p>
</li>
<li>
<p>Hyphen (-)</p>
</li>
<li>
<p>Colon (:)</p>
</li>
<li>
<p>Period (.)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Pool names must begin with a letter, except for the following
restrictions:</p>
<div class="ulist">
<ul>
<li>
<p>The beginning sequence <code>c</code>[<code>0-9</code>] is not allowed</p>
</li>
<li>
<p>The name <code>log</code> is reserved</p>
</li>
<li>
<p>A name that begins with <code>mirror</code>, <code>raidz</code>, or <code>spare</code> is not allowed
because these name are reserved.</p>
<div class="paragraph">
<p>In addition, pool names must not contain a percent sign (<code>%</code>)</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Dataset names must begin with an alphanumeric character. Dataset names
must not contain a percent sign (<code>%</code>).</p>
</li>
</ul>
</div>
<div id="getting-started-with-zfs" class="paragraph">
<p>== Getting Started With ZFS</p>
</div>
<div class="paragraph">
<p>This chapter provides step-by-step instructions on setting up simple ZFS
configurations. By the end of this chapter, you should have a basic idea
of how the ZFS commands work, and should be able to create simple pools
and file systems. This chapter is not designed to be a comprehensive
overview and refers to later chapters for more detailed information.</p>
</div>
<div class="paragraph">
<p>The following sections are provided in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#zfs-hardware-and-software-requirements-and-recommendations">ZFS Hardware and Software Requirements and
Recommendations</a></p>
</li>
<li>
<p><a href="#creating-a-basic-zfs-file-system">Creating a Basic ZFS File System</a></p>
</li>
<li>
<p><a href="#creating-a-zfs-storage-pool">Creating a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#creating-a-zfs-file-system-hierarchy">Creating a ZFS File System Hierarchy</a></p>
</li>
</ul>
</div>
<div id="zfs-hardware-and-software-requirements-and-recommendations" class="paragraph">
<p>=== ZFS Hardware and Software Requirements and Recommendations</p>
</div>
<div class="paragraph">
<p>Make sure you review the following hardware and software requirements
and recommendations before attempting to use the ZFS software:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A SPARC or x86 system that is running the Solaris Nevada release,
build 27 or later.</p>
</li>
<li>
<p>The minimum disk size is 128 Mbytes. The minimum amount of disk space
required for a storage pool is approximately 64 Mbytes.</p>
</li>
<li>
<p>Currently, the minimum amount of memory recommended to install a
Solaris system is 512 Mbytes. However, for good ZFS performance, at
least one Gbyte or more of memory is recommended.</p>
</li>
<li>
<p>If you create a mirrored disk configuration, multiple controllers are
recommended.</p>
</li>
</ul>
</div>
<div id="creating-a-basic-zfs-file-system" class="paragraph">
<p>=== Creating a Basic ZFS File System</p>
</div>
<div class="paragraph">
<p>ZFS administration has been designed with simplicity in mind. Among the
goals of the ZFS design is to reduce the number of commands needed to
create a usable file system. When you create a new pool, a new ZFS file
system is created and mounted automatically.</p>
</div>
<div class="paragraph">
<p>The following example illustrates how to create a non-redundant storage
pool named <code>tank</code> and a ZFS file system name <code>tank</code> in one command.
Assume that the whole disk <code>/dev/dsk/c1t0d0</code> is available for use.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank c1t0d0</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This command creates a non-redundant pool. A non-redundant pool
configuration is not recommended for production environments even if the
single storage object is presented from a hardware RAID array or from a
software volume manager. ZFS can only detect errors in these
configurations. ZFS can corrects error in pool configurations with
redundant data. For more information, about redundant ZFS pool
configurations, see <a href="#replication-features-of-a-zfs-storage-pool">Replication Features of a ZFS Storage
Pool</a>.</p>
</div>
<div class="paragraph">
<p>The new ZFS file system, <code>tank</code>, can use as much of the disk space on
<code>c1t0d0</code> as needed, and is automatically mounted at <code>/tank</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkfile 100m /tank/foo
# df -h /tank
Filesystem             size   used  avail capacity  Mounted on
tank                   80G   100M    80G     1%    /tank</pre>
</div>
</div>
<div class="paragraph">
<p>Within a pool, you will probably want to create additional file systems.
File systems provide points of administration that allow you to manage
different sets of data within the same pool.</p>
</div>
<div class="paragraph">
<p>The following example illustrates how to create a file system named <code>fs</code>
in the storage pool <code>tank</code>. Assume that the whole disk <code>/dev/dsk/c1t0d0</code>
is available for use.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank mirror c1t0d0 c2t0d0
# zfs create tank/fs</pre>
</div>
</div>
<div class="paragraph">
<p>The new ZFS file system, <code>tank/fs</code>, can use as much of the disk space on
<code>c1t0d0</code> as needed, and is automatically mounted at <code>/tank/fs</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkfile 100m /tank/fs/foo
# df -h /tank/fs
Filesystem             size   used  avail capacity  Mounted on
tank/fs                 80G   100M    80G     1%    /tank/fs</pre>
</div>
</div>
<div class="paragraph">
<p>In most cases, you will probably want to create and organize a hierarchy
of file systems that matches your organizational needs. For more
information about creating a hierarchy of ZFS file systems, see
<a href="#creating-a-zfs-file-system-hierarchy">Creating a ZFS File System Hierarchy</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="creating-a-zfs-storage-pool"><a class="anchor" href="#creating-a-zfs-storage-pool"></a>1.28. Creating a ZFS Storage Pool</h3>
<div class="paragraph">
<p>The previous example illustrates the simplicity of ZFS. The remainder of
this chapter demonstrates a more complete example similar to what you
would encounter in your environment. The first tasks are to identify
your storage requirements and create a storage pool. The pool describes
the physical characteristics of the storage and must be created before
any file systems are created.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Determine available devices.</p>
<div class="paragraph">
<p>Before creating a storage pool, you must determine which devices will
store your data. These devices must be disks of at least 128 Mbytes in
size, and they must not be in use by other parts of the operating
system. The devices can be individual slices on a preformatted disk, or
they can be entire disks that ZFS formats as a single large slice.</p>
</div>
<div class="paragraph">
<p>For the storage example used in <a href="#gayok">task_title</a>, assume that
the whole disks <code>/dev/dsk/c1t0d0</code> and <code>/dev/dsk/c1t1d0</code> are available
for use.</p>
</div>
<div class="paragraph">
<p>For more information about disks and how they are used and labeled, see
<a href="#using-disks-in-a-zfs-storage-pool">Using Disks in a ZFS Storage Pool</a>.</p>
</div>
</li>
<li>
<p>Choose data replication.</p>
<div class="paragraph">
<p>ZFS supports multiple types of data replication, which determines what
types of hardware failures the pool can withstand. ZFS supports
nonredundant (striped) configurations, as well as mirroring and RAID-Z
(a variation on RAID-5).</p>
</div>
<div class="paragraph">
<p>For the storage example used in <a href="#gayok">task_title</a>, basic
mirroring of two available disks is used.</p>
</div>
<div class="paragraph">
<p>For more information about ZFS replication features, see
<a href="#replication-features-of-a-zfs-storage-pool">Replication Features of a ZFS Storage Pool</a>.</p>
</div>
</li>
<li>
<p>Become root or assume an equivalent role with the appropriate ZFS
rights profile.</p>
<div class="paragraph">
<p>For more information about the ZFS rights profiles, see <a href="#zfs-rights-profiles">ZFS
Rights Profiles</a>.</p>
</div>
</li>
<li>
<p>Pick a pool name.</p>
<div class="paragraph">
<p>The pool name is used to identify the storage pool when you are using
the <code>zpool</code> or <code>zfs</code> commands. Most systems require only a single pool,
so you can pick any name that you prefer, provided it satisfies the
naming requirements outlined in <a href="#zfs-component-naming-requirements">ZFS Component Naming
Requirements</a>.</p>
</div>
</li>
<li>
<p>Create the pool.</p>
<div class="paragraph">
<p>For example, create a mirrored pool that is named <code>tank</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank mirror c1t0d0 c1t1d0</pre>
</div>
</div>
<div class="paragraph">
<p>If one or more devices contains another file system or is otherwise in
use, the command cannot create the pool.</p>
</div>
<div class="paragraph">
<p>For more information about creating storage pools, see
<a href="#creating-a-zfs-storage-pool">Creating a ZFS Storage Pool</a>.</p>
</div>
<div class="paragraph">
<p>For more information about how device usage is determined, see
<a href="#detecting-in-use-devices">Detecting in Use Devices</a>.</p>
</div>
</li>
<li>
<p>View the results.</p>
<div class="paragraph">
<p>You can determine if your pool was successfully created by using the
<code>zpool list</code> command.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool list
NAME                    SIZE    USED   AVAIL    CAP  HEALTH     ALTROOT
tank                     80G    137K     80G     0%  ONLINE     -</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about viewing pool status, see <a href="#querying-zfs-storage-pool-status">Querying
ZFS Storage Pool Status</a>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-a-zfs-file-system-hierarchy"><a class="anchor" href="#creating-a-zfs-file-system-hierarchy"></a>1.29. Creating a ZFS File System Hierarchy</h3>
<div class="paragraph">
<p>After creating a storage pool to store your data, you can create your
file system hierarchy. Hierarchies are simple yet powerful mechanisms
for organizing information. They are also very familiar to anyone who
has used a file system.</p>
</div>
<div class="paragraph">
<p>ZFS allows file systems to be organized into arbitrary hierarchies,
where each file system has only a single parent. The root of the
hierarchy is always the pool name. ZFS leverages this hierarchy by
supporting property inheritance so that common properties can be set
quickly and easily on entire trees of file systems.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pick the file system granularity.</p>
<div class="paragraph">
<p>ZFS file systems are the central point of administration. They are
lightweight and can be created easily. A good model to use is a file
system per user or project, as this model allows properties, snapshots,
and backups to be controlled on a per-user or per-project basis.</p>
</div>
<div class="paragraph">
<p>Two ZFS file systems, <code>bonwick</code> and <code>billm</code>, are created in
<a href="#gayog">task_title</a>.</p>
</div>
<div class="paragraph">
<p>For more information on managing file systems, see <a href="#managing-zfs-file-systems">Managing
ZFS File Systems</a>.</p>
</div>
</li>
<li>
<p>Group similar file systems.</p>
<div class="paragraph">
<p>ZFS allows file systems to be organized into hierarchies so that similar
file systems can be grouped. This model provides a central point of
administration for controlling properties and administering file
systems. Similar file systems should be created under a common name.</p>
</div>
<div class="paragraph">
<p>For the example in <a href="#gayog">task_title</a>, the two file systems are
placed under a file system named <code>home</code>.</p>
</div>
</li>
<li>
<p>Choose the file system properties.</p>
<div class="paragraph">
<p>Most file system characteristics are controlled by using simple
properties. These properties control a variety of behavior, including
where the file systems are mounted, how they are shared, if they use
compression, and if any quotas are in effect.</p>
</div>
<div class="paragraph">
<p>For the example in <a href="#gayog">task_title</a>, all home directories are
mounted at <code>/export/zfs/</code>&lt;user&gt;, are shared by using NFS, and
with compression enabled. In addition, a quota of 10 Gbytes on <code>bonwick</code>
is enforced.</p>
</div>
<div class="paragraph">
<p>For more information about properties, see <a href="#introducing-zfs-properties">Introducing ZFS
Properties</a>.</p>
</div>
</li>
<li>
<p>Become root or assume an equivalent role with the appropriate ZFS
rights profile.</p>
<div class="paragraph">
<p>For more information about the ZFS rights profiles, see <a href="#zfs-rights-profiles">ZFS
Rights Profiles</a>.</p>
</div>
</li>
<li>
<p>Create the desired hierarchy.</p>
<div class="paragraph">
<p>In this example, a file system that acts as a container for individual
file systems is created.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create tank/home</pre>
</div>
</div>
<div class="paragraph">
<p>Next, individual file systems are grouped under the <code>home</code> file system
in the pool <code>tank</code>.</p>
</div>
</li>
<li>
<p>Set the inherited properties.</p>
<div class="paragraph">
<p>After the file system hierarchy is established, set up any properties
that should be shared among all users:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set mountpoint=/export/zfs tank/home
# zfs set sharenfs=on tank/home
# zfs set compression=on tank/home
# zfs get compression tank/home
NAME             PROPERTY       VALUE                      SOURCE
tank/home        compression    on                         local</pre>
</div>
</div>
<div class="paragraph">
<p>A new feature is available that enables you to set file system
properties when the file system is created. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create -o mountpoint=/export/zfs -o sharenfs=on -o compression=on tank/home</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about properties and property inheritance, see
<a href="#introducing-zfs-properties">Introducing ZFS Properties</a>.</p>
</div>
</li>
<li>
<p>Create the individual file systems.</p>
<div class="paragraph">
<p>Note that the file systems could have been created and then the
properties could have been changed at the <code>home</code> level. All properties
can be changed dynamically while file systems are in use.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create tank/home/bonwick
# zfs create tank/home/billm</pre>
</div>
</div>
<div class="paragraph">
<p>These file systems inherit their property settings from their parent, so
they are automatically mounted at <code>/export/zfs/</code>&lt;user&gt; and are
NFS shared. You do not need to edit the <code>/etc/vfstab</code> or
<code>/etc/dfs/dfstab</code> file.</p>
</div>
<div class="paragraph">
<p>For more information about creating file systems, see
<a href="#creating-a-zfs-file-system">Creating a ZFS File System</a>.</p>
</div>
<div class="paragraph">
<p>For more information about mounting and sharing file systems, see
<a href="#mounting-and-sharing-zfs-file-systems">Mounting and Sharing ZFS File Systems</a>.</p>
</div>
</li>
<li>
<p>Set the file system-specific properties.</p>
<div class="paragraph">
<p>In this example, user <code>bonwick</code> is assigned a quota of 10 Gbytes. This
property places a limit on the amount of space he can consume,
regardless of how much space is available in the pool.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set quota=10G tank/home/bonwick</pre>
</div>
</div>
</li>
<li>
<p>View the results.</p>
<div class="paragraph">
<p>View available file system information by using the <code>zfs list</code> command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list
NAME                   USED  AVAIL  REFER  MOUNTPOINT
tank                  92.0K  67.0G   9.5K  /tank
tank/home             24.0K  67.0G     8K  /export/zfs
tank/home/billm          8K  67.0G     8K  /export/zfs/billm
tank/home/bonwick        8K  10.0G     8K  /export/zfs/bonwick</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the user <code>bonwick</code> only has 10 Gbytes of space available,
while the user <code>billm</code> can use the full pool (67 Gbytes).</p>
</div>
<div class="paragraph">
<p>For more information about viewing file system status, see
<a href="#querying-zfs-file-system-information">Querying ZFS File System Information</a>.</p>
</div>
<div class="paragraph">
<p>For more information about how space is used and calculated, see
<a href="#zfs-space-accounting">ZFS Space Accounting</a>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="zfs-and-traditional-file-system-differences"><a class="anchor" href="#zfs-and-traditional-file-system-differences"></a>2. ZFS and Traditional File System Differences</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter discusses some significant differences between ZFS and
traditional file systems. Understanding these key differences can help
reduce confusion when using traditional tools to interact with ZFS.</p>
</div>
<div class="paragraph">
<p>The following sections are provided in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#zfs-file-system-granularity">ZFS File System Granularity</a></p>
</li>
<li>
<p><a href="#zfs-space-accounting">ZFS Space Accounting</a></p>
</li>
<li>
<p><a href="#out-of-space-behavior">Out of Space Behavior</a></p>
</li>
<li>
<p><a href="#mounting-zfs-file-systems">Mounting ZFS File Systems</a></p>
</li>
<li>
<p><a href="#traditional-volume-management">Traditional Volume Management</a></p>
</li>
<li>
<p><a href="#the-nfsv4-acl-model">The NFSv4 ACL Model</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="zfs-file-system-granularity"><a class="anchor" href="#zfs-file-system-granularity"></a>2.1. ZFS File System Granularity</h3>
<div class="paragraph">
<p>Historically, file systems have been constrained to one device so that
the file systems themselves have been constrained to the size of the
device. Creating and re-creating traditional file systems because of
size constraints are time-consuming and sometimes difficult. Traditional
volume management products helped manage this process.</p>
</div>
<div class="paragraph">
<p>Because ZFS file systems are not constrained to specific devices, they
can be created easily and quickly, similar to the way directories are
created. ZFS file systems grow automatically within the space allocated
to the storage pool.</p>
</div>
<div class="paragraph">
<p>Instead of creating one file system, such as <code>/export/home</code>, to manage
many user subdirectories, you can create one file system per user. In
addition, ZFS provides a file system hierarchy so that you can easily
set up and manage many file systems by applying properties that can be
inherited by file systems contained within the hierarchy.</p>
</div>
<div class="paragraph">
<p>For an example of creating a file system hierarchy, see
<a href="#creating-a-zfs-file-system-hierarchy">Creating a ZFS File System Hierarchy</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="zfs-space-accounting"><a class="anchor" href="#zfs-space-accounting"></a>2.2. ZFS Space Accounting</h3>
<div class="paragraph">
<p>ZFS is based on a concept of pooled storage. Unlike typical file
systems, which are mapped to physical storage, all ZFS file systems in a
pool share the available storage in the pool. So, the available space
reported by utilities such as <code>df</code> might change even when the file
system is inactive, as other file systems in the pool consume or release
space. Note that the maximum file system size can be limited by using
quotas. For information about quotas, see <a href="#setting-quotas-on-zfs-file-systems">Setting Quotas on
ZFS File Systems</a>. Space can be guaranteed to a file system by using
reservations. For information about reservations, see
<a href="#setting-reservations-on-zfs-file-systems">Setting Reservations on ZFS File Systems</a>. This model is
very similar to the NFS model, where multiple directories are mounted
from the same file system (consider <code>/home</code>).</p>
</div>
<div class="paragraph">
<p>All metadata in ZFS is allocated dynamically. Most other file systems
pre-allocate much of their metadata. As a result, an immediate space
cost at file system creation for this metadata is required. This
behavior also means that the total number of files supported by the file
systems is predetermined. Because ZFS allocates its metadata as it needs
it, no initial space cost is required, and the number of files is
limited only by the available space. The output from the <code>df -g</code> command
must be interpreted differently for ZFS than other file systems. The
<code>total files</code> reported is only an estimate based on the amount of
storage that is available in the pool.</p>
</div>
<div class="paragraph">
<p>ZFS is a transactional file system. Most file system modifications are
bundled into transaction groups and committed to disk asynchronously.
Until these modifications are committed to disk, they are termed
<em>pending changes</em>. The amount of space used, available, and referenced
by a file or file system does not consider pending changes. Pending
changes are generally accounted for within a few seconds. Even
committing a change to disk by using <code>fsync(3C)</code> or <code>O_SYNC</code> does
not necessarily guarantee that the space usage information is updated
immediately.</p>
</div>
<div class="sect3">
<h4 id="out-of-space-behavior"><a class="anchor" href="#out-of-space-behavior"></a>2.2.1. Out of Space Behavior</h4>
<div class="paragraph">
<p>File system snapshots are inexpensive and easy to create in ZFS. Most
likely, snapshots will be common in most ZFS environments. For
information about ZFS snapshots, see <a href="#working-with-zfs-snapshots-and-clones">Working With ZFS
Snapshots and Clones</a>.</p>
</div>
<div class="paragraph">
<p>The presence of snapshots can cause some unexpected behavior when you
attempt to free space. Typically, given appropriate permissions, you can
remove a file from a full file system, and this action results in more
space becoming available in the file system. However, if the file to be
removed exists in a snapshot of the file system, then no space is gained
from the file deletion. The blocks used by the file continue to be
referenced from the snapshot.</p>
</div>
<div class="paragraph">
<p>As a result, the file deletion can consume more disk space, because a
new version of the directory needs to be created to reflect the new
state of the namespace. This behavior means that you can get an
unexpected ENOSPC or EDQUOT when attempting to remove a file.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mounting-zfs-file-systems"><a class="anchor" href="#mounting-zfs-file-systems"></a>2.3. Mounting ZFS File Systems</h3>
<div class="paragraph">
<p>ZFS is designed to reduce complexity and ease administration. For
example, with existing file systems you must edit the <code>/etc/vfstab</code> file
every time you add a new file system. ZFS has eliminated this
requirement by automatically mounting and unmounting file systems
according to the properties of the dataset. You do not need to manage
ZFS entries in the <code>/etc/vfstab</code> file.</p>
</div>
<div class="paragraph">
<p>For more information about mounting and sharing ZFS file systems, see
<a href="#mounting-and-sharing-zfs-file-systems">Mounting and Sharing ZFS File Systems</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="traditional-volume-management"><a class="anchor" href="#traditional-volume-management"></a>2.4. Traditional Volume Management</h3>
<div class="paragraph">
<p>As described in <a href="#zfs-pooled-storage">ZFS Pooled Storage</a>, ZFS eliminates the need
for a separate volume manager. ZFS operates on raw devices, so it is
possible to create a storage pool comprised of logical volumes, either
software or hardware. This configuration is not recommended, as ZFS
works best when it uses raw physical devices. Using logical volumes
might sacrifice performance, reliability, or both, and should be
avoided.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-nfsv4-acl-model"><a class="anchor" href="#the-nfsv4-acl-model"></a>2.5. The NFSv4 ACL Model</h3>
<div class="paragraph">
<p>Older versions of Solaris supported an ACL implementation that was
primarily based on the POSIX-draft specification. The POSIX-draft based
ACLs are used to protect UFS files, while a new ACL model based on the
NFSv4 specification is used to protect ZFS files.</p>
</div>
<div class="paragraph">
<p>The main differences of this ACL model are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Based on the NFSv4 specification and are similar to NT-style ACLs.</p>
</li>
<li>
<p>Much more granular set of access privileges.</p>
</li>
<li>
<p>Set and displayed with the <code>chmod</code> and <code>ls</code> commands rather than the
<code>setfacl</code> and <code>getfacl</code> commands.</p>
</li>
<li>
<p>Richer inheritance semantics for designating how access privileges are
applied from directory to subdirectories, and so on.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about using ACLs with ZFS files, see
<a href="#using-acls-to-protect-zfs-files">Using ACLs to Protect ZFS Files</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="managing-zfs-storage-pools"><a class="anchor" href="#managing-zfs-storage-pools"></a>3. Managing ZFS Storage Pools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes how to create and administer ZFS storage pools.</p>
</div>
<div class="paragraph">
<p>The following sections are provided in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#components-of-a-zfs-storage-pool">Components of a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#creating-and-destroying-zfs-storage-pools">Creating and Destroying ZFS Storage Pools</a></p>
</li>
<li>
<p><a href="#managing-devices-in-zfs-storage-pools">Managing Devices in ZFS Storage Pools</a></p>
</li>
<li>
<p><a href="#managing-zfs-storage-pool-properties">Managing ZFS Storage Pool Properties</a></p>
</li>
<li>
<p><a href="#querying-zfs-storage-pool-status">Querying ZFS Storage Pool Status</a></p>
</li>
<li>
<p><a href="#migrating-zfs-storage-pools">Migrating ZFS Storage Pools</a></p>
</li>
<li>
<p><a href="#upgrading-zfs-storage-pools">Upgrading ZFS Storage Pools</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="components-of-a-zfs-storage-pool"><a class="anchor" href="#components-of-a-zfs-storage-pool"></a>3.1. Components of a ZFS Storage Pool</h3>
<div class="paragraph">
<p>The following sections provide detailed information about the following
storage pool components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#using-disks-in-a-zfs-storage-pool">Using Disks in a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#using-files-in-a-zfs-storage-pool">Using Files in a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#identifying-virtual-devices-in-a-storage-pool">Identifying Virtual Devices in a Storage Pool</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="using-disks-in-a-zfs-storage-pool"><a class="anchor" href="#using-disks-in-a-zfs-storage-pool"></a>3.1.1. Using Disks in a ZFS Storage Pool</h4>
<div class="paragraph">
<p>The most basic element of a storage pool is a piece of physical storage.
Physical storage can be any block device of at least 128 Mbytes in size.
Typically, this device is a hard drive that is visible to the system in
the <code>/dev/dsk</code> directory.</p>
</div>
<div class="paragraph">
<p>A storage device can be a whole disk (<code>c1t0d0</code>) or an individual slice
(<code>c0t0d0s7</code>). The recommended mode of operation is to use an entire
disk, in which case the disk does not need to be specially formatted.
ZFS formats the disk using an EFI label to contain a single, large
slice. When used in this way, the partition table that is displayed by
the <code>format</code> command appears similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Current partition table (original):
Total disk sectors available: 71670953 + 16384 (reserved sectors)

Part      Tag    Flag     First Sector        Size        Last Sector
  0        usr    wm                34      34.18GB         71670953
  1 unassigned    wm                 0          0              0
  2 unassigned    wm                 0          0              0
  3 unassigned    wm                 0          0              0
  4 unassigned    wm                 0          0              0
  5 unassigned    wm                 0          0              0
  6 unassigned    wm                 0          0              0
  7 unassigned    wm                 0          0              0
  8   reserved    wm          71670954       8.00MB         71687337</pre>
</div>
</div>
<div class="paragraph">
<p>To use whole disks, the disks must be named using the standard Solaris
convention, such as <code>/dev/dsk/cXtXdXsX</code>. Some third-party drivers use a
different naming convention or place disks in a location other than the
<code>/dev/dsk</code> directory. To use these disks, you must manually label the
disk and provide a slice to ZFS.</p>
</div>
<div class="paragraph">
<p>ZFS applies an EFI label when you create a storage pool with whole
disks. Disks can be labeled with a traditional Solaris VTOC label when
you create a storage pool with a disk slice.</p>
</div>
<div class="paragraph">
<p>Slices should only be used under the following conditions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The device name is nonstandard.</p>
</li>
<li>
<p>A single disk is shared between ZFS and another file system, such as
UFS.</p>
</li>
<li>
<p>A disk is used as a swap or a dump device.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Disks can be specified by using either the full path, such as
<code>/dev/dsk/c1t0d0</code>, or a shorthand name that consists of the device name
within the <code>/dev/dsk</code> directory, such as <code>c1t0d0</code>. For example, the
following are valid disk names:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>c1t0d0</code></p>
</li>
<li>
<p><code>/dev/dsk/c1t0d0</code></p>
</li>
<li>
<p><code>c0t0d6s2</code></p>
</li>
<li>
<p><code>/dev/foo/disk</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using whole physical disks is the simplest way to create ZFS storage
pools. ZFS configurations become progressively more complex, from
management, reliability, and performance perspectives, when you build
pools from disk slices, LUNs in hardware RAID arrays, or volumes
presented by software-based volume managers. The following
considerations might help you determine how to configure ZFS with other
hardware or software storage solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you construct ZFS configurations on top of LUNs from hardware RAID
arrays, you need to understand the relationship between ZFS redundancy
features and the redundancy features offered by the array. Certain
configurations might provide adequate redundancy and performance, but
other configurations might not.</p>
</li>
<li>
<p>You can construct logical devices for ZFS using volumes presented by
software-based volume managers, such as Solaris Volume Manager (SVM) or
Veritas Volume Manager (VxVM). However, these configurations are not
recommended. While ZFS functions properly on such devices,
less-than-optimal performance might be the result.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For additional information about storage pool recommendations, see the
<a href="http://www.solarisinternals.com/wiki/index.php/ZFS_Best_Practices_Guide">ZFS
best practices guide</a>.</p>
</div>
<div class="paragraph">
<p>Disks are identified both by their path and by their device ID, if
available. This method allows devices to be reconfigured on a system
without having to update any ZFS state. If a disk is switched between
controller 1 and controller 2, ZFS uses the device ID to detect that the
disk has moved and should now be accessed using controller 2. The device
ID is unique to the drive&#8217;s firmware. While unlikely, some firmware
updates have been known to change device IDs. If this situation happens,
ZFS can still access the device by path and update the stored device ID
automatically. If you inadvertently change both the path and the ID of
the device, then export and re-import the pool in order to use it.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-files-in-a-zfs-storage-pool"><a class="anchor" href="#using-files-in-a-zfs-storage-pool"></a>3.1.2. Using Files in a ZFS Storage Pool</h4>
<div class="paragraph">
<p>ZFS also allows you to use UFS files as virtual devices in your storage
pool. This feature is aimed primarily at testing and enabling simple
experimentation, not for production use. The reason is that <strong>any use of
files relies on the underlying file system for consistency</strong>. If you
create a ZFS pool backed by files on a UFS file system, then you are
implicitly relying on UFS to guarantee correctness and synchronous
semantics.</p>
</div>
<div class="paragraph">
<p>However, files can be quite useful when you are first trying out ZFS or
experimenting with more complicated layouts when not enough physical
devices are present. All files must be specified as complete paths and
must be at least 64 Mbytes in size. If a file is moved or renamed, the
pool must be exported and re-imported in order to use it, as no device
ID is associated with files by which they can be located.</p>
</div>
</div>
<div class="sect3">
<h4 id="identifying-virtual-devices-in-a-storage-pool"><a class="anchor" href="#identifying-virtual-devices-in-a-storage-pool"></a>3.1.3. Identifying Virtual Devices in a Storage Pool</h4>
<div class="paragraph">
<p>Each storage pool is comprised of one or more virtual devices. A
<em>virtual device</em> is an internal representation of the storage pool that
describes the layout of physical storage and its fault characteristics.
As such, a virtual device represents the disk devices or files that are
used to create the storage pool.</p>
</div>
<div class="paragraph">
<p>Two top-level virtual devices provide data redundancy: mirror and RAID-Z
virtual devices. These virtual devices consist of disks, disk slices, or
files.</p>
</div>
<div class="paragraph">
<p>Disks, disk slices, or files that are used in pools outside of mirrors
and RAID-Z virtual devices, function as top-level virtual devices
themselves.</p>
</div>
<div class="paragraph">
<p>Storage pools typically contain multiple top-level virtual devices. ZFS
dynamically stripes data among all of the top-level virtual devices in a
pool.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="replication-features-of-a-zfs-storage-pool"><a class="anchor" href="#replication-features-of-a-zfs-storage-pool"></a>3.2. Replication Features of a ZFS Storage Pool</h3>
<div class="paragraph">
<p>ZFS provides data redundancy, as well as self-healing properties, in a
mirrored and a RAID-Z configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#mirrored-storage-pool-configuration">Mirrored Storage Pool Configuration</a></p>
</li>
<li>
<p><a href="#raid-z-storage-pool-configuration">RAID-Z Storage Pool Configuration</a></p>
</li>
<li>
<p><a href="#self-healing-data-in-a-redundant-configuration">Self-Healing Data in a Redundant Configuration</a></p>
</li>
<li>
<p><a href="#dynamic-striping-in-a-storage-pool">Dynamic Striping in a Storage Pool</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="mirrored-storage-pool-configuration"><a class="anchor" href="#mirrored-storage-pool-configuration"></a>3.2.1. Mirrored Storage Pool Configuration</h4>
<div class="paragraph">
<p>A mirrored storage pool configuration requires at least two disks,
preferably on separate controllers. Many disks can be used in a mirrored
configuration. In addition, you can create more than one mirror in each
pool. Conceptually, a simple mirrored configuration would look similar
to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mirror c1t0d0 c2t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>Conceptually, a more complex mirrored configuration would look similar
to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mirror c1t0d0 c2t0d0 c3t0d0 mirror c4t0d0 c5t0d0 c6t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>For information about creating a mirrored storage pool, see
<a href="#creating-a-mirrored-storage-pool">Creating a Mirrored Storage Pool</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="raid-z-storage-pool-configuration"><a class="anchor" href="#raid-z-storage-pool-configuration"></a>3.2.2. RAID-Z Storage Pool Configuration</h4>
<div class="paragraph">
<p>In addition to a mirrored storage pool configuration, ZFS provides a
RAID-Z configuration with either single or double parity fault
tolerance. Single-parity RAID-Z is similar to RAID-5. Double-parity
RAID-Z is similar to RAID-6.</p>
</div>
<div class="paragraph">
<p>All traditional RAID-5-like algorithms (RAID-4. RAID-5. RAID-6, RDP, and
EVEN-ODD, for example) suffer from a problem known as the “RAID-5 write
hole.” If only part of a RAID-5 stripe is written, and power is lost
before all blocks have made it to disk, the parity will remain out of
sync with the data, and therefore useless, forever (unless a subsequent
full-stripe write overwrites it). In RAID-Z, ZFS uses variable-width
RAID stripes so that all writes are full-stripe writes. This design is
only possible because ZFS integrates file system and device management
in such a way that the file system&#8217;s metadata has enough information
about the underlying data redundancy model to handle variable-width RAID
stripes. RAID-Z is the world&#8217;s first software-only solution to the
RAID-5 write hole.</p>
</div>
<div class="paragraph">
<p>You need at least two disks for a RAID-Z configuration. Otherwise, no
special hardware is required to create a RAID-Z configuration.
Currently, RAID-Z provides single parity. For example, if you have three
disks in a RAID-Z configuration, parity data occupies space equal to one
of the three disks.</p>
</div>
<div class="paragraph">
<p>A RAID-Z configuration with N disks of size X with P parity disks can
hold approximately (N-P)*X bytes and can withstand P device(s)
failing before data integrity is compromised. You need at least two
disks for a single-parity RAID-Z configuration and at least three disks
for a double-parity RAID-Z configuration. For example, if you have three
disks in a single-parity RAID-Z configuration, parity data occupies
space equal to one of the three disks. Otherwise, no special hardware is
required to create a RAID-Z configuration.</p>
</div>
<div class="paragraph">
<p>Conceptually, a RAID-Z configuration with three disks would look similar
to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>raidz c1t0d0 c2t0d0 c3t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>A more complex conceptual RAID-Z configuration would look similar to the
following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>raidz c1t0d0 c2t0d0 c3t0d0 c4t0d0 c5t0d0 c6t0d0 c7t0d0 raidz c8t0d0 c9t0d0 c10t0d0 c11t0d0
c12t0d0 c13t0d0 c14t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>If you are creating a RAID-Z configuration with many disks, as in this
example, a RAID-Z configuration with 14 disks is better split into a two
7-disk groupings. RAID-Z configurations with single-digit groupings of
disks should perform better.</p>
</div>
<div class="paragraph">
<p>For information about creating a RAID-Z storage pool, see
<a href="#creating-raid-z-storage-pools">Creating RAID-Z Storage Pools</a>.</p>
</div>
<div class="paragraph">
<p>For more information about choosing between a mirrored configuration or
a RAID-Z configuration based on performance and space considerations,
see the blog post,
<a href="https://blogs.oracle.com/roch/entry/when_to_and_not_to">When To (And Not
To) Use RAID-Z</a>. For additional information on RAID-Z storage pool
recommendations, see the
<a href="http://www.solarisinternals.com/wiki/index.php/ZFS_Best_Practices_Guide">ZFS
best practices guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="self-healing-data-in-a-redundant-configuration"><a class="anchor" href="#self-healing-data-in-a-redundant-configuration"></a>3.2.3. Self-Healing Data in a Redundant Configuration</h4>
<div class="paragraph">
<p>ZFS provides for self-healing data in a mirrored or RAID-Z
configuration.</p>
</div>
<div class="paragraph">
<p>When a bad data block is detected, not only does ZFS fetch the correct
data from another redundant copy, but it also repairs the bad data by
replacing it with the good copy.</p>
</div>
</div>
<div class="sect3">
<h4 id="dynamic-striping-in-a-storage-pool"><a class="anchor" href="#dynamic-striping-in-a-storage-pool"></a>3.2.4. Dynamic Striping in a Storage Pool</h4>
<div class="paragraph">
<p>For each virtual device that is added to the pool, ZFS dynamically
stripes data across all available devices. The decision about where to
place data is done at write time, so no fixed width stripes are created
at allocation time.</p>
</div>
<div class="paragraph">
<p>When virtual devices are added to a pool, ZFS gradually allocates data
to the new device in order to maintain performance and space allocation
policies. Each virtual device can also be a mirror or a RAID-Z device
that contains other disk devices or files. This configuration allows for
flexibility in controlling the fault characteristics of your pool. For
example, you could create the following configurations out of 4 disks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Four disks using dynamic striping</p>
</li>
<li>
<p>One four-way RAID-Z configuration</p>
</li>
<li>
<p>Two two-way mirrors using dynamic striping</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While ZFS supports combining different types of virtual devices within
the same pool, this practice is not recommended. For example, you can
create a pool with a two-way mirror and a three-way RAID-Z
configuration. However, your fault tolerance is as good as your worst
virtual device, RAID-Z in this case. The recommended practice is to use
top-level virtual devices of the same type with the same redundancy
level in each device.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-and-destroying-zfs-storage-pools"><a class="anchor" href="#creating-and-destroying-zfs-storage-pools"></a>3.3. Creating and Destroying ZFS Storage Pools</h3>
<div class="paragraph">
<p>The following sections describe different scenarios for creating and
destroying ZFS storage pools.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-a-zfs-storage-pool">Creating a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#handling-zfs-storage-pool-creation-errors">Handling ZFS Storage Pool Creation Errors</a></p>
</li>
<li>
<p><a href="#destroying-zfs-storage-pools">Destroying ZFS Storage Pools</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By design, creating and destroying pools is fast and easy. However, be
cautious when doing these operations. Although checks are performed to
prevent using devices known to be in use in a new pool, ZFS cannot
always know when a device is already in use. Destroying a pool is even
easier. Use <code>zpool destroy</code> with caution. This is a simple command with
significant consequences.</p>
</div>
<div class="sect3">
<h4 id="creating-a-zfs-storage-pool-1"><a class="anchor" href="#creating-a-zfs-storage-pool-1"></a>3.3.1. Creating a ZFS Storage Pool</h4>
<div class="paragraph">
<p>To create a storage pool, use the <code>zpool create</code> command. This command
takes a pool name and any number of virtual devices as arguments. The
pool name must satisfy the naming conventions outlined in
<a href="#zfs-component-naming-requirements">ZFS Component Naming Requirements</a>.</p>
</div>
<div class="sect4">
<h5 id="creating-a-basic-storage-pool"><a class="anchor" href="#creating-a-basic-storage-pool"></a>Creating a Basic Storage Pool</h5>
<div class="paragraph">
<p>The following command creates a new pool named <code>tank</code> that consists of
the disks <code>c1t0d0</code> and <code>c1t1d0</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank c1t0d0 c1t1d0</pre>
</div>
</div>
<div class="paragraph">
<p>These whole disks are found in the <code>/dev/dsk</code> directory and are labelled
appropriately by ZFS to contain a single, large slice. Data is
dynamically striped across both disks.</p>
</div>
</div>
<div class="sect4">
<h5 id="creating-a-mirrored-storage-pool"><a class="anchor" href="#creating-a-mirrored-storage-pool"></a>Creating a Mirrored Storage Pool</h5>
<div class="paragraph">
<p>To create a mirrored pool, use the <code>mirror</code> keyword, followed by any
number of storage devices that will comprise the mirror. Multiple
mirrors can be specified by repeating the <code>mirror</code> keyword on the
command line. The following command creates a pool with two, two-way
mirrors:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank mirror c1d0 c2d0 mirror c3d0 c4d0</pre>
</div>
</div>
<div class="paragraph">
<p>The second <code>mirror</code> keyword indicates that a new top-level virtual
device is being specified. Data is dynamically striped across both
mirrors, with data being redundant between each disk appropriately.</p>
</div>
<div class="paragraph">
<p>Currently, the following operations are supported on a ZFS mirrored
configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adding another set of disks for an additional top-level <code>vdev</code> to an
existing mirrored configuration. For more information, see
<a href="#adding-devices-to-a-storage-pool">Adding Devices to a Storage Pool</a>.</p>
</li>
<li>
<p>Attaching additional disks to an existing mirrored configuration. Or,
attaching additional disks to a non-replicated configuration to create a
mirrored configuration. For more information, see <a href="#attaching-and-detaching-devices-in-a-storage-pool">Attaching
and Detaching Devices in a Storage Pool</a>.</p>
</li>
<li>
<p>Replace a disk or disks in an existing mirrored configuration as long
as the replacement disks are greater than or equal to the device to be
replaced. For more information, see <a href="#replacing-devices-in-a-storage-pool">Replacing Devices in a
Storage Pool</a>.</p>
</li>
<li>
<p>Detach a disk or disk in a mirrored configuration as long as the
remaining devices provide adequate redundancy for the configuration. For
more information, see <a href="#attaching-and-detaching-devices-in-a-storage-pool">Attaching and Detaching Devices in a
Storage Pool</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Currently, the following operations are not supported on a mirrored
configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You cannot outright remove a device from a mirrored storage pool. An
RFE is filed for this feature.</p>
</li>
<li>
<p>You cannot split or break a mirror for backup purposes. An RFE is
filed for this feature.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="creating-raid-z-storage-pools"><a class="anchor" href="#creating-raid-z-storage-pools"></a>Creating RAID-Z Storage Pools</h5>
<div class="paragraph">
<p>Creating a single-parity RAID-Z pool is identical to creating a mirrored
pool, except that the <code>raidz</code> or <code>raidz1</code> keyword is used instead of
<code>mirror</code>. The following example shows how to create a pool with a single
RAID-Z device that consists of five disks:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank raidz c1t0d0 c2t0d0 c3t0d0 c4t0d0 /dev/dsk/c5t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>This example demonstrates that disks can be specified by using their
full paths. The <code>/dev/dsk/c5t0d0</code> device is identical to the <code>c5t0d0</code>
device.</p>
</div>
<div class="paragraph">
<p>A similar configuration could be created with disk slices. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank raidz c1t0d0s0 c2t0d0s0 c3t0d0s0 c4t0d0s0 c5t0d0s0</pre>
</div>
</div>
<div class="paragraph">
<p>However, the disks must be preformatted to have an appropriately sized
slice zero.</p>
</div>
<div class="paragraph">
<p>You can create a double-parity RAID-Z configuration by using the
<code>raidz2</code> keyword when the pool is created. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank raidz2 c1t0d0 c2t0d0 c3t0d0
# zpool status -v tank
  pool: tank
 state: ONLINE
 scrub: none requested
config:

        NAME          STATE     READ WRITE CKSUM
        tank          ONLINE       0     0     0
          raidz2      ONLINE       0     0     0
            c1t0d0    ONLINE       0     0     0
            c2t0d0    ONLINE       0     0     0
            c3t0d0    ONLINE       0     0     0

            errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>Currently, the following operations are supported on a ZFS RAID-Z
configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add another set of disks for an additional top-level <code>vdev</code> to an
existing RAID-Z configuration. For more information, see
<a href="#adding-devices-to-a-storage-pool">Adding Devices to a Storage Pool</a>.</p>
</li>
<li>
<p>Replace a disk or disks in an existing RAID-Z configuration as long as
the replacement disks are greater than or equal to the device to be
replaced. For more information, see <a href="#replacing-devices-in-a-storage-pool">Replacing Devices in a
Storage Pool</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Currently, the following operations are not supported on a RAID-Z
configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Attach an additional disk to an existing RAID-Z configuration.</p>
</li>
<li>
<p>Detach a disk from a RAID-Z configuration.</p>
</li>
<li>
<p>You cannot outright remove a device from a RAID-Z configuration. An
RFE is filed for this feature.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about a RAID-Z configuration, see
<a href="#raid-z-storage-pool-configuration">RAID-Z Storage Pool Configuration</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="creating-a-zfs-storage-pool-with-log-devices"><a class="anchor" href="#creating-a-zfs-storage-pool-with-log-devices"></a>Creating a ZFS Storage Pool with Log Devices</h5>
<div class="paragraph">
<p>By default, the ZIL is allocated from blocks within the main pool.
However, better performance might be possible by using separate intent
log devices, such as NVRAM or a dedicated disk. For more information
about ZFS log devices, see <a href="#setting-up-separate-zfs-logging-devices">Setting Up Separate ZFS Logging
Devices</a>.</p>
</div>
<div class="paragraph">
<p>You can set up a ZFS logging device when the storage pool is created or
after the pool is created.</p>
</div>
<div class="paragraph">
<p>For example, create a mirrored storage pool with mirrored log devices.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create datap mirror c1t1d0 c1t2d0 mirror c1t3d0 c1t4d0 log mirror c1t5d0 c1t8d0
# zpool status
  pool: datap
 state: ONLINE
 scrub: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        datap       ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c1t1d0  ONLINE       0     0     0
            c1t2d0  ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c1t3d0  ONLINE       0     0     0
            c1t4d0  ONLINE       0     0     0
        logs        ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c1t5d0  ONLINE       0     0     0
            c1t8d0  ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="creating-a-zfs-storage-pool-with-cache-devices"><a class="anchor" href="#creating-a-zfs-storage-pool-with-cache-devices"></a>Creating a ZFS Storage Pool with Cache Devices</h5>
<div class="paragraph">
<p>You can create a storage pool with cache devices to cache storage pool
data. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank mirror c2t0d0 c2t1d0 c2t3d0 cache c2t5d0 c2t8d0
# zpool status tank
  pool: tank
 state: ONLINE
 scrub: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        tank        ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c2t0d0  ONLINE       0     0     0
            c2t1d0  ONLINE       0     0     0
            c2t3d0  ONLINE       0     0     0
        cache
          c2t5d0    ONLINE       0     0     0
          c2t8d0    ONLINE       0     0     0</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Using cache devices provide the greatest performance improvement for
random read-workloads of mostly static content.</p>
</li>
<li>
<p>Capacity and reads can be monitored by using the <code>zpool iostat</code>
command.</p>
</li>
<li>
<p>Single or multiple cache devices can be added when the pool is created
or added and removed after the pool is created. For more information,
see <a href="#gfxrx">example_title</a>.</p>
</li>
<li>
<p>Cache devices cannot be mirrored or be part of a RAID-Z configuration.</p>
</li>
<li>
<p>If a read error is encountered on a cache device, that read I/O is
reissued to the original storage pool device, which might be part of a
mirrored or RAID-Z configuration. The content of the cache devices is
considered volatile, as is the case with other system caches.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="handling-zfs-storage-pool-creation-errors"><a class="anchor" href="#handling-zfs-storage-pool-creation-errors"></a>3.3.2. Handling ZFS Storage Pool Creation Errors</h4>
<div class="paragraph">
<p>Pool creation errors can occur for many reasons. Some of these reasons
are obvious, such as when a specified device doesn&#8217;t exist, while other
reasons are more subtle.</p>
</div>
<div class="sect4">
<h5 id="detecting-in-use-devices"><a class="anchor" href="#detecting-in-use-devices"></a>Detecting in Use Devices</h5>
<div class="paragraph">
<p>Before formatting a device, ZFS first determines if the disk is in use
by ZFS or some other part of the operating system. If the disk is in
use, you might see errors such as the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank c1t0d0 c1t1d0
invalid vdev specification
use '-f' to override the following errors:
/dev/dsk/c1t0d0s0 is currently mounted on /. Please see umount(1M).
/dev/dsk/c1t0d0s1 is currently mounted on swap. Please see swap(1M).
/dev/dsk/c1t1d0s0 is part of active ZFS pool zeepool. Please see zpool(1M).</pre>
</div>
</div>
<div class="paragraph">
<p>Some of these errors can be overridden by using the <code>f</code> option, but most
errors cannot. The following uses cannot be overridden by using the <code>f</code>
option, and you must manually correct them:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Mounted file system</strong></dt>
<dd>
<p>The disk or one of its slices contains a file system that is currently
mounted. To correct this error, use the <code>umount</code> command.</p>
</dd>
<dt class="hdlist1"><strong>File system in /etc/vfstab</strong></dt>
<dd>
<p>The disk contains a file system that is listed in the <code>/etc/vfstab</code>
file, but the file system is not currently mounted. To correct this
error, remove or comment out the line in the <code>/etc/vfstab</code> file.</p>
</dd>
<dt class="hdlist1"><strong>Dedicated dump device</strong></dt>
<dd>
<p>The disk is in use as the dedicated dump device for the system. To
correct this error, use the <code>dumpadm</code> command.</p>
</dd>
<dt class="hdlist1"><strong>Part of a ZFS pool</strong></dt>
<dd>
<p>The disk or file is part of an active ZFS storage pool. To correct
this error, use the <code>zpool</code> command to destroy the pool.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following in-use checks serve as helpful warnings and can be
overridden by using the <code>f</code> option to create the pool:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Contains a file system</strong></dt>
<dd>
<p>The disk contains a known file system, though it is not mounted and
doesn&#8217;t appear to be in use.</p>
</dd>
<dt class="hdlist1"><strong>Part of volume</strong></dt>
<dd>
<p>The disk is part of an SVM volume.</p>
</dd>
<dt class="hdlist1"><strong>Live upgrade</strong></dt>
<dd>
<p>The disk is in use as an alternate boot environment for Solaris Live
Upgrade.</p>
</dd>
<dt class="hdlist1"><strong>Part of exported ZFS pool</strong></dt>
<dd>
<p>The disk is part of a storage pool that has been exported or manually
removed from a system. In the latter case, the pool is reported as
<code>potentially active</code>, as the disk might or might not be a
network-attached drive in use by another system. Be cautious when
overriding a potentially active pool.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following example demonstrates how the <code>f</code> option is used:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank c1t0d0
invalid vdev specification
use '-f' to override the following errors:
/dev/dsk/c1t0d0s0 contains a ufs filesystem.
# zpool create -f tank c1t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>Ideally, correct the errors rather than use the <code>f</code> option.</p>
</div>
</div>
<div class="sect4">
<h5 id="mismatched-replication-levels"><a class="anchor" href="#mismatched-replication-levels"></a>Mismatched Replication Levels</h5>
<div class="paragraph">
<p>Creating pools with virtual devices of different replication levels is
not recommended. The <code>zpool</code> command tries to prevent you from
accidentally creating a pool with mismatched levels of redundancy. If
you try to create a pool with such a configuration, you see errors
similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank c1t0d0 mirror c2t0d0 c3t0d0
invalid vdev specification
use '-f' to override the following errors:
mismatched replication level: both disk and mirror vdevs are present
# zpool create tank mirror c1t0d0 c2t0d0 mirror c3t0d0 c4t0d0 c5t0d0
invalid vdev specification
use '-f' to override the following errors:
mismatched replication level: 2-way mirror and 3-way mirror vdevs are present</pre>
</div>
</div>
<div class="paragraph">
<p>You can override these errors with the <code>f</code> option, though this practice
is not recommended. The command also warns you about creating a mirrored
or RAID-Z pool using devices of different sizes. While this
configuration is allowed, mismatched levels of redundancy result in
unused space on the larger device, and requires the <code>f</code> option to
override the warning.</p>
</div>
</div>
<div class="sect4">
<h5 id="doing-a-dry-run-of-storage-pool-creation"><a class="anchor" href="#doing-a-dry-run-of-storage-pool-creation"></a>Doing a Dry Run of Storage Pool Creation</h5>
<div class="paragraph">
<p>Because creating a pool can fail unexpectedly in different ways, and
because formatting disks is such a potentially harmful action, the
<code>zpool create</code> command has an additional option, <code>n</code>, which simulates
creating the pool without actually writing data to disk. This option
performs the device in-use checking and replication level validation,
and reports any errors in the process. If no errors are found, you see
output similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create -n tank mirror c1t0d0 c1t1d0
would create 'tank' with the following layout:</pre>
</div>
</div>
<div class="paragraph">
<p>Some errors cannot be detected without actually creating the pool. The
most common example is specifying the same device twice in the same
configuration. This error cannot be reliably detected without writing
the data itself, so the <code>create -n</code> command can report success and yet
fail to create the pool when run for real.</p>
</div>
</div>
<div class="sect4">
<h5 id="default-mount-point-for-storage-pools"><a class="anchor" href="#default-mount-point-for-storage-pools"></a>Default Mount Point for Storage Pools</h5>
<div class="paragraph">
<p>When a pool is created, the default mount point for the root dataset is
&lt;/pool-name&gt;. This directory must either not exist or be empty.
If the directory does not exist, it is automatically created. If the
directory is empty, the root dataset is mounted on top of the existing
directory. To create a pool with a different default mount point, use
the <code>m</code> option of the <code>zpool create</code> command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create home c1t0d0
default mountpoint '/home' exists and is not empty
use '-m' option to specify a different default
# zpool create -m /export/zfs home c1t0d0</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create home c1t0d0
default mountpoint '/home' exists and is not empty
use '-m' option to provide a different default
# zpool create -m /export/zfs home c1t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>This command creates a new pool <code>home</code> and the <code>home</code> dataset with a
mount point of <code>/export/zfs</code>.</p>
</div>
<div class="paragraph">
<p>For more information about mount points, see <a href="#managing-zfs-mount-points">Managing ZFS
Mount Points</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="destroying-zfs-storage-pools"><a class="anchor" href="#destroying-zfs-storage-pools"></a>3.3.3. Destroying ZFS Storage Pools</h4>
<div class="paragraph">
<p>Pools are destroyed by using the <code>zpool destroy</code> command. This command
destroys the pool even if it contains mounted datasets.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool destroy tank</pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be very careful when you destroy a pool. Make sure you are destroying
the right pool and you always have copies of your data. If you
accidentally destroy the wrong pool, you can attempt to recover the
pool. For more information, see <a href="#recovering-destroyed-zfs-storage-pools">Recovering Destroyed ZFS
Storage Pools</a>.</p>
</div>
<div id="destroying-a-pool-with-faulted-devices" class="paragraph">
<p>===== Destroying a Pool With Faulted Devices</p>
</div>
<div class="paragraph">
<p>The act of destroying a pool requires that data be written to disk to
indicate that the pool is no longer valid. This state information
prevents the devices from showing up as a potential pool when you
perform an import. If one or more devices are unavailable, the pool can
still be destroyed. However, the necessary state information won&#8217;t be
written to these damaged devices.</p>
</div>
<div class="paragraph">
<p>These devices, when suitably repaired, are reported as <em>potentially
active</em> when you create a new pool, and appear as valid devices when you
search for pools to import. If a pool has enough faulted devices such
that the pool itself is faulted (meaning that a top-level virtual device
is faulted), then the command prints a warning and cannot complete
without the <code>f</code> option. This option is necessary because the pool cannot
be opened, so whether data is stored there or not is unknown. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool destroy tank
cannot destroy 'tank': pool is faulted
use '-f' to force destruction anyway
# zpool destroy -f tank</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about pool and device health, see
<a href="#determining-the-health-status-of-zfs-storage-pools">Determining the Health Status of ZFS Storage Pools</a>.</p>
</div>
<div class="paragraph">
<p>For more information about importing pools, see <a href="#importing-zfs-storage-pools">Importing
ZFS Storage Pools</a>.</p>
</div>
<div id="managing-devices-in-zfs-storage-pools" class="paragraph">
<p>=== Managing Devices in ZFS Storage Pools</p>
</div>
<div class="paragraph">
<p>Most of the basic information regarding devices is covered in
<a href="#components-of-a-zfs-storage-pool">Components of a ZFS Storage Pool</a>. Once a pool has been
created, you can perform several tasks to manage the physical devices
within the pool.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#adding-devices-to-a-storage-pool">Adding Devices to a Storage Pool</a></p>
</li>
<li>
<p><a href="#attaching-and-detaching-devices-in-a-storage-pool">Attaching and Detaching Devices in a Storage Pool</a></p>
</li>
<li>
<p><a href="#onlining-and-offlining-devices-in-a-storage-pool">Onlining and Offlining Devices in a Storage Pool</a></p>
</li>
<li>
<p><a href="#clearing-storage-pool-devices">Clearing Storage Pool Devices</a></p>
</li>
<li>
<p><a href="#replacing-devices-in-a-storage-pool">Replacing Devices in a Storage Pool</a></p>
</li>
<li>
<p><a href="#designating-hot-spares-in-your-storage-pool">Designating Hot Spares in Your Storage Pool</a></p>
</li>
</ul>
</div>
<div id="adding-devices-to-a-storage-pool" class="paragraph">
<p>==== Adding Devices to a Storage Pool</p>
</div>
<div class="paragraph">
<p>You can dynamically add space to a pool by adding a new top-level
virtual device. This space is immediately available to all datasets
within the pool. To add a new virtual device to a pool, use the
<code>zpool add</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool add zeepool mirror c2t1d0 c2t2d0</pre>
</div>
</div>
<div class="paragraph">
<p>The format of the virtual devices is the same as for the <code>zpool create</code>
command, and the same rules apply. Devices are checked to determine if
they are in use, and the command cannot change the level of redundancy
without the <code>f</code> option. The command also supports the <code>n</code> option so that
you can perform a dry run. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool add -n zeepool mirror c3t1d0 c3t2d0
would update 'zeepool' to the following configuration:</pre>
</div>
</div>
<div class="paragraph">
<p>This command syntax would add mirrored devices <code>c3t1d0</code> and <code>c3t2d0</code> to
`zeepool&#8217;s existing configuration.</p>
</div>
<div class="paragraph">
<p>For more information about how virtual device validation is done, see
<a href="#detecting-in-use-devices">Detecting in Use Devices</a>.</p>
</div>
<div id="gevok" class="paragraph">
<p>Adding Disks to a RAID-Z Configuration</p>
</div>
<div class="paragraph">
<p>Additional disks can be added similarly to a RAID-Z configuration. The
following example shows how to convert a storage pool with one RAID–Z
device comprised of 3 disks to a storage pool with two RAID-Z devices
comprised of 3 disks.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status
  pool: rpool
 state: ONLINE
 scrub: none requested
config:
        NAME         STATE     READ WRITE CKSUM
        rpool        ONLINE       0     0     0
          raidz1     ONLINE       0     0     0
            c1t2d0   ONLINE       0     0     0
            c1t3d0   ONLINE       0     0     0
            c1t4d0   ONLINE       0     0     0

errors: No known data errors
# zpool add rpool raidz c2t2d0 c2t3d0 c2t4d0
# zpool status
  pool: rpool
 state: ONLINE
 scrub: none requested
config:
        NAME         STATE     READ WRITE CKSUM
        rpool        ONLINE       0     0     0
          raidz1     ONLINE       0     0     0
            c1t2d0   ONLINE       0     0     0
            c1t3d0   ONLINE       0     0     0
            c1t4d0   ONLINE       0     0     0
          raidz1     ONLINE       0     0     0
            c2t2d0   ONLINE       0     0     0
            c2t3d0   ONLINE       0     0     0
            c2t4d0   ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
<div id="gfgaw" class="paragraph">
<p>Adding a Mirrored Log Device to a ZFS Storage Pool</p>
</div>
<div class="paragraph">
<p>The following example shows how to add a mirrored log device to mirrored
storage pool. For more information about using log devices in your
storage pool, see <a href="#setting-up-separate-zfs-logging-devices">Setting Up Separate ZFS Logging Devices</a>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status newpool
  pool: newpool
 state: ONLINE
 scrub: none requested
config:

        NAME         STATE     READ WRITE CKSUM
        newpool      ONLINE       0     0     0
          mirror     ONLINE       0     0     0
            c1t9d0   ONLINE       0     0     0
            c1t10d0  ONLINE       0     0     0

errors: No known data errors
# zpool add newpool log mirror c1t11d0 c1t12d0
# zpool status newpool
  pool: newpool
 state: ONLINE
 scrub: none requested
config:

        NAME         STATE     READ WRITE CKSUM
        newpool      ONLINE       0     0     0
          mirror     ONLINE       0     0     0
            c1t9d0   ONLINE       0     0     0
            c1t10d0  ONLINE       0     0     0
        logs         ONLINE       0     0     0
          mirror     ONLINE       0     0     0
            c1t11d0  ONLINE       0     0     0
            c1t12d0  ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>You can attach a log device to an existing log device to create a
mirrored log device. This operation is identical to attaching a device
in a unmirrored storage pool.</p>
</div>
<div id="gfxrx" class="paragraph">
<p>Adding and Removing Cache Devices to Your ZFS Storage Pool</p>
</div>
<div class="paragraph">
<p>You can add and remove cache devices to your ZFS storage pool.</p>
</div>
<div class="paragraph">
<p>Use the <code>zpool add</code> command to add cache devices. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool add tank cache c2t5d0 c2t8d0
# zpool status tank
  pool: tank
 state: ONLINE
 scrub: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        tank        ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c2t0d0  ONLINE       0     0     0
            c2t1d0  ONLINE       0     0     0
            c2t3d0  ONLINE       0     0     0
        cache
          c2t5d0    ONLINE       0     0     0
          c2t8d0    ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>Cache devices cannot be mirrored or be part of a RAID-Z configuration.</p>
</div>
<div class="paragraph">
<p>Use the <code>zpool remove</code> command to remove cache devices. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>E zpool remove tank c2t5d0 c2t8d0
# zpool status tank
  pool: tank
 state: ONLINE
 scrub: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        tank        ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c2t0d0  ONLINE       0     0     0
            c2t1d0  ONLINE       0     0     0
            c2t3d0  ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>Currently, the <code>zpool remove</code> command only supports removing hot spares
and cache devices. Devices that are part of the main mirrored pool
configuration can be removed by using the <code>zpool detach</code> command.
Non-redundant and RAID-Z devices cannot be removed from a pool.</p>
</div>
<div class="paragraph">
<p>For more information about using cache devices in a ZFS storage pool,
see <a href="#creating-a-zfs-storage-pool-with-cache-devices">Creating a ZFS Storage Pool with Cache Devices</a>.</p>
</div>
<div id="attaching-and-detaching-devices-in-a-storage-pool" class="paragraph">
<p>==== Attaching and Detaching Devices in a Storage Pool</p>
</div>
<div class="paragraph">
<p>In addition to the <code>zpool add</code> command, you can use the <code>zpool attach</code>
command to add a new device to an existing mirrored or non-mirrored
device.</p>
</div>
<div id="gevnu" class="paragraph">
<p>Converting a Two-Way Mirrored Storage Pool to a Three-way Mirrored
Storage Pool</p>
</div>
<div class="paragraph">
<p>In this example, <code>zeepool</code> is an existing two-way mirror that is
transformed to a three-way mirror by attaching <code>c2t1d0</code>, the new device,
to the existing device, <code>c1t1d0</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status
  pool: zeepool
 state: ONLINE
 scrub: none requested
config:
        NAME        STATE     READ WRITE CKSUM
        zeepool     ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c0t1d0  ONLINE       0     0     0
            c1t1d0  ONLINE       0     0     0
errors: No known data errors
# zpool attach zeepool c1t1d0 c2t1d0
# zpool status
  pool: zeepool
 state: ONLINE
 scrub: resilver completed with 0 errors on Fri Jan 12 14:47:36 2007
config:

        NAME        STATE     READ WRITE CKSUM
        zeepool     ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c0t1d0  ONLINE       0     0     0
            c1t1d0  ONLINE       0     0     0
            c2t1d0  ONLINE       0     0     0</pre>
</div>
</div>
<div class="paragraph">
<p>If the existing device is part of a two-way mirror, attaching the new
device, creates a three-way mirror, and so on. In either case, the new
device begins to resilver immediately.</p>
</div>
<div id="gevpf" class="paragraph">
<p>Converting a Non-Redundant ZFS Storage Pool to a Mirrored ZFS Storage</p>
</div>
<div class="paragraph">
<p>In addition, you can convert a non-redundant storage pool into a
redundant storage pool by using the <code>zpool attach</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create tank c0t1d0
# zpool status
  pool: tank
 state: ONLINE
 scrub: none requested
config:
        NAME        STATE     READ WRITE CKSUM
        tank        ONLINE       0     0     0
          c0t1d0    ONLINE       0     0     0

errors: No known data errors
# zpool attach tank c0t1d0 c1t1d0
# zpool status
  pool: tank
 state: ONLINE
 scrub: resilver completed with 0 errors on Fri Jan 12 14:55:48 2007
config:
        NAME        STATE     READ WRITE CKSUM
        tank        ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c0t1d0  ONLINE       0     0     0
            c1t1d0  ONLINE       0     0     0</pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>zpool detach</code> command to detach a device from a
mirrored storage pool. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool detach zeepool c2t1d0</pre>
</div>
</div>
<div class="paragraph">
<p>However, this operation is refused if there are no other valid replicas
of the data. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool detach newpool c1t2d0
cannot detach c1t2d0: only applicable to mirror and replacing vdevs</pre>
</div>
</div>
<div id="onlining-and-offlining-devices-in-a-storage-pool" class="paragraph">
<p>==== Onlining and Offlining Devices in a Storage Pool</p>
</div>
<div class="paragraph">
<p>ZFS allows individual devices to be taken offline or brought online.
When hardware is unreliable or not functioning properly, ZFS continues
to read or write data to the device, assuming the condition is only
temporary. If the condition is not temporary, it is possible to instruct
ZFS to ignore the device by bringing it offline. ZFS does not send any
requests to an offlined device.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Devices do not need to be taken offline in order to replace them.</p>
</div>
<div class="paragraph">
<p>You can use the <code>offline</code> command when you need to temporarily
disconnect storage. For example, if you need to physically disconnect an
array from one set of Fibre Channel switches and connect the array to a
different set, you could take the LUNs offline from the array that was
used in ZFS storage pools. After the array was reconnected and
operational on the new set of switches, you could then bring the same
LUNs online. Data that had been added to the storage pools while the
LUNs were offline would resilver to the LUNs after they were brought
back online.</p>
</div>
<div class="paragraph">
<p>This scenario is possible assuming that the systems in question see the
storage once it is attached to the new switches, possibly through
different controllers than before, and your pools are set up as RAID-Z
or mirrored configurations.</p>
</div>
<div class="sect4">
<h5 id="taking-a-device-offline"><a class="anchor" href="#taking-a-device-offline"></a>Taking a Device Offline</h5>
<div class="paragraph">
<p>You can take a device offline by using the <code>zpool offline</code> command. The
device can be specified by path or by short name, if the device is a
disk. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool offline tank c1t0d0
bringing device c1t0d0 offline</pre>
</div>
</div>
<div class="paragraph">
<p>Keep the following points in mind when taking a device offline:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You cannot take a pool offline to the point where it becomes faulted.
For example, you cannot take offline two devices out of a RAID-Z
configuration, nor can you take offline a top-level virtual device.</p>
<div class="literalblock">
<div class="content">
<pre># zpool offline tank c1t0d0
cannot offline c1t0d0: no valid replicas</pre>
</div>
</div>
</li>
<li>
<p>By default, the offline state is persistent. The device remains
offline when the system is rebooted.</p>
<div class="paragraph">
<p>To temporarily take a device offline, use the <code>zpool offline</code> <code>t</code>
option. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool offline -t tank c1t0d0
 bringing device 'c1t0d0' offline</pre>
</div>
</div>
<div class="paragraph">
<p>When the system is rebooted, this device is automatically returned to
the <code>ONLINE</code> state.</p>
</div>
</li>
<li>
<p>When a device is taken offline, it is not detached from the storage
pool. If you attempt to use the offlined device in another pool, even
after the original pool is destroyed, you will see a message similar to
the following:</p>
<div class="literalblock">
<div class="content">
<pre>device is part of exported or potentially active ZFS pool. Please see zpool(1M)</pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use the offlined device in another storage pool after
destroying the original storage pool, first bring the device back
online, then destroy the original storage pool.</p>
</div>
<div class="paragraph">
<p>Another way to use a device from another storage pool if you want to
keep the original storage pool is to replace the existing device in the
original storage pool with another comparable device. For information
about replacing devices, see <a href="#replacing-devices-in-a-storage-pool">Replacing Devices in a Storage
Pool</a>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Offlined devices show up in the <code>OFFLINE</code> state when you query pool
status. For information about querying pool status, see
<a href="#querying-zfs-storage-pool-status">Querying ZFS Storage Pool Status</a>.</p>
</div>
<div class="paragraph">
<p>For more information on device health, see <a href="#determining-the-health-status-of-zfs-storage-pools">Determining the
Health Status of ZFS Storage Pools</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="bringing-a-device-online"><a class="anchor" href="#bringing-a-device-online"></a>Bringing a Device Online</h5>
<div class="paragraph">
<p>Once a device is taken offline, it can be restored by using the
<code>zpool online</code> command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool online tank c1t0d0
bringing device c1t0d0 online</pre>
</div>
</div>
<div class="paragraph">
<p>When a device is brought online, any data that has been written to the
pool is resynchronized to the newly available device. Note that you
cannot use device onlining to replace a disk. If you offline a device,
replace the drive, and try to bring it online, it remains in the faulted
state.</p>
</div>
<div class="paragraph">
<p>If you attempt to online a faulted device, a message similar to the
following is displayed from <code>fmd</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool online tank c1t0d0
Bringing device c1t0d0 online
#
SUNW-MSG-ID: ZFS-8000-D3, TYPE: Fault, VER: 1, SEVERITY: Major
EVENT-TIME: Thu Aug 31 11:13:59 MDT 2006
PLATFORM: SUNW,Ultra-60, CSN: -, HOSTNAME: neo
SOURCE: zfs-diagnosis, REV: 1.0
EVENT-ID: e11d8245-d76a-e152-80c6-e63763ed7e4f
DESC: A ZFS device failed.  Refer to http://illumos.org/msg/ZFS-8000-D3 for more information.
AUTO-RESPONSE: No automated response will occur.
IMPACT: Fault tolerance of the pool may be compromised.
REC-ACTION: Run 'zpool status -x' and replace the bad device.</pre>
</div>
</div>
<div class="paragraph">
<p>For more information on replacing a faulted device, see
<a href="#repairing-a-missing-device">Repairing a Missing Device</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clearing-storage-pool-devices"><a class="anchor" href="#clearing-storage-pool-devices"></a>3.3.4. Clearing Storage Pool Devices</h4>
<div class="paragraph">
<p>If a device is taken offline due to a failure that causes errors to be
listed in the <code>zpool status</code> output, you can clear the error counts with
the <code>zpool clear</code> command.</p>
</div>
<div class="paragraph">
<p>If specified with no arguments, this command clears all device errors
within the pool. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool clear tank</pre>
</div>
</div>
<div class="paragraph">
<p>If one or more devices are specified, this command only clear errors
associated with the specified devices. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool clear tank c1t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>For more information on clearing <code>zpool</code> errors, see
<a href="#clearing-transient-errors">Clearing Transient Errors</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="replacing-devices-in-a-storage-pool"><a class="anchor" href="#replacing-devices-in-a-storage-pool"></a>3.3.5. Replacing Devices in a Storage Pool</h4>
<div class="paragraph">
<p>You can replace a device in a storage pool by using the <code>zpool replace</code>
command.</p>
</div>
<div class="paragraph">
<p>If you are physically replacing a device with another device in the same
location in a redundant pool, then you only need identify the replaced
device. ZFS recognizes that it is a different disk in the same location.
For example, to replace a failed disk (<code>c1t1d0</code>) by removing the disk
and replacing it in the same location, use the syntax similar to the
following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool replace tank c1t1d0</pre>
</div>
</div>
<div class="paragraph">
<p>If you are replacing a device in a non-redundant storage pool that
contains only one device, you will need to specify both devices. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool replace tank c1t1d0 c1t2d0</pre>
</div>
</div>
<div class="paragraph">
<p>Keep the following considerations in mind when replacing devices in a
ZFS storage pool:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The replacement device must be greater than or equal to the minimum
size of all the devices in a mirrored or RAID-Z configuration.</p>
</li>
<li>
<p>If the replacement device is larger, the pool capacity is increased
when the replacement is complete. Currently, you must export and import
the pool to see the expanded capacity. For example:</p>
<div class="literalblock">
<div class="content">
<pre># zpool list tank
NAME   SIZE   USED  AVAIL    CAP  HEALTH  ALTROOT
tank  16.8G    94K  16.7G     0%  ONLINE  -
# zpool replace tank c0t0d0 c0t4d0
# zpool list tank
NAME   SIZE   USED  AVAIL    CAP  HEALTH  ALTROOT
tank  16.8G   112K  16.7G     0%  ONLINE  -
# zpool export tank
# zpool import tank
# zpool list tank
NAME   SIZE   USED  AVAIL    CAP  HEALTH  ALTROOT
tank  33.9G   114K  33.9G     0%  ONLINE  -</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about exporting and importing pools, see
<a href="#migrating-zfs-storage-pools">Migrating ZFS Storage Pools</a>.</p>
</div>
</li>
<li>
<p>Currently, you must also perform the export and import steps when
growing the size of an existing LUN that is part of a storage pool to
see the expanded capacity.</p>
</li>
<li>
<p>Replacing many disks in a large pool is time consuming due to
resilvering the data onto the new disks. In addition, you might consider
running the <code>zpool scrub</code> command between disk replacements to ensure
that the replacement devices are operational and the data is written
correctly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about replacing devices, see <a href="#repairing-a-missing-device">Repairing
a Missing Device</a> and <a href="#repairing-a-damaged-device">Repairing a Damaged Device</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="designating-hot-spares-in-your-storage-pool"><a class="anchor" href="#designating-hot-spares-in-your-storage-pool"></a>3.3.6. Designating Hot Spares in Your Storage Pool</h4>
<div class="paragraph">
<p>The hot spares feature enables you to identify disks that could be used
to replace a failed or faulted device in one or more storage pools.
Designating a device as a <em>hot spare</em> means that the device is not an
active device in a pool, but if an active device in the pool fails, the
hot spare automatically replaces the failed device.</p>
</div>
<div class="paragraph">
<p>Devices can be designated as hot spares in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the pool is created with the <code>zpool create</code> command</p>
</li>
<li>
<p>After the pool is created with the <code>zpool add</code> command</p>
</li>
<li>
<p>Hot spare devices can be shared between multiple pools</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Designate devices as hot spares when the pool is created. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create zeepool mirror c1t1d0 c2t1d0 spare c1t2d0 c2t2d0
# zpool status zeepool
pool: zeepool
 state: ONLINE
 scrub: none requested
config:

        NAME         STATE     READ WRITE CKSUM
        zeepool      ONLINE       0     0     0
          mirror     ONLINE       0     0     0
            c1t1d0   ONLINE       0     0     0
            c2t1d0   ONLINE       0     0     0
          c1t2d0     AVAIL
          c2t2d0     AVAIL</pre>
</div>
</div>
<div class="paragraph">
<p>Designate hot spares by adding them to a pool after the pool is created.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool add -f zeepool spare c1t3d0 c2t3d0
# zpool status zeepool
pool: zeepool
 state: ONLINE
 scrub: none requested
config:

        NAME         STATE     READ WRITE CKSUM
        zeepool      ONLINE       0     0     0
          mirror     ONLINE       0     0     0
            c1t1d0   ONLINE       0     0     0
            c2t1d0   ONLINE       0     0     0
          c1t3d0     AVAIL
          c2t3d0     AVAIL</pre>
</div>
</div>
<div class="paragraph">
<p>Multiple pools can share devices that are designated as hot spares. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create zeepool mirror c1t1d0 c2t1d0 spare c1t2d0 c2t2d0
# zpool create tank raidz c3t1d0 c4t1d0 spare c1t2d0 c2t2d0</pre>
</div>
</div>
<div class="paragraph">
<p>Hot spares can be removed from a storage pool by using the
<code>zpool remove</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool remove zeepool c1t2d0
# zpool status zeepool
pool: zeepool
 state: ONLINE
 scrub: none requested
config:

        NAME         STATE     READ WRITE CKSUM
        zeepool      ONLINE       0     0     0
          mirror     ONLINE       0     0     0
            c1t1d0   ONLINE       0     0     0
            c2t1d0   ONLINE       0     0     0
          c1t3d0     AVAIL</pre>
</div>
</div>
<div class="paragraph">
<p>A hot spare cannot be removed if it is currently used by the storage
pool.</p>
</div>
<div class="paragraph">
<p>Keep the following points in mind when using ZFS hot spares:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Currently, the <code>zpool remove</code> command can only be used to remove hot
spares.</p>
</li>
<li>
<p>Add a disk as a spare that is equal to or larger than the size of the
largest disk in the pool. Adding a smaller disk as a spare to a pool is
allowed. However, when the smaller spare disk is activated, either
automatically or with the <code>zpool replace</code> command, the operation fails
with an error similar to the following:</p>
<div class="literalblock">
<div class="content">
<pre>cannot replace disk3 with disk4: device is too small</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="activating-and-deactivating-hot-spares-in-your-storage-pool"><a class="anchor" href="#activating-and-deactivating-hot-spares-in-your-storage-pool"></a>Activating and Deactivating Hot Spares in Your Storage Pool</h5>
<div class="paragraph">
<p>Hot spares are activated in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Manually replacement – Replace a failed device in a storage pool with
a hot spare by using the <code>zpool replace</code> command.</p>
</li>
<li>
<p>Automatic replacement – When a fault is received, an FMA agent
examines the pool to see if it has any available hot spares. If so, it
replaces the faulted device with an available spare.</p>
<div class="paragraph">
<p>If a hot spare that is currently in use fails, the agent detaches the
spare and thereby cancels the replacement. The agent then attempts to
replace the device with another hot spare, if one is available. This
feature is currently limited by the fact that the ZFS diagnosis engine
only emits faults when a device disappears from the system.</p>
</div>
<div class="paragraph">
<p>Currently, no automated response is available to bring the original
device back online. You must explicitly take one of the actions
described in the example below. A future enhancement will allow ZFS to
subscribe to hotplug events and automatically replace the affected
device when it is replaced on the system.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Manually replace a device with a hot spare by using the <code>zpool replace</code>
command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool replace zeepool c2t1d0 c2t3d0
# zpool status zeepool
  pool: zeepool
 state: ONLINE
 scrub: resilver completed with 0 errors on Fri Jun  2 13:44:40 2006
config:

        NAME            STATE     READ WRITE CKSUM
        zeepool         ONLINE       0     0     0
          mirror        ONLINE       0     0     0
            c1t2d0      ONLINE       0     0     0
            spare       ONLINE       0     0     0
              c2t1d0    ONLINE       0     0     0
              c2t3d0    ONLINE       0     0     0
          c1t3d0        AVAIL
          c2t3d0        INUSE     currently in use

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>A faulted device is automatically replaced if a hot spare is available.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -x
  pool: zeepool
 state: DEGRADED
status: One or more devices could not be opened.  Sufficient replicas exist for
        the pool to continue functioning in a degraded state.
action: Attach the missing device and online it using 'zpool online'.
   see: http://illumos.org/msg/ZFS-8000-D3
 scrub: resilver completed with 0 errors on Fri Jun  2 13:56:49 2006
config:

        NAME                 STATE     READ WRITE CKSUM
        zeepool              DEGRADED     0     0     0
          mirror             DEGRADED     0     0     0
            c1t2d0           ONLINE       0     0     0
            spare            DEGRADED     0     0     0
              c2t1d0         UNAVAIL      0     0     0  cannot open
              c2t3d0         ONLINE       0     0     0
          c1t3d0             AVAIL
          c2t3d0             INUSE     currently in use

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>Currently, three ways to deactivate hot spares are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Canceling the hot spare by removing it from the storage pool</p>
</li>
<li>
<p>Replacing the original device with a hot spare</p>
</li>
<li>
<p>Permanently swapping in the hot spare</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After the faulted device is replaced, use the <code>zpool detach</code> command to
return the hot spare back to the spare set. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool detach zeepool c2t3d0
# zpool status zeepool
  pool: zeepool
 state: ONLINE
 scrub: resilver completed with 0 errors on Fri Jun  2 13:58:35 2006
config:

        NAME               STATE     READ WRITE CKSUM
        zeepool            ONLINE       0     0     0
          mirror           ONLINE       0     0     0
            c1t2d0         ONLINE       0     0     0
            c2t1d0         ONLINE       0     0     0
          c1t3d0           AVAIL
          c2t3d0           AVAIL

errors: No known data errors</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="managing-zfs-storage-pool-properties"><a class="anchor" href="#managing-zfs-storage-pool-properties"></a>3.4. Managing ZFS Storage Pool Properties</h3>
<div class="paragraph">
<p>You can use the <code>zpool get</code> command to display pool property
information. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool get all tank2
NAME   PROPERTY     VALUE       SOURCE
tank2  size         33.8G       -
tank2  used         158K        -
tank2  available    33.7G       -
tank2  capacity     0%          -
tank2  altroot      -           default
tank2  health       ONLINE      -
tank2  guid         8032621780930948264  -
tank2  version      8           default
tank2  bootfs       -           default
tank2  delegation   on          default
tank2  autoreplace  off         default
tank2  temporary    off         default
tank2  failmode     wait        default</pre>
</div>
</div>
<div class="paragraph">
<p>Storage pool properties can be set with the <code>zpool set</code> command. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool set autoreplace=on tank
# zpool get autoreplace tank
NAME  PROPERTY     VALUE    SOURCE
tank  autoreplace  on       default</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. ZFS Pool Property Descriptions</caption>
<colgroup>
<col style="width: 18%;">
<col style="width: 11%;">
<col style="width: 13%;">
<col style="width: 58%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>altroot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">off</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identifies an alternate root directory. If set,
this directory is prepended to any mount points within the pool. This
property can be used when examining an unknown pool, if the mount points
cannot be trusted, or in an alternate boot environment, where the
typical paths are not valid. Setting this property implies that the
<code>temporary</code> property is also set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>available</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Read-only value that identifies the amount of storage that is available
within the pool.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
<code>avail</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>autoreplace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>off</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls automatic device replacement.
If set to off, device replacement must be initiated by the administrator
by using the <code>zpool</code> <code>replace</code> command. If set to on, any new device,
found in the same physical location as a device that previously belonged
to the pool, is automatically formatted and replaced. The default
behavior is off. This property can also be referred to by its shortened
column name, <code>replace</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bootfs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identifies the default bootable dataset for the
root pool. This property is expected to be set mainly by the
installation and upgrade programs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>capacity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Read-only value that identifies the percentage of pool space used.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
<code>cap</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>on</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether a non-privileged user can
be granted access permissions that are defined for the dataset. For more
information, see <a href="#zfs-delegated-administration">ZFS Delegated Administration</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>guid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only property that identifies the unique
identifier for the pool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>health</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only property that identifies the current
health of the pool, as either ONLINE, DEGRADED, FAULTED, OFFLINE,
REMOVED, or UNAVAIL.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only property that identifies the total size of
the storage pool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">used</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only property that identifies the amount of
storage space used within the pool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">temporary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">off</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls whether the pool is available temporarily. By default, all
pools are persistent, and are automatically opened when the system is
rebooted. Setting this property to <code>on</code> causes the pool to exist only
while the system is up. If the system is rebooted, the pool has to be
manually imported by using the <code>zpool import</code> command. Setting this
property is helpful when using pools on removable media, where the
devices might not be present when the system reboots.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
<code>temp</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identifies the current on-disk version of the
pool. The value of this property can be increased, but never decreased.
The preferred method of updating pools is with the <code>zpool upgrade</code>
command, although this property can be used when a specific version is
needed for backwards compatibility. This property can be set to any
number between 1 and the current version reported by the <code>zpool upgrade</code>
<code>v</code> command. The <code>current</code> value is an alias for the latest supported
version.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="querying-zfs-storage-pool-status"><a class="anchor" href="#querying-zfs-storage-pool-status"></a>3.5. Querying ZFS Storage Pool Status</h3>
<div class="paragraph">
<p>The <code>zpool list</code> command provides a number of ways to request
information regarding pool status. The information available generally
falls into three categories: basic usage information, I/O statistics,
and health status. All three types of storage pool information are
covered in this section.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#displaying-basic-zfs-storage-pool-information">Displaying Basic ZFS Storage Pool Information</a></p>
</li>
<li>
<p><a href="#viewing-zfs-storage-pool-io-statistics">Viewing ZFS Storage Pool I/O Statistics</a></p>
</li>
<li>
<p><a href="#determining-the-health-status-of-zfs-storage-pools">Determining the Health Status of ZFS Storage Pools</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="displaying-basic-zfs-storage-pool-information"><a class="anchor" href="#displaying-basic-zfs-storage-pool-information"></a>3.5.1. Displaying Basic ZFS Storage Pool Information</h4>
<div class="paragraph">
<p>You can use the <code>zpool list</code> command to display basic information about
pools.</p>
</div>
<div class="sect4">
<h5 id="listing-information-about-all-storage-pools"><a class="anchor" href="#listing-information-about-all-storage-pools"></a>Listing Information About All Storage Pools</h5>
<div class="paragraph">
<p>With no arguments, the command displays all the fields for all pools on
the system. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool list
NAME                    SIZE    USED   AVAIL    CAP  HEALTH     ALTROOT
tank                   80.0G   22.3G   47.7G    28%  ONLINE     -
dozer                   1.2T    384G    816G    32%  ONLINE     -</pre>
</div>
</div>
<div class="paragraph">
<p>This output displays the following information:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>NAME</code></dt>
<dd>
<p>The name of the pool.</p>
</dd>
<dt class="hdlist1"><code>SIZE</code></dt>
<dd>
<p>The total size of the pool, equal to the sum of the size of all
top-level virtual devices.</p>
</dd>
<dt class="hdlist1"><code>USED</code></dt>
<dd>
<p>The amount of space allocated by all datasets and internal metadata.
Note that this amount is different from the amount of space as
reported at the file system level.
+
For more information about determining available file system space,
see <a href="#zfs-space-accounting">ZFS Space Accounting</a>.</p>
</dd>
<dt class="hdlist1"><code>AVAILABLE</code></dt>
<dd>
<p>The amount of unallocated space in the pool.</p>
</dd>
<dt class="hdlist1"><code>CAPACITY</code> (<code>CAP</code>)</dt>
<dd>
<p>The amount of space used, expressed as a percentage of total space.</p>
</dd>
<dt class="hdlist1"><code>HEALTH</code></dt>
<dd>
<p>The current health status of the pool.
+
For more information about pool health, see <a href="#determining-the-health-status-of-zfs-storage-pools">Determining
the Health Status of ZFS Storage Pools</a>.</p>
</dd>
<dt class="hdlist1"><code>ALTROOT</code></dt>
<dd>
<p>The alternate root of the pool, if any.
+
For more information about alternate root pools, see <a href="#using-zfs-alternate-root-pools">Using
ZFS Alternate Root Pools</a>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can also gather statistics for a specific pool by specifying the
pool name. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool list tank
NAME                    SIZE    USED   AVAIL    CAP  HEALTH     ALTROOT
tank                   80.0G   22.3G   47.7G    28%  ONLINE     -</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="listing-specific-storage-pool-statistics"><a class="anchor" href="#listing-specific-storage-pool-statistics"></a>Listing Specific Storage Pool Statistics</h5>
<div class="paragraph">
<p>Specific statistics can be requested by using the <code>o</code> option. This
option allows for custom reports or a quick way to list pertinent
information. For example, to list only the name and size of each pool,
you use the following syntax:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool list -o name,size
NAME                    SIZE
tank                   80.0G
dozer                   1.2T</pre>
</div>
</div>
<div class="paragraph">
<p>The column names correspond to the properties that are listed in
<a href="#listing-information-about-all-storage-pools">Listing Information About All Storage Pools</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="scripting-zfs-storage-pool-output"><a class="anchor" href="#scripting-zfs-storage-pool-output"></a>Scripting ZFS Storage Pool Output</h5>
<div class="paragraph">
<p>The default output for the <code>zpool list</code> command is designed for
readability, and is not easy to use as part of a shell script. To aid
programmatic uses of the command, the <code>H</code> option can be used to suppress
the column headings and separate fields by tabs, rather than by spaces.
For example, to request a simple list of all pool names on the system:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool list -Ho name</pre>
</div>
</div>
<div class="paragraph">
<p>Here is another example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool list -H -o name,size
tank   80.0G
dozer  1.2T</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="viewing-zfs-storage-pool-io-statistics"><a class="anchor" href="#viewing-zfs-storage-pool-io-statistics"></a>3.5.2. Viewing ZFS Storage Pool I/O Statistics</h4>
<div class="paragraph">
<p>To request I/O statistics for a pool or specific virtual devices, use
the <code>zpool iostat</code> command. Similar to the <code>iostat</code> command, this
command can display a static snapshot of all I/O activity so far, as
well as updated statistics for every specified interval. The following
statistics are reported:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>USED CAPACITY</code></dt>
<dd>
<p>The amount of data currently stored in the pool or device. This figure
differs from the amount of space available to actual file systems by a
small amount due to internal implementation details.
+
For more information about the difference between pool space and
dataset space, see <a href="#zfs-space-accounting">ZFS Space Accounting</a>.</p>
</dd>
<dt class="hdlist1"><code>AVAILABLE CAPACITY</code></dt>
<dd>
<p>The amount of space available in the pool or device. As with the
<code>used</code> statistic, this amount differs from the amount of space
available to datasets by a small margin.</p>
</dd>
<dt class="hdlist1"><code>READ OPERATIONS</code></dt>
<dd>
<p>The number of read I/O operations sent to the pool or device,
including metadata requests.</p>
</dd>
<dt class="hdlist1"><code>WRITE OPERATIONS</code></dt>
<dd>
<p>The number of write I/O operations sent to the pool or device.</p>
</dd>
<dt class="hdlist1"><code>READ BANDWIDTH</code></dt>
<dd>
<p>The bandwidth of all read operations (including metadata), expressed
as units per second.</p>
</dd>
<dt class="hdlist1"><code>WRITE BANDWIDTH</code></dt>
<dd>
<p>The bandwidth of all write operations, expressed as units per second.</p>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="listing-pool-wide-statistics"><a class="anchor" href="#listing-pool-wide-statistics"></a>Listing Pool-Wide Statistics</h5>
<div class="paragraph">
<p>With no options, the <code>zpool iostat</code> command displays the accumulated
statistics since boot for all pools on the system. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool iostat
               capacity     operations    bandwidth
pool         used  avail   read  write   read  write
----------  -----  -----  -----  -----  -----  -----
tank         100G  20.0G   1.2M   102K   1.2M  3.45K
dozer       12.3G  67.7G   132K  15.2K  32.1K  1.20K</pre>
</div>
</div>
<div class="paragraph">
<p>Because these statistics are cumulative since boot, bandwidth might
appear low if the pool is relatively idle. You can request a more
accurate view of current bandwidth usage by specifying an interval. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool iostat tank 2
               capacity     operations    bandwidth
pool         used  avail   read  write   read  write
----------  -----  -----  -----  -----  -----  -----
tank         100G  20.0G   1.2M   102K   1.2M  3.45K
tank         100G  20.0G    134      0  1.34K      0
tank         100G  20.0G     94    342  1.06K   4.1M</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the command displays usage statistics only for the pool
<code>tank</code> every two seconds until you type Ctrl-C. Alternately, you can
specify an additional <code>count</code> parameter, which causes the command to
terminate after the specified number of iterations. For example,
<code>zpool iostat 2 3</code> would print a summary every two seconds for three
iterations, for a total of six seconds. If there is a single pool, then
the statistics are displayed on consecutive lines. If more than one pool
exists, then an additional dashed line delineates each iteration to
provide visual separation.</p>
</div>
</div>
<div class="sect4">
<h5 id="listing-virtual-device-statistics"><a class="anchor" href="#listing-virtual-device-statistics"></a>Listing Virtual Device Statistics</h5>
<div class="paragraph">
<p>In addition to pool-wide I/O statistics, the <code>zpool iostat</code> command can
display statistics for specific virtual devices. This command can be
used to identify abnormally slow devices, or simply to observe the
distribution of I/O generated by ZFS. To request the complete virtual
device layout as well as all I/O statistics, use the <code>zpool iostat -v</code>
command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool iostat -v
               capacity     operations    bandwidth
tank         used  avail   read  write   read  write
----------  -----  -----  -----  -----  -----  -----
mirror      20.4G  59.6G      0     22      0  6.00K
  c1t0d0        -      -      1    295  11.2K   148K
  c1t1d0        -      -      1    299  11.2K   148K
----------  -----  -----  -----  -----  -----  -----
total       24.5K   149M      0     22      0  6.00K</pre>
</div>
</div>
<div class="paragraph">
<p>Note two important things when viewing I/O statistics on a virtual
device basis.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, space usage is only available for top-level virtual devices.
The way in which space is allocated among mirror and RAID-Z virtual
devices is particular to the implementation and not easily expressed as
a single number.</p>
</li>
<li>
<p>Second, the numbers might not add up exactly as you would expect them
to. In particular, operations across RAID-Z and mirrored devices will
not be exactly equal. This difference is particularly noticeable
immediately after a pool is created, as a significant amount of I/O is
done directly to the disks as part of pool creation that is not
accounted for at the mirror level. Over time, these numbers should
gradually equalize, although broken, unresponsive, or offlined devices
can affect this symmetry as well.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use the same set of options (interval and count) when examining
virtual device statistics.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="determining-the-health-status-of-zfs-storage-pools"><a class="anchor" href="#determining-the-health-status-of-zfs-storage-pools"></a>3.5.3. Determining the Health Status of ZFS Storage Pools</h4>
<div class="paragraph">
<p>ZFS provides an integrated method of examining pool and device health.
The health of a pool is determined from the state of all its devices.
This state information is displayed by using the <code>zpool status</code> command.
In addition, potential pool and device failures are reported by <code>fmd</code>
and are displayed on the system console and the <code>/var/adm/messages</code>
file. This section describes how to determine pool and device health.
This chapter does not document how to repair or recover from unhealthy
pools. For more information on troubleshooting and data recovery, see
<a href="#zfs-troubleshooting-and-data-recovery">ZFS Troubleshooting and Data Recovery</a>.</p>
</div>
<div class="paragraph">
<p>Each device can fall into one of the following states:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>ONLINE</code></dt>
<dd>
<p>The device is in normal working order. While some transient errors
might still occur, the device is otherwise in working order.</p>
</dd>
<dt class="hdlist1"><code>DEGRADED</code></dt>
<dd>
<p>The virtual device has experienced failure but is still able to
function. This state is most common when a mirror or RAID-Z device has
lost one or more constituent devices. The fault tolerance of the pool
might be compromised, as a subsequent fault in another device might be
unrecoverable.</p>
</dd>
<dt class="hdlist1"><code>FAULTED</code></dt>
<dd>
<p>The virtual device is completely inaccessible. This status typically
indicates total failure of the device, such that ZFS is incapable of
sending or receiving data from it. If a top-level virtual device is in
this state, then the pool is completely inaccessible.</p>
</dd>
<dt class="hdlist1"><code>OFFLINE</code></dt>
<dd>
<p>The virtual device has been explicitly taken offline by the
administrator.</p>
</dd>
<dt class="hdlist1"><code>UNAVAILABLE</code></dt>
<dd>
<p>The device or virtual device cannot be opened. In some cases, pools
with <code>UNAVAILABLE</code> devices appear in <code>DEGRADED</code> mode. If a top-level
virtual device is unavailable, then nothing in the pool can be
accessed.</p>
</dd>
<dt class="hdlist1">REMOVED</dt>
<dd>
<p>The device was physically removed while the system was running. Device
removal detection is hardware-dependent and might not be supported on
all platforms.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The health of a pool is determined from the health of all its top-level
virtual devices. If all virtual devices are <code>ONLINE</code>, then the pool is
also <code>ONLINE</code>. If any one of the virtual devices is <code>DEGRADED</code> or
<code>UNAVAILABLE</code>, then the pool is also <code>DEGRADED</code>. If a top-level virtual
device is <code>FAULTED</code> or <code>OFFLINE</code>, then the pool is also <code>FAULTED</code>. A
pool in the faulted state is completely inaccessible. No data can be
recovered until the necessary devices are attached or repaired. A pool
in the degraded state continues to run, but you might not achieve the
same level of data redundancy or data throughput than if the pool were
online.</p>
</div>
<div class="sect4">
<h5 id="basic-storage-pool-health-status"><a class="anchor" href="#basic-storage-pool-health-status"></a>Basic Storage Pool Health Status</h5>
<div class="paragraph">
<p>The simplest way to request a quick overview of pool health status is to
use the <code>zpool status</code> command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -x
all pools are healthy</pre>
</div>
</div>
<div class="paragraph">
<p>Specific pools can be examined by specifying a pool name to the command.
Any pool that is not in the <code>ONLINE</code> state should be investigated for
potential problems, as described in the next section.</p>
</div>
</div>
<div class="sect4">
<h5 id="detailed-health-status"><a class="anchor" href="#detailed-health-status"></a>Detailed Health Status</h5>
<div class="paragraph">
<p>You can request a more detailed health summary by using the <code>v</code> option.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -v tank
  pool: tank
 state: DEGRADED
status: One or more devices could not be opened.  Sufficient replicas exist
        for the pool to continue functioning in a degraded state.
action: Attach the missing device and online it using 'zpool online'.
   see: http://illumos.org/msg/ZFS-8000-2Q
 scrub: none requested
config:

        NAME                STATE     READ WRITE CKSUM
        tank                DEGRADED     0     0     0
          mirror            DEGRADED     0     0     0
            c1t0d0          FAULTED      0     0     0  cannot open
            c1t1d0          ONLINE       0     0     0
errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>This output displays a complete description of why the pool is in its
current state, including a readable description of the problem and a
link to a knowledge article for more information. Each knowledge article
provides up-to-date information on the best way to recover from your
current problem. Using the detailed configuration information, you
should be able to determine which device is damaged and how to repair
the pool.</p>
</div>
<div class="paragraph">
<p>In the above example, the faulted device should be replaced. After the
device is replaced, use the <code>zpool online</code> command to bring the device
back online. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool online tank c1t0d0
Bringing device c1t0d0 online
# zpool status -x
all pools are healthy</pre>
</div>
</div>
<div class="paragraph">
<p>If a pool has an offlined device, the command output identifies the
problem pool. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -x
  pool: tank
 state: DEGRADED
status: One or more devices has been taken offline by the adminstrator.
        Sufficient replicas exist for the pool to continue functioning in a
        degraded state.
action: Online the device using 'zpool online' or replace the device with
        'zpool replace'.
 scrub: none requested
config:

        NAME         STATE     READ WRITE CKSUM
        tank         DEGRADED     0     0     0
          mirror     DEGRADED     0     0     0
             c1t0d0  ONLINE       0     0     0
             c1t1d0  OFFLINE      0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>READ</code> and <code>WRITE</code> columns provides a count of I/O errors seen on
the device, while the <code>CKSUM</code> column provides a count of uncorrectable
checksum errors that occurred on the device. Both of these error counts
likely indicate potential device failure, and some corrective action is
needed. If non-zero errors are reported for a top-level virtual device,
portions of your data might have become inaccessible. The errors count
identifies any known data errors.</p>
</div>
<div class="paragraph">
<p>In the example output above, the offlined device is not causing data
errors.</p>
</div>
<div class="paragraph">
<p>For more information about diagnosing and repairing faulted pools and
data, see <a href="#zfs-troubleshooting-and-data-recovery">ZFS Troubleshooting and Data Recovery</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="migrating-zfs-storage-pools"><a class="anchor" href="#migrating-zfs-storage-pools"></a>3.6. Migrating ZFS Storage Pools</h3>
<div class="paragraph">
<p>Occasionally, you might need to move a storage pool between machines. To
do so, the storage devices must be disconnected from the original
machine and reconnected to the destination machine. This task can be
accomplished by physically recabling the devices, or by using
multiported devices such as the devices on a SAN. ZFS enables you to
export the pool from one machine and import it on the destination
machine, even if the machines are of different endianness. For
information about replicating or migrating file systems between
different storage pools, which might reside on different machines, see
<a href="#saving-and-restoring-zfs-data">Saving and Restoring ZFS Data</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#preparing-for-zfs-storage-pool-migration">Preparing for ZFS Storage Pool Migration</a></p>
</li>
<li>
<p><a href="#exporting-a-zfs-storage-pool">Exporting a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#determining-available-storage-pools-to-import">Determining Available Storage Pools to Import</a></p>
</li>
<li>
<p><a href="#finding-zfs-storage-pools-from-alternate-directories">Finding ZFS Storage Pools From Alternate Directories</a></p>
</li>
<li>
<p><a href="#importing-zfs-storage-pools">Importing ZFS Storage Pools</a></p>
</li>
<li>
<p><a href="#recovering-destroyed-zfs-storage-pools">Recovering Destroyed ZFS Storage Pools</a></p>
</li>
<li>
<p><a href="#upgrading-zfs-storage-pools">Upgrading ZFS Storage Pools</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="preparing-for-zfs-storage-pool-migration"><a class="anchor" href="#preparing-for-zfs-storage-pool-migration"></a>3.6.1. Preparing for ZFS Storage Pool Migration</h4>
<div class="paragraph">
<p>Storage pools should be explicitly exported to indicate that they are
ready to be migrated. This operation flushes any unwritten data to disk,
writes data to the disk indicating that the export was done, and removes
all knowledge of the pool from the system.</p>
</div>
<div class="paragraph">
<p>If you do not explicitly export the pool, but instead remove the disks
manually, you can still import the resulting pool on another system.
However, you might lose the last few seconds of data transactions, and
the pool will appear faulted on the original machine because the devices
are no longer present. By default, the destination machine refuses to
import a pool that has not been explicitly exported. This condition is
necessary to prevent accidentally importing an active pool that consists
of network attached storage that is still in use on another system.</p>
</div>
</div>
<div class="sect3">
<h4 id="exporting-a-zfs-storage-pool"><a class="anchor" href="#exporting-a-zfs-storage-pool"></a>3.6.2. Exporting a ZFS Storage Pool</h4>
<div class="paragraph">
<p>To export a pool, use the <code>zpool export</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool export tank</pre>
</div>
</div>
<div class="paragraph">
<p>Once this command is executed, the pool <code>tank</code> is no longer visible on
the system. The command attempts to unmount any mounted file systems
within the pool before continuing. If any of the file systems fail to
unmount, you can forcefully unmount them by using the <code>f</code> option. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool export tank
cannot unmount '/export/home/eschrock': Device busy
# zpool export -f tank</pre>
</div>
</div>
<div class="paragraph">
<p>If devices are unavailable at the time of export, the disks cannot be
specified as cleanly exported. If one of these devices is later attached
to a system without any of the working devices, it appears as
“potentially active.” If ZFS volumes are in use in the pool, the pool
cannot be exported, even with the <code>f</code> option. To export a pool with an
ZFS volume, first make sure that all consumers of the volume are no
longer active.</p>
</div>
<div class="paragraph">
<p>For more information about ZFS volumes, see <a href="#zfs-volumes">ZFS Volumes</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="determining-available-storage-pools-to-import"><a class="anchor" href="#determining-available-storage-pools-to-import"></a>3.6.3. Determining Available Storage Pools to Import</h4>
<div class="paragraph">
<p>Once the pool has been removed from the system (either through export or
by forcefully removing the devices), attach the devices to the target
system. Although ZFS can handle some situations in which only a portion
of the devices is available, all devices within the pool must be moved
between the systems. The devices do not necessarily have to be attached
under the same device name. ZFS detects any moved or renamed devices,
and adjusts the configuration appropriately. To discover available
pools, run the <code>zpool import</code> command with no options. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import
  pool: tank
    id: 3778921145927357706
 state: ONLINE
action: The pool can be imported using its name or numeric identifier.
config:

        tank        ONLINE
          mirror    ONLINE
            c1t0d0  ONLINE
            c1t1d0  ONLINE</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the pool <code>tank</code> is available to be imported on the
target system. Each pool is identified by a name as well as a unique
numeric identifier. If multiple pools available to import have the same
name, you can use the numeric identifier to distinguish between them.</p>
</div>
<div class="paragraph">
<p>Similar to the <code>zpool status</code> command, the <code>zpool import</code> command refers
to a knowledge article available on the web with the most up-to-date
information regarding repair procedures for a problem that is preventing
a pool from being imported. In this case, the user can force the pool to
be imported. However, importing a pool that is currently in use by
another system over a storage network can result in data corruption and
panics as both systems attempt to write to the same storage. If some
devices in the pool are not available but enough redundancy is available
to have a usable pool, the pool appears in the <code>DEGRADED</code> state. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import
  pool: tank
    id: 3778921145927357706
 state: DEGRADED
status: One or more devices are missing from the system.
action: The pool can be imported despite missing or damaged devices.  The
        fault tolerance of the pool may be compromised if imported.
   see: http://illumos.org/msg/ZFS-8000-2Q
config:

        tank         DEGRADED
          mirror     DEGRADED
            c1t0d0   UNAVAIL   cannot open
            c1t1d0   ONLINE</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the first disk is damaged or missing, though you can
still import the pool because the mirrored data is still accessible. If
too many faulted or missing devices are present, the pool cannot be
imported. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import
  pool: dozer
    id: 12090808386336829175
 state: FAULTED
action: The pool cannot be imported. Attach the missing
        devices and try again.
   see: http://illumos.org/msg/ZFS-8000-6X
config:
        raidz               FAULTED
          c1t0d0    ONLINE
          c1t1d0    FAULTED
          c1t2d0    ONLINE
          c1t3d0    FAULTED</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, two disks are missing from a RAID-Z virtual device,
which means that sufficient redundant data is not available to
reconstruct the pool. In some cases, not enough devices are present to
determine the complete configuration. In this case, ZFS doesn&#8217;t know
what other devices were part of the pool, though ZFS does report as much
information as possible about the situation. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import
pool: dozer
    id: 12090808386336829175
 state: FAULTED
status: One or more devices are missing from the system.
action: The pool cannot be imported. Attach the missing
        devices and try again.
   see: http://illumos.org/msg/ZFS-8000-6X
config:
        dozer          FAULTED   missing device
          raidz       ONLINE
            c1t0d0    ONLINE
            c1t1d0    ONLINE
            c1t2d0    ONLINE
            c1t3d0    ONLINE
        Additional devices are known to be part of this pool, though their
        exact configuration cannot be determined.</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="finding-zfs-storage-pools-from-alternate-directories"><a class="anchor" href="#finding-zfs-storage-pools-from-alternate-directories"></a>3.6.4. Finding ZFS Storage Pools From Alternate Directories</h4>
<div class="paragraph">
<p>By default, the <code>zpool import</code> command only searches devices within the
<code>/dev/dsk</code> directory. If devices exist in another directory, or you are
using pools backed by files, you must use the <code>d</code> option to search
different directories. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create dozer mirror /file/a /file/b
# zpool export dozer
# zpool import -d /file
  pool: dozer
    id: 10952414725867935582
 state: ONLINE
action: The pool can be imported using its name or numeric identifier.
config:

        dozer        ONLINE
          mirror     ONLINE
            /file/a  ONLINE
            /file/b  ONLINE
# zpool import -d /file dozer</pre>
</div>
</div>
<div class="paragraph">
<p>If devices exist in multiple directories, you can specify multiple <code>d</code>
options.</p>
</div>
</div>
<div class="sect3">
<h4 id="importing-zfs-storage-pools"><a class="anchor" href="#importing-zfs-storage-pools"></a>3.6.5. Importing ZFS Storage Pools</h4>
<div class="paragraph">
<p>Once a pool has been identified for import, you can import it by
specifying the name of the pool or its numeric identifier as an argument
to the <code>zpool import</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import tank</pre>
</div>
</div>
<div class="paragraph">
<p>If multiple available pools have the same name, you can specify which
pool to import using the numeric identifier. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import
  pool: dozer
    id: 2704475622193776801
 state: ONLINE
action: The pool can be imported using its name or numeric identifier.
config:

        dozer       ONLINE
          c1t9d0    ONLINE

  pool: dozer
    id: 6223921996155991199
 state: ONLINE
action: The pool can be imported using its name or numeric identifier.
config:

        dozer       ONLINE
          c1t8d0    ONLINE
# zpool import dozer
cannot import 'dozer': more than one matching pool
import by numeric ID instead
# zpool import 6223921996155991199</pre>
</div>
</div>
<div class="paragraph">
<p>If the pool name conflicts with an existing pool name, you can import
the pool under a different name. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import dozer zeepool</pre>
</div>
</div>
<div class="paragraph">
<p>This command imports the exported pool <code>dozer</code> using the new name
<code>zeepool</code>. If the pool was not cleanly exported, ZFS requires the <code>f</code>
flag to prevent users from accidentally importing a pool that is still
in use on another system. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import dozer
cannot import 'dozer': pool may be in use on another system
use '-f' to import anyway
# zpool import -f dozer</pre>
</div>
</div>
<div class="paragraph">
<p>Pools can also be imported under an alternate root by using the <code>R</code>
option. For more information on alternate root pools, see
<a href="#using-zfs-alternate-root-pools">Using ZFS Alternate Root Pools</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="recovering-destroyed-zfs-storage-pools"><a class="anchor" href="#recovering-destroyed-zfs-storage-pools"></a>3.6.6. Recovering Destroyed ZFS Storage Pools</h4>
<div class="paragraph">
<p>You can use the <code>zpool import</code> <code>D</code> command to recover a storage pool
that has been destroyed. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool destroy tank
# zpool import -D
pool: tank
    id: 3778921145927357706
 state: ONLINE (DESTROYED)
action: The pool can be imported using its name or numeric identifier.  The
        pool was destroyed, but can be imported using the '-Df' flags.
config:

        tank        ONLINE
          mirror    ONLINE
            c1t0d0  ONLINE
            c1t1d0  ONLINE</pre>
</div>
</div>
<div class="paragraph">
<p>In the above <code>zpool import</code> output, you can identify this pool as the
destroyed pool because of the following state information:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>state: ONLINE (DESTROYED)</pre>
</div>
</div>
<div class="paragraph">
<p>To recover the destroyed pool, issue the <code>zpool import</code> <code>D</code> command
again with the pool to be recovered and the <code>f</code> option. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import -Df tank
# zpool status tank
  pool: tank
 state: ONLINE
 scrub: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        tank        ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c1t0d0  ONLINE       0     0     0
            c1t1d0  ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>If one of the devices in the destroyed pool is faulted or unavailable,
you might be able to recover the destroyed pool anyway. In this
scenario, import the degraded pool and then attempt to fix the device
failure. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool destroy dozer
# zpool import -D
pool: dozer
    id:
 state: DEGRADED (DESTROYED)
status: One or more devices are missing from the system.
action: The pool can be imported despite missing or damaged devices.  The
        fault tolerance of the pool may be compromised if imported.  The
        pool was destroyed, but can be imported using the '-Df' flags.
   see: http://illumos.org/msg/ZFS-8000-2Q
config:

        dozer        DEGRADED
           raidz      ONLINE
            c1t0d0    ONLINE
            c1t1d0    ONLINE
            c1t2d0    UNAVAIL  cannot open
            c1t3d0    ONLINE
# zpool import -Df dozer
# zpool status -x
  pool: dozer
 state: DEGRADED
status: One or more devices could not be opened.  Sufficient replicas exist for
        the pool to continue functioning in a degraded state.
action: Attach the missing device and online it using 'zpool online'.
   see: http://illumos.org/msg/ZFS-8000-D3
 scrub: resilver completed with 0 errors on Fri Mar 17 16:11:35 2006
config:

        NAME                     STATE     READ WRITE CKSUM
        dozer                    DEGRADED     0     0     0
          raidz                  ONLINE       0     0     0
            c1t0d0               ONLINE       0     0     0
            c1t1d0               ONLINE       0     0     0
            c1t2d0               UNAVAIL      0     0     0  cannot open
            c1t3d0               ONLINE       0     0     0

errors: No known data errors
# zpool online dozer c1t2d0
Bringing device c1t2d0 online
# zpool status -x
all pools are healthy</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="upgrading-zfs-storage-pools"><a class="anchor" href="#upgrading-zfs-storage-pools"></a>3.6.7. Upgrading ZFS Storage Pools</h4>
<div class="paragraph">
<p>If you have ZFS storage pools from an earlier ZFS release, you can
upgrade your pools with the <code>zpool upgrade</code> command to take advantage of
any newer pool features. In addition, the <code>zpool status</code> command has
been modified to notify you when your pools are running older versions.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status
  pool: test
 state: ONLINE
status: The pool is formatted using an older on-disk format.  The pool can
        still be used, but some features are unavailable.
action: Upgrade the pool using 'zpool upgrade'.  Once this is done, the
        pool will no longer be accessible on older software versions.
 scrub: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        test        ONLINE       0     0     0
          c1t27d0   ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>You can use the following syntax to identify additional information
about a particular version and supported releases.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool upgrade -v
This system supports ZFS pool feature flags.

The following features are supported:

FEAT DESCRIPTION
-------------------------------------------------------------
async_destroy                         (read-only compatible)
     Destroy filesystems asynchronously.
empty_bpobj                           (read-only compatible)
     Snapshots use less space.
     LZ4 compression algorithm support.
multi_vdev_crash_dump
     Crash dumps to multiple vdev pools.
spacemap_histogram                    (read-only compatible)
     Spacemaps maintain space histograms.
enabled_txg                           (read-only compatible)
     Record txg at which a feature is enabled
hole_birth
     Retain hole birth txg for more precise zfs send
extensible_dataset
     Enhanced dataset functionality, used by other features.
embedded_data
     Blocks which compress very well use even less space.
bookmarks                             (read-only compatible)
     "zfs bookmark" command
filesystem_limits                     (read-only compatible)
     Filesystem and snapshot limits.
large_blocks
     Support for blocks larger than 128KB.
     SHA-512/256 hash algorithm.
     Skein hash algorithm.
     Edon-R hash algorithm.

The following legacy versions are also supported:

VER  DESCRIPTION
---  --------------------------------------------------------
 1   Initial ZFS version
 2   Ditto blocks (replicated metadata)
 3   Hot spares and double parity RAID-Z
 4   zpool history
 5   Compression using the gzip algorithm
 6   bootfs pool property
 7   Separate intent log devices
 8   Delegated administration
 9   refquota and refreservation properties
 10  Cache devices
 11  Improved scrub performance
 12  Snapshot properties
 13  snapused property
 14  passthrough-x aclinherit
 15  user/group space accounting
 16  stmf property support
 17  Triple-parity RAID-Z
 18  Snapshot user holds
 19  Log device removal
 20  Compression using zle (zero-length encoding)
 21  Deduplication
 22  Received properties
 23  Slim ZIL
 24  System attributes
 25  Improved scrub stats
 26  Improved snapshot deletion performance
 27  Improved snapshot creation performance
 28  Multiple vdev replacements

For more information on a particular version, including supported releases,
see the ZFS Administration Guide.</pre>
</div>
</div>
<div class="paragraph">
<p>Then, you can run the <code>zpool upgrade</code> command to upgrade your pools. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool upgrade -a</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you upgrade your pools to the latest version, they will not be
accessible on systems that run older ZFS versions.</p>
</div>
<div id="managing-zfs-file-systems" class="paragraph">
<p>== Managing ZFS File Systems</p>
</div>
<div class="paragraph">
<p>This chapter provides detailed information about managing ZFS file
systems. Concepts such as hierarchical file system layout, property
inheritance, and automatic mount point management and share interactions
are included in this chapter.</p>
</div>
<div class="paragraph">
<p>A ZFS file system is a lightweight POSIX file system that is built on
top of a storage pool. File systems can be dynamically created and
destroyed without requiring you to allocate or format any underlying
space. Because file systems are so lightweight and because they are the
central point of administration in ZFS, you are likely to create many of
them.</p>
</div>
<div class="paragraph">
<p>ZFS file systems are administered by using the <code>zfs</code> command. The <code>zfs</code>
command provides a set of subcommands that perform specific operations
on file systems. This chapter describes these subcommands in detail.
Snapshots, volumes, and clones are also managed by using this command,
but these features are only covered briefly in this chapter. For
detailed information about snapshots and clones, see
<a href="#working-with-zfs-snapshots-and-clones">Working With ZFS Snapshots and Clones</a>. For detailed
information about emulated volumes, see <a href="#zfs-volumes">ZFS Volumes</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The term <em>dataset</em> is used in this chapter as a generic term to refer to
a file system, snapshot, clone, or volume.</p>
</div>
<div class="paragraph">
<p>The following sections are provided in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-and-destroying-zfs-file-systems">Creating and Destroying ZFS File Systems</a></p>
</li>
<li>
<p><a href="#introducing-zfs-properties">Introducing ZFS Properties</a></p>
</li>
<li>
<p><a href="#querying-zfs-file-system-information">Querying ZFS File System Information</a></p>
</li>
<li>
<p><a href="#managing-zfs-properties">Managing ZFS Properties</a></p>
</li>
<li>
<p><a href="#mounting-and-sharing-zfs-file-systems">Mounting and Sharing ZFS File Systems</a></p>
</li>
<li>
<p><a href="#zfs-quotas-and-reservations">ZFS Quotas and Reservations</a></p>
</li>
<li>
<p><a href="#saving-and-restoring-zfs-data">Saving and Restoring ZFS Data</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-and-destroying-zfs-file-systems"><a class="anchor" href="#creating-and-destroying-zfs-file-systems"></a>3.7. Creating and Destroying ZFS File Systems</h3>
<div class="paragraph">
<p>ZFS file systems can be created and destroyed by using the <code>zfs create</code>
and <code>zfs destroy</code> commands.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-a-zfs-file-system">Creating a ZFS File System</a></p>
</li>
<li>
<p><a href="#destroying-a-zfs-file-system">Destroying a ZFS File System</a></p>
</li>
<li>
<p><a href="#renaming-a-zfs-file-system">Renaming a ZFS File System</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="creating-a-zfs-file-system"><a class="anchor" href="#creating-a-zfs-file-system"></a>3.7.1. Creating a ZFS File System</h4>
<div class="paragraph">
<p>ZFS file systems are created by using the <code>zfs create</code> command. The
<code>create</code> subcommand takes a single argument: the name of the file system
to create. The file system name is specified as a path name starting
from the name of the pool:</p>
</div>
<div class="paragraph">
<p>&lt;pool-name/[filesystem-name/]filesystem-name&gt;</p>
</div>
<div class="paragraph">
<p>The pool name and initial file system names in the path identify the
location in the hierarchy where the new file system will be created. All
the intermediate file system names must already exist in the pool. The
last name in the path identifies the name of the file system to be
created. The file system name must satisfy the naming conventions
defined in <a href="#zfs-component-naming-requirements">ZFS Component Naming Requirements</a>.</p>
</div>
<div class="paragraph">
<p>In the following example, a file system named <code>bonwick</code> is created in
the <code>tank/home</code> file system.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create tank/home/bonwick</pre>
</div>
</div>
<div class="paragraph">
<p>ZFS automatically mounts the newly created file system if it is created
successfully. By default, file systems are mounted as
&lt;/dataset&gt;, using the path provided for the file system name in
the <code>create</code> subcommand. In this example, the newly created <code>bonwick</code>
file system is at <code>/tank/home/bonwick</code>. For more information about
automanaged mount points, see <a href="#managing-zfs-mount-points">Managing ZFS Mount Points</a>.</p>
</div>
<div class="paragraph">
<p>For more information about the <code>zfs create</code> command, see <code>zfs(8)</code>.</p>
</div>
<div class="paragraph">
<p>You can set file system properties when the file system is created.</p>
</div>
<div class="paragraph">
<p>In the following example, a mount point of <code>/export/zfs</code> is specified
and is created for the <code>tank/home</code> file system.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create -o mountpoint=/export/zfs tank/home</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about file system properties, see
<a href="#introducing-zfs-properties">Introducing ZFS Properties</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="destroying-a-zfs-file-system"><a class="anchor" href="#destroying-a-zfs-file-system"></a>3.7.2. Destroying a ZFS File System</h4>
<div class="paragraph">
<p>To destroy a ZFS file system, use the <code>zfs destroy</code> command. The
destroyed file system is automatically unmounted and unshared. For more
information about automatically managed mounts or automatically managed
shares, see <a href="#automatic-mount-points">Automatic Mount Points</a>.</p>
</div>
<div class="paragraph">
<p>In the following example, the <code>tabriz</code> file system is destroyed.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs destroy tank/home/tabriz</pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>No confirmation prompt appears with the <code>destroy</code> subcommand. Use it
with extreme caution.</p>
</div>
<div class="paragraph">
<p>If the file system to be destroyed is busy and so cannot be unmounted,
the <code>zfs destroy</code> command fails. To destroy an active file system, use
the <code>f</code> option. Use this option with caution as it can unmount, unshare,
and destroy active file systems, causing unexpected application
behavior.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs destroy tank/home/ahrens
cannot unmount 'tank/home/ahrens': Device busy

# zfs destroy -f tank/home/ahrens</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>zfs destroy</code> command also fails if a file system has children. To
recursively destroy a file system and all its descendents, use the <code>r</code>
option. Note that a recursive destroy also destroys snapshots so use
this option with caution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs destroy tank/ws
cannot destroy 'tank/ws': filesystem has children
use '-r' to destroy the following datasets:
tank/ws/billm
tank/ws/bonwick
tank/ws/maybee

# zfs destroy -r tank/ws</pre>
</div>
</div>
<div class="paragraph">
<p>If the file system to be destroyed has indirect dependents, even the
recursive destroy command described above fails. To force the
destruction of <em>all</em> dependents, including cloned file systems outside
the target hierarchy, the <code>R</code> option must be used. Use extreme caution
with this option.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs destroy -r tank/home/schrock
cannot destroy 'tank/home/schrock': filesystem has dependent clones
use '-R' to destroy the following datasets:
tank/clones/schrock-clone

# zfs destroy -R tank/home/schrock</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>No confirmation prompt appears with the <code>f</code>, <code>r</code>, or <code>R</code> options so use
these options carefully.</p>
</div>
<div class="paragraph">
<p>For more information about snapshots and clones, see
<a href="#working-with-zfs-snapshots-and-clones">Working With ZFS Snapshots and Clones</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="renaming-a-zfs-file-system"><a class="anchor" href="#renaming-a-zfs-file-system"></a>3.7.3. Renaming a ZFS File System</h4>
<div class="paragraph">
<p>File systems can be renamed by using the <code>zfs rename</code> command. Using the
<code>rename</code> subcommand can perform the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the name of a file system</p>
</li>
<li>
<p>Relocate the file system to a new location within the ZFS hierarchy</p>
</li>
<li>
<p>Change the name of a file system and relocate it with the ZFS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example uses the <code>rename</code> subcommand to do a simple rename
of a file system:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs rename tank/home/kustarz tank/home/kustarz_old</pre>
</div>
</div>
<div class="paragraph">
<p>This example renames the <code>kustarz</code> file system to <code>kustarz_old</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to use <code>zfs rename</code> to relocate a file
system.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs rename tank/home/maybee tank/ws/maybee</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>maybee</code> file system is relocated from <code>tank/home</code>
to <code>tank/ws</code>. When you relocate a file system through rename, the new
location must be within the same pool and it must have enough space to
hold this new file system. If the new location does not have enough
space, possibly because it has reached its quota, the rename will fail.</p>
</div>
<div class="paragraph">
<p>For more information about quotas, see <a href="#zfs-quotas-and-reservations">ZFS Quotas and
Reservations</a>.</p>
</div>
<div class="paragraph">
<p>The rename operation attempts an unmount/remount sequence for the file
system and any descendent file systems. The rename fails if the
operation is unable to unmount an active file system. If this problem
occurs, you will need to force unmount the file system.</p>
</div>
<div class="paragraph">
<p>For information about renaming snapshots, see <a href="#renaming-zfs-snapshots">Renaming ZFS
Snapshots</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="introducing-zfs-properties"><a class="anchor" href="#introducing-zfs-properties"></a>3.8. Introducing ZFS Properties</h3>
<div class="paragraph">
<p>Properties are the main mechanism that you use to control the behavior
of file systems, volumes, snapshots, and clones. Unless stated
otherwise, the properties defined in the section apply to all the
dataset types.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#zfs-read-only-native-properties">ZFS Read-Only Native Properties</a></p>
</li>
<li>
<p><a href="#settable-zfs-native-properties">Settable ZFS Native Properties</a></p>
</li>
<li>
<p><a href="#zfs-user-properties">ZFS User Properties</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Properties are divided into two types, native properties and user
defined properties. Native properties either export internal statistics
or control ZFS file system behavior. In addition, native properties are
either settable or read-only. User properties have no effect on ZFS file
system behavior, but you can use them to annotate datasets in a way that
is meaningful in your environment. For more information on user
properties, see <a href="#zfs-user-properties">ZFS User Properties</a>.</p>
</div>
<div class="paragraph">
<p>Most settable properties are also inheritable. An inheritable property
is a property that, when set on a parent, is propagated down to all of
its descendents.</p>
</div>
<div class="paragraph">
<p>All inheritable properties have an associated source. The source
indicates how a property was obtained. The source of a property can have
the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>local</code></dt>
<dd>
<p>A <code>local</code> source indicates that the property was explicitly set on the
dataset by using the <code>zfs set</code> command as described in
<a href="#setting-zfs-properties">Setting ZFS Properties</a>.</p>
</dd>
<dt class="hdlist1"><code>inherited from</code> &lt;dataset-name&gt;</dt>
<dd>
<p>A value of <code>inherited from</code> &lt;dataset-name&gt; means that the
property was inherited from the named ancestor.</p>
</dd>
<dt class="hdlist1"><code>default</code></dt>
<dd>
<p>A value of <code>default</code> means that the property setting was not inherited
or set locally. This source is a result of no ancestor having the
property as source <code>local</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following table identifies both read-only and settable native ZFS
file system properties. Read-only native properties are identified as
such. All other native properties listed in this table are settable. For
information about user properties, see <a href="#zfs-user-properties">ZFS User Properties</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. ZFS Native Property Descriptions</caption>
<colgroup>
<col style="width: 18%;">
<col style="width: 11%;">
<col style="width: 13%;">
<col style="width: 58%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aclinherit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>secure</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls how ACL entries are inherited
when files and directories are created. The values are <code>discard</code>,
<code>noallow</code>, <code>secure</code>, and <code>passthrough</code>. For a description of these
values, see <a href="#acl-property-modes">ACL Property Modes</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aclmode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupmask</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls how an ACL entry is modified
during a <code>chmod</code> operation. The values are <code>discard</code>, <code>groupmask</code>, and
<code>passthrough</code>. For a description of these values, see <a href="#acl-property-modes">ACL
Property Modes</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">atime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>on</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether the access time for files is
updated when they are read. Turning this property off avoids producing
write traffic when reading files and can result in significant
performance gains, though it might confuse mailers and other similar
utilities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Read-only property that identifies the amount of space available to the
dataset and all its children, assuming no other activity in the pool.
Because space is shared within a pool, available space can be limited by
various factors including physical pool size, quotas, reservations, or
other datasets within the pool.</p>
</div>
<div class="paragraph">
<p>This property can also be referenced by its shortened column name,
<code>avail</code>.</p>
</div>
<div class="paragraph">
<p>For more information about space accounting, see <a href="#zfs-space-accounting">ZFS Space
Accounting</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>canmount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">on</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether the given file system can be
mounted with the <code>zfs</code> <code>mount</code> command. This property can be set on any
file system and the property itself is not inheritable. However, when
this property is set, a mountpoint can be inherited to descendent file
systems, but the file system itself is never mounted. For more
information, see <a href="#the-canmount-property">The Property</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>casesensitivity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sensitive</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>This property indicates whether the file name matching algorithm used by
the file system should be <code>casesensitive</code>, <code>caseinsensitive</code>, or allow a
combination of both styles of matching (<code>mixed</code>). The default value for
this property is <code>sensitive</code>. Traditionally, UNIX and POSIX file systems
have case-sensitive file names.</p>
</div>
<div class="paragraph">
<p>The <code>mixed</code> value for this property indicates the file system can
support requests for both case-sensitive and case-insensitive matching
behavior. Currently, case-insensitive matching behavior on a file system
that supports mixed behavior is limited to the Solaris CIFS server
product. For more information about using the <code>mixed</code> value, see
<a href="#the-casesensitivity-property">The Property</a>.</p>
</div>
<div class="paragraph">
<p>Regardless of the <code>casesensitivity</code> property setting, the file system
preserves the case of the name specified to create a file. This property
cannot be changed after the file system is created.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checksum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>on</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls the checksum used to verify data
integrity. The default value is <code>on</code>, which automatically selects an
appropriate algorithm, currently <code>fletcher2</code>. The values are
<code>on, off, fletcher2</code>, <code>fletcher4</code>, and <code>sha256</code>. A value of <code>off</code>
disables integrity checking on user data. A value of <code>off</code> is not
recommended.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">compression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>off</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls the compression algorithm used for this dataset. Currently, you
can select <code>lzjb</code>, <code>gzip</code>, or <code>gzip-</code>&lt;N&gt;. Enabling compression
on a file system with existing data only compresses new data. Existing
data remains uncompressed.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
<code>compress</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">compressratio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Read-only property that identifies the compression ratio achieved for
this dataset, expressed as a multiplier. Compression can be turned on by
running <code>zfs set compression=on</code> &lt;dataset&gt;.</p>
</div>
<div class="paragraph">
<p>Calculated from the logical size of all files and the amount of
referenced physical data. Includes explicit savings through the use of
the compression property.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>copies</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the number of copies of user data per file
system. Available values are 1, 2 or 3. These copies are in addition to
any pool-level redundancy. Space used by multiple copies of user data is
charged to the corresponding file and dataset and counts against quotas
and reservations. In addition, the used property is updated when
multiple copies are enabled. Consider setting this property when the
file system is created because changing this property on an existing
file system only affects newly written data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">creation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only property that identifies the date and
time that this dataset was created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">devices</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>on</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls the ability to open device files in
the file system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>on</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether programs within this file system
are allowed to be executed. Also, when set to <code>off</code>, <code>mmap(2)</code> calls
with <code>PROT_EXEC</code> are disallowed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mounted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only property that indicates whether this
file system, clone, or snapshot is currently mounted. This property does
not apply to volumes. Value can be either yes or no.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mountpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls the mount point used for this file system. When the mountpoint
property is changed for a file system, the file system and any children
that inherit the mount point are unmounted. If the new value is
<code>legacy</code>, then they remain unmounted. Otherwise, they are automatically
remounted in the new location if the property was previously <code>legacy</code> or
<code>none</code>, or if they were mounted before the property was changed. In
addition, any shared file systems are unshared and shared in the new
location.</p>
</div>
<div class="paragraph">
<p>For more information about using this property, see <a href="#managing-zfs-mount-points">Managing
ZFS Mount Points</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nbmand</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">off</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether the file system should be
mounted with <code>nbmand</code> (Non-blocking mandatory) locks. This property is
for CIFS clients only. Changes to this property only take effect when
the file system is unmounted and remounted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>normalization</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property indicates whether a file
system should perform a unicode normalization of file names whenever two
file names are compared, and which normalization algorithm should be
used. File names are always stored unmodified, names are normalized as
part of any comparison process. If this property is set to a legal value
other than <code>none</code>, and the <code>utf8only</code> property was left unspecified, the
<code>utf8only</code> property is automatically set to <code>on</code>. The default value of
the <code>normalization</code> property is <code>none</code>. This property cannot be changed
after the file system is created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">origin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Read-only property for cloned file systems or volumes that identifies
the snapshot from which the clone was created. The origin cannot be
destroyed (even with the <code>r</code> or <code>f</code> options) as long as a clone exists.</p>
</div>
<div class="paragraph">
<p>Non-cloned file systems have an origin of none.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">quota</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number (or <code>none</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Limits the amount of space a dataset and its descendents can consume.
This property enforces a hard limit on the amount of space used,
including all space consumed by descendents, including file systems and
snapshots. Setting a quota on a descendent of a dataset that already has
a quota does not override the ancestor&#8217;s quota, but rather imposes an
additional limit. Quotas cannot be set on volumes, as the volsize
property acts as an implicit quota.</p>
</div>
<div class="paragraph">
<p>For information about setting quotas, see <a href="#setting-quotas-on-zfs-file-systems">Setting Quotas on
ZFS File Systems</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">readonly</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>off</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls whether this dataset can be modified. When set to <code>on</code>, no
modifications can be made to the dataset.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
<code>rdonly</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recordsize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>128K</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Specifies a suggested block size for files in the file system.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
recsize. For a detailed description, see <a href="#the-recordsize-property">The Property</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">referenced</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Read-only property that identifies the amount of data accessible by this
dataset, which might or might not be shared with other datasets in the
pool.</p>
</div>
<div class="paragraph">
<p>When a snapshot or clone is created, it initially references the same
amount of space as the file system or snapshot it was created from,
because its contents are identical.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
refer.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>refquota</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number (or none)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the amount of space that a
dataset can consume. This property enforces a hard limit on the amount
of space used. This hard limit does not include space used by
descendents, such as snapshots and clones.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>refreservation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number (or none)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the minimum amount of space that is guaranteed to a dataset, not
including descendents, such as snapshots and clones. When the amount of
space that is used is below this value, the dataset is treated as if it
were taking up the amount of space specified by <code>refreservation</code>. The
<code>refreservation</code> reservation is accounted for in the parent datasets'
space used, and counts against the parent datasets' quotas and
reservations.</p>
</div>
<div class="paragraph">
<p>If <code>refreservation</code> is set, a snapshot is only allowed if enough free
pool space is available outside of this reservation to accommodate the
current number of <em>referenced</em> bytes in the dataset.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
<code>refreserv</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">reservation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number (or none)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The minimum amount of space guaranteed to a dataset and its descendents.
When the amount of space used is below this value, the dataset is
treated as if it were using the amount of space specified by its
reservation. Reservations are accounted for in the parent datasets'
space used, and count against the parent datasets' quotas and
reservations.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
reserv.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#setting-reservations-on-zfs-file-systems">Setting Reservations on ZFS File
Systems</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">setuid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>on</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether the <code>setuid</code> bit is honored in
the file system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sharenfs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>off</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls whether the file system is available over NFS, and what options
are used. If set to <code>on</code>, the <code>zfs share</code> command is invoked with no
options. Otherwise, the <code>zfs share</code> command is invoked with options
equivalent to the contents of this property. If set to <code>off</code>, the file
system is managed by using the legacy <code>share</code> and <code>unshare</code> commands and
the <code>dfstab</code> file.</p>
</div>
<div class="paragraph">
<p>For more information on sharing ZFS file systems, see
<a href="#sharing-and-unsharing-zfs-file-systems">Sharing and Unsharing ZFS File Systems</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sharesmb</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">off</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls whether the file system is shared by using the Solaris CIFS
service, and what options are to be used. A file system with the
<code>sharesmb</code> property set to <code>off</code> is managed through traditional tools,
such as the <code>sharemgr</code> command. Otherwise, the file system is
automatically shared and unshared by using the <code>zfs share</code> and
<code>zfs unshare</code> commands.</p>
</div>
<div class="paragraph">
<p>If the property is set to <code>on</code>, the <code>sharemgr</code> command is invoked with
no options. Otherwise, the <code>sharemgr</code> command is invoked with options
that are equivalent to the contents of this property.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>snapdir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hidden</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether the <code>.zfs</code> directory is
hidden or visible in the root of the file system. For more information
on using snapshots, see <a href="#overview-of-zfs-snapshots">Overview of ZFS Snapshots</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only property that identifies the dataset
type as <code>filesystem</code> (file system or clone), <code>volume</code>, or <code>snapshot</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">used</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Read-only property that identifies the amount of space consumed by the
dataset and all its descendents.</p>
</div>
<div class="paragraph">
<p>For a detailed description, see <a href="#the-used-property">The Property</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>utf8only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Off</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property indicates whether a file system
should reject file names that include characters that are not present in
the UTF-8 character code set. If this property is explicitly set to
<code>off</code>, the <code>normalization</code> property must either not be explicitly set or
be set to <code>none</code>. The default value for the <code>utf8only</code> property is
<code>off</code>. This property cannot be changed after the file system is created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">volsize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>For volumes, specifies the logical size of the volume.</p>
</div>
<div class="paragraph">
<p>For a detailed description, see <a href="#the-volsize-property">The Property</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>volblocksize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 Kbytes</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>For volumes, specifies the block size of the volume. The block size
cannot be changed once the volume has been written, so set the block
size at volume creation time. The default block size for volumes is 8
Kbytes. Any power of 2 from 512 bytes to 128 Kbytes is valid.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
volblock.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>vscan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Off</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether regular files should be scanned
for viruses when a file is opened and closed. In addition to enabling
this property, a virus scanning service must also be enabled for virus
scanning to occur. The default value is <code>off</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">zoned</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Indicates whether this dataset has been added to a non-global zone. If
this property is set, then the mount point is not honored in the global
zone, and ZFS cannot mount such a file system when requested. When a
zone is first installed, this property is set for any added file
systems.</p>
</div>
<div class="paragraph">
<p>For more information about using ZFS with zones installed, see
<a href="#using-zfs-with-zones">Using ZFS With Zones</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>xattr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>on</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates whether extended attributes are
enabled or disabled for this file system. The default value is <code>on</code>.</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="zfs-read-only-native-properties"><a class="anchor" href="#zfs-read-only-native-properties"></a>3.8.1. ZFS Read-Only Native Properties</h4>
<div class="paragraph">
<p>Read-only native properties are properties that can be retrieved but
cannot be set. Read-only native properties are not inherited. Some
native properties are specific to a particular type of dataset. In such
cases, the particular dataset type is mentioned in the description in
<a href="#gcfgr">ZFS Native Property Descriptions</a>.</p>
</div>
<div class="paragraph">
<p>The read-only native properties are listed here and are described in
<a href="#gcfgr">ZFS Native Property Descriptions</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>available</p>
</li>
<li>
<p>creation</p>
</li>
<li>
<p>mounted</p>
</li>
<li>
<p>origin</p>
</li>
<li>
<p>compressratio</p>
</li>
<li>
<p>referenced</p>
</li>
<li>
<p>type</p>
</li>
<li>
<p>used</p>
<div class="paragraph">
<p>For detailed information, see <a href="#the-used-property">The Property</a>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information on space accounting, including the used,
referenced, and available properties, see <a href="#zfs-space-accounting">ZFS Space
Accounting</a>.</p>
</div>
<div class="sect4">
<h5 id="the-used-property"><a class="anchor" href="#the-used-property"></a>The used Property</h5>
<div class="paragraph">
<p>The amount of space consumed by this dataset and all its descendents.
This value is checked against the dataset&#8217;s quota and reservation. The
space used does not include the dataset&#8217;s reservation, but does consider
the reservation of any descendent datasets. The amount of space that a
dataset consumes from its parent, as well as the amount of space that is
freed if the dataset is recursively destroyed, is the greater of its
space used and its reservation.</p>
</div>
<div class="paragraph">
<p>When snapshots are created, their space is initially shared between the
snapshot and the file system, and possibly with previous snapshots. As
the file system changes, space that was previously shared becomes unique
to the snapshot, and counted in the snapshot&#8217;s space used. Additionally,
deleting snapshots can increase the amount of space unique to (and used
by) other snapshots. For more information about snapshots and space
issues, see <a href="#out-of-space-behavior">Out of Space Behavior</a>.</p>
</div>
<div class="paragraph">
<p>The amount of space used, available, or referenced does not take into
account pending changes. Pending changes are generally accounted for
within a few seconds. Committing a change to a disk using <code>fsync(3C)</code> or
<code>O_SYNC</code> does not necessarily guarantee that the space usage
information will be updated immediately.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="settable-zfs-native-properties"><a class="anchor" href="#settable-zfs-native-properties"></a>3.8.2. Settable ZFS Native Properties</h4>
<div class="paragraph">
<p>Settable native properties are properties whose values can be both
retrieved and set. Settable native properties are set by using the
<code>zfs set</code> command, as described in <a href="#setting-zfs-properties">Setting ZFS Properties</a>
or by using the <code>zfs create</code> command as described in
<a href="#creating-a-zfs-file-system">Creating a ZFS File System</a>. With the exceptions of quotas
and reservations, settable native properties are inherited. For more
information about quotas and reservations, see <a href="#zfs-quotas-and-reservations">ZFS Quotas
and Reservations</a>.</p>
</div>
<div class="paragraph">
<p>Some settable native properties are specific to a particular type of
dataset. In such cases, the particular dataset type is mentioned in the
description in <a href="#gcfgr">ZFS Native Property Descriptions</a>. If not
specifically mentioned, a property applies to all dataset types: file
systems, volumes, clones, and snapshots.</p>
</div>
<div class="paragraph">
<p>The settable properties are listed here and are described in
<a href="#gcfgr">ZFS Native Property Descriptions</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>aclinherit</p>
<div class="paragraph">
<p>For a detailed description, see <a href="#acl-property-modes">ACL Property Modes</a>.</p>
</div>
</li>
<li>
<p>aclmode</p>
<div class="paragraph">
<p>For a detailed description, see <a href="#acl-property-modes">ACL Property Modes</a>.</p>
</div>
</li>
<li>
<p>atime</p>
</li>
<li>
<p>canmount</p>
</li>
<li>
<p>casesensitivity</p>
</li>
<li>
<p>checksum</p>
</li>
<li>
<p>compression</p>
</li>
<li>
<p>copies</p>
</li>
<li>
<p>devices</p>
</li>
<li>
<p>exec</p>
</li>
<li>
<p>mountpoint</p>
</li>
<li>
<p>nbmand</p>
</li>
<li>
<p>normalization</p>
</li>
<li>
<p>quota</p>
</li>
<li>
<p>readonly</p>
</li>
<li>
<p>recordsize</p>
<div class="paragraph">
<p>For a detailed description, see <a href="#the-recordsize-property">The Property</a>.</p>
</div>
</li>
<li>
<p>refquota</p>
</li>
<li>
<p>refreservation</p>
</li>
<li>
<p>reservation</p>
</li>
<li>
<p>sharenfs</p>
</li>
<li>
<p>sharesmb</p>
</li>
<li>
<p>setuid</p>
</li>
<li>
<p>snapdir</p>
</li>
<li>
<p>vscan</p>
</li>
<li>
<p>utf8only</p>
</li>
<li>
<p>volsize</p>
<div class="paragraph">
<p>For a detailed description,see <a href="#the-volsize-property">The Property</a>.</p>
</div>
</li>
<li>
<p>volblocksize</p>
</li>
<li>
<p>zoned</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="the-canmount-property"><a class="anchor" href="#the-canmount-property"></a>The <code>canmount</code> Property</h5>
<div class="paragraph">
<p>If this property is set to no, the file system cannot be mounted by
using the <code>zfs mount</code> or <code>zfs mount</code> <code>a</code> commands. This property is
similar to setting the mountpoint property to <code>none</code>, except that the
dataset still has a normal mountpoint property that can be inherited.
For example, you can set this property to no, establish inheritable
properties for descendent file systems, but the file system itself is
never mounted nor it is accessible to users. In this case, the parent
file system with this property set to no is serving as a <em>container</em> so
that you can set attributes on the container, but the container itself
is never accessible.</p>
</div>
<div class="paragraph">
<p>In the following example, <code>userpool</code> is created and the canmount
property is set to off. Mount points for descendent user file systems
are set to one common mount point, <code>/export/home</code>. Properties that are
set on the parent file system are inherited by descendent file systems,
but the parent file system itself is never mounted.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create userpool mirror c0t5d0 c1t6d0
# zfs set canmount=off userpool
# zfs set mountpoint=/export/home userpool
# zfs set compression=on userpool
# zfs create userpool/user1
# zfs create userpool/user2
# zfs list -r userpool
NAME             USED  AVAIL  REFER  MOUNTPOINT
userpool         140K  8.24G  24.5K  /export/home
userpool/user1  24.5K  8.24G  24.5K  /export/home/user1
userpool/user2  24.5K  8.24G  24.5K  /export/home/user2</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="the-casesensitivity-property"><a class="anchor" href="#the-casesensitivity-property"></a>The casesensitivity Property</h5>
<div class="paragraph">
<p>This property indicates whether the file name matching algorithm used by
the file system should be <code>casesensitive</code>, <code>caseinsensitive</code>, or allow a
combination of both styles of matching (<code>mixed</code>).</p>
</div>
<div class="paragraph">
<p>When a case-insensitive matching request is made of a <em>mixed</em>
sensitivity file system, the behavior is generally the same as would be
expected of a purely case-insensitive file system. The difference is
that a mixed sensitivity file system might contain directories with
multiple names that are unique from a case-sensitive perspective, but
not unique from the case-insensitive perspective.</p>
</div>
<div class="paragraph">
<p>For example, a directory might contain files <code>foo</code>, <code>Foo</code>, and <code>FOO</code>. If
a request is made to case-insensitively match any of the possible forms
of <code>foo</code>, (for example <code>foo</code>, <code>FOO</code>, <code>FoO</code>, <code>fOo</code>, and so on) one of the
three existing files is chosen as the match by the matching algorithm.
Exactly which file the algorithm chooses as a match is not guaranteed,
but what is guaranteed is that the same file is chosen as a match for
any of the forms of <code>foo</code>. The file chosen as a case-insensitive match
for <code>foo</code>, <code>FOO</code>, <code>foO</code>, <code>Foo</code>, and so on, is always the same, so long
as the directory remains unchanged.</p>
</div>
<div class="paragraph">
<p>The <code>utf8only</code>, <code>normalization</code>, and <code>casesensitivity</code> properties are
also new permissions that can be assigned to non-privileged users by
using ZFS delegated administration. For more information, see
<a href="#delegating-zfs-permissions">Delegating ZFS Permissions</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="the-recordsize-property"><a class="anchor" href="#the-recordsize-property"></a>The recordsize Property</h5>
<div class="paragraph">
<p>Specifies a suggested block size for files in the file system.</p>
</div>
<div class="paragraph">
<p>This property is designed solely for use with database workloads that
access files in fixed-size records. ZFS automatically adjust block sizes
according to internal algorithms optimized for typical access patterns.
For databases that create very large files but access the files in small
random chunks, these algorithms may be suboptimal. Specifying a
recordsize greater than or equal to the record size of the database can
result in significant performance gains. Use of this property for
general purpose file systems is strongly discouraged, and may adversely
affect performance. The size specified must be a power of two greater
than or equal to 512 and less than or equal to 128 Kbytes. Changing the
file system&#8217;s <code>recordsize</code> only affects files created afterward.
Existing files are unaffected.</p>
</div>
<div class="paragraph">
<p>This property can also be referred to by its shortened column name,
recsize.</p>
</div>
</div>
<div class="sect4">
<h5 id="the-sharesmb-property"><a class="anchor" href="#the-sharesmb-property"></a>The <code>sharesmb</code> Property</h5>
<div class="paragraph">
<p>This property enabled sharing of ZFS file systems with the Solaris CIFS
service, and identifies options to be used.</p>
</div>
<div class="paragraph">
<p>Because SMB shares requires a resource name, a unique resource name is
constructed from the dataset name. The constructed name is a copy of the
dataset name except that the characters in the dataset name, which would
be illegal in the resource name, are replaced with underbar (_)
characters. A pseudo property &lt;name&gt; is also supported that
allows you to replace the dataset name with a specific name. The
specific name is then used to replace the prefix dataset in the case of
inheritance.</p>
</div>
<div class="paragraph">
<p>For example, if the dataset, <code>data/home/john</code>, is set to <code>name=john</code>,
then <code>data/home/john</code> has a resource name of <code>john</code>. If a child dataset
of <code>data/home/john/backups</code> exists, it has a resource name of
<code>john_backups</code>. When the <code>sharesmb</code> property is changed for a
dataset, the dataset and any children inheriting the property are
re-shared with the new options, only if the property was previously set
to <code>off</code>, or if they were shared before the property was changed. If the
new property is set to <code>off</code>, the file systems are unshared.</p>
</div>
<div class="paragraph">
<p>For examples of using the <code>sharesmb</code> property, see <a href="#sharing-zfs-files-in-a-solaris-cifs-environment">Sharing
ZFS Files in a Solaris CIFS Environment</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="the-volsize-property"><a class="anchor" href="#the-volsize-property"></a>The volsize Property</h5>
<div class="paragraph">
<p>The logical size of the volume. By default, creating a volume
establishes a reservation for the same amount. Any changes to volsize
are reflected in an equivalent change to the reservation. These checks
are used to prevent unexpected behavior for users. A volume that
contains less space than it claims is available can result in undefined
behavior or data corruption, depending on how the volume is used. These
effects can also occur when the volume size is changed while it is in
use, particularly when you shrink the size. Extreme care should be used
when adjusting the volume size.</p>
</div>
<div class="paragraph">
<p>Though not recommended, you can create a sparse volume by specifying the
<code>s</code> flag to <code>zfs create -V</code>, or by changing the reservation once the
volume has been created. A <em>sparse volume</em> is defined as a volume where
the reservation is not equal to the volume size. For a sparse volume,
changes to volsize are not reflected in the reservation.</p>
</div>
<div class="paragraph">
<p>For more information about using volumes, see <a href="#zfs-volumes">ZFS Volumes</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-user-properties-1"><a class="anchor" href="#zfs-user-properties-1"></a>3.8.3. ZFS User Properties</h4>
<div class="paragraph">
<p>In addition to the standard native properties, ZFS supports arbitrary
user properties. User properties have no effect on ZFS behavior, but you
can use them to annotate datasets with information that is meaningful in
your environment.</p>
</div>
<div class="paragraph">
<p>User property names must conform to the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Contain a colon (':') character to distinguish them from native
properties.</p>
</li>
<li>
<p>Contain lowercase letters, numbers, and the following punctuation
characters: ':', &#43; ,'.', '_'.</p>
</li>
<li>
<p>Maximum user property name is 256 characters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The expected convention is that the property name is divided into the
following two components but this namespace is not enforced by ZFS:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>module:property</pre>
</div>
</div>
<div class="paragraph">
<p>When making programmatic use of user properties, use a reversed DNS
domain name for the &lt;module&gt; component of property names to
reduce the chance that two independently-developed packages will use the
same property name for different purposes. Property names that begin
with "com.sun." are reserved for use by Sun Microsystems.</p>
</div>
<div class="paragraph">
<p>The values of user properties have the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Arbitrary strings that are always inherited and are never validated.</p>
</li>
<li>
<p>Maximum user property value is 1024 characters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set dept:users=finance userpool/user1
# zfs set dept:users=general userpool/user2
# zfs set dept:users=itops userpool/user3</pre>
</div>
</div>
<div class="paragraph">
<p>All of the commands that operate on properties, such as <code>zfs list</code>,
<code>zfs get</code>, <code>zfs set</code>, and so on, can be used to manipulate both native
properties and user properties.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>zfs get -r dept:users userpool
NAME            PROPERTY    VALUE           SOURCE
userpool        dept:users  all             local
userpool/user1  dept:users  finance         local
userpool/user2  dept:users  general         local
userpool/user3  dept:users  itops           local</pre>
</div>
</div>
<div class="paragraph">
<p>To clear a user property, use the <code>zfs inherit</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs inherit -r dept:users userpool</pre>
</div>
</div>
<div class="paragraph">
<p>If the property is not defined in any parent dataset, it is removed
entirely.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="querying-zfs-file-system-information"><a class="anchor" href="#querying-zfs-file-system-information"></a>3.9. Querying ZFS File System Information</h3>
<div class="paragraph">
<p>The <code>zfs list</code> command provides an extensible mechanism for viewing and
querying dataset information. Both basic and complex queries are
explained in this section.</p>
</div>
<div class="sect3">
<h4 id="listing-basic-zfs-information"><a class="anchor" href="#listing-basic-zfs-information"></a>3.9.1. Listing Basic ZFS Information</h4>
<div class="paragraph">
<p>You can list basic dataset information by using the <code>zfs list</code> command
with no options. This command displays the names of all datasets on the
system including their used, available, referenced, and mountpoint
properties. For more information about these properties, see
<a href="#introducing-zfs-properties">Introducing ZFS Properties</a>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list
NAME                   USED  AVAIL  REFER  MOUNTPOINT
pool                   476K  16.5G    21K  /pool
pool/clone              18K  16.5G    18K  /pool/clone
pool/home              296K  16.5G    19K  /pool/home
pool/home/marks        277K  16.5G   277K  /pool/home/marks
pool/home/marks@snap      0      -   277K  -
pool/test               18K  16.5G    18K  /test</pre>
</div>
</div>
<div class="paragraph">
<p>You can also use this command to display specific datasets by providing
the dataset name on the command line. Additionally, use the <code>r</code> option
to recursively display all descendents of that dataset. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list -r pool/home/marks
NAME                   USED  AVAIL  REFER  MOUNTPOINT
pool/home/marks        277K  16.5G   277K  /pool/home/marks
pool/home/marks@snap      0      -   277K  -</pre>
</div>
</div>
<div class="paragraph">
<p>You use <code>zfs list</code> command with absolute pathnames for datasets,
snapshots, and volumes. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list /pool/home/marks
NAME              USED  AVAIL  REFER  MOUNTPOINT
pool/home/marks   277K  16.5G   277K  /pool/home/marks</pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows how to display <code>tank/home/chua</code> and all of
its descendent datasets.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list -r tank/home/chua
NAME                        USED  AVAIL  REFER  MOUNTPOINT
tank/home/chua                26.0K  4.81G  10.0K  /tank/home/chua
tank/home/chua/projects       16K  4.81G   9.0K  /tank/home/chua/projects
tank/home/chua/projects/fs1    8K  4.81G     8K  /tank/home/chua/projects/fs1
tank/home/chua/projects/fs2    8K  4.81G     8K  /tank/home/chua/projects/fs2</pre>
</div>
</div>
<div class="paragraph">
<p>For additional information about the <code>zfs list</code> command, see <code>zfs(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="creating-complex-zfs-queries"><a class="anchor" href="#creating-complex-zfs-queries"></a>3.9.2. Creating Complex ZFS Queries</h4>
<div class="paragraph">
<p>The <code>zfs list</code> output can be customized by using of the <code>o</code>, <code>f</code>, and
<code>H</code> options.</p>
</div>
<div class="paragraph">
<p>You can customize property value output by using the <code>o</code> option and a
comma-separated list of desired properties. Supply any dataset property
as a valid value. For a list of all supported dataset properties, see
<a href="#introducing-zfs-properties">Introducing ZFS Properties</a>. In addition to the properties
defined there, the <code>o</code> option list can also contain the literal <code>name</code>
to indicate that the output should include the name of the dataset.</p>
</div>
<div class="paragraph">
<p>The following example uses <code>zfs list</code> to display the dataset name, along
with the sharenfs and mountpoint properties.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list -o name,sharenfs,mountpoint
NAME                   SHARENFS         MOUNTPOINT
tank                   off              /tank
tank/home              on               /tank/home
tank/home/ahrens       on               /tank/home/ahrens
tank/home/bonwick      on               /tank/home/bonwick
tank/home/chua         on               /tank/home/chua
tank/home/eschrock     on               legacy
tank/home/moore        on               /tank/home/moore
tank/home/tabriz       ro               /tank/home/tabriz</pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>t</code> option to specify the types of datasets to display.
The valid types are described in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Types of ZFS Datasets</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filesystem</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File systems and clones</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>volume</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Volumes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>snapshot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Snapshots</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>t</code> options takes a comma-separated list of the types of datasets to
be displayed. The following example uses the <code>t</code> and <code>o</code> options
simultaneously to show the name and used property for all file systems:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list -t filesystem -o name,used
NAME              USED
pool              476K
pool/clone         18K
pool/home         296K
pool/home/marks   277K
pool/test          18K</pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>H</code> option to omit the <code>zfs list</code> header from the
generated output. With the <code>H</code> option, all white space is output as
tabs. This option can be useful when you need parseable output, for
example, when scripting. The following example shows the output
generated from using the <code>zfs list</code> command with the <code>H</code> option:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list -H -o name
pool/clone
pool/home
pool/home/marks
pool/home/marks@snap
pool/test</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="managing-zfs-properties"><a class="anchor" href="#managing-zfs-properties"></a>3.10. Managing ZFS Properties</h3>
<div class="paragraph">
<p>Dataset properties are managed through the <code>zfs</code> command&#8217;s <code>set</code>,
<code>inherit</code>, and <code>get</code> subcommands.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#setting-zfs-properties">Setting ZFS Properties</a></p>
</li>
<li>
<p><a href="#inheriting-zfs-properties">Inheriting ZFS Properties</a></p>
</li>
<li>
<p><a href="#querying-zfs-properties">Querying ZFS Properties</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="setting-zfs-properties"><a class="anchor" href="#setting-zfs-properties"></a>3.10.1. Setting ZFS Properties</h4>
<div class="paragraph">
<p>You can use the <code>zfs set</code> command to modify any settable dataset
property. Or, you can use the <code>zfs create</code> command to set properties
when the dataset is created. For a list of settable dataset properties,
see <a href="#settable-zfs-native-properties">Settable ZFS Native Properties</a>. The <code>zfs set</code> command
takes a property/value sequence in the format of
&lt;property&gt;=&lt;value&gt; and a dataset name.</p>
</div>
<div class="paragraph">
<p>The following example sets the atime property to <code>off</code> for <code>tank/home</code>.
Only one property can be set or modified during each <code>zfs set</code>
invocation.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set atime=off tank/home</pre>
</div>
</div>
<div class="paragraph">
<p>In addition, any file system property can be set when the file system is
created. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create -o atime=off tank/home</pre>
</div>
</div>
<div class="paragraph">
<p>You can specify numeric properties by using the following easy to
understand suffixes (in order of magnitude): <code>BKMGTPEZ</code>. Any of these
suffixes can be followed by an optional <code>b</code>, indicating bytes, with the
exception of the <code>B</code> suffix, which already indicates bytes. The
following four invocations of <code>zfs set</code> are equivalent numeric
expressions indicating that the quota property be set to the value of 50
Gbytes on the <code>tank/home/marks</code> file system:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set quota=50G tank/home/marks
# zfs set quota=50g tank/home/marks
# zfs set quota=50GB tank/home/marks
# zfs set quota=50gb tank/home/marks</pre>
</div>
</div>
<div class="paragraph">
<p>Values of non-numeric properties are case-sensitive and must be
lowercase, with the exception of mountpoint and sharenfs. The values of
these properties can have mixed upper and lower case letters.</p>
</div>
<div class="paragraph">
<p>For more information about the <code>zfs set</code> command, see <code>zfs(8)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="inheriting-zfs-properties"><a class="anchor" href="#inheriting-zfs-properties"></a>3.10.2. Inheriting ZFS Properties</h4>
<div class="paragraph">
<p>All settable properties, with the exception of quotas and reservations,
inherit their value from their parent, unless a quota or reservation is
explicitly set on the child. If no ancestor has an explicit value set
for an inherited property, the default value for the property is used.
You can use the <code>zfs inherit</code> command to clear a property setting, thus
causing the setting to be inherited from the parent.</p>
</div>
<div class="paragraph">
<p>The following example uses the <code>zfs set</code> command to turn on compression
for the <code>tank/home/bonwick</code> file system. Then, <code>zfs inherit</code> is used to
unset the compression property, thus causing the property to inherit the
default setting of <code>off</code>. Because neither <code>home</code> nor <code>tank</code> have the
compression property set locally, the default value is used. If both had
compression on, the value set in the most immediate ancestor would be
used (<code>home</code> in this example).</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set compression=on tank/home/bonwick
# zfs get -r compression tank
NAME             PROPERTY      VALUE                    SOURCE
tank             compression   off                      default
tank/home        compression   off                      default
tank/home/bonwick compression   on                      local
# zfs inherit compression tank/home/bonwick
# zfs get -r compression tank
NAME             PROPERTY      VALUE                    SOURCE
tank             compression   off                      default
tank/home        compression   off                      default
tank/home/bonwick compression  off                      default</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>inherit</code> subcommand is applied recursively when the <code>r</code> option is
specified. In the following example, the command causes the value for
the compression property to be inherited by <code>tank/home</code> and any
descendents it might have.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs inherit -r compression tank/home</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be aware that the use of the <code>r</code> option clears the current property
setting for all descendent datasets.</p>
</div>
<div class="paragraph">
<p>For more information about the <code>zfs</code> command, see <code>zfs(8)</code>.</p>
</div>
<div id="querying-zfs-properties" class="paragraph">
<p>==== Querying ZFS Properties</p>
</div>
<div class="paragraph">
<p>The simplest way to query property values is by using the <code>zfs list</code>
command. For more information, see <a href="#listing-basic-zfs-information">Listing Basic ZFS
Information</a>. However, for complicated queries and for scripting, use
the <code>zfs get</code> command to provide more detailed information in a
customized format.</p>
</div>
<div class="paragraph">
<p>You can use the <code>zfs get</code> command to retrieve any dataset property. The
following example shows how to retrieve a single property on a dataset:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get checksum tank/ws
NAME             PROPERTY       VALUE                      SOURCE
tank/ws          checksum       on                         default</pre>
</div>
</div>
<div class="paragraph">
<p>The fourth column, <code>SOURCE</code>, indicates where this property value has
been set from. The following table defines the meaning of the possible
source values.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Possible <code>SOURCE</code> Values (<code>zfs get</code>)</caption>
<colgroup>
<col style="width: 36%;">
<col style="width: 64%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Source Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property was never explicitly set for this dataset or
any of its ancestors. The default value for this property is being used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>inherited from</code> &lt;dataset-name&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property value is being
inherited from the parent as specified by &lt;dataset-name&gt;.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>local</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property value was explicitly set for this dataset by
using <code>zfs set</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>temporary</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property value was set by using the <code>zfs mount</code> <code>o</code>
option and is only valid for the lifetime of the mount. For more
information about temporary mount point properties, see
<a href="#using-temporary-mount-properties">Using Temporary Mount Properties</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">- (none)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property is a read-only property. Its value is generated
by ZFS.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can use the special keyword <code>all</code> to retrieve all dataset
properties. The following example uses the <code>all</code> keyword to retrieve all
existing dataset properties:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get all tank
NAME  PROPERTY         VALUE                  SOURCE
tank  type             filesystem             -
tank  creation         Wed Jan 23  9:57 2008  -
tank  used             120K                   -
tank  available        33.1G                  -
tank  referenced       24.0K                  -
tank  compressratio    1.00x                  -
tank  mounted          yes                    -
tank  quota            none                   default
tank  reservation      none                   default
tank  recordsize       128K                   default
tank  mountpoint       /tank                  default
tank  sharenfs         off                    default
tank  checksum         on                     default
tank  compression      off                    default
tank  atime            on                     default
tank  devices          on                     default
tank  exec             on                     default
tank  setuid           on                     default
tank  readonly         off                    default
tank  zoned            off                    default
tank  snapdir          hidden                 default
tank  aclmode          groupmask              default
tank  aclinherit       secure                 default
tank  canmount         on                     default
tank  shareiscsi       off                    default
tank  xattr            on                     default
tank  copies           1                      default
tank  version          3                      -
tank  utf8only         off                    -
tank  normalization    none                   -
tank  casesensitivity  sensitive              -
tank  vscan            off                    default
tank  nbmand           off                    default
tank  sharesmb         off                    default
tank  refquota         none                   default
tank  refreservation   none                   default</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>s</code> option to <code>zfs get</code> enables you to specify, by source value, the
type of properties to display. This option takes a comma-separated list
indicating the desired source types. Only properties with the specified
source type are displayed. The valid source types are <code>local</code>,
<code>default</code>, <code>inherited</code>, <code>temporary</code>, and <code>none</code>. The following example
shows all properties that have been locally set on <code>pool</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get -s local all pool
NAME             PROPERTY      VALUE                      SOURCE
pool             compression   on                         local</pre>
</div>
</div>
<div class="paragraph">
<p>Any of the above options can be combined with the <code>r</code> option to
recursively display the specified properties on all children of the
specified dataset. In the following example, all temporary properties on
all datasets within <code>tank</code> are recursively displayed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get -r -s temporary all tank
NAME             PROPERTY       VALUE                      SOURCE
tank/home          atime          off                      temporary
tank/home/bonwick  atime          off                      temporary
tank/home/marks    atime          off                      temporary</pre>
</div>
</div>
<div class="paragraph">
<p>A recent feature enables you to make queries with the <code>zfs get</code> command
without specifying a target file system, which means it operates on all
pools or file systems. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get -s local all
tank/home               atime          off                    local
tank/home/bonwick       atime          off                    local
tank/home/marks         quota          50G                    local</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about the <code>zfs get</code> command, see <code>zfs(8)</code>.</p>
</div>
<div id="querying-zfs-properties-for-scripting" class="paragraph">
<p>===== Querying ZFS Properties for Scripting</p>
</div>
<div class="paragraph">
<p>The <code>zfs get</code> command supports the <code>H</code> and <code>o</code> options, which are
designed for scripting. The <code>H</code> option indicates that any header
information should be omitted and that all white space should come in
the form of tab. Uniform white space allows for easily parseable data.
You can use the <code>o</code> option to customize the output. This option takes a
comma-separated list of values to be output. All properties defined in
<a href="#introducing-zfs-properties">Introducing ZFS Properties</a>, along with the literals <code>name</code>,
<code>value</code>, <code>property</code> and <code>source</code> can be supplied in the <code>o</code> list.</p>
</div>
<div class="paragraph">
<p>The following example shows how to retrieve a single value by using the
<code>H</code> and <code>o</code> options of <code>zfs get</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get -H -o value compression tank/home</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>p</code> option reports numeric values as their exact values. For
example, 1 Mbyte would be reported as 1000000. This option can be used
as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get -H -o value -p used tank/home</pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>r</code> option along with any of the above options to
recursively retrieve the requested values for all descendents. The
following example uses the <code>r</code>, <code>o</code>, and <code>H</code> options to retrieve the
dataset name and the value of the used property for <code>export/home</code> and
its descendents, while omitting any header output:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get -H -o name,value -r used export/home
export/home     5.57G
export/home/marks       1.43G
export/home/maybee      2.15G</pre>
</div>
</div>
<div id="mounting-and-sharing-zfs-file-systems" class="paragraph">
<p>=== Mounting and Sharing ZFS File Systems</p>
</div>
<div class="paragraph">
<p>This section describes how mount points and shared file systems are
managed in ZFS.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#managing-zfs-mount-points">Managing ZFS Mount Points</a></p>
</li>
<li>
<p><a href="#mounting-zfs-file-systems">Mounting ZFS File Systems</a></p>
</li>
<li>
<p><a href="#using-temporary-mount-properties">Using Temporary Mount Properties</a></p>
</li>
<li>
<p><a href="#unmounting-zfs-file-systems">Unmounting ZFS File Systems</a></p>
</li>
<li>
<p><a href="#sharing-and-unsharing-zfs-file-systems">Sharing and Unsharing ZFS File Systems</a></p>
</li>
</ul>
</div>
<div id="managing-zfs-mount-points" class="paragraph">
<p>==== Managing ZFS Mount Points</p>
</div>
<div class="paragraph">
<p>By default, all ZFS file systems are mounted by ZFS at boot by using
SMF&#8217;s <code>svc://system/filesystem/local</code> service. File systems are mounted
under &lt;/path&gt;, where &lt;path&gt; is the name of the file
system.</p>
</div>
<div class="paragraph">
<p>You can override the default mount point by setting the mountpoint
property to a specific path by using the <code>zfs set</code> command. ZFS
automatically creates this mount point, if needed, and automatically
mounts this file system when the <code>zfs mount -a</code> command is invoked,
without requiring you to edit the <code>/etc/vfstab</code> file.</p>
</div>
<div class="paragraph">
<p>The <code>mountpoint</code> property is inherited. For example, if <code>pool/home</code> has
mountpoint set to <code>/export/stuff</code>, then <code>pool/home/user</code> inherits
<code>/export/stuff/user</code> for its mountpoint property.</p>
</div>
<div class="paragraph">
<p>The mountpoint property can be set to <code>none</code> to prevent the file system
from being mounted. In addition, the canmount property is available for
determining whether a file system can be mounted. For more information
about the canmount property, see <a href="#the-canmount-property">The Property</a>.</p>
</div>
<div class="paragraph">
<p>If desired, file systems can also be explicitly managed through legacy
mount interfaces by setting the mountpoint property to legacy by using
<code>zfs set</code>. Doing so prevents ZFS from automatically mounting and
managing this file system. Legacy tools including the <code>mount</code> and
<code>umount</code> commands, and the <code>/etc/vfstab</code> file must be used instead. For
more information about legacy mounts, see <a href="#legacy-mount-points">Legacy Mount
Points</a>.</p>
</div>
<div class="paragraph">
<p>When changing mount point management strategies, the following behaviors
apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automatic mount point behavior</p>
</li>
<li>
<p>Legacy mount point behavior</p>
</li>
</ul>
</div>
<div id="automatic-mount-points" class="paragraph">
<p>===== Automatic Mount Points</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When changing from <code>legacy</code> or <code>none</code>, ZFS automatically mounts the
file system.</p>
</li>
<li>
<p>If ZFS is currently managing the file system but it is currently
unmounted, and the mountpoint property is changed, the file system
remains unmounted.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also set the default mount point for the root dataset at
creation time by using <code>zpool create&#8217;s `m</code> option. For more information
about creating pools, see <a href="#creating-a-zfs-storage-pool">Creating a ZFS Storage Pool</a>.</p>
</div>
<div class="paragraph">
<p>Any dataset whose mountpoint property is not <code>legacy</code> is managed by ZFS.
In the following example, a dataset is created whose mount point is
automatically managed by ZFS.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create pool/filesystem
# zfs get mountpoint pool/filesystem
NAME             PROPERTY      VALUE                      SOURCE
pool/filesystem  mountpoint    /pool/filesystem           default
# zfs get mounted pool/filesystem
NAME             PROPERTY      VALUE                      SOURCE
pool/filesystem  mounted       yes                        -</pre>
</div>
</div>
<div class="paragraph">
<p>You can also explicitly set the mountpoint property as shown in the
following example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set mountpoint=/mnt pool/filesystem
# zfs get mountpoint pool/filesystem
NAME             PROPERTY      VALUE                      SOURCE
pool/filesystem  mountpoint    /mnt                       local
# zfs get mounted pool/filesystem
NAME             PROPERTY      VALUE                      SOURCE
pool/filesystem  mounted       yes                        -</pre>
</div>
</div>
<div class="paragraph">
<p>When the mountpoint property is changed, the file system is
automatically unmounted from the old mount point and remounted to the
new mount point. Mount point directories are created as needed. If ZFS
is unable to unmount a file system due to it being active, an error is
reported and a forced manual unmount is necessary.</p>
</div>
<div id="legacy-mount-points" class="paragraph">
<p>===== Legacy Mount Points</p>
</div>
<div class="paragraph">
<p>You can manage ZFS file systems with legacy tools by setting the
mountpoint property to legacy. Legacy file systems must be managed
through the <code>mount</code> and <code>umount</code> commands and the <code>/etc/vfstab</code> file.
ZFS does not automatically mount legacy file systems on boot, and the
ZFS <code>mount</code> and <code>umount</code> command do not operate on datasets of this
type. The following examples show how to set up and manage a ZFS dataset
in legacy mode:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set mountpoint=legacy tank/home/eschrock
# mount -F zfs tank/home/eschrock /mnt</pre>
</div>
</div>
<div class="paragraph">
<p>In addition, you must mount them by creating entries in the
<code>/etc/vfstab</code> file. Otherwise, the <code>system/filesystem/local</code> service
enters maintenance mode when the system boots.</p>
</div>
<div class="paragraph">
<p>To automatically mount a legacy file system on boot, you must add an
entry to the <code>/etc/vfstab</code> file. The following example shows what the
entry in the <code>/etc/vfstab</code> file might look like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#device         device        mount           FS      fsck    mount   mount
#to mount       to fsck       point           type    pass    at boot options
#

tank/home/eschrock -        /mnt           zfs      -       yes     -</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>device to fsck</code> and <code>fsck pass</code> entries are set to <code>-</code>.
This syntax is because the <code>fsck</code> command is not applicable to ZFS file
systems. For more information regarding data integrity and the lack of
need for <code>fsck</code> in ZFS, see <a href="#transactional-semantics">Transactional Semantics</a>.</p>
</div>
<div id="mounting-zfs-file-systems-1" class="paragraph">
<p>==== Mounting ZFS File Systems</p>
</div>
<div class="paragraph">
<p>ZFS automatically mounts file systems when file systems are created or
when the system boots. Use of the <code>zfs mount</code> command is necessary only
when changing mount options or explicitly mounting or unmounting file
systems.</p>
</div>
<div class="paragraph">
<p>The <code>zfs mount</code> command with no arguments shows all currently mounted
file systems that are managed by ZFS. Legacy managed mount points are
not displayed. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs mount
tank                            /tank
tank/home                       /tank/home
tank/home/bonwick               /tank/home/bonwick
tank/ws                         /tank/ws</pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>a</code> option to mount all ZFS managed file systems. Legacy
managed file systems are not mounted. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs mount -a</pre>
</div>
</div>
<div class="paragraph">
<p>By default, ZFS does not allow mounting on top of a nonempty directory.
To force a mount on top of a nonempty directory, you must use the <code>O</code>
option. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs mount tank/home/lalt
cannot mount '/export/home/lalt': directory is not empty
use legacy mountpoint to allow this behavior, or use the -O flag
# zfs mount -O tank/home/lalt</pre>
</div>
</div>
<div class="paragraph">
<p>Legacy mount points must be managed through legacy tools. An attempt to
use ZFS tools results in an error. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs mount pool/home/billm
cannot mount 'pool/home/billm': legacy mountpoint
use mount(1M) to mount this filesystem
# mount -F zfs tank/home/billm</pre>
</div>
</div>
<div class="paragraph">
<p>When a file system is mounted, it uses a set of mount options based on
the property values associated with the dataset. The correlation between
properties and mount options is as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Property</dt>
<dd>
<p>Mount Options</p>
</dd>
<dt class="hdlist1">devices</dt>
<dd>
<p><code>devices/nodevices</code></p>
</dd>
<dt class="hdlist1">exec</dt>
<dd>
<p><code>exec/noexec</code></p>
</dd>
<dt class="hdlist1">readonly</dt>
<dd>
<p><code>ro/rw</code></p>
</dd>
<dt class="hdlist1">setuid</dt>
<dd>
<p><code>setuid/nosetuid</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The mount option <code>nosuid</code> is an alias for <code>nodevices,nosetuid</code>.</p>
</div>
<div class="paragraph">
<p>You can use the NFSv4 mirror mount features to help you better manage
NFS-mounted ZFS home directories. For a description of mirror mounts,
see <a href="#zfs-and-file-system-mirror-mounts">ZFS and File System Mirror Mounts</a>.</p>
</div>
<div id="using-temporary-mount-properties" class="paragraph">
<p>==== Using Temporary Mount Properties</p>
</div>
<div class="paragraph">
<p>If any of the above options are set explicitly by using the <code>o</code> option
with the <code>zfs mount</code> command, the associated property value is
temporarily overridden. These property values are reported as
<code>temporary</code> by the <code>zfs get</code> command and revert back to their original
settings when the file system is unmounted. If a property value is
changed while the dataset is mounted, the change takes effect
immediately, overriding any temporary setting.</p>
</div>
<div class="paragraph">
<p>In the following example, the read-only mount option is temporarily set
on the <code>tank/home/perrin</code> file system:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs mount -o ro tank/home/perrin</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the file system is assumed to be unmounted. To
temporarily change a property on a file system that is currently
mounted, you must use the special <code>remount</code> option. In the following
example, the atime property is temporarily changed to <code>off</code> for a file
system that is currently mounted:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs mount -o remount,noatime tank/home/perrin
# zfs get atime tank/home/perrin
NAME             PROPERTY      VALUE                      SOURCE
tank/home/perrin atime         off                        temporary</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about the <code>zfs mount</code> command, see <code>zfs(8)</code>.</p>
</div>
<div id="unmounting-zfs-file-systems" class="paragraph">
<p>==== Unmounting ZFS File Systems</p>
</div>
<div class="paragraph">
<p>You can unmount file systems by using the <code>zfs unmount</code> subcommand. The
<code>unmount</code> command can take either the mount point or the file system
name as arguments.</p>
</div>
<div class="paragraph">
<p>In the following example, a file system is unmounted by file system
name:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs unmount tank/home/tabriz</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, the file system is unmounted by mount point:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs unmount /export/home/tabriz</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>unmount</code> command fails if the file system is active or busy. To
forceably unmount a file system, you can use the <code>f</code> option. Be cautious
when forceably unmounting a file system, if its contents are actively
being used. Unpredictable application behavior can result.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs unmount tank/home/eschrock
cannot unmount '/export/home/eschrock': Device busy
# zfs unmount -f tank/home/eschrock</pre>
</div>
</div>
<div class="paragraph">
<p>To provide for backwards compatibility, the legacy <code>umount</code> command can
be used to unmount ZFS file systems. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># umount /export/home/bob</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about the <code>zfs umount</code> command, see <code>zfs(8)</code>.</p>
</div>
<div id="sharing-and-unsharing-zfs-file-systems" class="paragraph">
<p>==== Sharing and Unsharing ZFS File Systems</p>
</div>
<div class="paragraph">
<p>Similar to mount points, ZFS can automatically share file systems by
using the sharenfs property. Using this method, you do not have to
modify the <code>/etc/dfs/dfstab</code> file when a new file system is added. The
sharenfs property is a comma-separated list of options to pass to the
<code>share</code> command. The special value <code>on</code> is an alias for the default
share options, which are <code>read/write</code> permissions for anyone. The
special value <code>off</code> indicates that the file system is not managed by ZFS
and can be shared through traditional means, such as the
<code>/etc/dfs/dfstab</code> file. All file systems whose sharenfs property is not
<code>off</code> are shared during boot.</p>
</div>
<div id="controlling-share-semantics" class="paragraph">
<p>===== Controlling Share Semantics</p>
</div>
<div class="paragraph">
<p>By default, all file systems are unshared. To share a new file system,
use <code>zfs set</code> syntax similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set sharenfs=on tank/home/eschrock</pre>
</div>
</div>
<div class="paragraph">
<p>The property is inherited, and file systems are automatically shared on
creation if their inherited property is not <code>off</code>. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set sharenfs=on tank/home
# zfs create tank/home/bricker
# zfs create tank/home/tabriz
# zfs set sharenfs=ro tank/home/tabriz</pre>
</div>
</div>
<div class="paragraph">
<p>Both <code>tank/home/bricker</code> and <code>tank/home/tabriz</code> are initially shared
writable because they inherit the sharenfs property from <code>tank/home</code>.
Once the property is set to <code>ro</code> (readonly), <code>tank/home/tabriz</code> is
shared read-only regardless of the sharenfs property that is set for
<code>tank/home</code>.</p>
</div>
<div id="unsharing-zfs-file-systems" class="paragraph">
<p>===== Unsharing ZFS File Systems</p>
</div>
<div class="paragraph">
<p>While most file systems are automatically shared and unshared during
boot, creation, and destruction, file systems sometimes need to be
explicitly unshared. To do so, use the <code>zfs unshare</code> command. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs unshare tank/home/tabriz</pre>
</div>
</div>
<div class="paragraph">
<p>This command unshares the <code>tank/home/tabriz</code> file system. To unshare all
ZFS file systems on the system, you need to use the <code>a</code> option.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs unshare -a</pre>
</div>
</div>
<div id="sharing-zfs-file-systems" class="paragraph">
<p>===== Sharing ZFS File Systems</p>
</div>
<div class="paragraph">
<p>Most of the time the automatic behavior of ZFS, sharing on boot and
creation, is sufficient for normal operation. If, for some reason, you
unshare a file system, you can share it again by using the <code>zfs share</code>
command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs share tank/home/tabriz</pre>
</div>
</div>
<div class="paragraph">
<p>You can also share all ZFS file systems on the system by using the <code>a</code>
option.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs share -a</pre>
</div>
</div>
<div id="legacy-share-behavior" class="paragraph">
<p>===== Legacy Share Behavior</p>
</div>
<div class="paragraph">
<p>If the sharenfs property is <code>off</code>, then ZFS does not attempt to share or
unshare the file system at any time. This setting enables you to
administer through traditional means such as the <code>/etc/dfs/dfstab</code> file.</p>
</div>
<div class="paragraph">
<p>Unlike the traditional <code>mount</code> command, the traditional <code>share</code> and
<code>unshare</code> commands can still function on ZFS file systems. As a result,
you can manually share a file system with options that are different
from the settings of the <code>sharenfs</code> property. This administrative model
is discouraged. Choose to either manage NFS shares completely through
ZFS or completely through the <code>/etc/dfs/dfstab</code> file. The ZFS
administrative model is designed to be simpler and less work than the
traditional model. However, in some cases, you might still want to
control file system sharing behavior through the familiar model.</p>
</div>
<div id="sharing-zfs-files-in-a-solaris-cifs-environment" class="paragraph">
<p>==== Sharing ZFS Files in a Solaris CIFS Environment</p>
</div>
<div class="paragraph">
<p>The <code>sharesmb</code> property is provided to share ZFS files by using the
Solaris CIFS software product. When this property is set on a ZFS file
system, these shares are visible to CIFS client systems. For more
information about using the CIFS software product, see the System
Administration Guide: Windows Interoperability.</p>
</div>
<div class="paragraph">
<p>For a detailed description of the <code>sharesmb</code> property, see
<a href="#the-sharesmb-property">The Property</a>.</p>
</div>
<div id="gfwqk" class="paragraph">
<p>Example—Sharing ZFS File Systems (<code>sharesmb</code>)</p>
</div>
<div class="paragraph">
<p>In this example, a ZFS file system <code>sandbox/fs1</code> is created and shared
with the <code>sharesmb</code> property. If necessary, enable the SMB services.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># svcadm enable -r smb/server
svcadm: svc:/milestone/network depends on svc:/network/physical, which has multiple instances.
# svcs | grep smb
online         10:47:15 svc:/network/smb/server:default</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create sandbox mirror c0t2d0 c0t4d0
# zfs create sandbox/fs1
# zfs set sharesmb=on sandbox/fs1</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>sharesmb</code> property is set for <code>sandbox/fs1</code> and its descendents.</p>
</div>
<div class="paragraph">
<p>Verify that the file system was shared. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sharemgr show -vp
default nfs=()
zfs nfs=()
    zfs/sandbox/fs1 smb=()
          sandbox_fs1=/sandbox/fs1</pre>
</div>
</div>
<div class="paragraph">
<p>A default SMB resource name, <code>sandbox_fs1</code>, is assigned
automatically.</p>
</div>
<div class="paragraph">
<p>In this example, another file system is created, <code>sandbox/fs2</code>, and
shared with a resource name, <code>myshare</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create sandbox/fs2
# zfs set sharesmb=name=myshare sandbox/fs2
# sharemgr show -vp
default nfs=()
zfs nfs=()
    zfs/sandbox/fs1 smb=()
          sandbox_fs1=/sandbox/fs1
    zfs/sandbox/fs2 smb=()
          myshare=/sandbox/fs2</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>sandbox/fs2/fs2_sub1</code> file system is created and is
automatically shared. The inherited resource name is
<code>myshare_fs2_sub1</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create sandbox/fs2/fs2_sub1
# sharemgr show -vp
default nfs=()
zfs nfs=()
    zfs/sandbox/fs1 smb=()
          sandbox_fs1=/sandbox/fs1
    zfs/sandbox/fs2 smb=()
          myshare=/sandbox/fs2
          myshare_fs2_sub1=/sandbox/fs2/fs2_sub1</pre>
</div>
</div>
<div class="paragraph">
<p>Disable SMB sharing for <code>sandbox/fs2</code> and its descendents.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set sharesmb=off sandbox/fs2
# sharemgr show -vp
default nfs=()
zfs nfs=()
    zfs/sandbox/fs1 smb=()
          sandbox_fs1=/sandbox/fs1</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>sharesmb</code> property is set on the pool&#8217;s top-level
file system. The descendent file systems are automatically shared.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create sandbox mirror c0t2d0 c0t4d0
# zfs set sharesmb=on sandbox
# zfs create sandbox/fs1
# zfs create sandbox/fs2</pre>
</div>
</div>
<div class="paragraph">
<p>The top-level file system has a resource name of <code>sandbox</code>, but the
descendents have their dataset name appended to the resource name.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sharemgr show -vp
default nfs=()
zfs nfs=()
    zfs/sandbox smb=()
          sandbox=/sandbox
          sandbox_fs1=/sandbox/fs1       smb=()
          sandbox_fs2=/sandbox/fs2       smb=()</pre>
</div>
</div>
<div id="zfs-quotas-and-reservations" class="paragraph">
<p>=== ZFS Quotas and Reservations</p>
</div>
<div class="paragraph">
<p>ZFS supports quotas and reservations at the file system level. You can
use the quota property to set a limit on the amount of space a file
system can use. In addition, you can use the reservation property to
guarantee that some amount of space is available to a file system. Both
properties apply to the dataset they are set on and all descendents of
that dataset.</p>
</div>
<div class="paragraph">
<p>That is, if a quota is set on the <code>tank/home</code> dataset, the total amount
of space used by <code>tank/home</code> <em>and all of its descendents</em> cannot exceed
the quota. Similarly, if <code>tank/home</code> is given a reservation, <code>tank/home</code>
<em>and all of its descendents</em> draw from that reservation. The amount of
space used by a dataset and all of its descendents is reported by the
used property.</p>
</div>
<div class="paragraph">
<p>In addition to the <code>quota</code> and <code>reservation</code> property, the <code>refquota</code>
and <code>refreservation</code> properties are available to manage file system
space without accounting for space consumed by descendents, such as
snapshots and clones.</p>
</div>
<div class="paragraph">
<p>Consider the following points to determine which quota and reservations
features might better manage your file systems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>quota</code> and <code>reservation</code> properties are convenient for managing
space consumed by datasets.</p>
</li>
<li>
<p>The <code>refquota</code> and <code>refreservation</code> properties are appropriate for
managing space consumed by datasets and snapshots.</p>
</li>
<li>
<p>Setting <code>refquota</code> or <code>refreservation</code> higher than quota or
reservation have no effect. If you set the <code>quota</code> or <code>refquota</code>
properties, operations that try to exceed either value fail. It is
possible to a exceed a <code>quota</code> that is greater than <code>refquota</code>. If some
snapshot blocks are dirtied, you might actually exceed the <code>quota</code>
before you exceed the <code>refquota</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information, see the examples below.</p>
</div>
<div id="setting-quotas-on-zfs-file-systems" class="paragraph">
<p>==== Setting Quotas on ZFS File Systems</p>
</div>
<div class="paragraph">
<p>ZFS quotas can be set and displayed by using the <code>zfs set</code> and <code>zfs get</code>
commands. In the following example, a quota of 10 Gbytes is set on
<code>tank/home/bonwick</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set quota=10G tank/home/bonwick
# zfs get quota tank/home/bonwick
NAME              PROPERTY      VALUE                      SOURCE
tank/home/bonwick quota         10.0G                      local</pre>
</div>
</div>
<div class="paragraph">
<p>ZFS quotas also impact the output of the <code>zfs list</code> and <code>df</code> commands.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list
NAME                   USED  AVAIL  REFER  MOUNTPOINT
tank/home             16.5K  33.5G  8.50K  /export/home
tank/home/bonwick     15.0K  10.0G  8.50K  /export/home/bonwick
tank/home/bonwick/ws  6.50K  10.0G  8.50K  /export/home/bonwick/ws
# df -h /export/home/bonwick
Filesystem             size   used  avail capacity  Mounted on
tank/home/bonwick       10G     8K    10G     1%    /export/home/bonwick</pre>
</div>
</div>
<div class="paragraph">
<p>Note that although <code>tank/home</code> has 33.5 Gbytes of space available,
<code>tank/home/bonwick</code> and <code>tank/home/bonwick/ws</code> only have 10 Gbytes of
space available, due to the quota on <code>tank/home/bonwick</code>.</p>
</div>
<div class="paragraph">
<p>You cannot set a quota to an amount less than is currently being used by
a dataset. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set quota=10K tank/home/bonwick
cannot set quota for 'tank/home/bonwick': size is less than current used or
reserved space</pre>
</div>
</div>
<div class="paragraph">
<p>You can set a <code>refquota</code> on a dataset that limits the amount of space
that the dataset can consume. This hard limit does not include space
that is consumed by snapshots and clones. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set refquota=10g students/studentA
# zfs list
NAME                USED  AVAIL  REFER  MOUNTPOINT
profs               106K  33.2G    18K  /profs
students           57.7M  33.2G    19K  /students
students/studentA  57.5M  9.94G  57.5M  /students/studentA
# zfs snapshot students/studentA@today
# zfs list
NAME                      USED  AVAIL  REFER  MOUNTPOINT
profs                     106K  33.2G    18K  /profs
students                 57.7M  33.2G    19K  /students
students/studentA        57.5M  9.94G  57.5M  /students/studentA
students/studentA@today      0      -  57.5M  -</pre>
</div>
</div>
<div class="paragraph">
<p>For additional convenience, you can set another quota on a dataset to
help manage the space that is consumed by snapshots. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set quota=20g students/studentA
# zfs list
NAME                      USED  AVAIL  REFER  MOUNTPOINT
profs                     106K  33.2G    18K  /profs
students                 57.7M  33.2G    19K  /students
students/studentA        57.5M  9.94G  57.5M  /students/studentA
students/studentA@today      0      -  57.5M  -</pre>
</div>
</div>
<div class="paragraph">
<p>In this scenario, <code>studentA</code> can bump into the refquota (10 Gbytes) hard
limit and remove files to recover even if snapshots exist.</p>
</div>
<div class="paragraph">
<p>In the above example, the smaller of the two quotas (10 Gbytes versus 20
Gbytes) is displayed in the <code>zfs list</code> output. To see the value of both
quotas, use the <code>zfs get</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get refquota,quota students/studentA
NAME               PROPERTY  VALUE              SOURCE
students/studentA  refquota  10G                local
students/studentA  quota     20G                local</pre>
</div>
</div>
<div id="setting-reservations-on-zfs-file-systems" class="paragraph">
<p>==== Setting Reservations on ZFS File Systems</p>
</div>
<div class="paragraph">
<p>A ZFS <em>reservation</em> is an allocation of space from the pool that is
guaranteed to be available to a dataset. As such, you cannot reserve
space for a dataset if that space is not currently available in the
pool. The total amount of all outstanding unconsumed reservations cannot
exceed the amount of unused space in the pool. ZFS reservations can be
set and displayed by using the <code>zfs set</code> and <code>zfs get</code> commands. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set reservation=5G tank/home/moore
# zfs get reservation tank/home/moore
NAME             PROPERTY      VALUE                      SOURCE
tank/home/moore  reservation   5.00G                      local</pre>
</div>
</div>
<div class="paragraph">
<p>ZFS reservations can affect the output of the <code>zfs list</code> command. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list
NAME                   USED  AVAIL  REFER  MOUNTPOINT
tank/home             5.00G  33.5G  8.50K  /export/home
tank/home/moore       15.0K  10.0G  8.50K  /export/home/moore</pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>tank/home</code> is using 5 Gbytes of space, although the total
amount of space referred to by <code>tank/home</code> and its descendents is much
less than 5 Gbytes. The used space reflects the space reserved for
<code>tank/home/moore</code>. Reservations are considered in the used space of the
parent dataset and do count against its quota, reservation, or both.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set quota=5G pool/filesystem
# zfs set reservation=10G pool/filesystem/user1
cannot set reservation for 'pool/filesystem/user1': size is greater than
available space</pre>
</div>
</div>
<div class="paragraph">
<p>A dataset can use more space than its reservation, as long as space is
available in the pool that is unreserved and the dataset&#8217;s current usage
is below its quota. A dataset cannot consume space that has been
reserved for another dataset.</p>
</div>
<div class="paragraph">
<p>Reservations are not cumulative. That is, a second invocation of
<code>zfs set</code> to set a reservation does not add its reservation to the
existing reservation. Rather, the second reservation replaces the first
reservation.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set reservation=10G tank/home/moore
# zfs set reservation=5G tank/home/moore
# zfs get reservation tank/home/moore
NAME             PROPERTY      VALUE                      SOURCE
tank/home/moore  reservation   5.00G                      local</pre>
</div>
</div>
<div class="paragraph">
<p>You can set a <code>refreservation</code> to guarantee space for a dataset that
does not include space consumed by snapshots and clones. The
<code>refreservation</code> reservation is accounted for in the parent datasets'
space used, and counts against the parent datasets' quotas and
reservations. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set refreservation=10g profs/prof1
# zfs list
NAME                      USED  AVAIL  REFER  MOUNTPOINT
profs                    10.0G  23.2G    19K  /profs
profs/prof1                10G  33.2G    18K  /profs/prof1</pre>
</div>
</div>
<div class="paragraph">
<p>You can also set a reservation on the same dataset to guarantee dataset
space and snapshot space. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set reservation=20g profs/prof1
# zfs list
NAME                      USED  AVAIL  REFER  MOUNTPOINT
profs                    20.0G  13.2G    19K  /profs
profs/prof1                10G  33.2G    18K  /profs/prof1</pre>
</div>
</div>
<div class="paragraph">
<p>Regular reservations are accounted for in the parent&#8217;s used space.</p>
</div>
<div class="paragraph">
<p>In the above example, the smaller of the two quotas (10 Gbytes versus 20
Gbytes) is displayed in the <code>zfs list</code> output. To see the value of both
quotas, use the <code>zfs get</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs get reservation,refreserv profs/prof1
NAME         PROPERTY        VALUE        SOURCE
profs/prof1  reservation     20G          local
profs/prof1  refreservation  10G          local</pre>
</div>
</div>
<div class="paragraph">
<p>If <code>refreservation</code> is set, a snapshot is only allowed if enough free
pool space exists outside of this reservation to accommodate the current
number of <em>referenced</em> bytes in the dataset.</p>
</div>
<div id="working-with-zfs-snapshots-and-clones" class="paragraph">
<p>== Working With ZFS Snapshots and Clones</p>
</div>
<div class="paragraph">
<p>This chapter describes how to create and manage ZFS snapshots and
clones. Information about saving snapshots is also provided in this
chapter.</p>
</div>
<div class="paragraph">
<p>The following sections are provided in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#overview-of-zfs-snapshots">Overview of ZFS Snapshots</a></p>
</li>
<li>
<p><a href="#creating-and-destroying-zfs-snapshots">Creating and Destroying ZFS Snapshots</a></p>
</li>
<li>
<p><a href="#displaying-and-accessing-zfs-snapshots">Displaying and Accessing ZFS Snapshots</a></p>
</li>
<li>
<p><a href="#rolling-back-to-a-zfs-snapshot">Rolling Back to a ZFS Snapshot</a></p>
</li>
<li>
<p><a href="#overview-of-zfs-clones">Overview of ZFS Clones</a></p>
</li>
<li>
<p><a href="#creating-a-zfs-clone">Creating a ZFS Clone</a></p>
</li>
<li>
<p><a href="#destroying-a-zfs-clone">Destroying a ZFS Clone</a></p>
</li>
<li>
<p><a href="#saving-and-restoring-zfs-data">Saving and Restoring ZFS Data</a></p>
</li>
</ul>
</div>
<div id="overview-of-zfs-snapshots" class="paragraph">
<p>=== Overview of ZFS Snapshots</p>
</div>
<div class="paragraph">
<p>A <em>snapshot</em> is a read-only copy of a file system or volume. Snapshots
can be created almost instantly, and initially consume no additional
disk space within the pool. However, as data within the active dataset
changes, the snapshot consumes disk space by continuing to reference the
old data and so prevents the space from being freed.</p>
</div>
<div class="paragraph">
<p>ZFS snapshots include the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Persist across system reboots.</p>
</li>
<li>
<p>The theoretical maximum number of snapshots is 2<sup>64</sup>.</p>
</li>
<li>
<p>Use no separate backing store. Snapshots consume disk space directly
from the same storage pool as the file system from which they were
created.</p>
</li>
<li>
<p>Recursive snapshots are created quickly as one atomic operation. The
snapshots are created together (all at once) or not created at all. The
benefit of atomic snapshots operations is that the snapshot data is
always taken at one consistent time, even across descendent file
systems.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Snapshots of volumes cannot be accessed directly, but they can be
cloned, backed up, rolled back to, and so on. For information about
backing up a ZFS snapshot, see <a href="#saving-and-restoring-zfs-data">Saving and Restoring ZFS
Data</a>.</p>
</div>
<div id="creating-and-destroying-zfs-snapshots" class="paragraph">
<p>==== Creating and Destroying ZFS Snapshots</p>
</div>
<div class="paragraph">
<p>Snapshots are created by using the <code>zfs snapshot</code> command, which takes
as its only argument the name of the snapshot to create. The snapshot
name is specified as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>filesystem@snapname
volume@snapname</pre>
</div>
</div>
<div class="paragraph">
<p>The snapshot name must satisfy the naming conventions defined in
<a href="#zfs-component-naming-requirements">ZFS Component Naming Requirements</a>.</p>
</div>
<div class="paragraph">
<p>In the following example, a snapshot of <code>tank/home/ahrens</code> that is named
<code>friday</code> is created.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs snapshot tank/home/ahrens@friday</pre>
</div>
</div>
<div class="paragraph">
<p>You can create snapshots for all descendent file systems by using the
<code>r</code> option. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs snapshot -r tank/home@now
# zfs list -t snapshot
NAME                   USED  AVAIL  REFER  MOUNTPOINT
tank/home@now             0      -  29.5K  -
tank/home/ahrens@now      0      -  2.15M  -
tank/home/anne@now        0      -  1.89M  -
tank/home/bob@now         0      -  1.89M  -
tank/home/cindys@now      0      -  2.15M  -</pre>
</div>
</div>
<div class="paragraph">
<p>Snapshots have no modifiable properties. Nor can dataset properties be
applied to a snapshot.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set compression=on tank/home/ahrens@tuesday
cannot set compression property for 'tank/home/ahrens@tuesday': snapshot
properties cannot be modified</pre>
</div>
</div>
<div class="paragraph">
<p>Snapshots are destroyed by using the <code>zfs destroy</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs destroy tank/home/ahrens@friday</pre>
</div>
</div>
<div class="paragraph">
<p>A dataset cannot be destroyed if snapshots of the dataset exist. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs destroy tank/home/ahrens
cannot destroy 'tank/home/ahrens': filesystem has children
use '-r' to destroy the following datasets:
tank/home/ahrens@tuesday
tank/home/ahrens@wednesday
tank/home/ahrens@thursday</pre>
</div>
</div>
<div class="paragraph">
<p>In addition, if clones have been created from a snapshot, then they must
be destroyed before the snapshot can be destroyed.</p>
</div>
<div class="paragraph">
<p>For more information about the <code>destroy</code> subcommand, see
<a href="#destroying-a-zfs-file-system">Destroying a ZFS File System</a>.</p>
</div>
<div id="renaming-zfs-snapshots" class="paragraph">
<p>===== Renaming ZFS Snapshots</p>
</div>
<div class="paragraph">
<p>You can rename snapshots but they must be renamed within the pool and
dataset from which they were created. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs rename tank/home/cindys@083006 tank/home/cindys@today</pre>
</div>
</div>
<div class="paragraph">
<p>In addition, the following shortcut syntax provides equivalent snapshot
renaming syntax as the example above.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs rename tank/home/cindys@083006 today</pre>
</div>
</div>
<div class="paragraph">
<p>The following snapshot rename operation is not supported because the
target pool and file system name are different from the pool and file
system where the snapshot was created.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs rename tank/home/cindys@today pool/home/cindys@saturday
cannot rename to 'pool/home/cindys@today': snapshots must be part of same</pre>
</div>
</div>
<div class="paragraph">
<p>You can recursively rename snapshots with the <code>zfs rename</code> <code>r</code> command.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list
NAME                         USED  AVAIL  REFER  MOUNTPOINT
users                        270K  16.5G    22K  /users
users/home                    76K  16.5G    22K  /users/home
users/home@yesterday            0      -    22K  -
users/home/markm              18K  16.5G    18K  /users/home/markm
users/home/markm@yesterday      0      -    18K  -
users/home/marks              18K  16.5G    18K  /users/home/marks
users/home/marks@yesterday      0      -    18K  -
users/home/neil               18K  16.5G    18K  /users/home/neil
users/home/neil@yesterday       0      -    18K  -
# zfs rename -r users/home@yesterday @2daysago
# zfs list -r users/home
NAME                        USED  AVAIL  REFER  MOUNTPOINT
users/home                   76K  16.5G    22K  /users/home
users/home@2daysago            0      -    22K  -
users/home/markm             18K  16.5G    18K  /users/home/markm
users/home/markm@2daysago      0      -    18K  -
users/home/marks             18K  16.5G    18K  /users/home/marks
users/home/marks@2daysago      0      -    18K  -
users/home/neil              18K  16.5G    18K  /users/home/neil
users/home/neil@2daysago       0      -    18K  -</pre>
</div>
</div>
<div id="displaying-and-accessing-zfs-snapshots" class="paragraph">
<p>==== Displaying and Accessing ZFS Snapshots</p>
</div>
<div class="paragraph">
<p>Snapshots of file systems are accessible in the <code>.zfs/snapshot</code>
directory within the root of the containing file system. For example, if
<code>tank/home/ahrens</code> is mounted on <code>/home/ahrens</code>, then the
<code>tank/home/ahrens@thursday</code> snapshot data is accessible in the
<code>/home/ahrens/.zfs/snapshot/thursday</code> directory.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls /tank/home/ahrens/.zfs/snapshot
tuesday wednesday thursday</pre>
</div>
</div>
<div class="paragraph">
<p>You can list snapshots as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list -t snapshot
NAME                        USED  AVAIL  REFER  MOUNTPOINT
pool/home/anne@monday          0      -   780K  -
pool/home/bob@monday           0      -  1.01M  -
tank/home/ahrens@tuesday   8.50K      -   780K  -
tank/home/ahrens@wednesday 8.50K      -  1.01M  -
tank/home/ahrens@thursday      0      -  1.77M  -
tank/home/cindys@today     8.50K      -   524K  -</pre>
</div>
</div>
<div class="paragraph">
<p>You can list snapshots that were created for a particular file system as
follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list -r -t snapshot -o name,creation tank/home
NAME                       CREATION
tank/home@now               Wed Aug 30 10:53 2006
tank/home/ahrens@tuesday    Wed Aug 30 10:53 2006
tank/home/ahrens@wednesday  Wed Aug 30 10:54 2006
tank/home/ahrens@thursday   Wed Aug 30 10:53 2006
tank/home/cindys@now        Wed Aug 30 10:57 2006</pre>
</div>
</div>
<div id="snapshot-space-accounting" class="paragraph">
<p>===== Snapshot Space Accounting</p>
</div>
<div class="paragraph">
<p>When a snapshot is created, its space is initially shared between the
snapshot and the file system, and possibly with previous snapshots. As
the file system changes, space that was previously shared becomes unique
to the snapshot, and thus is counted in the snapshot&#8217;s used property.
Additionally, deleting snapshots can increase the amount of space unique
to (and thus <em>used</em> by) other snapshots.</p>
</div>
<div class="paragraph">
<p>A snapshot&#8217;s space referenced property is the same as the file system&#8217;s
was when the snapshot was created.</p>
</div>
<div id="rolling-back-to-a-zfs-snapshot" class="paragraph">
<p>==== Rolling Back to a ZFS Snapshot</p>
</div>
<div class="paragraph">
<p>The <code>zfs rollback</code> command can be used to discard all changes made since
a specific snapshot. The file system reverts to its state at the time
the snapshot was taken. By default, the command cannot roll back to a
snapshot other than the most recent snapshot.</p>
</div>
<div class="paragraph">
<p>To roll back to an earlier snapshot, all intermediate snapshots must be
destroyed. You can destroy earlier snapshots by specifying the <code>r</code>
option.</p>
</div>
<div class="paragraph">
<p>If clones of any intermediate snapshots exist, the <code>R</code> option must be
specified to destroy the clones as well.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The file system that you want to roll back must be unmounted and
remounted, if it is currently mounted. If the file system cannot be
unmounted, the rollback fails. The <code>f</code> option forces the file system to
be unmounted, if necessary.</p>
</div>
<div class="paragraph">
<p>In the following example, the <code>tank/home/ahrens</code> file system is rolled
back to the <code>tuesday</code> snapshot:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs rollback tank/home/ahrens@tuesday
cannot rollback to 'tank/home/ahrens@tuesday': more recent snapshots exist
use '-r' to force deletion of the following snapshots:
tank/home/ahrens@wednesday
tank/home/ahrens@thursday
# zfs rollback -r tank/home/ahrens@tuesday</pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, the <code>wednesday</code> and <code>thursday</code> snapshots are
removed because you rolled back to the previous <code>tuesday</code> snapshot.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list -r -t snapshot -o name,creation tank/home/ahrens
NAME                      CREATION
tank/home/ahrens@tuesday  Wed Aug 30 10:53 2006</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="overview-of-zfs-clones"><a class="anchor" href="#overview-of-zfs-clones"></a>3.11. Overview of ZFS Clones</h3>
<div class="paragraph">
<p>A <em>clone</em> is a writable volume or file system whose initial contents are
the same as the dataset from which it was created. As with snapshots,
creating a clone is nearly instantaneous, and initially consumes no
additional disk space. In addition, you can snapshot a clone.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-a-zfs-clone">Creating a ZFS Clone</a></p>
</li>
<li>
<p><a href="#destroying-a-zfs-clone">Destroying a ZFS Clone</a></p>
</li>
<li>
<p><a href="#replacing-a-zfs-file-system-with-a-zfs-clone">Replacing a ZFS File System With a ZFS Clone</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Clones can only be created from a snapshot. When a snapshot is cloned,
an implicit dependency is created between the clone and snapshot. Even
though the clone is created somewhere else in the dataset hierarchy, the
original snapshot cannot be destroyed as long as the clone exists. The
origin property exposes this dependency, and the <code>zfs destroy</code> command
lists any such dependencies, if they exist.</p>
</div>
<div class="paragraph">
<p>Clones do not inherit the properties of the dataset from which it was
created. Use the <code>zfs get</code> and <code>zfs set</code> commands to view and change the
properties of a cloned dataset. For more information about setting ZFS
dataset properties, see <a href="#setting-zfs-properties">Setting ZFS Properties</a>.</p>
</div>
<div class="paragraph">
<p>Because a clone initially shares all its disk space with the original
snapshot, its used property is initially zero. As changes are made to
the clone, it uses more space. The used property of the original
snapshot does not consider the disk space consumed by the clone.</p>
</div>
<div class="sect3">
<h4 id="creating-a-zfs-clone"><a class="anchor" href="#creating-a-zfs-clone"></a>3.11.1. Creating a ZFS Clone</h4>
<div class="paragraph">
<p>To create a clone, use the <code>zfs clone</code> command, specifying the snapshot
from which to create the clone, and the name of the new file system or
volume. The new file system or volume can be located anywhere in the ZFS
hierarchy. The type of the new dataset (for example, file system or
volume) is the same type as the snapshot from which the clone was
created. You cannot create clone of a file system in a pool that is
different from where the original file system snapshot resides.</p>
</div>
<div class="paragraph">
<p>In the following example, a new clone named <code>tank/home/ahrens/bug123</code>
with the same initial contents as the snapshot <code>tank/ws/gate@yesterday</code>
is created.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs snapshot tank/ws/gate@yesterday
# zfs clone tank/ws/gate@yesterday tank/home/ahrens/bug123</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, a cloned workspace is created from the
<code>projects/newproject@today</code> snapshot for a temporary user as
<code>projects/teamA/tempuser</code>. Then, properties are set on the cloned
workspace.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs snapshot projects/newproject@today
# zfs clone projects/newproject@today projects/teamA/tempuser
# zfs set sharenfs=on projects/teamA/tempuser
# zfs set quota=5G projects/teamA/tempuser</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="destroying-a-zfs-clone"><a class="anchor" href="#destroying-a-zfs-clone"></a>3.11.2. Destroying a ZFS Clone</h4>
<div class="paragraph">
<p>ZFS clones are destroyed by using the <code>zfs destroy</code> command. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs destroy tank/home/ahrens/bug123</pre>
</div>
</div>
<div class="paragraph">
<p>Clones must be destroyed before the parent snapshot can be destroyed.</p>
</div>
</div>
<div class="sect3">
<h4 id="replacing-a-zfs-file-system-with-a-zfs-clone"><a class="anchor" href="#replacing-a-zfs-file-system-with-a-zfs-clone"></a>3.11.3. Replacing a ZFS File System With a ZFS Clone</h4>
<div class="paragraph">
<p>You can use the <code>zfs promote</code> command to replace an active ZFS file
system with a clone of that file system. This feature facilitates the
ability to clone and replace file systems so that the “origin” file
system become the clone of the specified file system. In addition, this
feature makes it possible to destroy the file system from which the
clone was originally created. Without clone promotion, you cannot
destroy a “origin” file system of active clones. For more information
about destroying clones, see <a href="#destroying-a-zfs-clone">Destroying a ZFS Clone</a>.</p>
</div>
<div class="paragraph">
<p>In the following example, the <code>tank/test/productA</code> file system is cloned
and then the clone file system, <code>tank/test/productAbeta</code> becomes the
<code>tank/test/productA</code> file system.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create tank/test
# zfs create tank/test/productA
# zfs snapshot tank/test/productA@today
# zfs clone tank/test/productA@today tank/test/productAbeta
# zfs list -r tank/test
NAME                   USED  AVAIL  REFER  MOUNTPOINT
tank/test              314K  8.24G  25.5K  /tank/test
tank/test/productA     288K  8.24G   288K  /tank/test/productA
tank/test/productA@today      0      -   288K  -
tank/test/productAbeta      0  8.24G   288K  /tank/test/productAbeta
# zfs promote tank/test/productAbeta
# zfs list -r tank/test
NAME                   USED  AVAIL  REFER  MOUNTPOINT
tank/test              316K  8.24G  27.5K  /tank/test
tank/test/productA        0  8.24G   288K  /tank/test/productA
tank/test/productAbeta   288K  8.24G   288K  /tank/test/productAbeta
tank/test/productAbeta@today      0      -   288K  -</pre>
</div>
</div>
<div class="paragraph">
<p>In the above <code>zfs</code> <code>list</code> output, you can see that the space accounting
of the original <code>productA</code> file system has been replaced with the
<code>productAbeta</code> file system.</p>
</div>
<div class="paragraph">
<p>Complete the clone replacement process by renaming the file systems. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs rename tank/test/productA tank/test/productAlegacy
# zfs rename tank/test/productAbeta tank/test/productA
# zfs list -r tank/test
NAME                   USED  AVAIL  REFER  MOUNTPOINT
tank/test              316K  8.24G  27.5K  /tank/test
tank/test/productA     288K  8.24G   288K  /tank/test/productA
tank/test/productA@today      0      -   288K  -
tank/test/productAlegacy      0  8.24G   288K  /tank/test/productAlegacy</pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, you can remove the legacy file system. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs destroy tank/test/productAlegacy</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="saving-and-restoring-zfs-data"><a class="anchor" href="#saving-and-restoring-zfs-data"></a>3.12. Saving and Restoring ZFS Data</h3>
<div class="paragraph">
<p>The <code>zfs send</code> command creates a stream representation of a snapshot
that is written to standard output. By default, a full stream is
generated. You can redirect the output to a file or to a different
system. The <code>zfs receive</code> command creates a snapshot whose contents are
specified in the stream that is provided on standard input. If a full
stream is received, a new file system is created as well. You can save
ZFS snapshot data and restore ZFS snapshot data and file systems with
these commands. See the examples in the next section.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#saving-zfs-data-with-other-backup-products">Saving ZFS Data With Other Backup Products</a></p>
</li>
<li>
<p><a href="#saving-a-zfs-snapshot">Saving a ZFS Snapshot</a></p>
</li>
<li>
<p><a href="#restoring-a-zfs-snapshot">Restoring a ZFS Snapshot</a></p>
</li>
<li>
<p><a href="#remote-replication-of-zfs-data">Remote Replication of ZFS Data</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following solutions for saving ZFS data are provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Saving ZFS snapshots and rolling back snapshots, if necessary.</p>
</li>
<li>
<p>Saving full and incremental copies of ZFS snapshots and restoring the
snapshots and file systems, if necessary.</p>
</li>
<li>
<p>Remotely replicating ZFS file systems by saving and restoring ZFS
snapshots and file systems.</p>
</li>
<li>
<p>Saving ZFS data with archive utilities such as <code>tar</code> and <code>cpio</code> or
third-party backup products.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider the following when choosing a solution for saving ZFS data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>File system snapshots and rolling back snapshots – Use the
<code>zfs snapshot</code> and <code>zfs rollback</code> commands if you want to easily create
a copy of a file system and revert back to a previous file system
version, if necessary. For example, if you want to restore a file or
files from a previous version of a file system, you could use this
solution.</p>
<div class="paragraph">
<p>For more information about creating and rolling back to a snapshot, see
<a href="#overview-of-zfs-snapshots">Overview of ZFS Snapshots</a>.</p>
</div>
</li>
<li>
<p>Saving snapshots – Use the <code>zfs send</code> and <code>zfs receive</code> commands to
save and restore a ZFS snapshot. You can save incremental changes
between snapshots, but you cannot restore files individually. You must
restore the entire file system snapshot.</p>
</li>
<li>
<p>Remote replication – Use the <code>zfs send</code> and <code>zfs receive</code> commands
when you want to copy a file system from one system to another. This
process is different from a traditional volume management product that
might mirror devices across a WAN. No special configuration or hardware
is required. The advantage of replicating a ZFS file system is that you
can re-create a file system on a storage pool on another system, and
specify different levels of configuration for the newly created pool,
such as RAID-Z, but with identical file system data.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="saving-zfs-data-with-other-backup-products"><a class="anchor" href="#saving-zfs-data-with-other-backup-products"></a>3.12.1. Saving ZFS Data With Other Backup Products</h4>
<div class="paragraph">
<p>In addition to the <code>zfs send</code> and <code>zfs receive</code> commands, you can also
use archive utilities, such as <code>tar(1)</code> and <code>cpio(1)</code>, to save ZFS
files. All of these utilities save and restore ZFS file attributes and
ACLs. Check the appropriate options for the <code>tar</code> and <code>cpio</code> commands.</p>
</div>
<div class="paragraph">
<p>For up-to-date information about issues with ZFS and third-party backup
products, please see the Solaris Express Developer Edition release
notes.</p>
</div>
<div class="paragraph">
<p><a href="http://opensolaris.org/os/community/zfs/faq/#backupsoftware" class="bare">http://opensolaris.org/os/community/zfs/faq/#backupsoftware</a></p>
</div>
</div>
<div class="sect3">
<h4 id="saving-a-zfs-snapshot"><a class="anchor" href="#saving-a-zfs-snapshot"></a>3.12.2. Saving a ZFS Snapshot</h4>
<div class="paragraph">
<p>The most common use of the <code>zfs send</code> command is to save a copy of a
snapshot and receive the snapshot on another system that is used to
store backup data. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>host1# zfs send tank/dana@snap1 | ssh host2 zfs recv newtank/dana</pre>
</div>
</div>
<div class="paragraph">
<p>When sending a full stream, the destination file system must not exist.</p>
</div>
<div class="paragraph">
<p>You can save incremental data by using the <code>zfs send</code> <code>i</code> option. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>host1# zfs send -i tank/dana@snap1 tank/dana@snap2 | ssh host2 zfs recv newtank/dana</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the first argument is the earlier snapshot and the second
argument is the later snapshot. In this case, the <code>newtank/dana</code> file
system must exist for the incremental receive to be successful.</p>
</div>
<div class="paragraph">
<p>The incremental &lt;snapshot1&gt; source can be specified as the last
component of the snapshot name. This shortcut means you only have to
specify the name after the <code>@</code> sign for &lt;snapshot1&gt;, which is
assumed to be from the same file system as &lt;snapshot2&gt;. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>host1# zfs send -i snap1 tank/dana@snap2 &gt; ssh host2 zfs recv newtank/dana</pre>
</div>
</div>
<div class="paragraph">
<p>This syntax is equivalent to the above example of the incremental
syntax.</p>
</div>
<div class="paragraph">
<p>The following message is displayed if you attempt to generate an
incremental stream from a different file system &lt;snapshot1&gt;:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>cannot send 'pool/fs@name': not an earlier snapshot from the same fs</pre>
</div>
</div>
<div class="paragraph">
<p>If you need to store many copies, you might consider compressing a ZFS
snapshot stream representation with the <code>gzip</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs send pool/fs@snap | gzip &gt; backupfile.gz</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="restoring-a-zfs-snapshot"><a class="anchor" href="#restoring-a-zfs-snapshot"></a>3.12.3. Restoring a ZFS Snapshot</h4>
<div class="paragraph">
<p>Keep the following key points in mind when you restore a file system
snapshot:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The snapshot and the file system are restored.</p>
</li>
<li>
<p>The file system and all descendent file systems are unmounted.</p>
</li>
<li>
<p>The file systems are inaccessible while they are being restored.</p>
</li>
<li>
<p>The original file system to be restored must not exist while it is
being restored.</p>
</li>
<li>
<p>If a conflicting file system name exists, <code>zfs rename</code> can be used to
rename the file system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs send tank/gozer@0830 &gt; /bkups/gozer.083006
# zfs receive tank/gozer2@today &lt; /bkups/gozer.083006
# zfs rename tank/gozer tank/gozer.old
# zfs rename tank/gozer2 tank/gozer</pre>
</div>
</div>
<div class="paragraph">
<p>You can use <code>zfs recv</code> as an alias for the <code>zfs receive</code> command.</p>
</div>
<div class="paragraph">
<p>If you make a change to the file system and you want to do another
incremental send of a snapshot, you must first rollback the receiving
file system.</p>
</div>
<div class="paragraph">
<p>For example, if you make a change to the file system as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>host2# rm newtank/dana/file.1</pre>
</div>
</div>
<div class="paragraph">
<p>And you do an incremental send of <code>tank/dana@snap3</code>, you must first
rollback the receiving file system to receive the new incremental
snapshot. You can eliminate the rollback step by using the <code>F</code> option.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>host1# zfs send -i tank/dana@snap2 tank/dana@snap3 | ssh host2 zfs recv -F newtank/dana</pre>
</div>
</div>
<div class="paragraph">
<p>When you receive an incremental snapshot, the destination file system
must already exist.</p>
</div>
<div class="paragraph">
<p>If you make changes to the file system and you do not rollback the
receiving file system to receive the new incremental snapshot or you do
not use the <code>F</code> option, you will see the following message:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>host1# zfs send -i tank/dana@snap4 tank/dana@snap5 | ssh host2 zfs recv newtank/dana
cannot receive: destination has been modified since most recent snapshot</pre>
</div>
</div>
<div class="paragraph">
<p>The following checks are performed before the <code>F</code> option is successful:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the most recent snapshot doesn&#8217;t match the incremental source,
neither the rollback nor the receive is completed, and an error message
is returned.</p>
</li>
<li>
<p>If you accidentally provide the name of different file system that
doesn&#8217;t match the incremental source to the <code>zfs receive</code> command,
neither the rollback nor the receive is completed, and the following
error message is returned.</p>
<div class="literalblock">
<div class="content">
<pre>cannot send 'pool/fs@name': not an earlier snapshot from the same fs</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="sending-and-receiving-complex-zfs-snapshot-streams"><a class="anchor" href="#sending-and-receiving-complex-zfs-snapshot-streams"></a>3.12.4. Sending and Receiving Complex ZFS Snapshot Streams</h4>
<div class="paragraph">
<p>This section describes how to use the <code>zfs send</code> <code>I</code> and <code>R</code> options to
send and receive more complex snapshot streams.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <code>zfs send</code> <code>I</code> option to send all incremental streams from one
snapshot to a cumulative snapshot. Or, use this option to send an
incremental stream from the origin snapshot to create a clone. The
original snapshot must already exist on the receiving side to accept the
incremental stream.</p>
</li>
<li>
<p>Use the <code>zfs send</code> <code>R</code> option to send a replication stream of all
descendent file systems. When received, all properties, snapshots,
descendent file systems, and clones are preserved.</p>
</li>
<li>
<p>Or use both options to send an incremental replication stream.</p>
<div class="ulist">
<ul>
<li>
<p>Changes to properties and snapshot and file system renames and
destroys are preserved.</p>
</li>
<li>
<p>If <code>zfs recv</code> <code>F</code> is not specified when receiving the replication
stream, dataset destroys are ignored. The <code>zfs recv</code> <code>F</code> syntax in this
case also retains its <em>rollback if necessary</em> meaning.</p>
</li>
<li>
<p>As with other (non <code>zfs send</code> <code>R</code>) <code>i</code> or <code>I</code> cases, if <code>I</code> is used,
all snapshots between snapA and snapD are sent. If <code>i</code> is used, only
snapD (for all descendents) are sent.</p>
</li>
</ul>
</div>
</li>
<li>
<p>To receive any of these new types of <code>zfs send</code> streams, the receiving
system must be running a software version capable of sending them. The
stream version is incremented.</p>
</li>
<li>
<p>However, you can access streams from older pool versions by using a
newer software version, which can also access newer pool versions. For
example, you can send and receive streams created with the newer options
to and from a version 3 pool. But, you must be running recent software
to receive a stream sent with the newer options.</p>
</li>
</ul>
</div>
<div id="gfxpm" class="paragraph">
<p>Examples—Sending and Receiving Complex ZFS Snapshot Streams</p>
</div>
<div class="paragraph">
<p>A group of incremental snapshots can be combined into one snapshot by
using the <code>zfs send</code> <code>I</code> option. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs send -I pool/fs@snapA pool/fs@snapD &gt; /snaps/fs@all-I</pre>
</div>
</div>
<div class="paragraph">
<p>Remove snapshots B, C, and D.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs destroy pool/fs@snapB
# zfs destroy pool/fs@snapC
# zfs destroy pool/fs@snapD</pre>
</div>
</div>
<div class="paragraph">
<p>Restore the combined snapshot.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs receive -d -F pool/fs &lt; /snaps/fs@all-I
# zfs list
NAME                      USED  AVAIL  REFER  MOUNTPOINT
pool                      428K  16.5G    20K  /pool
pool/fs                    71K  16.5G    21K  /pool/fs
pool/fs@snapA              16K      -  18.5K  -
pool/fs@snapB              17K      -    20K  -
pool/fs@snapC              17K      -  20.5K  -
pool/fs@snapD                0      -    21K  -</pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>zfs send</code> <code>I</code> command to combine a snapshot and a
clone snapshot to create a combined dataset. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create pool/fs
# zfs snapshot pool/fs@snap1
# zfs clone pool/fs@snap1 pool/clone
# zfs snapshot pool/clone@snapA
# zfs send -I pool/fs@snap1 pool/clone@snapA &gt; /snaps/fsclonesnap-I
# zfs destroy pool/clone@snapA
# zfs destroy pool/clone
# zfs receive -F pool/clone &lt; /snaps/fsclonesnap-I</pre>
</div>
</div>
<div class="paragraph">
<p>Use the <code>zfs send</code> <code>R</code> command to replicate a ZFS file system and all
descendent file systems, up to the named snapshot. When received, all
properties, snapshots, descendent file systems, and clones are
preserved.</p>
</div>
<div class="paragraph">
<p>In the following example, snapshots are created of user file systems.
One replication stream is created of all user snapshots. Then, the
original file systems and snapshots are destroyed and recovered.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs snapshot -r users@today
# zfs list
NAME                USED  AVAIL  REFER  MOUNTPOINT
users               187K  33.2G    22K  /users
users@today            0      -    22K  -
users/user1          18K  33.2G    18K  /users/user1
users/user1@today      0      -    18K  -
users/user2          18K  33.2G    18K  /users/user2
users/user2@today      0      -    18K  -
users/user3          18K  33.2G    18K  /users/user3
users/user3@today      0      -    18K  -
# zfs send -R users@today &gt; /snaps/users-R
# zfs destroy -r users
# zfs receive -F -d users &lt; /snaps/users-R
# zfs list
NAME                USED  AVAIL  REFER  MOUNTPOINT
users               196K  33.2G    22K  /users
users@today            0      -    22K  -
users/user1          18K  33.2G    18K  /users/user1
users/user1@today      0      -    18K  -
users/user2          18K  33.2G    18K  /users/user2
users/user2@today      0      -    18K  -
users/user3          18K  33.2G    18K  /users/user3
users/user3@today      0      -    18K  -</pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>zfs send</code> <code>R</code> command to replicate the <code>users</code> dataset
and its descendents and send the replicated stream to another pool,
<code>users2</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create users2 mirror c0t1d0 c1t1d0
# zfs receive -F -d users2 &lt; /snaps/users-R
# zfs list
NAME                 USED  AVAIL  REFER  MOUNTPOINT
users                224K  33.2G    22K  /users
users@today             0      -    22K  -
users/user1           33K  33.2G    18K  /users/user1
users/user1@today     15K      -    18K  -
users/user2           18K  33.2G    18K  /users/user2
users/user2@today       0      -    18K  -
users/user3           18K  33.2G    18K  /users/user3
users/user3@today       0      -    18K  -
users2               188K  16.5G    22K  /users2
users2@today            0      -    22K  -
users2/user1          18K  16.5G    18K  /users2/user1
users2/user1@today      0      -    18K  -
users2/user2          18K  16.5G    18K  /users2/user2
users2/user2@today      0      -    18K  -
users2/user3          18K  16.5G    18K  /users2/user3
users2/user3@today      0      -    18K  -</pre>
</div>
</div>
<div class="sect4">
<h5 id="remote-replication-of-zfs-data"><a class="anchor" href="#remote-replication-of-zfs-data"></a>Remote Replication of ZFS Data</h5>
<div class="paragraph">
<p>You can use the <code>zfs send</code> and <code>zfs recv</code> commands to remotely copy a
snapshot stream representation from one system to another system. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs send tank/cindy@today | ssh newsys zfs recv sandbox/restfs@today</pre>
</div>
</div>
<div class="paragraph">
<p>This command saves the <code>tank/cindy@today</code> snapshot data and restores it
into the <code>sandbox/restfs</code> file system and also creates a <code>restfs@today</code>
snapshot on the <code>newsys</code> system. In this example, the user has been
configured to use <code>ssh</code> on the remote system.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-acls-to-protect-zfs-files"><a class="anchor" href="#using-acls-to-protect-zfs-files"></a>4. Using ACLs to Protect ZFS Files</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter provides information about using access control lists
(ACLs) to protect your ZFS files by providing more granular permissions
than the standard UNIX permissions.</p>
</div>
<div class="paragraph">
<p>The following sections are provided in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#the-nfsv4-acl-model">The NFSv4 ACL Model</a></p>
</li>
<li>
<p><a href="#setting-acls-on-zfs-files">Setting ACLs on ZFS Files</a></p>
</li>
<li>
<p><a href="#setting-and-displaying-acls-on-zfs-files-in-verbose-format">Setting and Displaying ACLs on ZFS Files in Verbose
Format</a></p>
</li>
<li>
<p><a href="#setting-and-displaying-acls-on-zfs-files-in-compact-format">Setting and Displaying ACLs on ZFS Files in Compact
Format</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="the-nfsv4-acl-model-1"><a class="anchor" href="#the-nfsv4-acl-model-1"></a>4.1. The NFSv4 ACL Model</h3>
<div class="paragraph">
<p>Older versions of Solaris supported an ACL implementation that was
primarily based on the POSIX-draft ACL specification. The POSIX-draft
based ACLs are used to protect UFS files and are translated by versions
of NFS prior to NFSv4.</p>
</div>
<div class="paragraph">
<p>With the introduction of NFSv4, a new ACL model fully supports the
interoperability that NFSv4 offers between UNIX and non-UNIX clients.
The new ACL implementation, as defined in the NFSv4 specification,
provides much richer semantics that are based on NT-style ACLs.</p>
</div>
<div class="paragraph">
<p>The main differences of the new ACL model are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Based on the NFSv4 specification and similar to NT-style ACLs.</p>
</li>
<li>
<p>Provide much more granular set of access privileges. For more
information, see <a href="#gbbht">ACL Access Privileges</a>.</p>
</li>
<li>
<p>Set and displayed with the <code>chmod</code> and <code>ls</code> commands rather than the
<code>setfacl</code> and <code>getfacl</code> commands.</p>
</li>
<li>
<p>Provide richer inheritance semantics for designating how access
privileges are applied from directory to subdirectories, and so on. For
more information, see <a href="#acl-inheritance">ACL Inheritance</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both ACL models provide more fine-grained access control than is
available with the standard file permissions. Much like POSIX-draft
ACLs, the new ACLs are composed of multiple Access Control Entries
(ACEs).</p>
</div>
<div class="paragraph">
<p>POSIX-draft style ACLs use a single entry to define what permissions are
allowed and what permissions are denied. The new ACL model has two types
of ACEs that affect access checking: <code>ALLOW</code> and <code>DENY</code>. As such, you
cannot infer from any single ACE that defines a set of permissions
whether or not the permissions that weren&#8217;t defined in that ACE are
allowed or denied.</p>
</div>
<div class="paragraph">
<p>Translation between NFSv4-style ACLs and POSIX-draft ACLs is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you use any ACL-aware utility, such as the <code>cp</code>, <code>mv</code>, <code>tar</code>,
<code>cpio</code>, or <code>rcp</code> commands, to transfer UFS files with ACLs to a ZFS file
system, the POSIX-draft ACLs are translated into the equivalent
NFSv4-style ACLs.</p>
</li>
<li>
<p>Some NFSv4-style ACLs are translated to POSIX-draft ACLs. You see a
message similar to the following if an NFSv4–style ACL isn&#8217;t translated
to a POSIX-draft ACL:</p>
<div class="literalblock">
<div class="content">
<pre># cp -p filea /var/tmp
cp: failed to set acl entries on /var/tmp/filea</pre>
</div>
</div>
</li>
<li>
<p>If you create a UFS <code>tar</code> or <code>cpio</code> archive with the preserve ACL
option (<code>tar</code> <code>p</code> or <code>cpio</code> <code>P</code>) on a system that runs a current Solaris
release, you will lose the ACLs when the archive is extracted on a
system that runs a previous Solaris release.</p>
<div class="paragraph">
<p>All of the files are extracted with the correct file modes, but the ACL
entries are ignored.</p>
</div>
</li>
<li>
<p>You can use the <code>ufsrestore</code> command to restore data into a ZFS file
system, but the ACLs will be lost.</p>
</li>
<li>
<p>If you attempt to set an NFSv4-style ACL on a UFS file, you see a
message similar to the following:</p>
<div class="literalblock">
<div class="content">
<pre>chmod: ERROR: ACL type's are different</pre>
</div>
</div>
</li>
<li>
<p>If you attempt to set a POSIX-style ACL on a ZFS file, you will see
messages similar to the following:</p>
<div class="literalblock">
<div class="content">
<pre># getfacl filea
File system doesn't support aclent_t style ACL's.
See acl(5) for more information on Solaris ACL support.</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For information about other limitations with ACLs and backup products,
see <a href="#saving-zfs-data-with-other-backup-products">Saving ZFS Data With Other Backup Products</a>.</p>
</div>
<div class="sect3">
<h4 id="syntax-descriptions-for-setting-acls"><a class="anchor" href="#syntax-descriptions-for-setting-acls"></a>4.1.1. Syntax Descriptions for Setting ACLs</h4>
<div class="paragraph">
<p>Two basic ACL formats are provided as follows:</p>
</div>
<div class="paragraph">
<p><strong>Syntax for Setting Trivial ACLs</strong></p>
</div>
<div class="paragraph">
<p><code>chmod [options] A[index]{&#43;|=}owner@ |group@ |everyone@:`<em>access-permissions</em>/&#8230;&#8203;[:_inheritance-flags_]:`deny | allow</code>
&lt;file&gt;</p>
</div>
<div class="paragraph">
<p><code>chmod [options] A-owner@, group@, everyone@:`<em>access-permissions</em>/&#8230;&#8203;[:_inheritance-flags_]:`deny | allow</code>
&lt;file &#8230;&#8203;&gt;</p>
</div>
<div class="paragraph">
<p><code>chmod [options] A[index]-</code> &lt;file&gt;</p>
</div>
<div class="paragraph">
<p><strong>Syntax for Setting Non-Trivial ACLs</strong></p>
</div>
<div class="paragraph">
<p><code>chmod [options] A[index]{&#43;|=}user|group:name:`<em>access-permissions</em>/&#8230;&#8203;[:_inheritance-flags_]</code>:deny | allow`
&lt;file&gt;</p>
</div>
<div class="paragraph">
<p><code>chmod [options] A-user|group:name:`<em>access-permissions</em>/&#8230;&#8203;[:_inheritance-flags_]</code>:deny | allow`
&lt;file &#8230;&#8203;&gt;</p>
</div>
<div class="paragraph">
<p><code>chmod [options] A[index]-</code> &lt;file&gt;</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">owner@, group@, everyone@</dt>
<dd>
<p>Identifies the <em>ACL-entry-type</em> for trivial ACL syntax. For a
description of <em>ACL-entry-types</em>, see <a href="#gbbhr">ACL Entry Types</a>.</p>
</dd>
<dt class="hdlist1">user or group:_ACL-entry-ID=username or groupname_</dt>
<dd>
<p>Identifies the <em>ACL-entry-type</em> for explicit ACL syntax. The user and
group <em>ACL-entry-type</em> must also contain the <em>ACL-entry-ID</em>,
<em>username</em> or <em>groupname</em>. For a description of <em>ACL-entry-types</em>, see
<a href="#gbbhr">ACL Entry Types</a>.</p>
</dd>
<dt class="hdlist1"><em>access-permissions</em>/&#8230;&#8203;/</dt>
<dd>
<p>Identifies the access permissions that are granted or denied. For a
description of ACL access privileges, see <a href="#gbbht">ACL Access
Privileges</a>.</p>
</dd>
<dt class="hdlist1"><em>inheritance-flags</em></dt>
<dd>
<p>Identifies an optional list of ACL inheritance flags. For a
description of the ACL inheritance flags, see <a href="#gbbhx">ACL
Inheritance Flags</a>.</p>
</dd>
<dt class="hdlist1"><code>deny</code> | <code>allow</code></dt>
<dd>
<p>Identifies whether the access permissions are granted or denied.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In the following example, the <em>ACL-entry-ID</em> value is not relevant:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>group@:write_data/append_data/execute:deny</pre>
</div>
</div>
<div class="paragraph">
<p>The following example includes an <em>ACL-entry-ID</em> because a specific user
(<em>ACL-entry-type</em>) is included in the ACL.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>0:user:gozer:list_directory/read_data/execute:allow</pre>
</div>
</div>
<div class="paragraph">
<p>When an ACL entry is displayed, it looks similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>2:group@:write_data/append_data/execute:deny</pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>2</strong> or the <em>index-ID</em> designation in this example identifies the ACL
entry in the larger ACL, which might have multiple entries for owner,
specific UIDs, group, and everyone. You can specify the <em>index-ID</em> with
the <code>chmod</code> command to identify which part of the ACL you want to
modify. For example, you can identify index ID 3 as <code>A3</code> to the <code>chmod</code>
command, similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>chmod A3=user:venkman:read_acl:allow filename</pre>
</div>
</div>
<div class="paragraph">
<p>ACL entry types, which are the ACL representations of owner, group, and
other, are described in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. ACL Entry Types</caption>
<colgroup>
<col style="width: 24%;">
<col style="width: 76%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ACL Entry Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>owner@</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the access granted to the owner of the object.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group@</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the access granted to the owning group of the
object.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>everyone@</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the access granted to any user or group that
does not match any other ACL entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">With a user name, specifies the access granted to an additional
user of the object. Must include the <em>ACL-entry-ID</em>, which contains a
&lt;username&gt; or &lt;userID&gt;. If the value is not a valid
numeric UID or &lt;username&gt;, the ACL entry type is invalid.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>group</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">With a group name, specifies the access granted to an
additional group of the object. Must include the <em>ACL-entry-ID</em>, which
contains a &lt;groupname&gt; or &lt;groupID&gt;. If the value is not
a valid numeric GID or &lt;groupname&gt;, the ACL entry type is
invalid.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>ACL access privileges are described in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. ACL Access Privileges</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 18%;">
<col style="width: 62%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Access Privilege</th>
<th class="tableblock halign-left valign-top">Compact Access Privilege</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">add_file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">w</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to add a new file to a directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">add_subdirectory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">p</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">On a directory, permission to create a
subdirectory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">append_data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">p</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Placeholder. Not currently implemented.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to delete a file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete_child</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">D</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to delete a file or directory within a
directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">execute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to execute a file or search the contents of a
directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">list_directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to list the contents of a directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">read_acl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to read the ACL (<code>ls</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">read_attributes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to read basic attributes (non-ACLs)
of a file. Think of basic attributes as the stat level attributes.
Allowing this access mask bit means the entity can execute <code>ls(1)</code> and
<code>stat(2)</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">read_data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to read the contents of the file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">read_xattr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">R</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to read the extended attributes of a file
or perform a lookup in the file&#8217;s extended attributes directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">synchronize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Placeholder. Not currently implemented.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">write_xattr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">W</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Permission to create extended attributes or write to the extended
attributes directory.</p>
</div>
<div class="paragraph">
<p>Granting this permission to a user means that the user can create an
extended attribute directory for a file. The attribute file&#8217;s
permissions control the user&#8217;s access to the attribute.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">write_data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">w</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to modify or replace the contents of a
file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">write_attributes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to change the times associated with
a file or directory to an arbitrary value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">write_acl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission to write the ACL or the ability to modify
the ACL by using the <code>chmod</code> command.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">write_owner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">o</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Permission to change the file&#8217;s owner or group. Or, the ability to
execute the <code>chown</code> or <code>chgrp</code> commands on the file.</p>
</div>
<div class="paragraph">
<p>Permission to take ownership of a file or permission to change the group
ownership of the file to a group of which the user is a member. If you
want to change the file or group ownership to an arbitrary user or
group, then the <code>PRIV_FILE_CHOWN</code> privilege is required.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="acl-inheritance"><a class="anchor" href="#acl-inheritance"></a>4.1.2. ACL Inheritance</h4>
<div class="paragraph">
<p>The purpose of using ACL inheritance is so that a newly created file or
directory can inherit the ACLs they are intended to inherit, but without
disregarding the existing permission bits on the parent directory.</p>
</div>
<div class="paragraph">
<p>By default, ACLs are not propagated. If you set an non-trivial ACL on a
directory, it is not inherited to any subsequent directory. You must
specify the inheritance of an ACL on a file or directory.</p>
</div>
<div class="paragraph">
<p>The optional inheritance flags are described in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. ACL Inheritance Flags</caption>
<colgroup>
<col style="width: 24%;">
<col style="width: 18%;">
<col style="width: 58%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Inheritance Flag</th>
<th class="tableblock halign-left valign-top">Compact Inheritance Flag</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">file_inherit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only inherit the ACL from the parent directory to
the directory&#8217;s files.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dir_inherit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only inherit the ACL from the parent directory to
the directory&#8217;s subdirectories.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">inherit_only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">i</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inherit the ACL from the parent directory but
applies only to newly created files or subdirectories and not the
directory itself. This flag requires the <code>file_inherit</code> flag, the
<code>dir_inherit</code> flag, or both, to indicate what to inherit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no_propagate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only inherit the ACL from the parent directory to
the first-level contents of the directory, not the second-level or
subsequent contents. This flag requires the <code>file_inherit</code> flag, the
<code>dir_inherit</code> flag, or both, to indicate what to inherit.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, you can set a default ACL inheritance policy on the file
system that is more strict or less strict by using the <code>aclinherit</code> file
system property. For more information, see the next section.</p>
</div>
</div>
<div class="sect3">
<h4 id="acl-property-modes"><a class="anchor" href="#acl-property-modes"></a>4.1.3. ACL Property Modes</h4>
<div class="paragraph">
<p>The ZFS file system includes two property modes related to ACLs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>aclinherit</code> – This property determines the behavior of ACL
inheritance. Values include the following:</p>
<div class="ulist">
<ul>
<li>
<p><code>discard</code> – For new objects, no ACL entries are inherited when a file
or directory is created. The ACL on the file or directory is equal to
the permission mode of the file or directory.</p>
</li>
<li>
<p><code>noallow</code> – For new objects, only inheritable ACL entries that have
an access type of <code>deny</code> are inherited.</p>
</li>
<li>
<p><code>secure</code> – For new objects, the <code>write_owner</code> and <code>write_acl</code>
permissions are removed when an ACL entry is inherited.</p>
</li>
<li>
<p><code>passthrough</code> – For new objects, the inheritable ACL entries are
inherited with no changes made to them. This mode, in effect, disables
<code>secure</code> mode.</p>
<div class="paragraph">
<p>The default mode for the <code>aclinherit</code> is <code>secure</code>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>aclmode</code> – This property modifies ACL behavior whenever a file or
directory&#8217;s mode is modified by the <code>chmod</code> command or when a file is
initially created. Values include the following:</p>
<div class="ulist">
<ul>
<li>
<p><code>discard</code> – All ACL entries are removed except for the entries needed
to define the mode of the file or directory.</p>
</li>
<li>
<p><code>groupmask</code> – User or group ACL permissions are reduced so that they
are no greater than the group permission bits, unless it is a user entry
that has the same UID as the owner of the file or directory. Then, the
ACL permissions are reduced so that they are no greater than owner
permission bits.</p>
</li>
<li>
<p><code>passthrough</code> – For new objects, the inheritable ACL entries are
inherited with no changes made to the them.</p>
<div class="paragraph">
<p>The default mode for the <code>aclmode</code> property is <code>groupmask</code>.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setting-acls-on-zfs-files"><a class="anchor" href="#setting-acls-on-zfs-files"></a>4.2. Setting ACLs on ZFS Files</h3>
<div class="paragraph">
<p>As implemented with ZFS, ACLs are composed of an array of ACL entries.
ZFS provides a <em>pure</em> ACL model, where all files have an ACL. Typically,
the ACL is <em>trivial</em> in that it only represents the traditional UNIX
<code>owner/group/other</code> entries.</p>
</div>
<div class="paragraph">
<p>ZFS files still have permission bits and a mode, but these values are
more of a cache of what the ACL represents. As such, if you change the
permissions of the file, the file&#8217;s ACL is updated accordingly. In
addition, if you remove an non-trivial ACL that granted a user access to
a file or directory, that user could still have access to the file or
directory because of the file or directory&#8217;s permission bits that grant
access to group or everyone. All access control decisions are governed
by the permissions represented in a file or directory&#8217;s ACL.</p>
</div>
<div class="paragraph">
<p>The primary rules of ACL access on a ZFS file are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ZFS processes ACL entries in the order they are listed in the ACL,
from the top down.</p>
</li>
<li>
<p>Only ACL entries that have a “who” that matches the requester of the
access are processed.</p>
</li>
<li>
<p>Once an allow permission has been granted, it cannot be denied by a
subsequent ACL deny entry in the same ACL permission set.</p>
</li>
<li>
<p>The owner of the file is granted the <code>write_acl</code> permission
unconditionally, even if the permission is explicitly denied. Otherwise,
any permission left unspecified is denied.</p>
<div class="paragraph">
<p>In the cases of deny permissions or when an access permission is
missing, the privilege subsystem determines what access request is
granted for the owner of the file or for superuser. This mechanism
prevents owners of files from getting locked out of their files and
enables superuser to modify files for recovery purposes.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you set an non-trivial ACL on a directory, the ACL is not
automatically inherited by the directory&#8217;s children. If you set an
non-trivial ACL and you want it inherited to the directory&#8217;s children,
you have to use the ACL inheritance flags. For more information, see
<a href="#gbbhx">ACL Inheritance Flags</a> and <a href="#setting-acl-inheritance-on-zfs-files-in-verbose-format">Setting ACL
Inheritance on ZFS Files in Verbose Format</a>.</p>
</div>
<div class="paragraph">
<p>When you create a new file and depending on the <code>umask</code> value, a default
trivial ACL, similar to the following, is applied:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls -v file.1
-r--r--r--   1 root     root      206663 May  4 11:52 file.1
     0:owner@:write_data/append_data/execute:deny
     1:owner@:read_data/write_xattr/write_attributes/write_acl/write_owner
         :allow
     2:group@:write_data/append_data/execute:deny
     3:group@:read_data:allow
     4:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     5:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div class="paragraph">
<p>Note that each user category (<code>owner@</code>, <code>group@</code>, <code>everyone@</code>) in this
example has two ACL entries. One entry for <code>deny</code> permissions, and one
entry is for <code>allow</code> permissions.</p>
</div>
<div class="paragraph">
<p>A description of this file ACL is as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>0:owner@</code></dt>
<dd>
<p>The owner is denied execute permissions to the file (<code>execute:deny</code>).</p>
</dd>
<dt class="hdlist1"><code>1:owner@</code></dt>
<dd>
<p>The owner can read and modify the contents of the file
(<code>read_data/write_data/append_data</code>). The owner can also
modify the file&#8217;s attributes such as timestamps, extended attributes,
and ACLs (<code>write_xattr/write_attributes /write_acl</code>). In
addition, the owner can modify the ownership of the file
(<code>write_owner:allow</code>)</p>
</dd>
<dt class="hdlist1"><code>2:group@</code></dt>
<dd>
<p>The group is denied modify and execute permissions to the file
(<code>write_data/append_data/execute:deny</code>).</p>
</dd>
<dt class="hdlist1"><code>3:group@</code></dt>
<dd>
<p>The group is granted read permissions to the file
(<code>read_data:allow</code>).</p>
</dd>
<dt class="hdlist1"><code>4:everyone@</code></dt>
<dd>
<p>Everyone who is not user or group is denied permission to execute or
modify the contents of the file and to modify any attributes of the
file
(<code>write_data/append_data/write_xattr/execute/write_attributes/write_acl/write_owner:deny</code>).</p>
</dd>
<dt class="hdlist1"><code>5:everyone@</code></dt>
<dd>
<p>Everyone who is not user or group is granted read permissions to the
file, and the file&#8217;s attributes
(<code>read_data/read_xattr/read_attributes/read_acl/synchronize:allow</code>).
The <code>synchronize</code> access permission is not currently implemented.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When a new directory is created and depending on the <code>umask</code> value, a
default directory ACL is similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ls -dv dir.1
drwxr-xr-x   2 root     root           2 Feb 23 10:37 dir.1
     0:owner@::deny
     1:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     2:group@:add_file/write_data/add_subdirectory/append_data:deny
     3:group@:list_directory/read_data/execute:allow
     4:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     5:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>A description of this directory ACL is as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>0:owner@</code></dt>
<dd>
<p>The owner deny list is empty for the directory (<code>::deny</code>).</p>
</dd>
<dt class="hdlist1"><code>1:owner@</code></dt>
<dd>
<p>The owner can read and modify the directory contents
(<code>list_directory/read_data/add_file/write_data/add_subdirectory/append_data</code>),
search the contents (<code>execute</code>), and modify the file&#8217;s attributes such
as timestamps, extended attributes, and ACLs
(<code>write_xattr/write_attributes/write_acl</code>). In addition,
the owner can modify the ownership of the directory
(<code>write_owner:allow</code>).</p>
</dd>
<dt class="hdlist1"><code>2:group@</code></dt>
<dd>
<p>The group cannot add to or modify the directory contents
(<code>add_file/write_data/add_subdirectory/append_data:deny</code>).</p>
</dd>
<dt class="hdlist1"><code>3:group@</code></dt>
<dd>
<p>The group can list and read the directory contents. In addition, the
group has execute permission to search the directory contents
(<code>list_directory/read_data/execute:allow</code>).</p>
</dd>
<dt class="hdlist1"><code>4:everyone@</code></dt>
<dd>
<p>Everyone who is not user or group is denied permission to add to or
modify the contents of the directory
(<code>add_file/write_data/add_subdirectory/append_data</code>).
In addition, the permission to modify any attributes of the directory
is denied.
(<code>write_xattr /write_attributes/write_acl/write_owner:deny</code>).</p>
</dd>
<dt class="hdlist1"><code>5:everyone@</code></dt>
<dd>
<p>Everyone who is not user or group is granted read and execute
permissions to the directory contents and the directory&#8217;s attributes
(<code>list_directory/read_data/read_xattr/execute/read_attributes/read_acl/synchronize:allow</code>).
The <code>synchronize</code> access permission is not currently implemented.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="setting-and-displaying-acls-on-zfs-files-in-verbose-format"><a class="anchor" href="#setting-and-displaying-acls-on-zfs-files-in-verbose-format"></a>4.3. Setting and Displaying ACLs on ZFS Files in Verbose Format</h3>
<div class="paragraph">
<p>You can use the <code>chmod</code> command to modify ACLs on ZFS files. The
following <code>chmod</code> syntax for modifying ACLs uses <em>acl-specification</em> to
identify the format of the ACL. For a description of
<em>acl-specification</em>, see <a href="#syntax-descriptions-for-setting-acls">Syntax Descriptions for Setting
ACLs</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adding ACL entries</p>
<div class="ulist">
<ul>
<li>
<p>Adding an ACL entry for a user</p>
<div class="literalblock">
<div class="content">
<pre>% chmod A+acl-specification filename</pre>
</div>
</div>
</li>
<li>
<p>Adding an ACL entry by &lt;index-ID&gt;</p>
<div class="literalblock">
<div class="content">
<pre>% chmod Aindex-ID+acl-specification filename</pre>
</div>
</div>
<div class="paragraph">
<p>This syntax inserts the new ACL entry at the specified
&lt;index-ID&gt; location.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Replacing an ACL entry</p>
<div class="literalblock">
<div class="content">
<pre>% chmod Aindex-ID=acl-specification filename</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>% chmod A=acl-specification filename</pre>
</div>
</div>
</li>
<li>
<p>Removing ACL entries</p>
<div class="ulist">
<ul>
<li>
<p>Removing an ACL entry by &lt;index-ID&gt;</p>
<div class="literalblock">
<div class="content">
<pre>% chmod Aindex-ID- filename</pre>
</div>
</div>
</li>
<li>
<p>Removing an ACL entry by user</p>
<div class="literalblock">
<div class="content">
<pre>% chmod A-acl-specification filename</pre>
</div>
</div>
</li>
<li>
<p>Removing all non-trivial ACEs from a file</p>
<div class="literalblock">
<div class="content">
<pre>% chmod A- filename</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Verbose ACL information is displayed by using the <code>ls</code> <code>v</code> command. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -v file.1
-rw-r--r--   1 root     root      206663 Feb 16 11:00 file.1
     0:owner@:execute:deny
     1:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     2:group@:write_data/append_data/execute:deny
     3:group@:read_data:allow
     4:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     5:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div class="paragraph">
<p>For information about using the compact ACL format, see
<a href="#setting-and-displaying-acls-on-zfs-files-in-compact-format">Setting and Displaying ACLs on ZFS Files in Compact Format</a>.</p>
</div>
<div id="gbsdc" class="paragraph">
<p>Modifying Trivial ACLs on ZFS Files</p>
</div>
<div class="paragraph">
<p>This section provides examples of setting and displaying trivial ACLs.</p>
</div>
<div class="paragraph">
<p>In the following example, a trivial ACL exists on <code>file.1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -v file.1
-rw-r--r--   1 root     root      206663 Feb 16 11:00 file.1
     0:owner@:execute:deny
     1:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     2:group@:write_data/append_data/execute:deny
     3:group@:read_data:allow
     4:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     5:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, <code>write_data</code> permissions are granted for
<code>group@</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A2=group@:append_data/execute:deny file.1
# chmod A3=group@:read_data/write_data:allow file.1
# ls -v file.1
-rw-rw-r--   1 root     root           206663 May  3 16:36 file.1
     0:owner@:execute:deny
     1:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     2:group@:append_data/execute:deny
     3:group@:read_data/write_data:allow
     4:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     5:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, permissions on <code>file.1</code> are set back to 644.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod 644 file.1
# ls -v file.1
-rw-r--r--   1 root     root           206663 May  3 16:36 file.1
     0:owner@:execute:deny
     1:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     2:group@:write_data/append_data/execute:deny
     3:group@:read_data:allow
     4:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     5:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div id="gcpsk" class="paragraph">
<p>Setting Non-Trivial ACLs on ZFS Files</p>
</div>
<div class="paragraph">
<p>This section provides examples of setting and displaying non-trivial
ACLs.</p>
</div>
<div class="paragraph">
<p>In the following example, <code>read_data/execute</code> permissions are added
for the user <code>gozer</code> on the <code>test.dir</code> directory.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A+user:gozer:read_data/execute:allow test.dir
# ls -dv test.dir
drwxr-xr-x+  2 root     root           2 Feb 16 11:12 test.dir
     0:user:gozer:list_directory/read_data/execute:allow
     1:owner@::deny
     2:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     3:group@:add_file/write_data/add_subdirectory/append_data:deny
     4:group@:list_directory/read_data/execute:allow
     5:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     6:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, <code>read_data/execute</code> permissions are
removed for user <code>gozer</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A0- test.dir
# ls -dv test.dir
drwxr-xr-x   2 root     root           2 Feb 16 11:12 test.dir
     0:owner@::deny
     1:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     2:group@:add_file/write_data/add_subdirectory/append_data:deny
     3:group@:list_directory/read_data/execute:allow
     4:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     5:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div id="gbsby" class="paragraph">
<p>ACL Interaction With Permissions on ZFS Files</p>
</div>
<div class="paragraph">
<p>These ACL examples illustrate the interaction between setting ACLs and
then changing the file or directory&#8217;s permission bits.</p>
</div>
<div class="paragraph">
<p>In the following example, a trivial ACL exists on <code>file.2</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -v file.2
-rw-r--r--   1 root     root        2703 Feb 16 11:16 file.2
     0:owner@:execute:deny
     1:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     2:group@:write_data/append_data/execute:deny
     3:group@:read_data:allow
     4:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     5:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, ACL allow permissions are removed from
<code>everyone@</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A5- file.2
# ls -v file.2
-rw-r-----   1 root     root        2703 Feb 16 11:16 file.2
     0:owner@:execute:deny
     1:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     2:group@:write_data/append_data/execute:deny
     3:group@:read_data:allow
     4:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny</pre>
</div>
</div>
<div class="paragraph">
<p>In this output, the file&#8217;s permission bits are reset from 655 to 650.
Read permissions for <code>everyone@</code> have been effectively removed from the
file&#8217;s permissions bits when the ACL allow permissions are removed for
<code>everyone@</code>.</p>
</div>
<div class="paragraph">
<p>In the following example, the existing ACL is replaced with
<code>read_data/write_data</code> permissions for <code>everyone@</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A=everyone@:read_data/write_data:allow file.3
# ls -v file.3
-rw-rw-rw-+  1 root     root        1532 Feb 16 11:18 file.3
     0:everyone@:read_data/write_data:allow</pre>
</div>
</div>
<div class="paragraph">
<p>In this output, the <code>chmod</code> syntax effectively replaces the existing ACL
with <code>read_data/write_data:allow</code> permissions to read/write
permissions for owner, group, and <code>everyone@</code>. In this model,
<code>everyone@</code> specifies access to any user or group. Since no <code>owner@</code> or
<code>group@</code> ACL entry exists to override the permissions for owner and
group, the permission bits are set to 666.</p>
</div>
<div class="paragraph">
<p>In the following example, the existing ACL is replaced with read
permissions for user <code>gozer</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A=user:gozer:read_data:allow file.3
# ls -v file.3
----------+  1 root     root        1532 Feb 16 11:18 file.3
     0:user:gozer:read_data:allow</pre>
</div>
</div>
<div class="paragraph">
<p>In this output, the file permissions are computed to be 000 because no
ACL entries exist for <code>owner@</code>, <code>group@</code>, or <code>everyone@</code>, which
represent the traditional permission components of a file. The owner of
the file can resolve this problem by resetting the permissions (and the
ACL) as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod 655 file.3
# ls -v file.3
-rw-r-xr-x+  1 root     root           0 Mar  8 13:24 file.3
     0:user:gozer::deny
     1:user:gozer:read_data:allow
     2:owner@:execute:deny
     3:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     4:group@:write_data/append_data:deny
     5:group@:read_data/execute:allow
     6:everyone@:write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:deny
     7:everyone@:read_data/read_xattr/execute/read_attributes/read_acl
         /synchronize:allow</pre>
</div>
</div>
<div id="gbsdg" class="paragraph">
<p>Restoring Trivial ACLs on ZFS Files</p>
</div>
<div class="paragraph">
<p>You can use the <code>chmod</code> command to remove all non-trivial ACLs on a file
or directory.</p>
</div>
<div class="paragraph">
<p>In the following example, 2 non-trivial ACEs exist on <code>test5.dir</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -dv test5.dir
drwxr-xr-x+  2 root     root           2 Feb 16 11:23 test5.dir
     0:user:gozer:read_data:file_inherit:deny
     1:user:lp:read_data:file_inherit:deny
     2:owner@::deny
     3:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     4:group@:add_file/write_data/add_subdirectory/append_data:deny
     5:group@:list_directory/read_data/execute:allow
     6:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     7:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, the non-trivial ACLs for users <code>gozer</code> and
<code>lp</code> are removed. The remaining ACL contains the six default values for
<code>owner@</code>, <code>group@</code>, and <code>everyone@</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A- test5.dir
# ls -dv test5.dir
drwxr-xr-x   2 root     root           2 Feb 16 11:23 test5.dir
     0:owner@::deny
     1:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     2:group@:add_file/write_data/add_subdirectory/append_data:deny
     3:group@:list_directory/read_data/execute:allow
     4:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     5:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="sect3">
<h4 id="setting-acl-inheritance-on-zfs-files-in-verbose-format"><a class="anchor" href="#setting-acl-inheritance-on-zfs-files-in-verbose-format"></a>4.3.1. Setting ACL Inheritance on ZFS Files in Verbose Format</h4>
<div class="paragraph">
<p>You can determine how ACLs are inherited or not inherited on files and
directories. By default, ACLs are not propagated. If you set an
non-trivial ACL on a directory, the ACL is not inherited by any
subsequent directory. You must specify the inheritance of an ACL on a
file or directory.</p>
</div>
<div class="paragraph">
<p>In addition, two ACL properties are provided that can be set globally on
file systems: <code>aclinherit</code> and <code>aclmode</code>. By default, aclinherit is set
to <code>secure</code> and aclmode is set to <code>groupmask</code>.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="#acl-inheritance">ACL Inheritance</a>.</p>
</div>
<div id="gcakr" class="paragraph">
<p>Default ACL Inheritance</p>
</div>
<div class="paragraph">
<p>By default, ACLs are not propagated through a directory structure.</p>
</div>
<div class="paragraph">
<p>In the following example, an non-trivial ACE of
<code>read_data/write_data/execute</code> is applied for user <code>gozer</code> on
<code>test.dir</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A+user:gozer:read_data/write_data/execute:allow test.dir
# ls -dv test.dir
drwxr-xr-x+  2 root     root           2 Feb 17 14:45 test.dir
     0:user:gozer:list_directory/read_data/add_file/write_data/execute:allow
     1:owner@::deny
     2:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     3:group@:add_file/write_data/add_subdirectory/append_data:deny
     4:group@:list_directory/read_data/execute:allow
     5:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     6:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>If a <code>test.dir</code> subdirectory is created, the ACE for user <code>gozer</code> is not
propagated. User <code>gozer</code> would only have access to <code>sub.dir</code> if the
permissions on <code>sub.dir</code> granted him access as the file owner, group
member, or <code>everyone@</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkdir test.dir/sub.dir
# ls -dv test.dir/sub.dir
drwxr-xr-x   2 root     root           2 Feb 17 14:46 test.dir/sub.dir
     0:owner@::deny
     1:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     2:group@:add_file/write_data/add_subdirectory/append_data:deny
     3:group@:list_directory/read_data/execute:allow
     4:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     5:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div id="gcale" class="paragraph">
<p>Granting ACL Inheritance on Files and Directories</p>
</div>
<div class="paragraph">
<p>This series of examples identify the file and directory ACEs that are
applied when the <code>file_inherit</code> flag is set.</p>
</div>
<div class="paragraph">
<p>In the following example, <code>read_data/write_data</code> permissions are
added for files in the <code>test.dir</code> directory for user <code>gozer</code> so that he
has read access on any newly created files.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A+user:gozer:read_data/write_data:file_inherit:allow test2.dir
# ls -dv test2.dir
drwxr-xr-x+  2 root     root           2 Feb 17 14:47 test2.dir
     0:user:gozer:read_data/write_data:file_inherit:allow
     1:owner@::deny
     2:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     3:group@:add_file/write_data/add_subdirectory/append_data:deny
     4:group@:list_directory/read_data/execute:allow
     5:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     6:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, user gozer&#8217;s permissions are applied on the
newly created <code>test2.dir/file.2</code> file. The ACL inheritance granted,
<code>read_data:file_inherit:allow</code>, means user <code>gozer</code> can read the
contents of any newly created file.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># touch test2.dir/file.2
# ls -v test2.dir/file.2
-rw-r--r--+  1 root     root           0 Feb 17 14:49 test2.dir/file.2
     0:user:gozer:write_data:deny
     1:user:gozer:read_data/write_data:allow
     2:owner@:execute:deny
     3:owner@:read_data/write_data/append_data/write_xattr/write_attributes+
         /write_acl/write_owner:allow
     4:group@:write_data/append_data/execute:deny
     5:group@:read_data:allow
     6:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     7:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div class="paragraph">
<p>Because the aclmode for this file is set to the default mode,
<code>groupmask</code>, user <code>gozer</code> does not have <code>write_data</code> permission on
<code>file.2</code> because the group permission of the file does not allow it.</p>
</div>
<div class="paragraph">
<p>Note the <code>inherit_only</code> permission, which is applied when the
<code>file_inherit</code> or <code>dir_inherit</code> flags are set, is used to
propagate the ACL through the directory structure. As such, user <code>gozer</code>
is only granted or denied permission from <code>everyone@</code> permissions unless
he is the owner of the file or a member of the owning group of the file.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkdir test2.dir/subdir.2
# ls -dv test2.dir/subdir.2
drwxr-xr-x+  2 root     root           2 Feb 17 14:50 test2.dir/subdir.2
     0:user:gozer:list_directory/read_data/add_file/write_data:file_inherit
         /inherit_only:allow
     1:owner@::deny
     2:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     3:group@:add_file/write_data/add_subdirectory/append_data:deny
     4:group@:list_directory/read_data/execute:allow
     5:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     6:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>The following series of examples identify the file and directory ACLs
that are applied when both the <code>file_inherit</code> and <code>dir_inherit</code>
flags are set.</p>
</div>
<div class="paragraph">
<p>In the following example, user <code>gozer</code> is granted read, write, and
execute permissions that are inherited for newly created files and
directories.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A+user:gozer:read_data/write_data/execute:file_inherit/dir_inherit:allow test3.dir
# ls -dv test3.dir
drwxr-xr-x+  2 root     root           2 Feb 17 14:51 test3.dir
     0:user:gozer:list_directory/read_data/add_file/write_data/execute
         :file_inherit/dir_inherit:allow
     1:owner@::deny
     2:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     3:group@:add_file/write_data/add_subdirectory/append_data:deny
     4:group@:list_directory/read_data/execute:allow
     5:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     6:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># touch test3.dir/file.3
# ls -v test3.dir/file.3
-rw-r--r--+  1 root     root           0 Feb 17 14:53 test3.dir/file.3
     0:user:gozer:write_data/execute:deny
     1:user:gozer:read_data/write_data/execute:allow
     2:owner@:execute:deny
     3:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     4:group@:write_data/append_data/execute:deny
     5:group@:read_data:allow
     6:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     7:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># mkdir test3.dir/subdir.1
# ls -dv test3.dir/subdir.1
drwxr-xr-x+  2 root     root           2 May  4 15:00 test3.dir/subdir.1
     0:user:gozer:list_directory/read_data/add_file/write_data/execute
         :file_inherit/dir_inherit/inherit_only:allow
     1:user:gozer:add_file/write_data:deny
     2:user:gozer:list_directory/read_data/add_file/write_data/execute:allow
     3:owner@::deny
     4:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     5:group@:add_file/write_data/add_subdirectory/append_data:deny
     6:group@:list_directory/read_data/execute:allow
     7:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     8:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>In these examples, because the permission bits of the parent directory
for <code>group@</code> and <code>everyone@</code> deny write and execute permissions, user
<code>gozer</code> is denied write and execute permissions. The default aclmode
property is <code>secure</code>, which means that <code>write_data</code> and <code>execute</code>
permissions are not inherited.</p>
</div>
<div class="paragraph">
<p>In the following example, user <code>gozer</code> is granted read, write, and
execute permissions that are inherited for newly created files, but are
not propagated to subsequent contents of the directory.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A+user:gozer:read_data/write_data/execute:file_inherit/no_propagate:allow test4.dir
# ls -dv test4.dir
drwxr-xr-x+  2 root     root           2 Feb 17 14:54 test4.dir
     0:user:gozer:list_directory/read_data/add_file/write_data/execute
         :file_inherit/no_propagate:allow
     1:owner@::deny
     2:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     3:group@:add_file/write_data/add_subdirectory/append_data:deny
     4:group@:list_directory/read_data/execute:allow
     5:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     6:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>As the following example illustrates, when a new subdirectory is
created, user <code>gozer&#8217;s `read_data/write_data/execute</code>
permission for files are not propagated to the new <code>sub4.dir</code> directory.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mkdir test4.dir/sub4.dir
# ls -dv test4.dir/sub4.dir
drwxr-xr-x   2 root     root           2 Feb 17 14:57 test4.dir/sub4.dir
     0:owner@::deny
     1:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     2:group@:add_file/write_data/add_subdirectory/append_data:deny
     3:group@:list_directory/read_data/execute:allow
     4:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     5:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>As the following example illustrates, <code>gozer&#8217;s
`read_data/write_data/execute</code> permission for files is
propagated to the newly created file.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># touch test4.dir/file.4
# ls -v test4.dir/file.4
-rw-r--r--+  1 root     root           0 May  4 15:02 test4.dir/file.4
     0:user:gozer:write_data/execute:deny
     1:user:gozer:read_data/write_data/execute:allow
     2:owner@:execute:deny
     3:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     4:group@:write_data/append_data/execute:deny
     5:group@:read_data:allow
     6:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     7:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div id="gbcid" class="paragraph">
<p>ACL Inheritance With ACL Mode Set to Passthrough</p>
</div>
<div class="paragraph">
<p>If the <code>aclmode</code> property on the <code>tank/cindy</code> file system is set to
<code>passthrough</code>, then user <code>gozer</code> would inherit the ACL applied on
<code>test4.dir</code> for the newly created <code>file.4</code> as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set aclmode=passthrough tank/cindy
# touch test4.dir/file.4
# ls -v test4.dir/file.4
-rw-r--r--+  1 root     root           0 Feb 17 15:15 test4.dir/file.4
     0:user:gozer:read_data/write_data/execute:allow
     1:owner@:execute:deny
     2:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     3:group@:write_data/append_data/execute:deny
     4:group@:read_data:allow
     5:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     6:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
<div class="paragraph">
<p>This output illustrates that the
<code>read_data/write_data/execute:allow:file_inherit/dir_inherit</code>
ACL that was set on the parent directory, <code>test4.dir</code>, is passed through
to user <code>gozer</code>.</p>
</div>
<div id="gbchq" class="paragraph">
<p>ACL Inheritance With ACL Mode Set to Discard</p>
</div>
<div class="paragraph">
<p>If the aclmode property on a file system is set to <code>discard</code>, then ACLs
can potentially be discarded when the permission bits on a directory
change. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set aclmode=discard tank/cindy
# chmod A+user:gozer:read_data/write_data/execute:dir_inherit:allow test5.dir
# ls -dv test5.dir
drwxr-xr-x+  2 root     root           2 Feb 16 11:23 test5.dir
     0:user:gozer:list_directory/read_data/add_file/write_data/execute
         :dir_inherit:allow
     1:owner@::deny
     2:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     3:group@:add_file/write_data/add_subdirectory/append_data:deny
     4:group@:list_directory/read_data/execute:allow
     5:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     6:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>If, at a later time, you decide to tighten the permission bits on a
directory, the non-trivial ACL is discarded. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod 744 test5.dir
# ls -dv test5.dir
drwxr--r--   2 root     root           2 Feb 16 11:23 test5.dir
     0:owner@::deny
     1:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     2:group@:add_file/write_data/add_subdirectory/append_data/execute:deny
     3:group@:list_directory/read_data:allow
     4:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /execute/write_attributes/write_acl/write_owner:deny
     5:everyone@:list_directory/read_data/read_xattr/read_attributes/read_acl
         /synchronize:allow</pre>
</div>
</div>
<div id="gbche" class="paragraph">
<p>ACL Inheritance With ACL Inherit Mode Set to Noallow</p>
</div>
<div class="paragraph">
<p>In the following example, two non-trivial ACLs with file inheritance are
set. One ACL allows <code>read_data</code> permission, and one ACL denies
<code>read_data</code> permission. This example also illustrates how you can
specify two ACEs in the same <code>chmod</code> command.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs set aclinherit=nonallow tank/cindy
# chmod A+user:gozer:read_data:file_inherit:deny,user:lp:read_data:file_inherit:allow test6.dir
# ls -dv test6.dir
drwxr-xr-x+  2 root     root           2 May  4 14:23 test6.dir
     0:user:gozer:read_data:file_inherit:deny
     1:user:lp:read_data:file_inherit:allow
     2:owner@::deny
     3:owner@:list_directory/read_data/add_file/write_data/add_subdirectory
         /append_data/write_xattr/execute/write_attributes/write_acl
         /write_owner:allow
     4:group@:add_file/write_data/add_subdirectory/append_data:deny
     5:group@:list_directory/read_data/execute:allow
     6:everyone@:add_file/write_data/add_subdirectory/append_data/write_xattr
         /write_attributes/write_acl/write_owner:deny
     7:everyone@:list_directory/read_data/read_xattr/execute/read_attributes
         /read_acl/synchronize:allow</pre>
</div>
</div>
<div class="paragraph">
<p>As the following example shows, when a new file is created, the ACL that
allows <code>read_data</code> permission is discarded.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># touch test6.dir/file.6
# ls -v test6.dir/file.6
-rw-r--r--+  1 root     root           0 May  4 13:44 test6.dir/file.6
     0:user:gozer:read_data:deny
     1:owner@:execute:deny
     2:owner@:read_data/write_data/append_data/write_xattr/write_attributes
         /write_acl/write_owner:allow
     3:group@:write_data/append_data/execute:deny
     4:group@:read_data:allow
     5:everyone@:write_data/append_data/write_xattr/execute/write_attributes
         /write_acl/write_owner:deny
     6:everyone@:read_data/read_xattr/read_attributes/read_acl/synchronize
         :allow</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setting-and-displaying-acls-on-zfs-files-in-compact-format"><a class="anchor" href="#setting-and-displaying-acls-on-zfs-files-in-compact-format"></a>4.4. Setting and Displaying ACLs on ZFS Files in Compact Format</h3>
<div class="paragraph">
<p>You can set and display permissions on ZFS files in a compact format
that uses 14 unique letters to represent the permissions. The letters
that represent the compact permissions are listed in <a href="#gbbht">ACL
Access Privileges</a> and <a href="#gbbhx">ACL Inheritance Flags</a>.</p>
</div>
<div class="paragraph">
<p>You can display compact ACL listings for files and directories by using
the <code>ls</code> <code>V</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -V file.1
-rw-r--r--   1 root     root      206663 Feb 16 11:00 file.1
            owner@:--x-----------:------:deny
            owner@:rw-p---A-W-Co-:------:allow
            group@:-wxp----------:------:deny
            group@:r-------------:------:allow
         everyone@:-wxp---A-W-Co-:------:deny
         everyone@:r-----a-R-c--s:------:allow</pre>
</div>
</div>
<div class="paragraph">
<p>The compact ACL output is described as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>owner@</code></dt>
<dd>
<p>The owner is denied execute permissions to the file (<code>x</code>=<code>execute</code>).</p>
</dd>
<dt class="hdlist1"><code>owner@</code></dt>
<dd>
<p>The owner can read and modify the contents of the file
(<code>rw</code>=<code>read_data/write_data</code>), (<code>p</code>=<code>append_data</code>). The
owner can also modify the file&#8217;s attributes such as timestamps,
extended attributes, and ACLs (<code>A</code>=<code>write_xattr</code>,
<code>W</code>=<code>write_attributes</code>, <code>C</code>=<code>write_acl</code>). In addition, the
owner can modify the ownership of the file (<code>O</code>=<code>write_owner</code>).</p>
</dd>
<dt class="hdlist1"><code>group@</code></dt>
<dd>
<p>The group is denied modify and execute permissions to the file
(<code>rw</code>=<code>read_data/write_data</code>, <code>p</code>=<code>append_data</code>, and
<code>x</code>=<code>execute</code>).</p>
</dd>
<dt class="hdlist1"><code>group@</code></dt>
<dd>
<p>The group is granted read permissions to the file
(<code>r</code>=<code>read_data</code>).</p>
</dd>
<dt class="hdlist1"><code>everyone@</code></dt>
<dd>
<p>Everyone who is not user or group is denied permission to execute or
modify the contents of the file, and to modify any attributes of the
file (<code>w</code>=<code>write_data</code>, <code>x</code>=<code>execute</code>, <code>p</code>=<code>append_data</code>,
<code>A</code>=<code>write_xattr</code>, <code>W</code>=<code>write_attributes</code>,
<code>C</code>=<code>write_acl</code>, and <code>o</code>=<code>write_owner</code>).</p>
</dd>
<dt class="hdlist1"><code>everyone@</code></dt>
<dd>
<p>Everyone who is not user or group is granted read permissions to the
file and the file&#8217;s attributes (<code>r</code>=<code>read_data</code>,
<code>a</code>=<code>append_data</code>, <code>R</code>=<code>read_xattr</code>, <code>c</code>=<code>read_acl</code>, and
<code>s</code>=<code>synchronize</code>). The <code>synchronize</code> access permission is not
currently implemented.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Compact ACL format provides the following advantages over verbose ACL
format:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Permissions can be specified as positional arguments to the <code>chmod</code>
command.</p>
</li>
<li>
<p>The hyphen (-) characters, which identify no permissions, can be
removed and only the required letters need to be specified.</p>
</li>
<li>
<p>Both permissions and inheritance flags are set in the same fashion.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For information about using the verbose ACL format, see
<a href="#setting-and-displaying-acls-on-zfs-files-in-verbose-format">Setting and Displaying ACLs on ZFS Files in Verbose Format</a>.</p>
</div>
<div id="gcfhr" class="paragraph">
<p>Setting and Displaying ACLs in Compact Format</p>
</div>
<div class="paragraph">
<p>In the following example, a trivial ACL exists on <code>file.1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ls -V file.1
-rw-r-xr-x   1 root     root      206663 Feb 16 11:00 file.1
            owner@:--x-----------:------:deny
            owner@:rw-p---A-W-Co-:------:allow
            group@:-w-p----------:------:deny
            group@:r-x-----------:------:allow
         everyone@:-w-p---A-W-Co-:------:deny
         everyone@:r-x---a-R-c--s:------:allow</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, read_data/execute permissions are added for the
user <code>gozer</code> on <code>file.1</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A+user:gozer:rx:allow file.1
# ls -V file.1
-rw-r-xr-x+  1 root     root      206663 Feb 16 11:00 file.1
        user:gozer:r-x-----------:------:allow
            owner@:--x-----------:------:deny
            owner@:rw-p---A-W-Co-:------:allow
            group@:-w-p----------:------:deny
            group@:r-x-----------:------:allow
         everyone@:-w-p---A-W-Co-:------:deny
         everyone@:r-x---a-R-c--s:------:allow</pre>
</div>
</div>
<div class="paragraph">
<p>Another way to add the same permissions for user <code>gozer</code> is to insert a
new ACL at a specific position, 4, for example. As such, the existing
ACLs at positions 4–6 are pushed down. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A4+user:gozer:rx:allow file.1
# ls -V file.1
-rw-r-xr-x+  1 root     root      206663 Feb 16 11:00 file.1
            owner@:--x-----------:------:deny
            owner@:rw-p---A-W-Co-:------:allow
            group@:-w-p----------:------:deny
            group@:r-x-----------:------:allow
        user:gozer:r-x-----------:------:allow
         everyone@:-w-p---A-W-Co-:------:deny
         everyone@:r-x---a-R-c--s:------:allow</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, user <code>gozer</code> is granted read, write, and
execute permissions that are inherited for newly created files and
directories by using the compact ACL format.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A+user:gozer:rwx:fd:allow dir.2
# ls -dV dir.2
drwxr-xr-x+  2 root     root           2 Aug 28 13:21 dir.2
        user:gozer:rwx-----------:fd----:allow
            owner@:--------------:------:deny
            owner@:rwxp---A-W-Co-:------:allow
            group@:-w-p----------:------:deny
            group@:r-x-----------:------:allow
         everyone@:-w-p---A-W-Co-:------:deny
         everyone@:r-x---a-R-c--s:------:allow</pre>
</div>
</div>
<div class="paragraph">
<p>You can also cut and paste permissions and inheritance flags from the
<code>ls</code> <code>V</code> output into the compact <code>chmod</code> format. For example, to
duplicate the permissions and inheritance flags on <code>dir.1</code> for user
<code>gozer</code> to user <code>cindys</code>, copy and paste the permission and inheritance
flags (<code>rwx-----------:f-----:allow</code>) into your <code>chmod</code> command. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A+user:cindys:rwx-----------:fd----:allow dir.2
# ls -dv dir.2
drwxr-xr-x+  2 root     root           2 Aug 28 14:12 dir.2
       user:cindys:rwx-----------:fd----:allow
        user:gozer:rwx-----------:fd----:allow
            owner@:--------------:------:deny
            owner@:rwxp---A-W-Co-:------:allow
            group@:-w-p----------:------:deny
            group@:r-x-----------:------:allow
         everyone@:-w-p---A-W-Co-:------:deny
         everyone@:r-x---a-R-c--s:------:allow</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="zfs-delegated-administration-1"><a class="anchor" href="#zfs-delegated-administration-1"></a>5. ZFS Delegated Administration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes how to use delegated administration to allow
non-privileged users to perform ZFS administration tasks.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#overview-of-zfs-delegated-administration">Overview of ZFS Delegated Administration</a></p>
</li>
<li>
<p><a href="#delegating-zfs-permissions">Delegating ZFS Permissions</a></p>
</li>
<li>
<p><a href="#displaying-zfs-delegated-permissions-examples">Displaying ZFS Delegated Permissions (Examples)</a></p>
</li>
<li>
<p><a href="#delegating-zfs-permissions-examples">Delegating ZFS Permissions (Examples)</a></p>
</li>
<li>
<p><a href="#removing-zfs-permission-examples">Removing ZFS Permission (Examples)</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="overview-of-zfs-delegated-administration"><a class="anchor" href="#overview-of-zfs-delegated-administration"></a>5.1. Overview of ZFS Delegated Administration</h3>
<div class="paragraph">
<p>This feature enables you to distribute fine-grained permissions to
specific users, groups, or everyone. Two styles of delegated permissions
are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Individual permissions can be explicitly specified such a create,
destroy, mount and snapshot, and so on.</p>
</li>
<li>
<p>Groups of permissions called <em>permission sets</em> can be defined. A
permission set can later be updated and all of the consumers of the set
automatically pick up the change. Permission sets begin with the <code>@</code>
letter and are limited to 64 characters in length. After the <code>@</code>
character, the remaining characters in the set name have the same
restrictions as normal ZFS file system names.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ZFS delegated administration provides similar features to the RBAC
security. However, ZFS delegated administration provides the following
advantages for administering ZFS storage pools and file systems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Permissions follow the ZFS storage pool when the pool is migrated.</p>
</li>
<li>
<p>Provides dynamic inheritance and you can control how the permissions
propagate through the file systems.</p>
</li>
<li>
<p>Can be configured so that only the creator of a file system can
destroy the file systems they create.</p>
</li>
<li>
<p>Permissions can be distributed to specific file systems. Newly created
file systems can automatically pick up permissions.</p>
</li>
<li>
<p>Provides simple NFS administration. For example, a user with explicit
permissions could create a snapshot over NFS in the appropriate
<code>.zfs/snapshot</code> directory.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider using delegated administration for distributing ZFS tasks. For
information about using RBAC to manage general Solaris administration
tasks, see Part III, Roles, Rights Profiles, and Privileges, in System
Administration Guide: Security Services.</p>
</div>
<div class="sect3">
<h4 id="disabling-zfs-delegated-permissions"><a class="anchor" href="#disabling-zfs-delegated-permissions"></a>5.1.1. Disabling ZFS Delegated Permissions</h4>
<div class="paragraph">
<p>You can modify the ability to use delegated administration with the
pool&#8217;s <code>delegation</code> property. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool get delegation users
NAME  PROPERTY    VALUE       SOURCE
users  delegation  on          default
# zpool set delegation=off users
# zpool get delegation users
NAME  PROPERTY    VALUE       SOURCE
users  delegation  off         local</pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>delegation</code> property is enabled.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="delegating-zfs-permissions"><a class="anchor" href="#delegating-zfs-permissions"></a>5.2. Delegating ZFS Permissions</h3>
<div class="paragraph">
<p>You can use the <code>zfs allow</code> command to grant permissions on ZFS datasets
to non-root users in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Individual permissions can be granted to a user, group, or everyone.</p>
</li>
<li>
<p>Groups of individual permissions can be granted as a <em>permission set</em>
to a user, group, or everyone.</p>
</li>
<li>
<p>Permissions can be granted either locally, which is to the current
dataset only, or granted to all descendents of the current dataset.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following table describes the operations that can be delegated and
any dependent permissions that are required to do the delegated
operations.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 22%;">
<col style="width: 38%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Permission (Subcommand)</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Dependencies</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>allow</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to grant permissions that you have to another
user.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must also have the permission that is being allowed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clone</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to clone any of the dataset&#8217;s snapshots.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must
also have the <code>create</code> ability and the <code>mount</code> ability in the origin
file system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>create</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to create descendent datasets.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must also have
the <code>mount</code> ability.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>destroy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to destroy a dataset.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must also have the
<code>mount</code> ability.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to mount and unmount a dataset and create and
destroy volume device links.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>promote</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to promote a clone to a dataset.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must also have
the <code>mount</code> ability and <code>promote</code> ability in the origin file system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>receive</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to create descendent file system with the
`zfs receive`command.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must also have the <code>mount</code> ability and the
<code>create</code> ability.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rename</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to rename a dataset.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must also have the <code>mount</code>
ability and the <code>create</code> ability in the new parent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to rollback a snapshot.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must also have the
<code>mount</code> ability.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>send</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to send a snapshot stream.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>share</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to share and unshare a dataset.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>snapshot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ability to take a snapshot of a dataset.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, you can delegate the following ZFS properties to non-root
users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>aclinherit</code></p>
</li>
<li>
<p><code>aclmode</code></p>
</li>
<li>
<p><code>atime</code></p>
</li>
<li>
<p><code>canmount</code></p>
</li>
<li>
<p><code>casesensitivity</code></p>
</li>
<li>
<p><code>checksum</code></p>
</li>
<li>
<p><code>compression</code></p>
</li>
<li>
<p><code>copies</code></p>
</li>
<li>
<p><code>exec</code></p>
</li>
<li>
<p><code>devices</code></p>
</li>
<li>
<p><code>mountpoint</code></p>
</li>
<li>
<p><code>nbmand</code></p>
</li>
<li>
<p><code>normalization</code></p>
</li>
<li>
<p><code>quota</code></p>
</li>
<li>
<p><code>readonly</code></p>
</li>
<li>
<p><code>recordsize</code></p>
</li>
<li>
<p><code>reservation</code></p>
</li>
<li>
<p><code>setuid</code></p>
</li>
<li>
<p><code>shareiscsi</code></p>
</li>
<li>
<p><code>sharenfs</code></p>
</li>
<li>
<p><code>sharesmb</code></p>
</li>
<li>
<p><code>snapdir</code></p>
</li>
<li>
<p><code>userprop</code></p>
</li>
<li>
<p><code>utf8only</code></p>
</li>
<li>
<p><code>version</code></p>
</li>
<li>
<p><code>volsize</code></p>
</li>
<li>
<p><code>vscan</code></p>
</li>
<li>
<p><code>xattr</code></p>
</li>
<li>
<p><code>zoned</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some of the properties listed above can only set at dataset creation
time. For a description of these properties, see <a href="#introducing-zfs-properties">Introducing
ZFS Properties</a>.</p>
</div>
<div class="sect3">
<h4 id="syntax-descriptions-for-delegating-permissions"><a class="anchor" href="#syntax-descriptions-for-delegating-permissions"></a>5.2.1. Syntax Descriptions for Delegating Permissions</h4>
<div class="paragraph">
<p>The <code>zfs allow</code> syntax is as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow -[l d u g e c s] everyone|user|group[,,...] perm|@setname ,...] filesystem| volume</pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>zfs allow</code> syntax (in bold) identifies to whom the
permissions are delegated:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>zfs allow [-uge] | user | group | everyone [,...] filesystem | volume</pre>
</div>
</div>
<div class="paragraph">
<p>Multiple entities can be specified as a comma-separated list. If none of
the <code>uge</code> options are specified, then the argument is interpreted
preferentially as the keyword <code>everyone</code>, then as a user name, and
lastly, as a group name. To specify a user or group named “everyone,”
use the <code>u</code> or <code>g</code> options. To specify a group with the same name as a
user, use the <code>g</code> option.</p>
</div>
<div class="paragraph">
<p>The following <code>zfs allow</code> syntax (in bold) identifies how permissions
and permission sets are specified:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>zfs allow [-s] ... perm | @setname [,...] filesystem | volume</pre>
</div>
</div>
<div class="paragraph">
<p>Multiple permissions can be specified as a comma-separated list.
Permission names are the same as ZFS subcommands and properties. For
more information, see the section above.</p>
</div>
<div class="paragraph">
<p>Permissions can be aggregated into <em>permissions sets</em> and are identified
by the <code>s</code> option. Permission sets can be used by other <code>zfs allow</code>
commands for the specified file system and its descendents. Sets are
evaluated dynamically, so changes to a set are immediately updated.
Permission sets follow the same naming conventions as ZFS file systems,
but the name must begin with an at sign (<code>@</code>), and can be no more than
64 characters long.</p>
</div>
<div class="paragraph">
<p>The following <code>zfs allow</code> syntax (in bold) identifies how the
permissions are delegated:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>zfs allow [-ld] ... ... filesystem | volume</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>l</code> option identifies if whether the permission is allowed for the
specified dataset and not its descendents, unless the <code>d</code> option is also
specified. The <code>d</code> option indicates that the permission is allowed for
the descendent datasets and not for this dataset, unless the <code>l</code> option
is also specified. If neither of the <code>ld</code> options are specified, then
the permissions are allowed for the file system or volume and all of its
descendents.</p>
</div>
</div>
<div class="sect3">
<h4 id="removing-zfs-delegated-permissions-zfs-unallow"><a class="anchor" href="#removing-zfs-delegated-permissions-zfs-unallow"></a>5.2.2. Removing ZFS Delegated Permissions (<code>zfs unallow</code>)</h4>
<div class="paragraph">
<p>You can remove previously granted permissions with the <code>zfs unallow</code>
command.</p>
</div>
<div class="paragraph">
<p>For example, if you delegated create, destroy, mount, and snapshot
permissions as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow cindys, create,destroy,mount,snapshot tank/cindys
# zfs allow tank/cindys
-------------------------------------------------------------
Local+Descendent permissions on (tank/cindys)
        user cindys create,destroy,mount,snapshot
-------------------------------------------------------------</pre>
</div>
</div>
<div class="paragraph">
<p>You would need to use syntax similar to the following to remove these
permissions:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs unallow cindys tank/cindys
# zfs allow tank/cindys</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-zfs-delegated-administration"><a class="anchor" href="#using-zfs-delegated-administration"></a>5.3. Using ZFS Delegated Administration</h3>
<div class="paragraph">
<p>This section provides examples of displaying and delegating permissions.</p>
</div>
<div class="sect3">
<h4 id="displaying-zfs-delegated-permissions-examples"><a class="anchor" href="#displaying-zfs-delegated-permissions-examples"></a>5.3.1. Displaying ZFS Delegated Permissions (Examples)</h4>
<div class="paragraph">
<p>You can use the following command to display permissions:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow dataset</pre>
</div>
</div>
<div class="paragraph">
<p>The above command prints permissions that are set or allowed on this
dataset. The output contains the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Permissions sets</p>
</li>
<li>
<p>Specific permissions or create time permissions</p>
</li>
<li>
<p>Local</p>
</li>
<li>
<p>Local and descendent</p>
</li>
<li>
<p>Descendent only</p>
</li>
</ul>
</div>
<div id="gfthg" class="paragraph">
<p>Displaying Simple Delegated Administration Permissions</p>
</div>
<div class="paragraph">
<p>The following example output indicates that user <code>cindys</code> has permission
to create, destroy, mount, snapshot in the <code>tank/cindys</code> file system.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow tank/cindys
       -------------------------------------------------------------
       Local+Descendent permissions on (tank/cindys)
               user cindys create,destroy,mount,snapshot</pre>
</div>
</div>
<div id="gftex" class="paragraph">
<p>Displaying Complex Delegated Administration Permissions</p>
</div>
<div class="paragraph">
<p>The following example output indicates the following permissions on the
<code>pool</code> and <code>pool/fred</code> file systems.</p>
</div>
<div class="paragraph">
<p>For the <code>pool/fred</code> file system:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Two permission sets are defined:</p>
<div class="ulist">
<ul>
<li>
<p><code>@eng</code> (create, destroy, snapshot, mount, clone, promote, rename)</p>
</li>
<li>
<p><code>@simple</code> (create, mount)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create time permissions are set for the <code>@eng</code> permission set and the
<code>mountpoint</code> property. Create time means that after a dataset set is
created, the <code>@eng</code> permission set and the <code>mountpoint</code> property are
granted.</p>
</li>
<li>
<p>User <code>tom</code> is granted the <code>@eng</code> permission set and the user <code>joe</code> is
granted create, destroy, mount permissions for local file systems.</p>
</li>
<li>
<p>User <code>fred</code> is granted the <code>@basic</code> permission set and share and
rename permissions for the local and descendent file systems.</p>
</li>
<li>
<p>User <code>barney</code> is granted the <code>@basic</code> permission set for descendent
file systems only.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the pool file system:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The permission set <code>@simple</code> (create, destroy, mount) is defined.</p>
</li>
<li>
<p>The group <code>staff</code> is granted the <code>@simple</code> permission set on the local
file system.</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="content">
<pre>$ zfs allow pool/fred
------------------------------------------------------------------------------
Permission sets on (pool/fred)
        @eng create,destroy,snapshot,mount,clone,promote,rename
        @simple create,mount
Create time permissions on (pool/fred)
        @eng,mountpoint
Local permissions on (pool/fred)
        user tom @eng
        user joe create,destroy,mount
Local+Descendent permissions on (pool/fred)
        user fred @basic,share,rename
Descendent permissions on (pool/fred)
        user barney @basic
        group staff @basic
------------------------------------------------------------------------------
Permission sets on (pool)
        @simple create,destroy,mount
Local permissions on (pool)
        group staff @simple
------------------------------------------------------------------------------</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="delegating-zfs-permissions-examples"><a class="anchor" href="#delegating-zfs-permissions-examples"></a>5.3.2. Delegating ZFS Permissions (Examples)</h4>
<div id="gftfg" class="paragraph">
<p>Delegating Permissions to an Individual User</p>
</div>
<div class="paragraph">
<p>When you provide create and mount permissions, you need to make sure
that the user has permissions on the underlying mount point.</p>
</div>
<div class="paragraph">
<p>For example, to give <code>marks</code> create and mount permissions on <code>tank</code>, set
the permissions first:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chmod A+user:marks:add_subdirectory:fd:allow /tank</pre>
</div>
</div>
<div class="paragraph">
<p>Then, use the <code>zfs allow</code> to grant create, destroy, and mount
permissions. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow marks create,destroy,mount tank</pre>
</div>
</div>
<div class="paragraph">
<p>This means that <code>marks</code> can create his own file systems in the <code>tank</code>
file system. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># su marks
marks$ zfs create tank/marks
marks$ ^D
# su lp
$ zfs create tank/lp
cannot create 'tank/lp': permission denied</pre>
</div>
</div>
<div id="gftft" class="paragraph">
<p>Delegating Create and Destroy Permissions to a Group</p>
</div>
<div class="paragraph">
<p>The following example shows how to set up a file system so that anyone
in the <code>staff</code> group can create and mount file systems in the <code>tank</code>
file system, and also allows them to destroy their own file systems.
However, <code>staff</code> group members cannot destroy anyone else&#8217;s file
systems.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow staff create,mount tank
# zfs allow -c create,destroy tank
# zfs allow tank
-------------------------------------------------------------
Create time permissions on (tank)
        create,destroy
Local+Descendent permissions on (tank)
        group staff create,mount
-------------------------------------------------------------
# su cindys
cindys% zfs create tank/cindys
cindys% exit
# su marks
marks% zfs create tank/marks/data
marks% exit
cindys% zfs destroy tank/marks/data
cannot destroy 'tank/mark': permission denied</pre>
</div>
</div>
<div id="gftfk" class="paragraph">
<p>Delegating Permissions at the Right File System Level</p>
</div>
<div class="paragraph">
<p>Make sure to grant users permission at the right file system level. User
<code>marks</code> is granted create, destroy, and mount permissions for the local
and descendent file systems. User <code>marks</code> is granted local permission to
snapshot the <code>tank</code> file system, but this does not allow him to snapshot
his own file system.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow -l marks snapshot tank
# zfs allow tank
-------------------------------------------------------------
Local permissions on (tank)
        user marks snapshot
Local+Descendent permissions on (tank)
        user marks create,destroy,mount
-------------------------------------------------------------
# su marks
marks$ zfs snapshot tank/@snap1
marks$ zfs snapshot tank/marks@snap1
cannot create snapshot 'mark/marks@snap1': permission denied</pre>
</div>
</div>
<div class="paragraph">
<p>Use the <code>zfs allow</code> <code>d</code> option to grant marks permission at the
descendent level. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs unallow -l marks snapshot tank
# zfs allow -d marks snapshot tank
# zfs allow tank
-------------------------------------------------------------
Descendent permissions on (tank)
        user marks snapshot
Local+Descendent permissions on (tank)
        user marks create,destroy,mount
-------------------------------------------------------------
# su marks
$ zfs snapshot tank@snap2
cannot create snapshot 'sandbox@snap2': permission denied
$ zfs snapshot tank/marks@snappy</pre>
</div>
</div>
<div class="paragraph">
<p>User <code>marks</code> can only create a snapshot below the <code>tank</code> level.</p>
</div>
<div id="gfteu" class="paragraph">
<p>Defining and Using Complex Delegated Permissions</p>
</div>
<div class="paragraph">
<p>You can grant specific permissions to users or groups. For example, the
following <code>zfs allow</code> command grants specific permissions to the <code>staff</code>
group. In addition, destroy and snapshot permissions are granted after
tank file systems are created.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow staff create,mount tank
# zfs allow tank
-------------------------------------------------------------
Create time permissions on (tank)
        destroy,snapshot
Local+Descendent permissions on (tank)
        group staff create
-------------------------------------------------------------</pre>
</div>
</div>
<div class="paragraph">
<p>Because <code>marks</code> is a member of the <code>staff</code> group, he can create file
systems in <code>tank</code>. In addition, user <code>marks</code> can create a snapshot of
<code>tank/marks2</code> because he has specific permissions. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># su marks
$ zfs create tank/marks2
$ zfs allow tank/marks2
-------------------------------------------------------------
Local permissions on (tank/marks2)
        user marks destroy,snapshot
-------------------------------------------------------------
Create time permissions on (tank)
        destroy,snapshot
Local+Descendent permissions on (tank)
        group staff create
        everyone mount
-------------------------------------------------------------</pre>
</div>
</div>
<div class="paragraph">
<p>But, he can&#8217;t create a snapshot in <code>tank/marks</code> because he doesn&#8217;t have
specific permissions. See the listing above. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ zfs snapshot tank/marks2@snap1
$ zfs snapshot tank/marks@snappp
cannot create snapshot 'tank/marks@snappp': permission denied</pre>
</div>
</div>
<div class="paragraph">
<p>You can create snapshot directories if you have create permission in
your home directory, for example. This is helpful when your file system
is NFS mounted. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cd /tank/marks2
$ ls
$ cd .zfs
$ ls
$ cd snapshot
$ ls -l
total 3
drwxr-xr-x   2 marks    staff          2 Dec 15 13:53 snap1
$ pwd
/tank/marks2/.zfs/snapshot
$ mkdir snap2
$ zfs list
NAME                   USED  AVAIL  REFER  MOUNTPOINT
tank                   264K  33.2G  33.5K  /tank
tank/marks            24.5K  33.2G  24.5K  /tank/marks
tank/marks2             46K  33.2G  24.5K  /tank/marks2
tank/marks2@snap1     21.5K      -  24.5K  -
tank/marks2@snap2         0      -  24.5K  -
$ ls
snap1  snap2
$ rmdir snap2
$ ls</pre>
</div>
</div>
<div id="gfkcq" class="paragraph">
<p>Defining and Using a ZFS Delegated Permission Set</p>
</div>
<div class="paragraph">
<p>The following example creates a permission set <code>@myset</code> and grants the
permission set and the rename permission to the group <code>staff</code> for the
<code>tank</code> file system. User <code>cindys</code>, a group <code>staff</code> member, has the
ability to create a file system in <code>tank</code> but user <code>lp</code> has no
permission to create a file system in <code>tank</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow -s @myset create,destroy,mount,snapshot,promote,clone,readonly tank
# zfs allow tank
-------------------------------------------------------------
Permission sets on (tank)
        @myset clone,create,destroy,mount,promote,readonly,snapshot
-------------------------------------------------------------
# zfs allow staff @myset,rename tank
# zfs allow tank
-------------------------------------------------------------
Permission sets on (tank)
        @myset clone,create,destroy,mount,promote,readonly,snapshot
Local+Descendent permissions on (tank)
        group staff @myset,rename
# chmod A+group:staff:add_subdirectory:fd:allow tank
# su cindys
cindys% zfs create tank/data
Cindys% zfs allow tank
-------------------------------------------------------------
Permission sets on (tank)
        @myset clone,create,destroy,mount,promote,readonly,snapshot
Local+Descendent permissions on (tank)
        group staff @myset,rename
-------------------------------------------------------------
cindys% ls -l /tank
total 15
drwxr-xr-x   2 cindys   staff          2 Aug  8 14:10 data
cindys% exit
# su lp
$ zfs create tank/lp
cannot create 'tank/lp': permission denied</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="removing-zfs-permission-examples"><a class="anchor" href="#removing-zfs-permission-examples"></a>5.3.3. Removing ZFS Permission (Examples)</h4>
<div class="paragraph">
<p>You can use the following command to remove granted permissions. For
example, user <code>cindys</code> has permission to create, mount, destroy, and
snapshot in the <code>tank/cindys</code> file system.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow cindys create,destroy,mount,snapshot tank/cindys
       # zfs allow tank/cindys
       -------------------------------------------------------------
       Local+Descendent permissions on (tank/cindys)
               user cindys create,destroy,mount,snapshot
       -------------------------------------------------------------</pre>
</div>
</div>
<div class="paragraph">
<p>This <code>zfs unallow</code> syntax removes user <code>cindys&#8217;s snapshot permission
from the `tank/cindys</code> file system.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs unallow cindys snapshot tank/cindys
# zfs allow tank/cindys
-------------------------------------------------------------
Local+Descendent permissions on (tank/cindys)
        user cindys create,destroy,mount
-------------------------------------------------------------
cindys% zfs create tank/cindys/data
cindys% zfs snapshot tank/cindys@today
cannot create snapshot 'tank/cindys@today': permission denied</pre>
</div>
</div>
<div class="paragraph">
<p>User <code>marks</code> has the following permissions in <code>tank/marks</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow tank/marks
-------------------------------------------------------------
Local+Descendent permissions on (tank/marks)
        user marks create,destroy,mount
-------------------------------------------------------------</pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>zfs unallow</code> syntax removes all permissions for user
<code>marks</code> from <code>tank/marks</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs unallow marks tank/marks</pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>zfs unallow</code> syntax removes a permission set on the
<code>tank</code> file system.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs allow tank
-------------------------------------------------------------
Permission sets on (tank)
        @myset clone,create,destroy,mount,promote,readonly,snapshot
Create time permissions on (tank)
        create,destroy,mount
Local+Descendent permissions on (tank)
        group staff create,mount
-------------------------------------------------------------
# zfs unallow -s @myset tank
$ zfs allow tank
-------------------------------------------------------------
Create time permissions on (tank)
        create,destroy,mount
Local+Descendent permissions on (tank)
        group staff create,mount
-------------------------------------------------------------</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="zfs-advanced-topics"><a class="anchor" href="#zfs-advanced-topics"></a>6. ZFS Advanced Topics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes ZFS volumes, using ZFS with zones, ZFS alternate
root pools, and ZFS rights profiles.</p>
</div>
<div class="paragraph">
<p>The following sections are provided in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#zfs-volumes">ZFS Volumes</a></p>
</li>
<li>
<p><a href="#using-zfs-with-zones">Using ZFS With Zones</a></p>
</li>
<li>
<p><a href="#using-zfs-alternate-root-pools">Using ZFS Alternate Root Pools</a></p>
</li>
<li>
<p><a href="#zfs-rights-profiles">ZFS Rights Profiles</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="zfs-volumes"><a class="anchor" href="#zfs-volumes"></a>6.1. ZFS Volumes</h3>
<div class="paragraph">
<p>A ZFS volume is a dataset that represents a block device and can be used
like any block device. ZFS volumes are identified as devices in the
<code>/dev/zvol/{dsk,rdsk}/path</code> directory.</p>
</div>
<div class="paragraph">
<p>In the following example, 5-Gbyte ZFS volume, <code>tank/vol</code>, is created:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create -V 5gb tank/vol</pre>
</div>
</div>
<div class="paragraph">
<p>When you create a volume, a reservation is automatically set to the
initial size of the volume. The reservation size continues to equal the
size of the volume so that unexpected behavior doesn&#8217;t occur. For
example, if the size of the volume shrinks, data corruption might occur.
You must be careful when changing the size of the volume.</p>
</div>
<div class="paragraph">
<p>In addition, if you create a snapshot of a volume that changes in size,
you might introduce file system inconsistencies if you attempt to
rollback the snapshot or create a clone from the snapshot.</p>
</div>
<div class="paragraph">
<p>For information about file system properties that can be applied to
volumes, see <a href="#gcfgr">ZFS Native Property Descriptions</a>.</p>
</div>
<div class="paragraph">
<p>If you are using a system configured to use zones, you cannot create or
clone a ZFS volume in a non-global zone. Any attempt to do so will fail.
For information about using ZFS volumes in a global zone, see
<a href="#adding-zfs-volumes-to-a-non-global-zone">Adding ZFS Volumes to a Non-Global Zone</a>.</p>
</div>
<div class="sect3">
<h4 id="using-a-zfs-volume-as-a-swap-or-dump-device"><a class="anchor" href="#using-a-zfs-volume-as-a-swap-or-dump-device"></a>6.1.1. Using a ZFS Volume as a Swap or Dump Device</h4>
<div class="paragraph">
<p>To set up a swap area, create a ZFS volume of a specific size and then
enable swap on that device. Do not swap to a file on a ZFS file system.
A ZFS swap file configuration is not supported.</p>
</div>
<div class="paragraph">
<p>In the following example, the 5-Gbyte <code>tank/vol</code> volume is added as a
swap device.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># swap -a /dev/zvol/dsk/tank/vol
# swap -l
swapfile                 dev  swaplo blocks   free
/dev/dsk/c0t0d0s1      32,33      16 1048688  1048688
/dev/zvol/dsk/tank/vol 254,1      16 10485744 10485744</pre>
</div>
</div>
<div class="paragraph">
<p>Using a ZFS volume as a dump device is not supported. Use the <code>dumpadm</code>
command to set up a dump device.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-a-zfs-volume-as-a-solaris-iscsi-target"><a class="anchor" href="#using-a-zfs-volume-as-a-solaris-iscsi-target"></a>6.1.2. Using a ZFS Volume as a Solaris iSCSI Target</h4>
<div class="paragraph">
<p>Solaris iSCSI targets and initiators are supported in the Solaris
release.</p>
</div>
<div class="paragraph">
<p>In addition, you can easily create a ZFS volume as a iSCSI target by
setting the <code>shareiscsi</code> property on the volume. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs create -V 2g tank/volumes/v2
# zfs set shareiscsi=on tank/volumes/v2
# iscsitadm list target
Target: tank/volumes/v2
    iSCSI Name: iqn.1986-03.com.sun:02:984fe301-c412-ccc1-cc80-cf9a72aa062a
    Connections: 0</pre>
</div>
</div>
<div class="paragraph">
<p>After the iSCSI target is created, set up the iSCSI initiator. For more
information about Solaris iSCSI targets and initiators, see Chapter 14,
Configuring Solaris iSCSI Targets and Initiators (Tasks), in System
Administration Guide: Devices and File Systems.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Solaris iSCSI targets can also be created and managed with <code>iscsitadm</code>
command. If you set the <code>shareiscsi</code> property on a ZFS volume, do not
use the <code>iscsitadm</code> command to also create the same target device.
Otherwise, you will end up with duplicate target information for the
same device.</p>
</div>
<div class="paragraph">
<p>A ZFS volume as an iSCSI target is managed just like another ZFS
dataset. However, the rename, export, and import operations work a
little differently for iSCSI targets.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When you rename a ZFS volume, the iSCSI target name remains the same.
For example:</p>
<div class="literalblock">
<div class="content">
<pre># zfs rename tank/volumes/v2 tank/volumes/v1
# iscsitadm list target
Target: tank/volumes/v1
    iSCSI Name: iqn.1986-03.com.sun:02:984fe301-c412-ccc1-cc80-cf9a72aa062a
    Connections: 0</pre>
</div>
</div>
</li>
<li>
<p>Exporting a pool that contains a shared ZFS volume causes the target
to be removed. Importing a pool that contains a shared ZFS volume causes
the target to be shared. For example:</p>
<div class="literalblock">
<div class="content">
<pre># zpool export tank
# iscsitadm list target
# zpool import tank
# iscsitadm list target
Target: tank/volumes/v1
    iSCSI Name: iqn.1986-03.com.sun:02:984fe301-c412-ccc1-cc80-cf9a72aa062a
    Connections: 0</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>All iSCSI target configuration information is stored within the dataset.
Like an NFS shared file system, an iSCSI target that is imported on a
different system is shared appropriately.</p>
</div>
<div id="using-zfs-with-zones" class="paragraph">
<p>=== Using ZFS With Zones</p>
</div>
<div class="paragraph">
<p>The following sections describe how to use ZFS with zones.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#adding-zfs-file-systems-to-a-non-global-zone">Adding ZFS File Systems to a Non-Global Zone</a></p>
</li>
<li>
<p><a href="#delegating-datasets-to-a-non-global-zone">Delegating Datasets to a Non-Global Zone</a></p>
</li>
<li>
<p><a href="#adding-zfs-volumes-to-a-non-global-zone">Adding ZFS Volumes to a Non-Global Zone</a></p>
</li>
<li>
<p><a href="#using-zfs-storage-pools-within-a-zone">Using ZFS Storage Pools Within a Zone</a></p>
</li>
<li>
<p><a href="#managing-zfs-properties-within-a-zone">Managing ZFS Properties Within a Zone</a></p>
</li>
<li>
<p><a href="#understanding-the-zoned-property">Understanding the Property</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keep the following points in mind when associating ZFS datasets with
zones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can add a ZFS file system or a ZFS clone to a non-global with or
without delegating administrative control.</p>
</li>
<li>
<p>You can add a ZFS volume as a device to non-global zones</p>
</li>
<li>
<p>You cannot associate ZFS snapshots with zones at this time</p>
</li>
<li>
<p>Do not use a ZFS file system for a global zone root path or a
non-global zone root path in the Solaris 10 releases. You can use ZFS as
a zone root path in the Solaris Express releases, but keep in mind that
patching or upgrading these zones is not supported.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the sections below, a ZFS dataset refers to a file system or clone.</p>
</div>
<div class="paragraph">
<p>Adding a dataset allows the non-global zone to share space with the
global zone, though the zone administrator cannot control properties or
create new file systems in the underlying file system hierarchy. This is
identical to adding any other type of file system to a zone, and should
be used when the primary purpose is solely to share common space.</p>
</div>
<div class="paragraph">
<p>ZFS also allows datasets to be delegated to a non-global zone, giving
complete control over the dataset and all its children to the zone
administrator. The zone administrator can create and destroy file
systems or clones within that dataset, and modify properties of the
datasets. The zone administrator cannot affect datasets that have not
been added to the zone, and cannot exceed any top-level quotas set on
the exported dataset.</p>
</div>
<div class="paragraph">
<p>Consider the following interactions when working with ZFS on a system
configured to use zones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A ZFS file system that is added to a non-global zone must have its
<code>mountpoint</code> property set to legacy.</p>
</li>
<li>
<p>When a source <code>zonepath</code> and the target <code>zonepath</code> both reside on ZFS
and are in the same pool, <code>zoneadm clone</code> will now automatically use ZFS
clone to clone a zone. The <code>zoneadm clone</code> command will take a ZFS
snapshot of the source <code>zonepath</code> and set up the target <code>zonepath</code>. You
cannot use the <code>zfs clone</code> command to clone a zone. For more
information, see Part II, Zones, in System Administration Guide:
Virtualization Using the Solaris Operating System.</p>
</li>
</ul>
</div>
<div id="adding-zfs-file-systems-to-a-non-global-zone" class="paragraph">
<p>==== Adding ZFS File Systems to a Non-Global Zone</p>
</div>
<div class="paragraph">
<p>You can add a ZFS file system as a generic file system when the goal is
solely to share space with the global zone. A ZFS file system that is
added to a non-global zone must have its <code>mountpoint</code> property set to
legacy.</p>
</div>
<div class="paragraph">
<p>You can add a ZFS file system to a non-global zone by using the
<code>zonecfg</code> command&#8217;s <code>add fs</code> subcommand. For example:</p>
</div>
<div class="paragraph">
<p>In the following example, a ZFS file system is added to a non-global
zone by a global administrator in the global zone.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zonecfg -z zion
zonecfg:zion&gt; add fs
zonecfg:zion:fs&gt; set type=zfs
zonecfg:zion:fs&gt; set special=tank/zone/zion
zonecfg:zion:fs&gt; set dir=/export/shared
zonecfg:zion:fs&gt; end</pre>
</div>
</div>
<div class="paragraph">
<p>This syntax adds the ZFS file system, <code>tank/zone/zion</code>, to the already
configured <code>zion</code> zone, mounted at <code>/export/shared</code>. The mountpoint
property of the file system must be set to legacy, and the file system
cannot already be mounted in another location. The zone administrator
can create and destroy files within the file system. The file system
cannot be remounted in a different location, nor can the zone
administrator change properties on the file system such as atime,
readonly, compression, and so on. The global zone administrator is
responsible for setting and controlling properties of the file system.</p>
</div>
<div class="paragraph">
<p>For more information about the <code>zonecfg</code> command and about configuring
resource types with <code>zonecfg</code>, see Part II, Zones, in System
Administration Guide: Virtualization Using the Solaris Operating System.</p>
</div>
<div id="delegating-datasets-to-a-non-global-zone" class="paragraph">
<p>==== Delegating Datasets to a Non-Global Zone</p>
</div>
<div class="paragraph">
<p>If the primary goal is to delegate the administration of storage to a
zone, then ZFS supports adding datasets to a non-global zone through use
of the <code>zonecfg</code> command&#8217;s <code>add dataset</code> subcommand.</p>
</div>
<div class="paragraph">
<p>In the following example, a ZFS file system is delegated to a non-global
zone by a global administrator in the global zone.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zonecfg -z zion
zonecfg:zion&gt; add dataset
zonecfg:zion:dataset&gt; set name=tank/zone/zion
zonecfg:zion:dataset&gt; end</pre>
</div>
</div>
<div class="paragraph">
<p>Unlike adding a file system, this syntax causes the ZFS file system
<code>tank/zone/zion</code> to be visible within the already configured <code>zion</code>
zone. The zone administrator can set file system properties, as well as
create children. In addition, the zone administrator can take snapshots,
create clones, and otherwise control the entire file system hierarchy.</p>
</div>
<div class="paragraph">
<p>For more information about what actions are allowed within zones, see
<a href="#managing-zfs-properties-within-a-zone">Managing ZFS Properties Within a Zone</a>.</p>
</div>
<div id="adding-zfs-volumes-to-a-non-global-zone" class="paragraph">
<p>==== Adding ZFS Volumes to a Non-Global Zone</p>
</div>
<div class="paragraph">
<p>ZFS volumes cannot be added to a non-global zone by using the <code>zonecfg</code>
command&#8217;s <code>add dataset</code> subcommand. If an attempt to add an ZFS volume
is detected, the zone cannot boot. However, volumes can be added to a
zone by using the <code>zonecfg</code> command&#8217;s <code>add device</code> subcommand.</p>
</div>
<div class="paragraph">
<p>In the following example, a ZFS volume is added to a non-global zone by
a global administrator in the global zone:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zonecfg -z zion
zion: No such zone configured
Use 'create' to begin configuring a new zone.
zonecfg:zion&gt; create
zonecfg:zion&gt; add device
zonecfg:zion:device&gt; set match=/dev/zvol/dsk/tank/vol
zonecfg:zion:device&gt; end</pre>
</div>
</div>
<div class="paragraph">
<p>This syntax exports the <code>tank/vol</code> volume to the zone. Note that adding
a raw volume to a zone has implicit security risks, even if the volume
doesn&#8217;t correspond to a physical device. In particular, the zone
administrator could create malformed file systems that would panic the
system when a mount is attempted. For more information about adding
devices to zones and the related security risks, see
<a href="#understanding-the-zoned-property">Understanding the Property</a>.</p>
</div>
<div class="paragraph">
<p>For more information about adding devices to zones, see Part II, Zones,
in System Administration Guide: Virtualization Using the Solaris
Operating System.</p>
</div>
<div id="using-zfs-storage-pools-within-a-zone" class="paragraph">
<p>==== Using ZFS Storage Pools Within a Zone</p>
</div>
<div class="paragraph">
<p>ZFS storage pools cannot be created or modified within a zone. The
delegated administration model centralizes control of physical storage
devices within the global zone and control of virtual storage to
non-global zones. While a pool-level dataset can be added to a zone, any
command that modifies the physical characteristics of the pool, such as
creating, adding, or removing devices, is not allowed from within a
zone. Even if physical devices are added to a zone by using the
<code>zonecfg</code> command&#8217;s <code>add device</code> subcommand, or if files are used, the
<code>zpool</code> command does not allow the creation of any new pools within the
zone.</p>
</div>
<div id="managing-zfs-properties-within-a-zone" class="paragraph">
<p>==== Managing ZFS Properties Within a Zone</p>
</div>
<div class="paragraph">
<p>After a dataset is added to a zone, the zone administrator can control
specific dataset properties. When a dataset is added to a zone, all its
ancestors are visible as read-only datasets, while the dataset itself is
writable as are all of its children. For example, consider the following
configuration:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>global# zfs list -Ho name
tank/home
tank/data
tank/data/matrix
tank/data/zion
tank/data/zion/home</pre>
</div>
</div>
<div class="paragraph">
<p>If <code>tank/data/zion</code> is added to a zone, each dataset would have the
following properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Dataset</th>
<th class="tableblock halign-left valign-top">Visible</th>
<th class="tableblock halign-left valign-top">Writable</th>
<th class="tableblock halign-left valign-top">Immutable Properties</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tank</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tank/home</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tank/data</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tank/data/matrix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tank/data/zion</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sharenfs, zoned, quota, reservation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tank/data/zion/home</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sharenfs, zoned</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that every parent of <code>tank/zone/zion</code> is visible read-only, all
children are writable, and datasets that are not part of the parent
hierarchy are not visible at all. The zone administrator cannot change
the sharenfs property, because non-global zones cannot act as NFS
servers. Neither can the zone administrator change the <code>zoned</code> property,
because doing so would expose a security risk as described in the next
section.</p>
</div>
<div class="paragraph">
<p>Any other settable property can be changed, except for the <code>quota</code>
property, and the dataset itself. This behavior allows the global zone
administrator to control the space consumption of all datasets used by
the non-global zone.</p>
</div>
<div class="paragraph">
<p>In addition, the sharenfs and mountpoint properties cannot be changed by
the global zone administrator once a dataset has been added to a
non-global zone.</p>
</div>
<div id="understanding-the-zoned-property" class="paragraph">
<p>==== Understanding the zoned Property</p>
</div>
<div class="paragraph">
<p>When a dataset is added to a non-global zone, the dataset must be
specially marked so that certain properties are not interpreted within
the context of the global zone. After a dataset has been added to a
non-global zone under the control of a zone administrator, its contents
can no longer be trusted. As with any file system, there might be setuid
binaries, symbolic links, or otherwise questionable contents that might
adversely affect the security of the global zone. In addition, the
mountpoint property cannot be interpreted in the context of the global
zone. Otherwise, the zone administrator could affect the global zone&#8217;s
namespace. To address the latter, ZFS uses the zoned property to
indicate that a dataset has been delegated to a non-global zone at one
point in time.</p>
</div>
<div class="paragraph">
<p>The zoned property is a boolean value that is automatically turned on
when a zone containing a ZFS dataset is first booted. A zone
administrator will not need to manually turn on this property. If the
zoned property is set, the dataset cannot be mounted or shared in the
global zone, and is ignored when the <code>zfs share</code> <code>a</code> command or the
<code>zfs mount</code> <code>a</code> command is executed. In the following example,
<code>tank/zone/zion</code> has been added to a zone, while <code>tank/zone/global</code> has
not:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zfs list -o name,zoned,mountpoint -r tank/zone
NAME                  ZONED  MOUNTPOINT
tank/zone/global        off  /tank/zone/global
tank/zone/zion           on  /tank/zone/zion
# zfs mount
tank/zone/global           /tank/zone/global
tank/zone/zion             /export/zone/zion/root/tank/zone/zion</pre>
</div>
</div>
<div class="paragraph">
<p>Note the difference between the mountpoint property and the directory
where the <code>tank/zone/zion</code> dataset is currently mounted. The mountpoint
property reflects the property as stored on disk, not where the dataset
is currently mounted on the system.</p>
</div>
<div class="paragraph">
<p>When a dataset is removed from a zone or a zone is destroyed, the zoned
property is <strong>not</strong> automatically cleared. This behavior is due to the
inherent security risks associated with these tasks. Because an
untrusted user has had complete access to the dataset and its children,
the mountpoint property might be set to bad values, or setuid binaries
might exist on the file systems.</p>
</div>
<div class="paragraph">
<p>To prevent accidental security risks, the zoned property must be
manually cleared by the global administrator if you want to reuse the
dataset in any way. Before setting the zoned property to <code>off</code>, make
sure that the mountpoint property for the dataset and all its children
are set to reasonable values and that no setuid binaries exist, or turn
off the setuid property.</p>
</div>
<div class="paragraph">
<p>After you have verified that no security vulnerabilities are left, the
zoned property can be turned off by using the <code>zfs set</code> or <code>zfs inherit</code>
commands. If the zoned property is turned off while a dataset is in use
within a zone, the system might behave in unpredictable ways. Only
change the property if you are sure the dataset is no longer in use by a
non-global zone.</p>
</div>
<div id="using-zfs-alternate-root-pools" class="paragraph">
<p>=== Using ZFS Alternate Root Pools</p>
</div>
<div class="paragraph">
<p>When a pool is created, the pool is intrinsically tied to the host
system. The host system maintains knowledge about the pool so that it
can detect when the pool is otherwise unavailable. While useful for
normal operation, this knowledge can prove a hindrance when booting from
alternate media, or creating a pool on removable media. To solve this
problem, ZFS provides an <em>alternate root</em> pool feature. An alternate
root pool does not persist across system reboots, and all mount points
are modified to be relative to the root of the pool.</p>
</div>
<div id="creating-zfs-alternate-root-pools" class="paragraph">
<p>==== Creating ZFS Alternate Root Pools</p>
</div>
<div class="paragraph">
<p>The most common use for creating an alternate root pool is for use with
removable media. In these circumstances, users typically want a single
file system, and they want it to be mounted wherever they choose on the
target system. When an alternate root pool is created by using the <code>R</code>
option, the mount point of the root file system is automatically set to
<code>/</code>, which is the equivalent of the alternate root itself.</p>
</div>
<div class="paragraph">
<p>In the following example, a pool called <code>morpheus</code> is created with
<code>/mnt</code> as the alternate root path:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool create -R /mnt morpheus c0t0d0
# zfs list morpheus
NAME                   USED  AVAIL  REFER  MOUNTPOINT
morpheus              32.5K  33.5G     8K  /mnt/</pre>
</div>
</div>
<div class="paragraph">
<p>Note the single file system, <code>morpheus</code>, whose mount point is the
alternate root of the pool, <code>/mnt</code>. The mount point that is stored on
disk is <code>/</code> and the full path to <code>/mnt</code> is interpreted only in the
context of the alternate root pool. This file system can then be
exported and imported under an arbitrary alternate root pool on a
different system.</p>
</div>
<div id="importing-alternate-root-pools" class="paragraph">
<p>==== Importing Alternate Root Pools</p>
</div>
<div class="paragraph">
<p>Pools can also be imported using an alternate root. This feature allows
for recovery situations, where the mount points should not be
interpreted in context of the current root, but under some temporary
directory where repairs can be performed. This feature also can be used
when mounting removable media as described above.</p>
</div>
<div class="paragraph">
<p>In the following example, a pool called <code>morpheus</code> is imported with
<code>/mnt</code> as the alternate root path. This example assumes that <code>morpheus</code>
was previously exported.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool import -R /mnt morpheus
# zpool list morpheus
NAME                    SIZE    USED   AVAIL    CAP  HEALTH     ALTROOT
morpheus               33.8G   68.0K   33.7G     0%  ONLINE     /mnt
# zfs list morpheus
NAME                   USED  AVAIL  REFER  MOUNTPOINT
morpheus              32.5K  33.5G     8K  /mnt/morpheus</pre>
</div>
</div>
<div id="zfs-rights-profiles" class="paragraph">
<p>=== ZFS Rights Profiles</p>
</div>
<div class="paragraph">
<p>If you want to perform ZFS management tasks without using the superuser
(root) account, you can assume a role with either of the following
profiles to perform ZFS administration tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ZFS Storage Management – Provides the ability to create, destroy, and
manipulate devices within a ZFS storage pool</p>
</li>
<li>
<p>ZFS File system Management – Provides the ability to create, destroy,
and modify ZFS file systems</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about creating or assigning roles, see System
Administration Guide: Security Services.</p>
</div>
<div class="paragraph">
<p>In addition to using RBAC roles for administering ZFS file systems, you
might also consider using ZFS delegated administration for distributed
ZFS administration tasks. For more information, see <a href="#zfs-delegated-administration">ZFS
Delegated Administration</a>.</p>
</div>
<div id="zfs-troubleshooting-and-data-recovery" class="paragraph">
<p>== ZFS Troubleshooting and Data Recovery</p>
</div>
<div class="paragraph">
<p>This chapter describes how to identify and recover from ZFS failure
modes. Information for preventing failures is provided as well.</p>
</div>
<div class="paragraph">
<p>The following sections are provided in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#zfs-failure-modes">ZFS Failure Modes</a></p>
</li>
<li>
<p><a href="#checking-zfs-data-integrity">Checking ZFS Data Integrity</a></p>
</li>
<li>
<p><a href="#identifying-problems-in-zfs">Identifying Problems in ZFS</a></p>
</li>
<li>
<p><a href="#repairing-a-damaged-zfs-configuration">Repairing a Damaged ZFS Configuration</a></p>
</li>
<li>
<p><a href="#repairing-a-missing-device">Repairing a Missing Device</a></p>
</li>
<li>
<p><a href="#repairing-a-damaged-device">Repairing a Damaged Device</a></p>
</li>
<li>
<p><a href="#repairing-damaged-data">Repairing Damaged Data</a></p>
</li>
<li>
<p><a href="#repairing-an-unbootable-system">Repairing an Unbootable System</a></p>
</li>
</ul>
</div>
<div id="zfs-failure-modes" class="paragraph">
<p>=== ZFS Failure Modes</p>
</div>
<div class="paragraph">
<p>As a combined file system and volume manager, ZFS can exhibit many
different failure modes. This chapter begins by outlining the various
failure modes, then discusses how to identify them on a running system.
This chapter concludes by discussing how to repair the problems. ZFS can
encounter three basic types of errors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#missing-devices-in-a-zfs-storage-pool">Missing Devices in a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#damaged-devices-in-a-zfs-storage-pool">Damaged Devices in a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#corrupted-zfs-data">Corrupted ZFS Data</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that a single pool can experience all three errors, so a complete
repair procedure involves finding and correcting one error, proceeding
to the next error, and so on.</p>
</div>
<div id="missing-devices-in-a-zfs-storage-pool" class="paragraph">
<p>==== Missing Devices in a ZFS Storage Pool</p>
</div>
<div class="paragraph">
<p>If a device is completely removed from the system, ZFS detects that the
device cannot be opened and places it in the <code>FAULTED</code> state. Depending
on the data replication level of the pool, this might or might not
result in the entire pool becoming unavailable. If one disk in a
mirrored or RAID-Z device is removed, the pool continues to be
accessible. If all components of a mirror are removed, if more than one
device in a RAID-Z device is removed, or if a single-disk, top-level
device is removed, the pool becomes <code>FAULTED</code>. No data is accessible
until the device is reattached.</p>
</div>
<div id="damaged-devices-in-a-zfs-storage-pool" class="paragraph">
<p>==== Damaged Devices in a ZFS Storage Pool</p>
</div>
<div class="paragraph">
<p>The term “damaged” covers a wide variety of possible errors. Examples
include the following errors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transient I/O errors due to a bad disk or controller</p>
</li>
<li>
<p>On-disk data corruption due to cosmic rays</p>
</li>
<li>
<p>Driver bugs resulting in data being transferred to or from the wrong
location</p>
</li>
<li>
<p>Simply another user overwriting portions of the physical device by</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In some cases, these errors are transient, such as a random I/O error
while the controller is having problems. In other cases, the damage is
permanent, such as on-disk corruption. Even still, whether the damage is
permanent does not necessarily indicate that the error is likely to
occur again. For example, if an administrator accidentally overwrites
part of a disk, no type of hardware failure has occurred, and the device
need not be replaced. Identifying exactly what went wrong with a device
is not an easy task and is covered in more detail in a later section.</p>
</div>
<div id="corrupted-zfs-data" class="paragraph">
<p>==== Corrupted ZFS Data</p>
</div>
<div class="paragraph">
<p>Data corruption occurs when one or more device errors (indicating
missing or damaged devices) affects a top-level virtual device. For
example, one half of a mirror can experience thousands of device errors
without ever causing data corruption. If an error is encountered on the
other side of the mirror in the exact same location, corrupted data will
be the result.</p>
</div>
<div class="paragraph">
<p>Data corruption is always permanent and requires special consideration
during repair. Even if the underlying devices are repaired or replaced,
the original data is lost forever. Most often this scenario requires
restoring data from backups. Data errors are recorded as they are
encountered, and can be controlled through routine disk scrubbing as
explained in the following section. When a corrupted block is removed,
the next scrubbing pass recognizes that the corruption is no longer
present and removes any trace of the error from the system.</p>
</div>
<div id="checking-zfs-data-integrity" class="paragraph">
<p>=== Checking ZFS Data Integrity</p>
</div>
<div class="paragraph">
<p>No <code>fsck</code> utility equivalent exists for ZFS. This utility has
traditionally served two purposes, data repair and data validation.</p>
</div>
<div id="data-repair" class="paragraph">
<p>==== Data Repair</p>
</div>
<div class="paragraph">
<p>With traditional file systems, the way in which data is written is
inherently vulnerable to unexpected failure causing data
inconsistencies. Because a traditional file system is not transactional,
unreferenced blocks, bad link counts, or other inconsistent data
structures are possible. The addition of journaling does solve some of
these problems, but can introduce additional problems when the log
cannot be rolled back. With ZFS, none of these problems exist. The only
way for inconsistent data to exist on disk is through hardware failure
(in which case the pool should have been redundant) or a bug in the ZFS
software exists.</p>
</div>
<div class="paragraph">
<p>Given that the <code>fsck</code> utility is designed to repair known pathologies
specific to individual file systems, writing such a utility for a file
system with no known pathologies is impossible. Future experience might
prove that certain data corruption problems are common enough and simple
enough such that a repair utility can be developed, but these problems
can always be avoided by using redundant pools.</p>
</div>
<div class="paragraph">
<p>If your pool is not redundant, the chance that data corruption can
render some or all of your data inaccessible is always present.</p>
</div>
<div id="data-validation" class="paragraph">
<p>==== Data Validation</p>
</div>
<div class="paragraph">
<p>In addition to data repair, the <code>fsck</code> utility validates that the data
on disk has no problems. Traditionally, this task is done by unmounting
the file system and running the <code>fsck</code> utility, possibly taking the
system to single-user mode in the process. This scenario results in
downtime that is proportional to the size of the file system being
checked. Instead of requiring an explicit utility to perform the
necessary checking, ZFS provides a mechanism to perform routine checking
of all data. This functionality, known as <em>scrubbing</em>, is commonly used
in memory and other systems as a method of detecting and preventing
errors before they result in hardware or software failure.</p>
</div>
<div id="controlling-zfs-data-scrubbing" class="paragraph">
<p>==== Controlling ZFS Data Scrubbing</p>
</div>
<div class="paragraph">
<p>Whenever ZFS encounters an error, either through scrubbing or when
accessing a file on demand, the error is logged internally so that you
can get a quick overview of all known errors within the pool.</p>
</div>
<div id="explicit-zfs-data-scrubbing" class="paragraph">
<p>===== Explicit ZFS Data Scrubbing</p>
</div>
<div class="paragraph">
<p>The simplest way to check your data integrity is to initiate an explicit
scrubbing of all data within the pool. This operation traverses all the
data in the pool once and verifies that all blocks can be read.
Scrubbing proceeds as fast as the devices allow, though the priority of
any I/O remains below that of normal operations. This operation might
negatively impact performance, though the file system should remain
usable and nearly as responsive while the scrubbing occurs. To initiate
an explicit scrub, use the <code>zpool scrub</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool scrub tank</pre>
</div>
</div>
<div class="paragraph">
<p>The status of the current scrub can be displayed in the <code>zpool status</code>
output. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -v tank
  pool: tank
 state: ONLINE
 scrub: scrub completed with 0 errors on Wed Aug 30 14:02:24 2006
config:

        NAME        STATE     READ WRITE CKSUM
        tank        ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c1t0d0  ONLINE       0     0     0
            c1t1d0  ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>Note that only one active scrubbing operation per pool can occur at one
time.</p>
</div>
<div class="paragraph">
<p>You can stop a scrub that is in progress by using the <code>s</code> option. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool scrub -s tank</pre>
</div>
</div>
<div class="paragraph">
<p>In most cases, a scrub operation to ensure data integrity should
continue to completion. Stop a scrub at your own discretion if system
performance is impacted by a scrub operation.</p>
</div>
<div class="paragraph">
<p>Performing routine scrubbing also guarantees continuous I/O to all disks
on the system. Routine scrubbing has the side effect of preventing power
management from placing idle disks in low-power mode. If the system is
generally performing I/O all the time, or if power consumption is not a
concern, then this issue can safely be ignored.</p>
</div>
<div class="paragraph">
<p>For more information about interpreting <code>zpool status</code> output, see
<a href="#querying-zfs-storage-pool-status">Querying ZFS Storage Pool Status</a>.</p>
</div>
<div id="zfs-data-scrubbing-and-resilvering" class="paragraph">
<p>===== ZFS Data Scrubbing and Resilvering</p>
</div>
<div class="paragraph">
<p>When a device is replaced, a resilvering operation is initiated to move
data from the good copies to the new device. This action is a form of
disk scrubbing. Therefore, only one such action can happen at a given
time in the pool. If a scrubbing operation is in progress, a resilvering
operation suspends the current scrubbing, and restarts it after the
resilvering is complete.</p>
</div>
<div class="paragraph">
<p>For more information about resilvering, see <a href="#viewing-resilvering-status">Viewing
Resilvering Status</a>.</p>
</div>
<div id="identifying-problems-in-zfs" class="paragraph">
<p>=== Identifying Problems in ZFS</p>
</div>
<div class="paragraph">
<p>The following sections describe how to identify problems in your ZFS
file systems or storage pools.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#determining-if-problems-exist-in-a-zfs-storage-pool">Determining if Problems Exist in a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#reviewing-zpool-status-output">Reviewing Output</a></p>
</li>
<li>
<p><a href="#system-reporting-of-zfs-error-messages">System Reporting of ZFS Error Messages</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use the following features to identify problems with your ZFS
configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Detailed ZFS storage pool information with the <code>zpool status</code> command</p>
</li>
<li>
<p>Pool and device failures are reported with ZFS/FMA diagnostic messages</p>
</li>
<li>
<p>Previous ZFS commands that modified pool state information can be
displayed with the <code>zpool history</code> command</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most ZFS troubleshooting is centered around the <code>zpool status</code> command.
This command analyzes the various failures in the system and identifies
the most severe problem, presenting you with a suggested action and a
link to a knowledge article for more information. Note that the command
only identifies a single problem with the pool, though multiple problems
can exist. For example, data corruption errors always imply that one of
the devices has failed. Replacing the failed device does not fix the
data corruption problems.</p>
</div>
<div class="paragraph">
<p>In addition, a ZFS diagnostic engine is provided to diagnose and report
pool failures and device failures. Checksum, I/O, device, and pool
errors associated with pool or device failures are also reported. ZFS
failures as reported by <code>fmd</code> are displayed on the console as well as
the system messages file. In most cases, the <code>fmd</code> message directs you
to the <code>zpool status</code> command for further recovery instructions.</p>
</div>
<div class="paragraph">
<p>The basic recovery process is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If appropriate, use the <code>zpool history</code> command to identify the
previous ZFS commands that led up to the error scenario. For example:</p>
<div class="literalblock">
<div class="content">
<pre># zpool history
History for 'tank':
2007-04-25.10:19:42 zpool create tank mirror c0t8d0 c0t9d0 c0t10d0
2007-04-25.10:19:45 zfs create tank/erick
2007-04-25.10:19:55 zfs set checksum=off tank/erick</pre>
</div>
</div>
<div class="paragraph">
<p>Notice in the above output that checksums are disabled for the
<code>tank/erick</code> file system. This configuration is not recommended.</p>
</div>
</li>
<li>
<p>Identify the errors through the <code>fmd</code> messages that are displayed on
the system console or in the <code>/var/adm/messages</code> files.</p>
</li>
<li>
<p>Find further repair instructions in the <code>zpool status -x</code> command.</p>
</li>
<li>
<p>Repair the failures, such as:</p>
<div class="ulist">
<ul>
<li>
<p>Replace the faulted or missing device and bring it online.</p>
</li>
<li>
<p>Restore the faulted configuration or corrupted data from a backup.</p>
</li>
<li>
<p>Verify the recovery by using the <code>zpool status</code> <code>x</code> command.</p>
</li>
<li>
<p>Back up your restored configuration, if applicable.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This chapter describes how to interpret <code>zpool status</code> output in order
to diagnose the type of failure and directs you to one of the following
sections on how to repair the problem. While most of the work is
performed automatically by the command, it is important to understand
exactly what problems are being identified in order to diagnose the type
of failure.</p>
</div>
<div id="determining-if-problems-exist-in-a-zfs-storage-pool" class="paragraph">
<p>==== Determining if Problems Exist in a ZFS Storage Pool</p>
</div>
<div class="paragraph">
<p>The easiest way to determine if any known problems exist on the system
is to use the <code>zpool status</code> <code>x</code> command. This command describes only
pools exhibiting problems. If no bad pools exist on the system, then the
command displays a simple message, as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -x
all pools are healthy</pre>
</div>
</div>
<div class="paragraph">
<p>Without the <code>x</code> flag, the command displays the complete status for all
pools (or the requested pool, if specified on the command line), even if
the pools are otherwise healthy.</p>
</div>
<div class="paragraph">
<p>For more information about command-line options to the <code>zpool status</code>
command, see <a href="#querying-zfs-storage-pool-status">Querying ZFS Storage Pool Status</a>.</p>
</div>
<div id="reviewing-zpool-status-output" class="paragraph">
<p>==== Reviewing <code>zpool status</code> Output</p>
</div>
<div class="paragraph">
<p>The complete <code>zpool status</code> output looks similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status tank
  pool: tank
 state: DEGRADED
status: One or more devices has been taken offline by the administrator.
        Sufficient replicas exist for the pool to continue functioning in a
        degraded state.
action: Online the device using 'zpool online' or replace the device with
        'zpool replace'.
 scrub: none requested
 config:

        NAME         STATE     READ WRITE CKSUM
        tank         DEGRADED     0     0     0
          mirror     DEGRADED     0     0     0
            c1t0d0   ONLINE       0     0     0
            c1t1d0   OFFLINE      0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>This output is divided into several sections:</p>
</div>
<div id="overall-pool-status-information" class="paragraph">
<p>===== Overall Pool Status Information</p>
</div>
<div class="paragraph">
<p>This header section in the <code>zpool status</code> output contains the following
fields, some of which are only displayed for pools exhibiting problems:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>pool</code></dt>
<dd>
<p>The name of the pool.</p>
</dd>
<dt class="hdlist1"><code>state</code></dt>
<dd>
<p>The current health of the pool. This information refers only to the
ability of the pool to provide the necessary replication level. Pools
that are <code>ONLINE</code> might still have failing devices or data corruption.</p>
</dd>
<dt class="hdlist1"><code>status</code></dt>
<dd>
<p>A description of what is wrong with the pool. This field is omitted if
no problems are found.</p>
</dd>
<dt class="hdlist1"><code>action</code></dt>
<dd>
<p>A recommended action for repairing the errors. This field is an
abbreviated form directing the user to one of the following sections.
This field is omitted if no problems are found.</p>
</dd>
<dt class="hdlist1"><code>see</code></dt>
<dd>
<p>A reference to a knowledge article containing detailed repair
information. Online articles are updated more often than this guide
can be updated, and should always be referenced for the most
up-to-date repair procedures. This field is omitted if no problems are
found.</p>
</dd>
<dt class="hdlist1"><code>scrub</code></dt>
<dd>
<p>Identifies the current status of a scrub operation, which might
include the date and time that the last scrub was completed, a scrub
in progress, or if no scrubbing was requested.</p>
</dd>
<dt class="hdlist1"><code>errors</code></dt>
<dd>
<p>Identifies known data errors or the absence of known data errors.</p>
</dd>
</dl>
</div>
<div id="configuration-information" class="paragraph">
<p>===== Configuration Information</p>
</div>
<div class="paragraph">
<p>The <code>config</code> field in the <code>zpool status</code> output describes the
configuration layout of the devices comprising the pool, as well as
their state and any errors generated from the devices. The state can be
one of the following: <code>ONLINE</code>, <code>FAULTED</code>, <code>DEGRADED</code>, <code>UNAVAILABLE</code>, or
<code>OFFLINE</code>. If the state is anything but <code>ONLINE</code>, the fault tolerance of
the pool has been compromised.</p>
</div>
<div class="paragraph">
<p>The second section of the configuration output displays error
statistics. These errors are divided into three categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>READ</code> – I/O error occurred while issuing a read request.</p>
</li>
<li>
<p><code>WRITE</code> – I/O error occurred while issuing a write request.</p>
</li>
<li>
<p><code>CKSUM</code> – Checksum error. The device returned corrupted data as the
result of a read request.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These errors can be used to determine if the damage is permanent. A
small number of I/O errors might indicate a temporary outage, while a
large number might indicate a permanent problem with the device. These
errors do not necessarily correspond to data corruption as interpreted
by applications. If the device is in a redundant configuration, the disk
devices might show uncorrectable errors, while no errors appear at the
mirror or RAID-Z device level. If this scenario is the case, then ZFS
successfully retrieved the good data and attempted to heal the damaged
data from existing replicas.</p>
</div>
<div class="paragraph">
<p>For more information about interpreting these errors to determine device
failure, see <a href="#determining-the-type-of-device-failure">Determining the Type of Device Failure</a>.</p>
</div>
<div class="paragraph">
<p>Finally, additional auxiliary information is displayed in the last
column of the <code>zpool status</code> output. This information expands on the
<code>state</code> field, aiding in diagnosis of failure modes. If a device is
<code>FAULTED</code>, this field indicates whether the device is inaccessible or
whether the data on the device is corrupted. If the device is undergoing
resilvering, this field displays the current progress.</p>
</div>
<div class="paragraph">
<p>For more information about monitoring resilvering progress, see
<a href="#viewing-resilvering-status">Viewing Resilvering Status</a>.</p>
</div>
<div id="scrubbing-status" class="paragraph">
<p>===== Scrubbing Status</p>
</div>
<div class="paragraph">
<p>The third section of the <code>zpool status</code> output describes the current
status of any explicit scrubs. This information is distinct from whether
any errors are detected on the system, though this information can be
used to determine the accuracy of the data corruption error reporting.
If the last scrub ended recently, most likely, any known data corruption
has been discovered.</p>
</div>
<div class="paragraph">
<p>For more information about data scrubbing and how to interpret this
information, see <a href="#checking-zfs-data-integrity">Checking ZFS Data Integrity</a>.</p>
</div>
<div id="data-corruption-errors" class="paragraph">
<p>===== Data Corruption Errors</p>
</div>
<div class="paragraph">
<p>The <code>zpool status</code> command also shows whether any known errors are
associated with the pool. These errors might have been found during disk
scrubbing or during normal operation. ZFS maintains a persistent log of
all data errors associated with the pool. This log is rotated whenever a
complete scrub of the system finishes.</p>
</div>
<div class="paragraph">
<p>Data corruption errors are always fatal. Their presence indicates that
at least one application experienced an I/O error due to corrupt data
within the pool. Device errors within a redundant pool do not result in
data corruption and are not recorded as part of this log. By default,
only the number of errors found is displayed. A complete list of errors
and their specifics can be found by using the <code>zpool status</code> <code>v</code> option.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -v
  pool: tank
 state: DEGRADED
status: One or more devices has experienced an error resulting in data
        corruption.  Applications may be affected.
action: Restore the file in question if possible.  Otherwise restore the
        entire pool from backup.
   see: http://illumos.org/msg/ZFS-8000-8A
 scrub: resilver completed with 1 errors on Fri Mar 17 15:42:18 2006
config:

        NAME         STATE     READ WRITE CKSUM
        tank         DEGRADED     0     0     1
          mirror     DEGRADED     0     0     1
            c1t0d0   ONLINE       0     0     2
            c1t1d0   UNAVAIL      0     0     0  corrupted data

errors: The following persistent errors have been detected:

          DATASET  OBJECT  RANGE
          5        0       lvl=4294967295 blkid=0</pre>
</div>
</div>
<div class="paragraph">
<p>A similar message is also displayed by <code>fmd</code> on the system console and
the <code>/var/adm/messages</code> file. These messages can also be tracked by
using the <code>fmdump</code> command.</p>
</div>
<div class="paragraph">
<p>For more information about interpreting data corruption errors, see
<a href="#identifying-the-type-of-data-corruption">Identifying the Type of Data Corruption</a>.</p>
</div>
<div id="system-reporting-of-zfs-error-messages" class="paragraph">
<p>==== System Reporting of ZFS Error Messages</p>
</div>
<div class="paragraph">
<p>In addition to persistently keeping track of errors within the pool, ZFS
also displays syslog messages when events of interest occur. The
following scenarios generate events to notify the administrator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Device state transition</strong> – If a device becomes <code>FAULTED</code>, ZFS logs a
message indicating that the fault tolerance of the pool might be
compromised. A similar message is sent if the device is later brought
online, restoring the pool to health.</p>
</li>
<li>
<p><strong>Data corruption</strong> – If any data corruption is detected, ZFS logs a
message describing when and where the corruption was detected. This
message is only logged the first time it is detected. Subsequent
accesses do not generate a message.</p>
</li>
<li>
<p><strong>Pool failures and device failures</strong> – If a pool failure or device
failure occurs, the fault manager daemon reports these errors through
syslog messages as well as the <code>fmdump</code> command.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If ZFS detects a device error and automatically recovers from it, no
notification occurs. Such errors do not constitute a failure in the pool
redundancy or data integrity. Moreover, such errors are typically the
result of a driver problem accompanied by its own set of error messages.</p>
</div>
<div id="repairing-a-damaged-zfs-configuration" class="paragraph">
<p>=== Repairing a Damaged ZFS Configuration</p>
</div>
<div class="paragraph">
<p>ZFS maintains a cache of active pools and their configuration on the
root file system. If this file is corrupted or somehow becomes out of
sync with what is stored on disk, the pool can no longer be opened. ZFS
tries to avoid this situation, though arbitrary corruption is always
possible given the qualities of the underlying file system and storage.
This situation typically results in a pool disappearing from the system
when it should otherwise be available. This situation can also manifest
itself as a partial configuration that is missing an unknown number of
top-level virtual devices. In either case, the configuration can be
recovered by exporting the pool (if it is visible at all), and
re-importing it.</p>
</div>
<div class="paragraph">
<p>For more information about importing and exporting pools, see
<a href="#migrating-zfs-storage-pools">Migrating ZFS Storage Pools</a>.</p>
</div>
<div id="repairing-a-missing-device" class="paragraph">
<p>=== Repairing a Missing Device</p>
</div>
<div class="paragraph">
<p>If a device cannot be opened, it displays as <code>UNAVAILABLE</code> in the
<code>zpool status</code> output. This status means that ZFS was unable to open the
device when the pool was first accessed, or the device has since become
unavailable. If the device causes a top-level virtual device to be
unavailable, then nothing in the pool can be accessed. Otherwise, the
fault tolerance of the pool might be compromised. In either case, the
device simply needs to be reattached to the system to restore normal
operation.</p>
</div>
<div class="paragraph">
<p>For example, you might see a message similar to the following from <code>fmd</code>
after a device failure:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SUNW-MSG-ID: ZFS-8000-D3, TYPE: Fault, VER: 1, SEVERITY: Major
EVENT-TIME: Thu Aug 31 11:40:59 MDT 2006
PLATFORM: SUNW,Sun-Blade-1000, CSN: -, HOSTNAME: tank
SOURCE: zfs-diagnosis, REV: 1.0
EVENT-ID: e11d8245-d76a-e152-80c6-e63763ed7e4e
DESC: A ZFS device failed.  Refer to http://illumos.org/msg/ZFS-8000-D3 for more information.
AUTO-RESPONSE: No automated response will occur.
IMPACT: Fault tolerance of the pool may be compromised.
REC-ACTION: Run 'zpool status -x' and replace the bad device.</pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to use the <code>zpool status</code> <code>x</code> command to view more
detailed information about the device problem and the resolution. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -x
  pool: tank
 state: DEGRADED
status: One or more devices could not be opened.  Sufficient replicas exist for
        the pool to continue functioning in a degraded state.
action: Attach the missing device and online it using 'zpool online'.
   see: http://illumos.org/msg/ZFS-8000-D3
 scrub: resilver completed with 0 errors on Thu Aug 31 11:45:59 MDT 2006
config:

        NAME         STATE     READ WRITE CKSUM
        tank         DEGRADED     0     0     0
          mirror     DEGRADED     0     0     0
            c0t1d0   UNAVAIL      0     0     0  cannot open
            c1t1d0   ONLINE       0     0     0</pre>
</div>
</div>
<div class="paragraph">
<p>You can see from this output that the missing device <code>c0t1d0</code> is not
functioning. If you determine that the drive is faulty, replace the
device.</p>
</div>
<div class="paragraph">
<p>Then, use the <code>zpool online</code> command to online the replaced device. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool online tank c0t1d0</pre>
</div>
</div>
<div class="paragraph">
<p>Confirm that the pool with the replaced device is healthy.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -x tank
pool 'tank' is healthy</pre>
</div>
</div>
<div id="physically-reattaching-the-device" class="paragraph">
<p>==== Physically Reattaching the Device</p>
</div>
<div class="paragraph">
<p>Exactly how a missing device is reattached depends on the device in
question. If the device is a network-attached drive, connectivity should
be restored. If the device is a USB or other removable media, it should
be reattached to the system. If the device is a local disk, a controller
might have failed such that the device is no longer visible to the
system. In this case, the controller should be replaced at which point
the disks will again be available. Other pathologies can exist and
depend on the type of hardware and its configuration. If a drive fails
and it is no longer visible to the system (an unlikely event), the
device should be treated as a damaged device. Follow the procedures
outlined in <a href="#repairing-a-damaged-device">Repairing a Damaged Device</a>.</p>
</div>
<div id="notifying-zfs-of-device-availability" class="paragraph">
<p>==== Notifying ZFS of Device Availability</p>
</div>
<div class="paragraph">
<p>Once a device is reattached to the system, ZFS might or might not
automatically detect its availability. If the pool was previously
faulted, or the system was rebooted as part of the attach procedure,
then ZFS automatically rescans all devices when it tries to open the
pool. If the pool was degraded and the device was replaced while the
system was up, you must notify ZFS that the device is now available and
ready to be reopened by using the <code>zpool online</code> command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool online tank c0t1d0</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about bringing devices online, see
<a href="#bringing-a-device-online">Bringing a Device Online</a>.</p>
</div>
<div id="repairing-a-damaged-device" class="paragraph">
<p>=== Repairing a Damaged Device</p>
</div>
<div class="paragraph">
<p>This section describes how to determine device failure types, clear
transient errors, and replace a device.</p>
</div>
<div id="determining-the-type-of-device-failure" class="paragraph">
<p>==== Determining the Type of Device Failure</p>
</div>
<div class="paragraph">
<p>The term <em>damaged device</em> is rather vague, and can describe a number of
possible situations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Bit rot</strong> – Over time, random events, such as magnetic influences and
cosmic rays, can cause bits stored on disk to flip in unpredictable
events. These events are relatively rare but common enough to cause
potential data corruption in large or long-running systems. These errors
are typically transient.</p>
</li>
<li>
<p><strong>Misdirected reads or writes</strong> – Firmware bugs or hardware faults can
cause reads or writes of entire blocks to reference the incorrect
location on disk. These errors are typically transient, though a large
number might indicate a faulty drive.</p>
</li>
<li>
<p><strong>Administrator error</strong> – Administrators can unknowingly overwrite
portions of the disk with bad data (such as copying <code>/dev/zero</code> over
portions of the disk) that cause permanent corruption on disk. These
errors are always transient.</p>
</li>
<li>
<p><strong>Temporary outage</strong>– A disk might become unavailable for a period time,
causing I/Os to fail. This situation is typically associated with
network-attached devices, though local disks can experience temporary
outages as well. These errors might or might not be transient.</p>
</li>
<li>
<p><strong>Bad or flaky hardware</strong> – This situation is a catch-all for the
various problems that bad hardware exhibits. This could be consistent
I/O errors, faulty transports causing random corruption, or any number
of failures. These errors are typically permanent.</p>
</li>
<li>
<p><strong>Offlined device</strong> – If a device is offline, it is assumed that the
administrator placed the device in this state because it is presumed
faulty. The administrator who placed the device in this state can
determine is this assumption is accurate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Determining exactly what is wrong can be a difficult process. The first
step is to examine the error counts in the <code>zpool status</code> output as
follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -v pool</pre>
</div>
</div>
<div class="paragraph">
<p>The errors are divided into I/O errors and checksum errors, both of
which might indicate the possible failure type. Typical operation
predicts a very small number of errors (just a few over long periods of
time). If you are seeing large numbers of errors, then this situation
probably indicates impending or complete device failure. However, the
pathology for administrator error can result in large error counts. The
other source of information is the system log. If the log shows a large
number of SCSI or fibre channel driver messages, then this situation
probably indicates serious hardware problems. If no syslog messages are
generated, then the damage is likely transient.</p>
</div>
<div class="paragraph">
<p>The goal is to answer the following question:</p>
</div>
<div class="paragraph">
<p><em>Is another error likely to occur on this device?</em></p>
</div>
<div class="paragraph">
<p>Errors that happen only once are considered <em>transient</em>, and do not
indicate potential failure. Errors that are persistent or severe enough
to indicate potential hardware failure are considered “fatal.” The act
of determining the type of error is beyond the scope of any automated
software currently available with ZFS, and so much must be done manually
by you, the administrator. Once the determination is made, the
appropriate action can be taken. Either clear the transient errors or
replace the device due to fatal errors. These repair procedures are
described in the next sections.</p>
</div>
<div class="paragraph">
<p>Even if the device errors are considered transient, it still may have
caused uncorrectable data errors within the pool. These errors require
special repair procedures, even if the underlying device is deemed
healthy or otherwise repaired. For more information on repairing data
errors, see <a href="#repairing-damaged-data">Repairing Damaged Data</a>.</p>
</div>
<div id="clearing-transient-errors" class="paragraph">
<p>==== Clearing Transient Errors</p>
</div>
<div class="paragraph">
<p>If the device errors are deemed transient, in that they are unlikely to
effect the future health of the device, then the device errors can be
safely cleared to indicate that no fatal error occurred. To clear error
counters for RAID-Z or mirrored devices, use the <code>zpool clear</code> command.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool clear tank c1t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>This syntax clears any errors associated with the device and clears any
data error counts associated with the device.</p>
</div>
<div class="paragraph">
<p>To clear all errors associated with the virtual devices in the pool, and
clear any data error counts associated with the pool, use the following
syntax:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool clear tank</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about clearing pool errors, see
<a href="#clearing-storage-pool-devices">Clearing Storage Pool Devices</a>.</p>
</div>
<div id="replacing-a-device-in-a-zfs-storage-pool" class="paragraph">
<p>==== Replacing a Device in a ZFS Storage Pool</p>
</div>
<div class="paragraph">
<p>If device damage is permanent or future permanent damage is likely, the
device must be replaced. Whether the device can be replaced depends on
the configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#determining-if-a-device-can-be-replaced">Determining if a Device Can Be Replaced</a></p>
</li>
<li>
<p><a href="#devices-that-cannot-be-replaced">Devices That Cannot be Replaced</a></p>
</li>
<li>
<p><a href="#replacing-a-device-in-a-zfs-storage-pool">Replacing a Device in a ZFS Storage Pool</a></p>
</li>
<li>
<p><a href="#viewing-resilvering-status">Viewing Resilvering Status</a></p>
</li>
</ul>
</div>
<div id="determining-if-a-device-can-be-replaced" class="paragraph">
<p>===== Determining if a Device Can Be Replaced</p>
</div>
<div class="paragraph">
<p>For a device to be replaced, the pool must be in the <code>ONLINE</code> state. The
device must be part of a redundant configuration, or it must be healthy
(in the <code>ONLINE</code> state). If the disk is part of a redundant
configuration, sufficient replicas from which to retrieve good data must
exist. If two disks in a four-way mirror are faulted, then either disk
can be replaced because healthy replicas are available. However, if two
disks in a four-way RAID-Z device are faulted, then neither disk can be
replaced because not enough replicas from which to retrieve data exist.
If the device is damaged but otherwise online, it can be replaced as
long as the pool is not in the <code>FAULTED</code> state. However, any bad data on
the device is copied to the new device unless there are sufficient
replicas with good data.</p>
</div>
<div class="paragraph">
<p>In the following configuration, the disk <code>c1t1d0</code> can be replaced, and
any data in the pool is copied from the good replica, <code>c1t0d0</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mirror            DEGRADED
    c1t0d0             ONLINE
    c1t1d0             FAULTED</pre>
</div>
</div>
<div class="paragraph">
<p>The disk <code>c1t0d0</code> can also be replaced, though no self-healing of data
can take place because no good replica is available.</p>
</div>
<div class="paragraph">
<p>In the following configuration, neither of the faulted disks can be
replaced. The <code>ONLINE</code> disks cannot be replaced either, because the pool
itself is faulted.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>raidz             FAULTED
    c1t0d0             ONLINE
    c2t0d0             FAULTED
    c3t0d0             FAULTED
    c3t0d0             ONLINE</pre>
</div>
</div>
<div class="paragraph">
<p>In the following configuration, either top-level disk can be replaced,
though any bad data present on the disk is copied to the new disk.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c1t0d0         ONLINE
c1t1d0         ONLINE</pre>
</div>
</div>
<div class="paragraph">
<p>If either disk were faulted, then no replacement could be performed
because the pool itself would be faulted.</p>
</div>
<div id="devices-that-cannot-be-replaced" class="paragraph">
<p>===== Devices That Cannot be Replaced</p>
</div>
<div class="paragraph">
<p>If the loss of a device causes the pool to become faulted, or the device
contains too many data errors in an non-redundant configuration, then
the device cannot safely be replaced. Without sufficient redundancy, no
good data with which to heal the damaged device exists. In this case,
the only option is to destroy the pool and re-create the configuration,
restoring your data in the process.</p>
</div>
<div class="paragraph">
<p>For more information about restoring an entire pool, see
<a href="#repairing-zfs-storage-pool-wide-damage">Repairing ZFS Storage Pool-Wide Damage</a>.</p>
</div>
<div id="replacing-a-device-in-a-zfs-storage-pool-1" class="paragraph">
<p>===== Replacing a Device in a ZFS Storage Pool</p>
</div>
<div class="paragraph">
<p>Once you have determined that a device can be replaced, use the
<code>zpool replace</code> command to replace the device. If you are replacing the
damaged device with another different device, use the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool replace tank c1t0d0 c2t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>This command begins migrating data to the new device from the damaged
device, or other devices in the pool if it is in a redundant
configuration. When the command is finished, it detaches the damaged
device from the configuration, at which point the device can be removed
from the system. If you have already removed the device and replaced it
with a new device in the same location, use the single device form of
the command. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool replace tank c1t0d0</pre>
</div>
</div>
<div class="paragraph">
<p>This command takes an unformatted disk, formats it appropriately, and
then begins resilvering data from the rest of the configuration.</p>
</div>
<div class="paragraph">
<p>For more information about the <code>zpool replace</code> command, see
<a href="#replacing-devices-in-a-storage-pool">Replacing Devices in a Storage Pool</a>.</p>
</div>
<div id="viewing-resilvering-status" class="paragraph">
<p>===== Viewing Resilvering Status</p>
</div>
<div class="paragraph">
<p>The process of replacing a drive can take an extended period of time,
depending on the size of the drive and the amount of data in the pool.
The process of moving data from one device to another device is known as
<em>resilvering</em>, and can be monitored by using the <code>zpool status</code> command.</p>
</div>
<div class="paragraph">
<p>Traditional file systems resilver data at the block level. Because ZFS
eliminates the artificial layering of the volume manager, it can perform
resilvering in a much more powerful and controlled manner. The two main
advantages of this feature are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ZFS only resilvers the minimum amount of necessary data. In the case
of a short outage (as opposed to a complete device replacement), the
entire disk can be resilvered in a matter of minutes or seconds, rather
than resilvering the entire disk, or complicating matters with “dirty
region” logging that some volume managers support. When an entire disk
is replaced, the resilvering process takes time proportional to the
amount of data used on disk. Replacing a 500-Gbyte disk can take seconds
if only a few gigabytes of used space is in the pool.</p>
</li>
<li>
<p>Resilvering is interruptible and safe. If the system loses power or is
rebooted, the resilvering process resumes exactly where it left off,
without any need for manual intervention.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To view the resilvering process, use the <code>zpool status</code> command. For
example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status tank
  pool: tank
 state: DEGRADED
reason: One or more devices is being resilvered.
action: Wait for the resilvering process to complete.
   see: http://illumos.org/msg/ZFS-XXXX-08
 scrub: none requested
config:
        NAME                  STATE     READ WRITE CKSUM
        tank                  DEGRADED     0     0     0
          mirror              DEGRADED     0     0     0
            replacing         DEGRADED     0     0     0  52% resilvered
              c1t0d0          ONLINE       0     0     0
              c2t0d0          ONLINE       0     0     0
            c1t1d0            ONLINE       0     0     0</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the disk <code>c1t0d0</code> is being replaced by <code>c2t0d0</code>. This
event is observed in the status output by presence of the <em>replacing</em>
virtual device in the configuration. This device is not real, nor is it
possible for you to create a pool by using this virtual device type. The
purpose of this device is solely to display the resilvering process, and
to identify exactly which device is being replaced.</p>
</div>
<div class="paragraph">
<p>Note that any pool currently undergoing resilvering is placed in the
<code>DEGRADED</code> state, because the pool cannot provide the desired level of
redundancy until the resilvering process is complete. Resilvering
proceeds as fast as possible, though the I/O is always scheduled with a
lower priority than user-requested I/O, to minimize impact on the
system. Once the resilvering is complete, the configuration reverts to
the new, complete, configuration. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status tank
  pool: tank
 state: ONLINE
 scrub: scrub completed with 0 errors on Thu Aug 31 11:20:18 2006
config:

        NAME        STATE     READ WRITE CKSUM
        tank        ONLINE       0     0     0
          mirror    ONLINE       0     0     0
            c2t0d0  ONLINE       0     0     0
            c1t1d0  ONLINE       0     0     0

errors: No known data errors</pre>
</div>
</div>
<div class="paragraph">
<p>The pool is once again <code>ONLINE</code>, and the original bad disk (<code>c1t0d0</code>)
has been removed from the configuration.</p>
</div>
<div id="repairing-damaged-data" class="paragraph">
<p>=== Repairing Damaged Data</p>
</div>
<div class="paragraph">
<p>The following sections describe how to identify the type of data
corruption and how to repair the data, if possible.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#identifying-the-type-of-data-corruption">Identifying the Type of Data Corruption</a></p>
</li>
<li>
<p><a href="#repairing-a-corrupted-file-or-directory">Repairing a Corrupted File or Directory</a></p>
</li>
<li>
<p><a href="#repairing-zfs-storage-pool-wide-damage">Repairing ZFS Storage Pool-Wide Damage</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ZFS uses checksumming, redundancy, and self-healing data to minimize the
chances of data corruption. Nonetheless, data corruption can occur if
the pool isn&#8217;t redundant, if corruption occurred while the pool was
degraded, or an unlikely series of events conspired to corrupt multiple
copies of a piece of data. Regardless of the source, the result is the
same: The data is corrupted and therefore no longer accessible. The
action taken depends on the type of data being corrupted, and its
relative value. Two basic types of data can be corrupted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pool metadata – ZFS requires a certain amount of data to be parsed to
open a pool and access datasets. If this data is corrupted, the entire
pool or complete portions of the dataset hierarchy will become
unavailable.</p>
</li>
<li>
<p>Object data – In this case, the corruption is within a specific file
or directory. This problem might result in a portion of the file or
directory being inaccessible, or this problem might cause the object to
be broken altogether.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Data is verified during normal operation as well as through scrubbing.
For more information about how to verify the integrity of pool data, see
<a href="#checking-zfs-data-integrity">Checking ZFS Data Integrity</a>.</p>
</div>
<div id="identifying-the-type-of-data-corruption" class="paragraph">
<p>==== Identifying the Type of Data Corruption</p>
</div>
<div class="paragraph">
<p>By default, the <code>zpool status</code> command shows only that corruption has
occurred, but not where this corruption occurred. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status tank -v
   pool: tank
     state: ONLINE
    status: One or more devices has experienced an error resulting in data
             corruption.  Applications may be affected.
    action: Restore the file in question if possible.  Otherwise restore the
             entire pool from backup.
       see: http://illumos.org/msg/ZFS-8000-8A
     scrub: none requested
    config:

        NAME         STATE     READ WRITE CKSUM
        tank         ONLINE       1     0     0
          mirror     ONLINE       1     0     0
            c2t0d0   ONLINE       2     0     0
            c1t1d0   ONLINE       2     0     0

    errors: The following persistent errors have been detected:

          DATASET  OBJECT  RANGE
          tank     6       0-512</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status
   pool: monkey
state: ONLINE
status: One or more devices has experienced an error resulting in data
         corruption.  Applications may be affected.
action: Restore the file in question if possible.  Otherwise restore the
         entire pool from backup.
    see: http://illumos.org/msg/ZFS-8000-8A
scrub: none requested
config:

         NAME        STATE     READ WRITE CKSUM
         monkey      ONLINE       0     0     0
           c1t1d0s6  ONLINE       0     0     0
           c1t1d0s7  ONLINE       0     0     0

errors: 8 data errors, use '-v' for a list</pre>
</div>
</div>
<div class="paragraph">
<p>Each error indicates only that an error occurred at the given point in
time. Each error is not necessarily still present on the system. Under
normal circumstances, this situation is true. Certain temporary outages
might result in data corruption that is automatically repaired once the
outage ends. A complete scrub of the pool is guaranteed to examine every
active block in the pool, so the error log is reset whenever a scrub
finishes. If you determine that the errors are no longer present, and
you don&#8217;t want to wait for a scrub to complete, reset all errors in the
pool by using the <code>zpool online</code> command.</p>
</div>
<div class="paragraph">
<p>If the data corruption is in pool-wide metadata, the output is slightly
different. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -v morpheus
  pool: morpheus
    id: 1422736890544688191
 state: FAULTED
status: The pool metadata is corrupted.
action: The pool cannot be imported due to damaged devices or data.
   see: http://illumos.org/msg/ZFS-8000-72
config:

        morpheus    FAULTED   corrupted data
          c1t10d0   ONLINE</pre>
</div>
</div>
<div class="paragraph">
<p>In the case of pool-wide corruption, the pool is placed into the
<code>FAULTED</code> state, because the pool cannot possibly provide the needed
redundancy level.</p>
</div>
<div id="repairing-a-corrupted-file-or-directory" class="paragraph">
<p>==== Repairing a Corrupted File or Directory</p>
</div>
<div class="paragraph">
<p>If a file or directory is corrupted, the system might still be able to
function depending on the type of corruption. Any damage is effectively
unrecoverable if no good copies of the data exist anywhere on the
system. If the data is valuable, you have no choice but to restore the
affected data from backup. Even so, you might be able to recover from
this corruption without restoring the entire pool.</p>
</div>
<div class="paragraph">
<p>If the damage is within a file data block, then the file can safely be
removed, thereby clearing the error from the system. Use the
<code>zpool status</code> <code>v</code> command to display a list of filenames with
persistent errors. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># zpool status -v
   pool: monkey
state: ONLINE
status: One or more devices has experienced an error resulting in data
         corruption.  Applications may be affected.
action: Restore the file in question if possible.  Otherwise restore the
         entire pool from backup.
    see: http://illumos.org/msg/ZFS-8000-8A
scrub: none requested
config:

         NAME        STATE     READ WRITE CKSUM
         monkey      ONLINE       0     0     0
           c1t1d0s6  ONLINE       0     0     0
           c1t1d0s7  ONLINE       0     0     0

errors: Permanent errors have been detected in the following files:

/monkey/a.txt
/monkey/bananas/b.txt
/monkey/sub/dir/d.txt
/monkey/ghost/e.txt
/monkey/ghost/boo/f.txt</pre>
</div>
</div>
<div class="paragraph">
<p>The preceding output is described as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the full path to the file is found and the dataset is mounted, the
full path to the file is displayed. For example:</p>
<div class="literalblock">
<div class="content">
<pre>/monkey/a.txt</pre>
</div>
</div>
</li>
<li>
<p>If the full path to the file is found, but the dataset is not mounted,
then the dataset name with no preceding slash (/), followed by the path
within the dataset to the file, is displayed. For example:</p>
<div class="literalblock">
<div class="content">
<pre>monkey/ghost:/e.txt</pre>
</div>
</div>
</li>
<li>
<p>If the object number to a file path cannot be successfully translated,
either due to an error or because the object doesn&#8217;t have a real file
path associated with it , as is the case for a <code>dnode_t</code>, then the
dataset name followed by the object&#8217;s number is displayed. For example:</p>
<div class="literalblock">
<div class="content">
<pre>monkey/dnode:&lt;0x0&gt;</pre>
</div>
</div>
</li>
<li>
<p>If an object in the meta-object set (MOS) is corrupted, then a special
tag of <code>&lt;metadata&gt;</code>, followed by the object number, is
displayed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the damage is within a file data block, then the file can safely be
removed, thereby clearing the error from the system. The first step is
to try to locate the file by using the <code>find</code> command and specify the
object number that is identified in the <code>zpool status</code> output under
<code>DATASET/OBJECT/RANGE</code> output as the inode number to find. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># find -inum 6</pre>
</div>
</div>
<div class="paragraph">
<p>Then, try removing the file with the <code>rm</code> command. If this command
doesn&#8217;t work, the corruption is within the file&#8217;s metadata, and ZFS
cannot determine which blocks belong to the file in order to remove the
corruption.</p>
</div>
<div class="paragraph">
<p>If the corruption is within a directory or a file&#8217;s metadata, the only
choice is to move the file elsewhere. You can safely move any file or
directory to a less convenient location, allowing the original object to
be restored in place.</p>
</div>
<div id="repairing-zfs-storage-pool-wide-damage" class="paragraph">
<p>==== Repairing ZFS Storage Pool-Wide Damage</p>
</div>
<div class="paragraph">
<p>If the damage is in pool metadata that damage prevents the pool from
being opened, then you must restore the pool and all its data from
backup. The mechanism you use varies widely by the pool configuration
and backup strategy. First, save the configuration as displayed by
<code>zpool status</code> so that you can recreate it once the pool is destroyed.
Then, use <code>zpool destroy</code> <code>f</code> to destroy the pool. Also, keep a file
describing the layout of the datasets and the various locally set
properties somewhere safe, as this information will become inaccessible
if the pool is ever rendered inaccessible. With the pool configuration
and dataset layout, you can reconstruct your complete configuration
after destroying the pool. The data can then be populated by using
whatever backup or restoration strategy you use.</p>
</div>
<div id="repairing-an-unbootable-system" class="paragraph">
<p>=== Repairing an Unbootable System</p>
</div>
<div class="paragraph">
<p>ZFS is designed to be robust and stable despite errors. Even so,
software bugs or certain unexpected pathologies might cause the system
to panic when a pool is accessed. As part of the boot process, each pool
must be opened, which means that such failures will cause a system to
enter into a panic-reboot loop. In order to recover from this situation,
ZFS must be informed not to look for any pools on startup.</p>
</div>
<div class="paragraph">
<p>ZFS maintains an internal cache of available pools and their
configurations in <code>/etc/zfs/zpool.cache</code>. The location and contents of
this file are private and are subject to change. If the system becomes
unbootable, boot to the <code>none</code> milestone by using the <code>m milestone=none</code>
boot option. Once the system is up, remount your root file system as
writable and then remove <code>/etc/zfs/zpool.cache</code>. These actions cause ZFS
to forget that any pools exist on the system, preventing it from trying
to access the bad pool causing the problem. You can then proceed to a
normal system state by issuing the <code>svcadm milestone all</code> command. You
can use a similar process when booting from an alternate root to perform
repairs.</p>
</div>
<div class="paragraph">
<p>Once the system is up, you can attempt to import the pool by using the
<code>zpool import</code> command. However, doing so will likely cause the same
error that occurred during boot, because the command uses the same
mechanism to access pools. If more than one pool is on the system and
you want to import a specific pool without accessing any other pools,
you must re-initialize the devices in the damaged pool, at which point
you can safely import the good pool.</p>
</div>
<script src="scroll-spy.js"></script>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-07-15 04:27:39 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>